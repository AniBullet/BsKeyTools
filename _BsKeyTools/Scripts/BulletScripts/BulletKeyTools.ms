/*
* @Description: å…³é”®å¸§å°å·¥å…·,é€æ¸ä¸°å¯Œä¸­
* @Author: Bullet.S
* @Date: 2019-09-28 11:48:53
 * @LastEditors: Bullet.S
 * @LastEditTime: 2022-07-03 04:31:37
* @Email: animator.bullet@foxmail.com
*/

try(destroydialog rolBsKeyTools)catch()
try(destroydialog rolFnKeys)catch()
try(destroydialog rolAddMyScripts)catch()
try(destroydialog rolCustomFps)catch()
try(destroydialog rolCustomBtn)catch()
try (callbacks.removeScripts #animationRangeChange id:#UpdateTimeRange) catch ()
try (callbacks.removeScripts #filePostOpen id:#UpdateFps) catch ()

Global BulletConfig = execute ("@\"" + (getDir #maxData) + "\\BulletConfig.ini\"")  --é…ç½®æ–‡ä»¶è·¯å¾„
Global iniPos  	--ä½ç½®ä¿å­˜è®°å½•
struct myScript (id,msName,dir)
Global iniArrMyScripts   = #((myScript id:1 msName:"<ï¼‹ï¼‹>" dir:""), \
(myScript id:2 msName:"<ï¼‹ï¼‹>" dir:""), \
(myScript id:3 msName:"<ï¼‹ï¼‹>" dir:""), \
(myScript id:4 msName:"<ï¼‹ï¼‹>" dir:""), \
(myScript id:5 msName:"<ï¼‹ï¼‹>" dir:""), \
(myScript id:6 msName:"<ï¼‹ï¼‹>" dir:""), \
(myScript id:7 msName:"<ï¼‹ï¼‹>" dir:""), \
(myScript id:8 msName:"<ï¼‹ï¼‹>" dir:""))
Global idBtn                = 1
global iniBsAutoCheckUpdate = true
Global switchToolPanel      = 0
global switchMSPanel        = 0
Global iniToolBtnAll        = #(101,102,103,104,105,106,107,108,109,110,111,112,
							201,202,203,204,205,206,207,208,209,210,211,212,
							301,302,303,304,305,306,307,308,309,310,311,312,
							401,402,403,404,405,406,407,408,409,410,411,412)
global iniIsIcon = false

try(FileIn ((getDir #scripts) + "\\BulletScripts\\fnSaveLoadConfig.ms"))
catch(messagebox "åŠ è½½é…ç½®å¤±è´¥ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
stLoadConfigAll.fnLoadConfigBsKeyToolsAll()
try(FileIn ((getDir #scripts) + "\\BulletScripts\\fnCheckUpdate.ms"))
catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
try(FileIn ((getDir #scripts) + "\\BulletScripts\\fnGetColorTheme.ms"))
catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
try(FileIn ((getDir #scripts) + "\\BulletScripts\\BsSwitchBtnString.ms"))
catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)

Global arrToolC1 = #()
Global arrToolC2 = #()
Global arrToolC3 = #()
Global arrToolC4 = #()
Global arrSourToolC1 = #()
Global arrSourToolC2 = #()
Global arrSourToolC3 = #()
Global arrSourToolC4 = #()

global curVerBsKeyTools = "0.9.9"
global verUrlBsKeyTools = "https://gitee.com/acebullet/BsKeyTools/raw/main/_BsKeyTools/version.dat"
global dlUrlBsKeyTools = "https://gitee.com/acebullet/BsKeyTools/raw/main/_BsKeyTools/_BsKeyTools%EF%BC%88%E8%A3%85%E5%AE%8C%E9%87%8D%E5%90%AFMAX,%E8%AF%AF%E6%9D%80%E8%AF%B7%E4%BF%A1%E4%BB%BB%EF%BC%89.exe"
global dlFileBsKeyTools = (getdir #temp) + "\\_BsKeyToolsï¼ˆè£…å®Œé‡å¯MAX,è¯¯æ€è¯·ä¿¡ä»»ï¼‰.exe"

struct myScript (id,msName,dir)

Global rolBsKeyTools
Global posMouMoved       = [0,0]
Global switchMouseState  = false
Global switchSelKeyRange = 0
Global arrLastSelRange   = #()
Global switchAllKeyRange = 0
Global iniAddToolbars    = 0
Global arrLastAllRange   = #()
Global arrKeysTime       = #()  -----------bipedå’Œboneçš„é¦–å°¾å¸§
Global arrLinkKeys       = #()  -----------å­˜linkå¸§
Global arrKeysSelected   = #()  -----------å­˜é€‰ä¸­çš„å¸§
global arrBlockingKeys   = #()  -----------é€‰ä¸­æˆ–è€…æ‰€æœ‰ç‰©ä½“çš„æ‰€æœ‰å…³é”®å¸§
global arrBoneEndAll     = #()  -----------æœ«ç«¯éª¨éª¼ä¸´æ—¶å±‚
Global keyFirst
Global keyEnd
Global keySelFirst
Global keySelEnd
Global fnAddKyes
Global fnSelectKeys
Global fnSelLinkKeys
Global fnAddLinkTimesKeys
Global fnAddLinkParamsKeys
Global keyMovedOffset = 5
Global symbol ----é€‰æ‹©çš„èŒƒå›´åˆ¤æ–­, 0å·¦è¾¹,1å³è¾¹,2å…¨éƒ¨
Global layerTraj --è½¨è¿¹è¾…åŠ©å±‚
Global arrTraj            = #()  ---è½¨è¿¹å­˜æ”¾æ•°ç»„, æ–¹ä¾¿åˆ é™¤
Global arrTempUnSelection = #()  ---éšè—æœªé€‰ä¸­ä¸´æ—¶å­˜æ”¾æ•°ç»„
Global menuSetFps
Global menuSetSpeed
Global SIOFile = dotNetClass "System.IO.File"
Global SIODir = dotNetClass "System.IO.Directory"
-- Global myTimer = dotnetobject "System.Timers.Timer" 500 autoreset:true
------------------å…¨å±€å˜é‡-------------------------------------------------------------------

-------------------å³é”®é¢æ¿ç©ºç™½å¤„è®¾ç½®---------------------------------------------------------
fn fnDelFileDir targetDel =  --åˆ é™¤æ–‡ä»¶
(
	if (SIOFile.Exists targetDel == true) then ---åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ–‡ä»¶
	(
		if getFileAttribute targetDel #readOnly == true or \
		getFileAttribute targetDel #hidden == true do --ä¿®æ”¹åªè¯»æˆ–è€…éšè—å±æ€§
		(
			setFileAttribute targetDel #readOnly false ; \
			setFileAttribute targetDel #hidden false
		)
		try (SIOFile.Delete(targetDel);(print ("å·²åˆ é™¤: "+ filenameFromPath targetDel)))
		catch (
			messagebox ("åˆ é™¤å¤±è´¥: "+ filenameFromPath targetDel + ". è¯·å°è¯•æ‰‹åŠ¨åˆ é™¤ã€‚          ")
			(shellLaunch (getfilenamepath targetDel) "")
		)
	)
)
fn fnDelDir dirDel =
(
	if (SIODir.Exists dirDel) == true do
	(
		if getFileAttribute dirDel #readOnly == true or getFileAttribute dirDel #hidden == true do
		(
			setFileAttribute dirDel #readOnly false ; setFileAttribute dirDel #hidden false
		)
		try (SIODir.Delete(dirDel) true;(print ("å·²åˆ é™¤: "+ pathConfig.stripPathToLeaf dirDel + " æ–‡ä»¶å¤¹")))
		catch (
			messagebox ("åˆ é™¤å¤±è´¥: "+ pathConfig.stripPathToLeaf dirDel + " æ–‡ä»¶å¤¹. è¯·å°è¯•æ‰‹åŠ¨åˆ é™¤.")
			(shellLaunch dirDel "")
		)
	)
)

------------------æ·»åŠ toolbar-----------------------------------------------
-- <Item typeID="2" type="CTB_MACROBUTTON" width="77" height="0" controlID="0" macroTypeID="3" macroType="MB_TYPE_ACTION" actionTableID="647394" imageID="-1" imageName="" actionID="BulletKeyTools`_[BulletTools]" tip="BsKeyTools" label="BsKeyTools" />

-- <Item typeID="2" type="CTB_MACROBUTTON" width="0" height="0" controlID="0" macroTypeID="3" macroType="MB_TYPE_ACTION" actionTableID="647394" imageID="-1" imageName="" actionID="BulletKeyTools`_[BulletTools]" tip="BsKeyTools" label="BsKeyTools" />

iniAddToolbars  = fnGetConfig iniAddToolbars "BulletKeyToolsSet"  "ToolBarBtn" (iniAddToolbars as string)
fn addToolBarButton macro cat txt remove: false =
(
	fn insertContent f data: "" find: "" rewrite: false =
	(						
		file = MemStreamMgr.openFile f
		size = file.size()
		MemStreamMgr.close file
				
		stream = openFile f mode:"r+"

		seek stream 0 
			
		mt = "\"Main Toolbar\""			
		skipToString stream mt
				
		exist = (skipToString stream find) == undefined
		
		previousContent = ""
		
		findPos = filePos stream
		
		if(not exist) do
		(							
			if(rewrite) do 
			(
				pos = findPos - find.count
				seek stream	0
				previousContent += readChars stream (pos)					
			)
			
			pos = findPos - (if(rewrite) then 0 else find.count)
		
			seek stream pos
			
			previousContent += readChars stream (size - pos)
									
			if(rewrite) do pos = 0
			
			seek stream pos
				
						
			format data to: stream
			format previousContent to: stream
		)
		
		close stream
		
		return not exist
	)
	
	try
	(
		f = cui.getConfigFile() 
		
		cui.loadConfig f
		cui.saveConfigAs f
		cui.loadConfig f
		
		l = "<Item typeID=\"2\" type=\"CTB_MACROBUTTON\" width=\"0\" height=\"0\" controlID=\"0\" macroTypeID=\"3\" macroType=\"MB_TYPE_ACTION\" actionTableID=\"647394\" imageID=\"-1\" imageName=\"\" actionID=\"" + macro + "`_[" + cat + "]\" tip=\"" + txt + "\" label=\"" + txt + "\" />"
		delBtnLine = "<Item typeID=\"2\" type=\"CTB_MACROBUTTON\" width=\"77\" height=\"0\" controlID=\"0\" macroTypeID=\"3\" macroType=\"MB_TYPE_ACTION\" actionTableID=\"647394\" imageID=\"-1\" imageName=\"\" actionID=\"" + macro + "`_[" + cat + "]\" tip=\"" + txt + "\" label=\"" + txt + "\" />"
		if(remove) then
		(			
			insertContent f find: delBtnLine rewrite: true
		)
		else
		(		
			insertContent f find: "</Items>" data: ("\t\t" + l + "\n")			
		)
				
		cui.loadConfig f
		--cui.setConfigFile f
		cui.saveConfigAs f
		--cui.loadConfig f
			
	) catch(messageBox "è¯·æ‰‹åŠ¨å¤„ç†Toolbar!             \r\n" title: "é”™è¯¯!")
)
-----------------------------------------------------------------------------------------------------
global arrToolNewC1 = #();global arrToolNewC2 = #();global arrToolNewC3 = #();global arrToolNewC4 = #();
global arrToolsAll
global arrToolsNameAll

rollout rolCustomBtn "è‡ªå®šä¹‰åŠŸèƒ½æŒ‰é’®ä½ç½®" width:490 height:210
(
	dotNetControl dotnetBtnTabCon "System.Windows.Forms.TabControl" height:165 width:30 align:#center pos:[136,18]

	multilistbox mlbToolsBtnAll "å·²é€‰æ‹©:        " width:100 height:12 pos:[5,4] selection:0
	button btnAddToSort ">>>" width:30 height:40 pos:[106,20]
	button btnRemoveFromSort "<<<" width:30 height:40 pos:[106,60]
	listbox mlbToolBtn1 "å‰©ä½™:     " width:80 height:12 pos:[167,4] selection:0
	listbox mlbToolBtn2 "å‰©ä½™:     " width:80 height:12 pos:[247,4] selection:0
	listbox mlbToolBtn3 "å‰©ä½™:     " width:80 height:12 pos:[327,4] selection:0
	listbox mlbToolBtn4 "å‰©ä½™:     " width:80 height:12 pos:[407,4] selection:0
	button btnMoveUp "â†‘" width:30 height:40 pos:[106,100]
	button btnMoveDown "â†“" width:30 height:40 pos:[106,140]
	button btnResetBtn "é‡ç½®é»˜è®¤" width:60 height:25 pos:[0,185]
	button btnCollectCurrent "åŠ è½½å½“å‰" width:60 height:25 pos:[60,185]
	button btnReAdd "æ¸…ç©º" width:50 height:25 pos:[120,185]
	button btnSetBtn ">>> ç¡®è®¤è®¾ç½®æ’åºï¼ˆæ¯ç»„æœ€å¤š12ä¸ªæŒ‰é’®ï¼‰<<<" width:320 height:25 pos:[170,185]
	
	fn fnSwitchTab = 
	(
		local strCurIndex = (rolCustomBtn.dotnetBtnTabCon.SelectedIndex + 1) as string
		local arrMlbToolBtn = #(mlbToolBtn1,mlbToolBtn2,mlbToolBtn3,mlbToolBtn4)
		for i in arrMlbToolBtn do
		(
			if (i.name)[i.name.count] == strCurIndex then i.enabled = true
			else i.enabled = false
		)
	)
	
	on dotnetBtnTabCon Selected arg do
	(
		fnSwitchTab()
	)		
	
	fn fnToolBtnCountText =
	(
		mlbToolBtn1.caption = "å‰©ä½™: " + (12 - mlbToolBtn1.items.count) as string
		mlbToolBtn2.caption = "å‰©ä½™: " + (12 - mlbToolBtn2.items.count) as string
		mlbToolBtn3.caption = "å‰©ä½™: " + (12 - mlbToolBtn3.items.count) as string
		mlbToolBtn4.caption = "å‰©ä½™: " + (12 - mlbToolBtn4.items.count) as string
	)
	
	fn fnAddRemoveItems action:"add" =
	(
		local arrBtnSort = #(rolCustomBtn.mlbToolBtn1,rolCustomBtn.mlbToolBtn2,
							rolCustomBtn.mlbToolBtn3,rolCustomBtn.mlbToolBtn4)
		local arrTarSort = arrBtnSort[rolCustomBtn.dotnetBtnTabCon.SelectedIndex + 1]
		local numSelAddBtn = (rolCustomBtn.mlbToolsBtnAll.selection as array).count
		local arrBtnAllTemp = join #() (mlbToolsBtnAll.items as array)
		local arrTarSortTemp = join #() (arrTarSort.items as array)
		
		if (action == "add") then 
		(
			if numSelAddBtn > 0 and ((arrTarSort.items as array).count + numSelAddBtn) <= 12 then
			(
				for i in mlbToolsBtnAll.selection as array do
				(
					append arrTarSortTemp arrBtnAllTemp[i]
				)
				for i in mlbToolsBtnAll.selection as array do
				(
					deleteitem arrBtnAllTemp (finditem arrBtnAllTemp mlbToolsBtnAll.items[i])
				)
				arrTarSort.items = arrTarSortTemp
				mlbToolsBtnAll.items = arrBtnAllTemp
				-- mlbToolsBtnAll.selection = 0
			)
			else if ((arrTarSort.items as array).count + numSelAddBtn) > 12 then (messagebox"æ¯æ æœ€å¤š12ä¸ªæŒ‰é’®...          "beep:false)
		)
		else if (action == "remove") then 
		(
			if arrTarSort.selection != 0 then 
			(
				arrBtnAllTemp = join #(arrTarSort.selected) arrBtnAllTemp
				deleteitem arrTarSortTemp (finditem arrTarSortTemp arrTarSort.selected)
				mlbToolsBtnAll.items = arrBtnAllTemp
				arrTarSort.items = arrTarSortTemp
				-- arrTarSort.selection = 0
			)
		)
	)

	fn fnSaveBtnSort =
	(
		arrToolNewC1 = mlbToolBtn1.items
		arrToolNewC2 = mlbToolBtn2.items
		arrToolNewC3 = mlbToolBtn3.items
		arrToolNewC4 = mlbToolBtn4.items
		-- arrToolsAll = arrToolC1 + arrToolC2 + arrToolC3 + arrToolC4
		-- arrToolsNameAll = for i in arrToolsAll collect i.caption
		local arrToolsNewAll = arrToolNewC1 + arrToolNewC2 + arrToolNewC3 + arrToolNewC4
		local arrIniToolBtnAllNew = #()
		for i in arrToolsNewAll do 
		(
			append arrIniToolBtnAllNew iniToolBtnAll[finditem arrToolsNameAll i]
		)
		iniToolBtnAll = (join #() arrIniToolBtnAllNew)
		fnSetToolBtnConfig ()
		-- print iniToolBtnAll #nomap
		rolBsKeyTools.fnReloadToolsBtn()
		rolBsKeyTools.fnSwitchToolsBtn idBtn
	)

	fn fnRefreshMlbToolBtn =
	(
		mlbToolBtn1.items = for i in arrToolC1 collect i.caption
		mlbToolBtn2.items = for i in arrToolC2 collect i.caption
		mlbToolBtn3.items = for i in arrToolC3 collect i.caption
		mlbToolBtn4.items = for i in arrToolC4 collect i.caption
		mlbToolsBtnAll.items = #()
		fnToolBtnCountText()
	)

	fn fnCheckSort =
	(
		if (((mlbToolsBtnAll.items as array).count == 0) and ((mlbToolBtn1.items as array).count == 12) and
			((mlbToolBtn1.items as array).count == 12) and ((mlbToolBtn1.items as array).count == 12) and 
			((mlbToolBtn1.items as array).count == 12)) then (true) else (false)
	)

	fn fnMoveItems action:"MoveUp" = 
	(
		local arrBtnSort = #(rolCustomBtn.mlbToolBtn1,rolCustomBtn.mlbToolBtn2,
							rolCustomBtn.mlbToolBtn3,rolCustomBtn.mlbToolBtn4)
		local arrTarSort = arrBtnSort[rolCustomBtn.dotnetBtnTabCon.SelectedIndex + 1]
		local arrTarSortTemp = join #() (arrTarSort.items as array)
		
		if arrTarSort.selection != 0 then 
		(
			local tarSortBtn = arrTarSort.selected
			local tarSortBtnIndex = arrTarSort.selection
			
			if (action == "MoveUp") and (tarSortBtnIndex != 1) then 
			(
				deleteItem arrTarSortTemp tarSortBtnIndex
				insertitem tarSortBtn arrTarSortTemp (tarSortBtnIndex - 1)
				arrTarSort.selection = (tarSortBtnIndex - 1)
			)
			else if (action == "MoveDown") and (tarSortBtnIndex != 12) then
			(
				deleteItem arrTarSortTemp tarSortBtnIndex
				insertitem tarSortBtn arrTarSortTemp (tarSortBtnIndex + 1)
				arrTarSort.selection = (tarSortBtnIndex + 1)
			)
			arrTarSort.items = arrTarSortTemp
			-- print arrTarSortTemp #nomap
		)
	)

	on rolCustomBtn open do 
	(
		local arrBtnTabCon = #(rolBsKeyTools.ckbC1.caption,rolBsKeyTools.ckbC2.caption,
						rolBsKeyTools.ckbC3.caption,rolBsKeyTools.ckbC4.caption)
		arrToolNewC1 = #();arrToolNewC2 = #();arrToolNewC3 = #();arrToolNewC4 = #();
		arrToolsAll = arrToolC1 + arrToolC2 + arrToolC3 + arrToolC4
		arrToolsNameAll = for i in arrToolsAll collect i.caption
		mlbToolsBtnAll.items     = arrToolsNameAll
		mlbToolsBtnAll.text = "å·²é€‰æ‹©: " + (rolCustomBtn.mlbToolsBtnAll.selection as array).count as string
		dotnetBtnTabCon.dock     = dotnetBtnTabCon.dock.Fill
		dotnetBtnTabCon.Drawmode = dotnetBtnTabCon.Drawmode.OwnerDrawFixed
		dotnetBtnTabCon.SizeMode = dotnetBtnTabCon.SizeMode.Fixed
		dotnetBtnTabCon.ItemSize = dotNetobject "System.Drawing.Size" 40 30
		dotnetBtnTabCon.alignment = (dotnetclass "system.Windows.Forms.Tabalignment").left
        
        for aTab in arrBtnTabCon do
        (
            dotnetBtnTabCon.TabPages.add aTab
        )
        rolCustomBtn.dotnetBtnTabCon.SelectedIndex = 0
		fnSwitchTab()
		fnToolBtnCountText()
	)
	
	on mlbToolsBtnAll selectionEnd do 
	(
		mlbToolsBtnAll.text = "å·²é€‰æ‹©: " + (rolCustomBtn.mlbToolsBtnAll.selection as array).count as string
	)
	
	on btnAddToSort pressed do
	(
		fnAddRemoveItems()
		fnToolBtnCountText()
		mlbToolsBtnAll.text = "å·²é€‰æ‹©: " + (rolCustomBtn.mlbToolsBtnAll.selection as array).count as string
	)

	on btnRemoveFromSort pressed do
	(
		fnAddRemoveItems action:"remove"
		fnToolBtnCountText()
		mlbToolsBtnAll.text = "å·²é€‰æ‹©: " + (rolCustomBtn.mlbToolsBtnAll.selection as array).count as string
	)

	on btnSetBtn pressed do 
	(
		if fnCheckSort() == true then
		(
			fnSaveBtnSort()
			try(destroydialog rolCustomBtn)catch()
		)
		else (messagebox "è¯·ç¡®è®¤æŒ‰é’®éƒ½æ’åºå®Œæ¯•,æ‰èƒ½å®Œæˆè®¾ç½®...                    " beep:false)
	)
	on btnResetBtn pressed do 
	(
		if (queryBox "æ˜¯å¦é‡ç½®åŠŸèƒ½æŒ‰é’®é»˜è®¤ä½ç½®ï¼Ÿ                   " \
		title:"é‡ç½®ä½ç½®" beep:false) then
		(
			iniToolBtnAll = #(101,102,103,104,105,106,107,108,109,110,111,112,
							201,202,203,204,205,206,207,208,209,210,211,212,
							301,302,303,304,305,306,307,308,309,310,311,312,
							401,402,403,404,405,406,407,408,409,410,411,412)
			fnSetToolBtnConfig ()
			rolBsKeyTools.fnReloadToolsBtn()
			rolBsKeyTools.fnSwitchToolsBtn idBtn
			-- print iniToolBtnAll #nomap
			fnRefreshMlbToolBtn()
			arrToolsAll = arrToolC1 + arrToolC2 + arrToolC3 + arrToolC4
			arrToolsNameAll = for i in arrToolsAll collect i.caption
			mlbToolsBtnAll.text = "å·²é€‰æ‹©: " + (rolCustomBtn.mlbToolsBtnAll.selection as array).count as string
		)
	)
	on btnReAdd pressed do 
	(
		if (queryBox "æ˜¯å¦æ¸…ç©ºå½“å‰åˆ—è¡¨é‡æ–°æ’åºï¼Ÿ                   " \
		title:"æ¸…ç©ºé‡æ–°æ’åº" beep:false) then
		(
			arrToolsAll = arrToolC1 + arrToolC2 + arrToolC3 + arrToolC4
			arrToolsNameAll = for i in arrToolsAll collect i.caption
			mlbToolsBtnAll.items = arrToolsNameAll
			arrToolNewC1 = #();arrToolNewC2 = #();arrToolNewC3 = #();arrToolNewC4 = #();
			mlbToolBtn1.items = #();mlbToolBtn2.items = #();mlbToolBtn3.items = #();mlbToolBtn4.items = #()
			fnToolBtnCountText()
			mlbToolsBtnAll.selection = 0
			mlbToolsBtnAll.text = "å·²é€‰æ‹©: " + (rolCustomBtn.mlbToolsBtnAll.selection as array).count as string
		)
	)
	on btnCollectCurrent pressed do 
	(
		fnRefreshMlbToolBtn()
		mlbToolsBtnAll.text = "å·²é€‰æ‹©: " + (rolCustomBtn.mlbToolsBtnAll.selection as array).count as string
	)
	
	on btnMoveUp pressed do 
	(
		fnMoveItems action:"MoveUp"
	)

	on btnMoveDown pressed do 
	(
		fnMoveItems action:"MoveDown"
	)
)
--------------------------------------------------------------------------------------------------------
fn fnSwitchIconStyle = 
(
	rolBsKeyTools.ckbFnBoxDisplay.images = #("AtmosApp_24i.bmp","AtmosApp_24i.bmp",3,1,1,1,1,true,true)
	rolBsKeyTools.btnHideUnSel.images = #("IsolateSelection_16i.bmp","IsolateSelection_16i.bmp",1,1,1,1,1,true,true)
	rolBsKeyTools.btnJudgeLinkKey.images = #("Maintoolbar_24i.bmp","Maintoolbar_24i.bmp",103,6,5,6,5,true,true)
	rolBsKeyTools.ckbShadowCut.images = #("Radiosity_24i.bmp","Radiosity_24i.bmp",6,3,4,3,4,true,true)
	rolBsKeyTools.ckbFreezeMesh.images = #("UVWUnwrapView_24i.bmp","UVWUnwrapView_24a.bmp",27,17,19,17,19,true,false)
	rolBsKeyTools.btnCutFrameDisplay.images = #("AutoGrid_16i.bmp","AutoGrid_16i.bmp",2,2,2,2,2,true,true)
	rolBsKeyTools.btnAllFrameDisplay.images = #("TrackViewStatus_24i.bmp","TrackViewStatus_24i.bmp",27,3,3,3,3,true,true)
	rolBsKeyTools.btnTrackBarTools.images = #("PFSubObjectIcons_24i.bmp","PFSubObjectIcons_24i.bmp",2,2,2,2,2,true,true)
	rolBsKeyTools.ckbHideBones.images = #("Systems_24i.bmp","Systems_24i.bmp",3,1,1,1,1,true,true)
	rolBsKeyTools.ckbHideBiped.images = #("CAT_ColourMode_i.bmp","CAT_ColourMode_a.bmp",10,2,1,2,1,true,false)
	rolBsKeyTools.btnImageComp.images = #("TaskPanel_i.bmp","TaskPanel_i.bmp",6,2,2,2,2,true,false)
	rolBsKeyTools.btnTrajedit.images = #("bip_curve_24i.bmp","bip_curve_24i.bmp",20,7,7,7,7,true,true)
	rolBsKeyTools.btnFileOpen.images = #("Maxscript_24i.bmp","Maxscript_24i.bmp",5,1,1,1,1,true,true)
	rolBsKeyTools.btnLightTable.images = #("SW_PartDyn_24i.bmp","SW_PartDyn_24i.bmp",5,1,1,1,1,true,true)
	rolBsKeyTools.ckbPlayBlocking.images = #("SchematicView_24i.bmp","SchematicView_24i.bmp",4,3,3,3,3,true,true)
	rolBsKeyTools.btnSpringMagic.images = #("NURBSSurface_24i.bmp","NURBSSurface_24i.bmp",2,1,1,1,1,true,true)
	rolBsKeyTools.btnCSTools.images = #("bip_layer_i.bmp","bip_layer_i.bmp",24,17,17,17,17,true,true)
	rolBsKeyTools.btnAnimCopyPaste.images = #("MergeAnim_24i.bmp","MergeAnim_24i.bmp",4,4,4,4,4,true,true)
	rolBsKeyTools.btnLayerManager.images = #("AnimLayerToolbar_16i.bmp","AnimLayerToolbar_16i.bmp",12,1,1,1,1,true,true)
	rolBsKeyTools.btnSelectionsetTools.images = #("enss_maintoolbar_16i.bmp","enss_maintoolbar_16i.bmp",1,1,1,1,1,true,true)
	rolBsKeyTools.btnPoseTool.images = #("bip_modes_i.bmp","bip_modes_i.bmp",8,1,1,1,1,true,true)
	rolBsKeyTools.btnQuicksave.images = #("bip_copy1paste_i.bmp","bip_copy1paste_i.bmp",10,3,3,3,3,true,true)
)

rcmenu menuConfig
(
	local startupBsKeyTools = (getDir #Scripts) + "\\BulletScripts\\StartupMS\\BulletKeyTools.ms"
	local startupPath = (getDir #StartupScripts)+ "\\BulletKeyTools.ms"
	local startupMarcroPath = (getDir #StartupScripts)+ "\\BsKeyToolsMacro.ms"
	local startupMenuBarPath = (getDir #StartupScripts)+ "\\BsKeyToolsMenuBar.ms"
	menuItem mItemHelpDoc ">> å¿…çœ‹å¸®åŠ©æ–‡æ¡£ <<"
	menuItem mItemBugReport ">> é—®é¢˜å’Œå’Œå»ºè®® <<"
	separator menuSepHelp
	menuItem mItemIsStartup "æ˜¯å¦éš3dsMaxè‡ªå¯"
	menuItem mItemAddToolBarBtn "æ·»åŠ å·¥å…·æ å¿«é€Ÿå¯åŠ¨"
	menuItem mItemCustomSortBtn "è‡ªå®šä¹‰åŠŸèƒ½æŒ‰é’®ä½ç½®"
	menuItem mItemIsIcon "åˆ‡æ¢å›¾æ ‡æ¨¡å¼ [å®éªŒ]"
	separator menuSepCustom
	menuItem mItemCleanVirus "æ€æ¯’å·¥å…· [æµ‹è¯•ä¸­]"
	subMenu "æ›´æ–°è®¾ç½® [éœ€è¦è”ç½‘]"
	(
		menuItem mItemCheckUpdate "æ£€æŸ¥æ›´æ–° [éœ€è¦è”ç½‘]"
		menuItem mItemForceUpdate "å¼ºåˆ¶æ›´æ–° [æ— è§†ç‰ˆæœ¬]"
		menuItem mItemAutoCheckUpdate "è‡ªå¯æ£€æµ‹ [éœ€è¦è”ç½‘]"
		menuItem mItemUpdateLog "æ›´æ–°è®°å½• [éœ€æ±‚ä½•åœ¨]"
		menuItem mItemUndoVersion "å›é€€ç‰ˆæœ¬ [ä¸Šä¸ªç‰ˆæœ¬]"
	)
	subMenu "è°ƒè¯•ç›¸å…³ [è°¨æ…ä½¿ç”¨]"
	(
		menuItem mItemScriptsPath "è„šæœ¬ç›®å½• [æŸ¥é”™ä¼˜åŒ–]"
		menuItem mItemConfigFilePath "é…ç½®æ–‡ä»¶ [å¤‡ä»½å¯¼å…¥]"
		menuItem mItemRolloutBuilder "è„šæœ¬ç•Œé¢ [å­¦ä¹ å·¥å…·]"
	)
	separator menuSepConf
	menuItem mItemClose "å…³é—­ [ç©ºç™½å¤„ä¸­é”®ä¹Ÿå¯]"
	menuItem mItemUninstall "å¸è½½ [è¯·æœŸå¾…æ›´å¥½çš„æˆ‘]"
	subMenu "å…³äºæˆ‘ [æ¬¢è¿å»ºè®®äº¤æµ]"
	(
		menuItem mItemBilibili "ğŸ“º Bilibili"
		menuItem mItemTwitter "ğŸ¦ Twitter"
		menuItem mItemQgroup "ğŸ§ Qgroup"
	)

	on menuConfig open do
	(
		if(SIOFile.Exists startupPath) then (mItemIsStartup.checked = true)
		else (mItemIsStartup.checked = false)
		if (iniAddToolbars == 1) then (mItemAddToolBarBtn.checked = true)
		else (mItemAddToolBarBtn.checked = false)
		mItemAutoCheckUpdate.checked = iniBsAutoCheckUpdate
		mItemIsIcon.checked = iniIsIcon
	)

	on mItemHelpDoc picked do 
	(shellLaunch "https://www.notion.so/bullet4869/BsKeyTools-17b5ba7c37ae45f6a69ce90f45fa0657" "")

	on mItemBugReport picked do
	(shellLaunch "https://github.com/AnimatorBullet/BsKeyTools/issues" "")

	on mItemBilibili picked do 
	(shellLaunch "https://space.bilibili.com/2031113" "")

	on mItemTwitter picked do 
	(shellLaunch "https://twitter.com/aniBulletCom" "")

	on mItemScriptsPath picked do 
	(shellLaunch (getdir #Scripts) "")

	on mItemQgroup picked do
	(
		if (queryBox "æ˜¯å¦åŠ å…¥ä¸ªäººåˆ†äº«äº¤æµç¾¤ï¼Ÿ\r\n\r\n(æ¸¸æˆï¼ŒåŠ¨ç”»çˆ±å¥½è€…ä¼‘é—²å¹æ°´æ­£èƒ½é‡åˆ†äº«ç¾¤)\r\n\r\nå­å¼¹å·¥å…·äºº(993590655)ï¼Œç¡®è®¤å¯ç›´æ¥è·³è½¬é“¾æ¥~          \r\n        " \
		title:"åŠ å…¥äº¤æµç¾¤" beep:false) then
		(shellLaunch "https://jq.qq.com/?_wv=1027&k=hmeHhTwu" "")
	)

	on mItemCleanVirus picked do
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\BsCleanVirus.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on mItemConfigFilePath picked do
	(
		if (queryBox "æ˜¯å¦æ‰“å¼€é…ç½®æ–‡ä»¶ç›®å½•ï¼Ÿï¼ˆé…ç½®æ–‡ä»¶ï¼šBulletConfig.iniï¼‰\r\n\r\nã€å¦å­˜æˆ–æ›¿æ¢æ­¤æ–‡ä»¶å¯æ‰‹åŠ¨å¤„ç†å¤‡ä»½æˆ–å¯¼å…¥è„šæœ¬é…ç½®ã€‘                                                     " \
		title:"é…ç½®æ–‡ä»¶" beep:false) then
		(shellLaunch (getFilenamePath BulletConfig) "")
	)

	on mItemRolloutBuilder picked do
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\Quote\\RolloutBuilder.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on mItemIsStartup picked do 
	(
		if (mItemIsStartup.checked == true) then 
		(
			fnDelFileDir startupPath
			mItemIsStartup.checked = false
			messagebox ("å·²è§£é™¤ BsKeyTools è‡ªå¯ï¼                  ")  title:"è‡ªå¯è®¾ç½®"
		)
		else 
		(
			if (not (SIOFile.Exists startupPath)) do
			(
				try 
				(
					SIOFile.Copy startupBsKeyTools startupPath
					messagebox ("å·²æ‰“å¼€ BsKeyTools è‡ªå¯ï¼                  ")  title:"è‡ªå¯è®¾ç½®"
					mItemIsStartup.checked = true
					setFileAttribute startupPath #readOnly true
				)
				catch
				(
					messagebox ("è‡ªå¯å¤±è´¥ï¼Œçƒ¦è¯·æ‰‹åŠ¨å¤„ç†ï¼š\r\næŠŠ BulletKeyTools.ms å¤åˆ¶åˆ°\r\n\r\n" + (getDir #StartupScripts) + "                    ")
					(shellLaunch (getfilenamepath startupBsKeyTools) "")
				)
			)
		)
	)

	on mItemAddToolBarBtn picked do
	(
		if (mItemAddToolBarBtn.checked == false) then 
		(
			addToolBarButton "BulletKeyTools" "BulletTools" "BsKeyTools" remove: true
			addToolBarButton "BulletKeyTools" "BulletTools" "BsKeyTools"
			mItemAddToolBarBtn.checked = true
			iniAddToolbars = 1
		)
		else
		(
			addToolBarButton "BulletKeyTools" "BulletTools" "BsKeyTools" remove: true
			mItemAddToolBarBtn.checked = false
			iniAddToolbars = 0
		)
		SetINISetting BulletConfig "BulletKeyToolsSet"  "ToolBarBtn" (iniAddToolbars as string)
	)

	on mItemCheckUpdate picked do 
	(fnCheckUpdate curVerBsKeyTools verUrlBsKeyTools dlUrlBsKeyTools dlFileBsKeyTools isForceUpdate:false)

	on mItemForceUpdate picked do 
	(fnCheckUpdate curVerBsKeyTools verUrlBsKeyTools dlUrlBsKeyTools dlFileBsKeyTools isForceUpdate:true)

	on mItemUndoVersion picked do 
	(
		local dlUrlPreviousVersion = "https://gitee.com/acebullet/BsKeyTools/raw/main/_BsKeyTools/_PreviousVersion.exe"
		local dlFilePreviousVersion = (getdir #temp) + "\\_PreviousVersion.exe"
		fnCheckUpdate curVerBsKeyTools verUrlBsKeyTools dlUrlPreviousVersion dlFilePreviousVersion isForceUpdate:true
	)

	on mItemAutoCheckUpdate picked do 
	(
		if (mItemAutoCheckUpdate.checked == true) then (mItemAutoCheckUpdate.checked = false)
		else (mItemAutoCheckUpdate.checked = true)
		iniBsAutoCheckUpdate = mItemAutoCheckUpdate.checked
	)

	on mItemClose picked do 
	(
		try(destroydialog rolBsKeyTools)catch()
		try(destroydialog rolFnKeys)catch()
		try(destroydialog rolAddMyScripts)catch()
	)

	on mItemUninstall picked do
	(
		if (queryBox "æ˜¯å¦å½»åº•æ¸…é™¤ BsKeyToolsï¼Ÿ          \r\n( é…ç½®æ–‡ä»¶é»˜è®¤ä¿ç•™ )" \
		title:"æœ‰ç¼˜å†ä¼š" beep:false) then
		(
			if (iniAddToolbars == 1) then 
			(
				addToolBarButton "BulletKeyTools" "BulletTools" "BsKeyTools" remove: true
				iniAddToolbars = 0
				SetINISetting BulletConfig "BulletKeyToolsSet"  "ToolBarBtn" (iniAddToolbars as string)
			)
			if ((menuMan.findMenu "ğŸ® BsKeyTools") != undefined) then 
            (
                menuMan.unRegisterMenu (menuMan.findMenu "ğŸ® BsKeyTools")
                menuMan.updateMenuBar()
            )
			if (SIOFile.Exists startupPath) do (fnDelFileDir startupPath)
			if (SIOFile.Exists startupMarcroPath) do (fnDelFileDir startupMarcroPath)
			if (SIOFile.Exists startupMenuBarPath) do (fnDelFileDir startupMenuBarPath)
			arrDelPath = #(((getDir #Scripts)+ "\\BulletScripts"),((getDir #maxroot) + "\\UI_ln\\Icons\\cstoolIcons"))
			for d in arrDelPath do (fnDelDir d)
			try(destroydialog rolBsKeyTools)catch()
			try(destroydialog rolFnKeys)catch()
			try(destroydialog rolAddMyScripts)catch()
			(messagebox "å·²æ¸…ç†å¹²å‡€ï¼Œä¿ç•™é…ç½®æ–‡ä»¶å¤‡ç”¨...    \r\n" beep:false title:"å¸è½½æˆåŠŸï¼")
		)
	)

	on mItemUpdateLog picked do (shellLaunch "https://www.notion.so/bullet4869/4e28c488d5474a9082e164b7c5b6926c" "")

	on mItemCustomSortBtn picked do 
	(
		try(destroydialog rolCustomBtn)catch()
		Createdialog rolCustomBtn fgcolor:myFgColor pos:((getdialogpos rolBsKeyTools)+[0,rolBsKeyTools.height]) parent:rolBsKeyTools.hwnd
	)

	on mItemIsIcon picked do 
	(
		if (mItemIsIcon.checked == false) then 
		(
			fnSwitchIconStyle()
			mItemIsIcon.checked = not mItemIsIcon.checked
			iniIsIcon = mItemIsIcon.checked
		)
		else
		(
			mItemIsIcon.checked = not mItemIsIcon.checked
			iniIsIcon = mItemIsIcon.checked
			try(fileIn ((getDir #Scripts)+ @"\\BulletScripts\\BulletKeyTools.ms"))
			catch(messagebox "æ‰“å¼€BsKeyToolså¤±è´¥,\r\nå»ºè®®é‡å¯Maxæˆ–é‡æ–°å®‰è£…...          ")
		)
	)
)

-------------------å¸§ç‡,æ’­æ”¾é€Ÿåº¦--------------------------------------------------------------
Global valueFps
Global valuePlaySpeed = ""
Global strCurrentFps = framerate as string + "FPS"

fn fnBsRefFps =
(
	local arrMenuSetFps = #(menuSetFps.menuSet60Fps,menuSetFps.menuSet30Fps, \
							menuSetFps.menuSet24Fps,menuSetFps.menuCustomFps)
	for i in arrMenuSetFps do i.checked = false
	case of
	(
		(framerate == 60):(menuSetFps.menuSet60Fps.checked = true)
		(framerate == 30):(menuSetFps.menuSet30Fps.checked = true)
		(framerate == 24):(menuSetFps.menuSet24Fps.checked = true)
		default:(menuSetFps.menuCustomFps.checked = true)
	)
	menuSetFps.menuCurrentFps.text = "å½“å‰: " + framerate as string + "FPS"
	strCurrentFps = framerate as string + "FPS"
	rolBsKeyTools.btnSetFps.text = strCurrentFps
)

fn fnSetFps numFps =
(
	framerate = numFps
	valueFps = numFps
	fnBsRefFps ()
	slidertime -= 1
	slidertime += 1
)

fn fnRefPlaySpeedValue =
(
	local arrMenuSetSpeed = #(menuSetSpeed.menuSet14Speed,menuSetSpeed.menuSet12Speed, \
		menuSetSpeed.menuSet1Speed,menuSetSpeed.menuSet2Speed,menuSetSpeed.menuSet4Speed)
		for i in arrMenuSetSpeed do i.checked = false
	case of
	(
		(timeConfiguration.playbackSpeed == 1):(valuePlaySpeed = "-1/4x-";menuSetSpeed.menuSet14Speed.checked =true)
		(timeConfiguration.playbackSpeed == 2):(valuePlaySpeed = "-1/2x-";menuSetSpeed.menuSet12Speed.checked =true)
		(timeConfiguration.playbackSpeed == 3):(valuePlaySpeed = "- 1x -";menuSetSpeed.menuSet1Speed.checked =true)
		(timeConfiguration.playbackSpeed == 4):(valuePlaySpeed = "- 2x -";menuSetSpeed.menuSet2Speed.checked =true)
		(timeConfiguration.playbackSpeed == 5):(valuePlaySpeed = "- 4x -";menuSetSpeed.menuSet4Speed.checked =true)
	)
	rolBsKeyTools.btnSetSpeed.text = valuePlaySpeed
	menuSetSpeed.menuCurrentSpeed.text = "å½“å‰: " + valuePlaySpeed
)

fn fnSetSpeed numSpeed =
(
	timeConfiguration.playbackSpeed = numSpeed
	fnRefPlaySpeedValue ()
)

rollout rolCustomFps ""
(
	edittext edtFpsValue "FPS: "  pos:[10,10] width:60 usePercentageWidth:true \
	percentageWidth:44.0 labelOnTop:false text:"60" bold:true readOnly:false --å¸§ç‡æ•°å€¼
	button btnSetFps "Set" pos:[80,8]
	label labTips strCurrentFps

	on rolCustomFps open do 
	(
		edtFpsValue.text = framerate as string
		labTips.text = "å½“å‰:" + framerate as string + "FPS"
		valueFps = framerate as integer
	)

	on edtFpsValue entered val do 
	(
		if ((val != ".") and (val as integer != undefined) and (val != "") and (val as integer >= 0)) then
		(
			valueFps = (val as integer)
		)
		else messagebox "---------------------------\r\nè¯·è¾“å…¥æ­£ç¡®å¸§ç‡æ•°å€¼\r\n"
	)
	on btnSetFps pressed do 
	(
		framerate = valueFps
		labTips.text = "å½“å‰:" + framerate as string + "FPS"
		fnBsRefFps ()
		slidertime -= 1
		slidertime += 1
	)
)

rcmenu menuSetFps
(
	menuItem menuCurrentFps "" enabled:false
	menuItem menuSet60Fps "- 60Fps -"
	menuItem menuSet30Fps "- 30Fps -"
	menuItem menuSet24Fps "- 24Fps -"
	separator menuSepCustom
	menuItem menuCustomFps "è‡ªå®šä¹‰å¸§ç‡"

	on menuSetFps open do (fnBsRefFps ())

	on menuSet60Fps picked do (fnSetFps 60)
	on menuSet30Fps picked do(fnSetFps 30)
	on menuSet24Fps picked do (fnSetFps 24)

	on menuCustomFps picked do
	(
		try (destroyDialog rolCustomFps) catch()
		createdialog rolCustomFps 120 55 fgcolor:myFgColor \
		pos:[mouse.screenpos.x,mouse.screenpos.y]
	)
)

rcmenu menuSetSpeed
(
	menuItem menuCurrentSpeed "" enabled:false
	menuItem menuSet14Speed "-1/4x-"
	menuItem menuSet12Speed "-1/2x-"
	separator menuSepSpeedLow
	menuItem menuSet1Speed "- 1x -"
	separator menuSepSpeedHigh
	menuItem menuSet2Speed "- 2x -"
	menuItem menuSet4Speed "- 4x -"

	on menuSetSpeed open do (fnRefPlaySpeedValue ())

	on menuSet14Speed picked do (fnSetSpeed 1)
	on menuSet12Speed picked do(fnSetSpeed 2)
	on menuSet1Speed picked do (fnSetSpeed 3)
	on menuSet2Speed picked do (fnSetSpeed 4)
	on menuSet4Speed picked do (fnSetSpeed 5)
)
------------------å¸§ç‡,æ’­æ”¾é€Ÿåº¦------------------------------------------------------------
rollout rolAddMyScripts "æˆ‘çš„è„šæœ¬" width:300 height:220
(
	local btnMSWidth = 200

	label lblRename "â†“ è¯·è¾“å…¥å‘½å â†“" pos:[20,5]
	label lblReDir "æŒ‡å®šè·¯å¾„" pos:[210,5]
	label lblClearOneMs "æ¸…é™¤" pos:[265,5]
	edittext edtRenameMs1 "1"  pos:[5,25] width:btnMSWidth height:20 text:""
	edittext edtRenameMs2 "2"  pos:[5,45] width:btnMSWidth height:20 text:""
	edittext edtRenameMs3 "3"  pos:[5,65] width:btnMSWidth height:20 text:""
	edittext edtRenameMs4 "4"  pos:[5,85] width:btnMSWidth height:20 text:""
	edittext edtRenameMs5 "5"  pos:[5,105] width:btnMSWidth height:20 text:""
	edittext edtRenameMs6 "6"  pos:[5,125] width:btnMSWidth height:20 text:""
	edittext edtRenameMs7 "7"  pos:[5,145] width:btnMSWidth height:20 text:""
	edittext edtRenameMs8 "8"  pos:[5,165] width:btnMSWidth height:20 text:""
	button btnReAddMs1 "..."  pos:[btnMSWidth + 10,25] width:50 height:20 border:true
	button btnReAddMs2 "..."  pos:[btnMSWidth + 10,45] width:50 height:20 border:true
	button btnReAddMs3 "..."  pos:[btnMSWidth + 10,65] width:50 height:20 border:true
	button btnReAddMs4 "..."  pos:[btnMSWidth + 10,85] width:50 height:20 border:true
	button btnReAddMs5 "..."  pos:[btnMSWidth + 10,105] width:50 height:20 border:true
	button btnReAddMs6 "..."  pos:[btnMSWidth + 10,125] width:50 height:20 border:true
	button btnReAddMs7 "..."  pos:[btnMSWidth + 10,145] width:50 height:20 border:true
	button btnReAddMs8 "..."  pos:[btnMSWidth + 10,165] width:50 height:20 border:true
	button btnClearMs1 "X" pos:[btnMSWidth + 65,25]  width:30 height:20 border:true
	button btnClearMs2 "X" pos:[btnMSWidth + 65,45]  width:30 height:20 border:true
	button btnClearMs3 "X" pos:[btnMSWidth + 65,65]  width:30 height:20 border:true
	button btnClearMs4 "X" pos:[btnMSWidth + 65,85]  width:30 height:20 border:true
	button btnClearMs5 "X" pos:[btnMSWidth + 65,105]  width:30 height:20 border:true
	button btnClearMs6 "X" pos:[btnMSWidth + 65,125]  width:30 height:20 border:true
	button btnClearMs7 "X" pos:[btnMSWidth + 65,145]  width:30 height:20 border:true
	button btnClearMs8 "X" pos:[btnMSWidth + 65,165]  width:30 height:20 border:true
	button btnClearMyScripts "! æ¸…é™¤æ‰€æœ‰è„šæœ¬å¼•ç”¨ !" pos:[15,190] width:160 height:25 border:true
	button btnDoit "! æ³¨æ„ç¡®è®¤ !" pos:[175,190] width:120 height:25 border:true

	fn fnRefreshBtnReAddMs btnMsName btnMsDir edtRenameMs id =
	(
		dirScript = getOpenFileName caption:"è¯·é€‰æ‹©æ·»åŠ çš„Maxè„šæœ¬:" historyCategory:"myScripts" \
		types:"maxscript(*.ms,*.mse)|*.ms*|All(*.*)|*.*" filename:(getDir #scripts + @"\") 
		if (dirScript != undefined) then
		(
			nameMyScript = getFilenameFile dirScript
			btnMsName.text = nameMyScript
			btnMsDir.text = "å·²ä¿®æ”¹"
			if iniArrMyScripts[id] != undefined then iniArrMyScripts[id].dir = dirScript
			else (append iniArrMyScripts (myScript id edtRenameMs.text dirScript))
		)
		-- print dirScript
	)

	fn fnAddMsName id edtRenameMs =
	(
		if (iniArrMyScripts[id] != undefined) then
		(
			if edtRenameMs.text != "" then iniArrMyScripts[id].msName = edtRenameMs.text
			else iniArrMyScripts[id].msName = "<ï¼‹ï¼‹>"
		)
	)

	fn fnRefreshMyScriptsUI =
	(
		local tempArrBtn = #(rolAddMyScripts.edtRenameMs1, \
		rolAddMyScripts.edtRenameMs2, \
		rolAddMyScripts.edtRenameMs3, \
		rolAddMyScripts.edtRenameMs4, \
		rolAddMyScripts.edtRenameMs5, \
		rolAddMyScripts.edtRenameMs6, \
		rolAddMyScripts.edtRenameMs7, \
		rolAddMyScripts.edtRenameMs8)

		for b = 1 to tempArrBtn.count do
		(
			if iniArrMyScripts[b] != undefined then
			(
				if iniArrMyScripts[b].msName != undefined then 
				(
					tempArrBtn[b].text = iniArrMyScripts[b].msName 
				)
				else tempArrBtn[b].text = ""
			)
		)
	)

	fn fnClearOneMs id =
	(
		iniArrMyScripts[id].msName = "<ï¼‹ï¼‹>"
		iniArrMyScripts[id].dir = ""
		execute ("rolAddMyScripts.edtRenameMs" + (id as string) + ".text = \"<ï¼‹ï¼‹>\"")
		execute ("rolBsKeyTools.btnMyScripts" + (id as string) + ".tooltip = \"<ï¼‹ï¼‹>\"")
	)

	fn fnClearMyScripts = --æ¸…é™¤è„šæœ¬
	(
		--è®¾ç½®dotNetçª—å£å…ƒç´ 
		local mb = dotNetClass "System.Windows.Forms.MessageBox"
		local buttons = dotNetClass "System.Windows.Forms.MessageBoxButtons"
		local icons = dotNetClass "System.Windows.Forms.MessageBoxIcon"
		local defaultButton = dotNetClass "System.Windows.Forms.MessageBoxDefaultButton"
		local dialogResult = dotNetClass "System.Windows.Forms.DialogResult"

		local result = mb.show "ç¡®å®šæ¸…é™¤æ‰€æœ‰å¼•ç”¨çš„è„šæœ¬æŒ‰é’®å— ?" "è‡ªå®šè„šæœ¬ä¸€é”®æ¸…é™¤" buttons.YesNoCancel icons.Information defaultButton.Button3

		--é€‰é¡¹æŒ‰é’®
		if ( result == dialogResult.Yes ) then
		(
			iniArrMyScripts = #((myScript id:1 msName:"<ï¼‹ï¼‹>" dir:""), \
			(myScript id:2 msName:"<ï¼‹ï¼‹>" dir:""), \
			(myScript id:3 msName:"<ï¼‹ï¼‹>" dir:""), \
			(myScript id:4 msName:"<ï¼‹ï¼‹>" dir:""), \
			(myScript id:5 msName:"<ï¼‹ï¼‹>" dir:""), \
			(myScript id:6 msName:"<ï¼‹ï¼‹>" dir:""), \
			(myScript id:7 msName:"<ï¼‹ï¼‹>" dir:""), \
			(myScript id:8 msName:"<ï¼‹ï¼‹>" dir:""))
			local arrMyScriptTemp = #(rolBsKeyTools.btnMyScripts1, \
			rolBsKeyTools.btnMyScripts2, \
			rolBsKeyTools.btnMyScripts3, \
			rolBsKeyTools.btnMyScripts4, \
			rolBsKeyTools.btnMyScripts5, \
			rolBsKeyTools.btnMyScripts6, \
			rolBsKeyTools.btnMyScripts7, \
			rolBsKeyTools.btnMyScripts8)
			local arrBtnTemp = #(rolAddMyScripts.edtRenameMs1, \
			rolAddMyScripts.edtRenameMs2, \
			rolAddMyScripts.edtRenameMs3, \
			rolAddMyScripts.edtRenameMs4, \
			rolAddMyScripts.edtRenameMs5, \
			rolAddMyScripts.edtRenameMs6, \
			rolAddMyScripts.edtRenameMs7, \
			rolAddMyScripts.edtRenameMs8)
			for b = 1 to arrMyScriptTemp.count do 
			(
				arrMyScriptTemp[b].text = "<ï¼‹ï¼‹>"
				arrMyScriptTemp[b].tooltip = "<ï¼‹ï¼‹>"
			)
			for b = 1 to arrBtnTemp.count do 
			(
				arrBtnTemp[b].text = "<ï¼‹ï¼‹>"
			)
		)
		else if ( result == dialogResult.No ) then
		(
			format "NO\n"
		)
		else if ( result == dialogResult.Cancel ) then
		(
			format "CANCEL\n"
		)
	)

	fn fnApplyMyMs =
	(
		fnAddMsName 1 edtRenameMs1
		fnAddMsName 2 edtRenameMs2
		fnAddMsName 3 edtRenameMs3
		fnAddMsName 4 edtRenameMs4
		fnAddMsName 5 edtRenameMs5
		fnAddMsName 6 edtRenameMs6
		fnAddMsName 7 edtRenameMs7
		fnAddMsName 8 edtRenameMs8

		arrMyScriptTemp = #(rolBsKeyTools.btnMyScripts1, \
		rolBsKeyTools.btnMyScripts2, \
		rolBsKeyTools.btnMyScripts3, \
		rolBsKeyTools.btnMyScripts4, \
		rolBsKeyTools.btnMyScripts5, \
		rolBsKeyTools.btnMyScripts6, \
		rolBsKeyTools.btnMyScripts7, \
		rolBsKeyTools.btnMyScripts8)
		for b = 1 to arrMyScriptTemp.count do 
		(
			if iniArrMyScripts[b] != undefined then
			(
				if (iniArrMyScripts[b].msName != undefined) then 
				(
					arrMyScriptTemp[b].text = iniArrMyScripts[b].msName
				)
			)
		)
		try(destroydialog rolAddMyScripts)catch()
		stSetConfigAll.fnSetConfigBsKeyTools ()
	)

	on rolAddMyScripts open do 
	(
		fnRefreshMyScriptsUI ()
	)

	on btnReAddMs1 pressed do 
	(
		fnRefreshBtnReAddMs edtRenameMs1 btnReAddMs1 edtRenameMs1 1
	)

	on btnReAddMs2 pressed do 
	(
		fnRefreshBtnReAddMs edtRenameMs2 btnReAddMs2 edtRenameMs2 2
	)

	on btnReAddMs3 pressed do 
	(
		fnRefreshBtnReAddMs edtRenameMs3 btnReAddMs3 edtRenameMs3 3
	)
	on btnReAddMs4 pressed do 
	(
		fnRefreshBtnReAddMs edtRenameMs4 btnReAddMs4 edtRenameMs4 4
	)
	on btnReAddMs5 pressed do 
	(
		fnRefreshBtnReAddMs edtRenameMs5 btnReAddMs5 edtRenameMs5 5
	)
	on btnReAddMs6 pressed do 
	(
		fnRefreshBtnReAddMs edtRenameMs6 btnReAddMs6 edtRenameMs6 6
	)
	on btnReAddMs7 pressed do 
	(
		fnRefreshBtnReAddMs edtRenameMs7 btnReAddMs7 edtRenameMs7 7
	)
	on btnReAddMs8 pressed do 
	(
		fnRefreshBtnReAddMs edtRenameMs8 btnReAddMs8 edtRenameMs8 8
	)

	on edtRenameMs1 changed txt do 
	(
		tempText = substituteString txt "\n" ""
		edtRenameMs1.text = tempText
	)

	on edtRenameMs2 changed txt do 
	(
		tempText = substituteString txt "\n" ""
		edtRenameMs2.text = tempText
	)

	on edtRenameMs3 changed txt do 
	(
		tempText = substituteString txt "\n" ""
		edtRenameMs3.text = tempText
	)
	on edtRenameMs4 changed txt do 
	(
		tempText = substituteString txt "\n" ""
		edtRenameMs4.text = tempText
	)
	on edtRenameMs5 changed txt do 
	(
		tempText = substituteString txt "\n" ""
		edtRenameMs5.text = tempText
	)
	on edtRenameMs6 changed txt do 
	(
		tempText = substituteString txt "\n" ""
		edtRenameMs6.text = tempText
	)
	on edtRenameMs7 changed txt do 
	(
		tempText = substituteString txt "\n" ""
		edtRenameMs7.text = tempText
	)
	on edtRenameMs8 changed txt do 
	(
		tempText = substituteString txt "\n" ""
		edtRenameMs8.text = tempText
	)

	on btnClearMs1 pressed do (fnClearOneMs 1)
	on btnClearMs2 pressed do (fnClearOneMs 2)
	on btnClearMs3 pressed do (fnClearOneMs 3)
	on btnClearMs4 pressed do (fnClearOneMs 4)
	on btnClearMs5 pressed do (fnClearOneMs 5)
	on btnClearMs6 pressed do (fnClearOneMs 6)
	on btnClearMs7 pressed do (fnClearOneMs 7)
	on btnClearMs8 pressed do (fnClearOneMs 8)

	on btnDoit pressed do(fnApplyMyMs())

	on rolAddMyScripts close do (fnApplyMyMs())

	on btnClearMyScripts pressed do (fnClearMyScripts())
)
---------------------æ»‘åŠ¨å¸§åˆ‡æ¢rollout---------------------------------
rollout rolFnKeys "æ»‘åŠ¨å¸§åˆ‡æ¢ v1.1" width:280 height:120
(
	group ""
	(
		checkbox chkLHand "å·¦æ‰‹" pos:[24,20] width:50 height:20 color:Blue
		checkbox chkRHand "å³æ‰‹" pos:[96,20] width:50 height:20 color:Green
		checkbox chkLFoot "å·¦è„š" pos:[24,55] width:50 height:20 color:Blue checked:true
		checkbox chkRFoot "å³è„š" pos:[96,55] width:50 height:20 color:Green checked:true
		button btnPlanted "å›ºå®šå…³é”®å¸§" pos:[184,20] width:80 height:25 toolTip:"Set Planted Key"
		button btnSliding "æ»‘åŠ¨å…³é”®å¸§" pos:[184,50] width:80 height:25 toolTip:"Set Sliding Key"
		button btnFree "è‡ªç”±å…³é”®å¸§" pos:[184,80] width:80 height:25 toolTip:"Set Free Key"
		label lblMe "[2019.05.28]  Bullet.S" pos:[24,92] width:120 height:16 color:Green
	)
	
	Fn fnSetKeyType keyType = 
	(
		sliderTime = animationRange.start
		for obj in selection where ((classof obj.baseObject == Biped_Object) \
		and (biped.getCurrentLayer obj.controller == 0)) do
		(
			bipCtrl = obj.controller
			if chkLHand.checked then 
			(
				sel_obj1 = (biped.getNode bipCtrl #larm)
				k = numKeys sel_obj1.controller
					for i=1 to k do
					(
					t = (biped.getkey sel_obj1.controller i).time
						slidertime = t
						with animate on --at time t		
						(
							case of
							(
								(keyType == 1):(biped.SetPlantedKey sel_obj1)
								(keyType == 2):(biped.SetSlidingKey sel_obj1)
								(keyType == 3):(biped.SetFreeKey sel_obj1)
							)
						)
					)
			)
			if chkRHand.checked then 
			(
				sel_obj2 = (biped.getNode bipCtrl #rarm)
				k = numKeys sel_obj2.controller
					for i=1 to k do
					(
					t = (biped.getkey sel_obj2.controller i).time
						slidertime = t
						with animate on --at time t		
						(
							case of
							(
								(keyType == 1):(biped.SetPlantedKey sel_obj2)
								(keyType == 2):(biped.SetSlidingKey sel_obj2)
								(keyType == 3):(biped.SetFreeKey sel_obj2)
							)
						)
					)
			)
			if chkLFoot.checked then 
			(
				sel_obj3 = (biped.getNode bipCtrl #lleg)
				k = numKeys sel_obj3.controller
					for i=1 to k do
					(
					t = (biped.getkey sel_obj3.controller i).time
						slidertime = t
						with animate on --at time t		
						(
							case of
							(
								(keyType == 1):(biped.SetPlantedKey sel_obj3)
								(keyType == 2):(biped.SetSlidingKey sel_obj3)
								(keyType == 3):(biped.SetFreeKey sel_obj3)
							)
						)
					)
			)
			if chkRFoot.checked then 
			(
				sel_obj4 = (biped.getNode bipCtrl #rleg)
				k = numKeys sel_obj4.controller
					for i=1 to k do
					(
					t = (biped.getkey sel_obj4.controller i).time
						slidertime = t
						with animate on --at time t		
						(
							case of
							(
								(keyType == 1):(biped.SetPlantedKey sel_obj4)
								(keyType == 2):(biped.SetSlidingKey sel_obj4)
								(keyType == 3):(biped.SetFreeKey sel_obj4)
							)
						)
					)
			)
		)
	)
	
	on btnPlanted pressed  do
	(
		fnSetKeyType 1
	)
	
	on btnSliding pressed  do
	(
		fnSetKeyType 2
	)
	
	on btnFree pressed  do
	(
		fnSetKeyType 3
	)
)
-----------------------------------------------------------------
-------------ä¸»UI-----------------------------------------------------------------
rollout rolBsKeyTools "" width:220 height:300
(
	local strMainRol = ("BsKeyTools_v" + curVerBsKeyTools)
	---------------------------------UI--------------------------------------
	groupbox gbxMainUI strMainRol pos:[5,5] width:210 height:217
	
		-- label lblRangeStartText "èµ·å§‹å¸§" pos:[15,21] width:80 height:20
		-- label lblRangeEndText "ç»“æŸå¸§" pos:[65,21] width:80 height:20
		spinner spiStartTime "" pos:[10,21] width:60 height:20 type:#integer \
		range:[-999999999,999999999,animationrange.start] scale:1
		spinner spiEndTime "" pos:[70,21] width:60 height:20 type:#integer \
		range:[-999999999,999999999,animationrange.end] scale:1

		button btnMagicBtn "" pos:[130,20] width:80 height:18  \
		tooltip:"ç‚¹æˆ‘ç‚¹æˆ‘ç‚¹æˆ‘~è‰¯å¿ƒå°å·¥å…·" border:false
		button btnHideUnSel "ç‹¬æ˜¾" pos:[10,40]width:40 height:30 \
		toolTip:"éšè—å½“å‰æ˜¾ç¤ºçš„æœªé€‰ä¸­ç‰©ä½“ï¼Œå³é”®å¯é‡æ–°æ˜¾ç¤º"  
		checkbutton btnJudgeLinkKey "Link?" highlightcolor:myCheckedColor \
		pos:[50,40] tooltip:"é€‰æ‹©å¸§å‰ç¡®è®¤æ˜¯å¦å­˜åœ¨ Link å¸§?" width:40 height:30 checked:false
		button btnSelBeforeKeys "" \
		pos:[90,40] width:40 height:30 toolTip:"é€‰æ‹©æ»‘æ¡å‰é¢å…³é”®å¸§"  
		button btnSelAllKeys "" \
		pos:[130,40] width:40 height:30 toolTip:"é€‰æ‹©æ‰€æœ‰å…³é”®å¸§"  
		button btnSelAfterKeys "" \
		pos:[170,40] width:40 height:30 toolTip:"é€‰æ‹©æ»‘æ¡åé¢å…³é”®å¸§"
		edittext edtMoveKey "" width:53 usePercentageWidth:true percentageWidth:44.0 \ 
		pos:[6,72] labelOnTop:false text:"5f" bold:true readOnly:false height:17
		button btnSet5 "Â±5f" width:35 pos:[60,70] height:20 \
		toolTip:"æ¢å¤é»˜è®¤ç§»åŠ¨å¸§æ•°\r\nå·¦å‡»ï¼š5f\r\nå³å‡»ï¼š-5f"
		button btnSetAdd "å·¦+å³-" width:65 pos:[95,70] height:20 \
		toolTip:"ç§»åŠ¨å¸§æ•°è®¾ç½®å¢å‡ 5 å¸§\r\nå·¦å‡»å¢åŠ ï¼›å³å‡»å‡å°‘"
		-- button btnSetOpposite "è´Ÿ" width:30 pos:[160,85] height:20
		button btnMoveKeys "ç§»åŠ¨å¸§" width:50 height:20 \
		pos:[160,70] toolTip:"ç§»åŠ¨å…³é”®å¸§ï¼Œå…ˆå·¦è¾¹è®¾å®šå¸§æ•°\r\nå·¦å‡»ï¼šå¸§æ èŒƒå›´ä¿æŒä¸å˜~\r\nå³å‡»ï¼šå¸§æ èŒƒå›´åŒæ­¥å¢å‡~"  

		button btnCutFrameDisplay "é€‰å®šå¸§" pos:[10,90] width:50 height:25 \
		tooltip:"é¢„è§ˆé€‰æ‹©å¸§\r\nå†ç‚¹å›åˆ°ä¸Šæ¬¡å¸§èŒƒå›´"
		button btnAllFrameDisplay "é¦–å°¾å¸§" pos:[60,90] width:50 height:25 \
		tooltip:"é¢„è§ˆå…¨éƒ¨å¸§\r\nå†ç‚¹å›åˆ°ä¸Šæ¬¡å¸§èŒƒå›´"
		-- button btnZeroFrameDisplay "é›¶å¸§" pos:[100,40] width:30 height:20 \
		-- tooltip:"é¦–å¸§å›åˆ°0å¸§"
		checkbutton ckbShadowCut "ç§€å‰ªå½±" highlightcolor:myCheckedColor \
		pos:[110,90] width:50 height:25 toolTip:"åˆ‡æ¢å‰ªå½±æ˜¾ç¤º"
		button btnQuicksave "å¿«å¤‡ä»½" pos:[160,90] width:50 height:25 \
		tooltip:"å¿«é€Ÿå¤‡ä»½å½“å‰æ–‡ä»¶"
		checkbutton ckbFnBoxDisplay "BOXæ˜¾"  highlightcolor:myCheckedColor \
		width:50 height:25 toolTip:"éª¨éª¼åˆ‡æ¢Boxæ˜¾ç¤º" pos:[10,115]
		checkbutton ckbFreezeMesh "å†»æ¨¡å‹" highlightcolor:myCheckedColor \
		toolTip:"å†»ç»“è§£å†»æ¨¡å‹" width:50 height:25 pos:[60,115]
		checkbutton ckbHideBones "éšBone" highlightcolor:myCheckedColor \
		width:50 height:25 toolTip:"æ˜¾ç¤ºéšè— bone\r\næ‰€åœ¨å±‚è‹¥éšè—åˆ™ä¸ä¼šæ˜¾ç¤º" pos:[110,115]
		checkbutton ckbHideBiped "éšBip" width:50 height:25 highlightcolor:myCheckedColor \
		toolTip:"æ˜¾ç¤ºéšè— Bip\r\næ‰€åœ¨å±‚è‹¥éšè—åˆ™ä¸ä¼šæ˜¾ç¤º" pos:[160,115]
		button btnImageComp "æ„å›¾æ¡†" pos:[10,140] width:50 height:25 \
		tooltip:"å„ç§ç»å…¸åˆ†å‰²è§†å›¾ä»¥è¾…åŠ©æ„å›¾"
		button btnTrajedit "è½¨è¿¹çº¿" pos:[60,140] width:50 height:25 \
		tooltip:"åŠ¨ç”»è½¨è¿¹å·¥å…·ä¸ªäººä¼˜åŒ–ç‰ˆ"
		button btnFileOpen "æ—¶å…‰æœº" pos:[110,140] width:50 height:25 \
		tooltip:"å¿«é€Ÿæ‰“å¼€maxæ–‡ä»¶\r\nå¯æ”¶è—å¸¸ç”¨ç›®å½•"
		button btnLightTable "æ´‹è‘±çš®" pos:[160,140] width:50 height:25 \
		toolTip:"æ˜¾ç¤ºè¿åŠ¨é‡å½± (ä¿®æ”¹è‡ªSan_oOo)"
		checkButton ckbPlayBlocking "è·³å¸§æ’­" pos:[10,165] width:50 height:25 
		highlightcolor:myCheckedColor tooltip:"ç‚¹å‡»é¢„è§ˆå…³é”®å¸§ Blocking åŠ¨ç”»\r\nè‹¥æœ‰ Link å¸§éœ€è¦æŒ‰ä¸‹ä¸Šé¢æŒ‰é’®" checked:false
		timer clock "PlayClock" interval:1 active:false
		button btnSpringMagic "é£˜å¸¦è§£" pos:[60,165] width:50 height:25 \
		tooltip:"å·¦ç‚¹æ–°ç‰ˆ,å³ç‚¹æ—§ç‰ˆ" 
		button btnCSTools "CSé€‰æ‹©" pos:[110,165] width:50 height:25 \
		toolTip:"å¿«é€Ÿé€‰æ‹©CSéª¨éª¼å’Œè°ƒBipedç­‰" 
		button btnAnimCopyPaste "æš´åŠ›è´´"  pos:[160,165] width:50 height:25 \
		toolTip:"åŠ¨ç”»æš´åŠ›ç²˜è´´ä¸œè§äº‘ä¼˜åŒ–ç‰ˆ\r\n(æœ‰æ—¶é—´æˆ‘ä¹Ÿä¼šä¼˜åŒ–æˆ–æ–°å†™)" 
		button btnLayerManager "å±‚" pos:[10,190] width:20 height:25 \
		toolTip:"æ¨¡æ‹Ÿæ—§ç‰ˆå±‚ç®¡ç†å™¨" 
		button btnSelectionsetTools "é›†" pos:[30,190] width:20 height:25 \
		toolTip:"é€‰æ‹©é›†å·¥å…·å¢å¼ºç‰ˆ" 
		button btnPoseTool "åº“" pos:[50,190] width:20 height:25 \
		toolTip:"å‚è€ƒåº“å·¥å…·,å¾…å®Œå–„"
		button btnTrackBarTools "å¸§æ " pos:[70,190] width:40 height:25 \
		toolTip:"å¸§æ å·¥å…·æ¡" enabled:false
		button btnSetFps "" pos:[110,190] width:50 height:25 \
		toolTip:"è®¾ç½®å¸§ç‡" 
		button btnSetSpeed "" pos:[160,190] width:50 height:25 \
		toolTip:"è®¾ç½®æ’­æ”¾é€Ÿåº¦" 
	
	groupbox gbxMinTools "" pos:[220,5] width:130 height:240
	
		checkbutton ckbC1 "" width:30 height:29 highlightcolor:myCheckedColor \
		pos:[225,15] toolTip:"" border:false
		checkbutton ckbC2 "" width:30 height:29 highlightcolor:myCheckedColor \
		pos:[255,15] toolTip:"" border:false
		checkbutton ckbC3 "" width:30 height:29 highlightcolor:myCheckedColor \
		pos:[285,15] toolTip:"" border:false
		checkbutton ckbC4 "" width:30 height:29 highlightcolor:myCheckedColor \
		pos:[315,15] toolTip:"" border:false

		local btnHeight = 32
		local btnWidth = 60
		local btnPos = [999999,999999]
		button btnColorTools "é¢œè‰²æ¸å˜" width:btnWidth height:btnHeight visible:false \
		tooltip:"åš Demo ç´ æ¨¡æˆ–ç‰¹æ•ˆæ–¹ä¾¿~" pos:btnPos
		checkbutton ckbIsoMesh "æ¨¡å‹ç‹¬æ˜¾" width:btnWidth height:btnHeight visible:false \
		toolTip:"å•ç‹¬æ˜¾ç¤ºæ¨¡å‹é¢„è§ˆ" pos:btnPos highlightcolor:myCheckedColor 
		button btnBipedTraj "Bipedè½¨è¿¹" width:btnWidth height:btnHeight visible:false \
		toolTip:"å·¦ï¼šåˆ‡æ¢æ˜¾ç¤ºå•ä¸ªBipedè½¨è¿¹,\r\nå³ï¼šæ¸…é™¤æ·»åŠ çš„æ‰€æœ‰Bipedè½¨è¿¹~" pos:btnPos
		button btnFnFrame "æ•´å°æ•°å¸§" width:btnWidth height:btnHeight visible:false \
		tooltip:"æ•´æ•°å°æ•°å¸§åˆ‡æ¢,\r\nå¹³æ»‘æ‹–å¸§çœ‹å¡é¡¿" pos:btnPos
		button btnSelByColor "åŒè‰²é€‰æ‹©" width:btnWidth height:btnHeight visible:false \
		tooltip:"é€‰æ‹©åŒé¢œè‰²ç‰©ä½“" pos:btnPos
		button btnFnTCB "TCB/æ¬§æ‹‰" width:btnWidth height:btnHeight visible:false \
		tooltip:"æ¬§æ‹‰å’ŒTCBäº’è½¬" pos:btnPos
		button btnEulerFilter "æ¬§æ‹‰è¿‡æ»¤" width:btnWidth height:btnHeight visible:false \
		tooltip:"Boneéª¨éª¼è¿‡æ»¤æ¬§æ‹‰æ—‹è½¬" pos:btnPos
		button btnDelOutKeys "æ¸…æ‰€æœ‰å¸§" width:btnWidth height:btnHeight visible:false \
		toolTip:"æ¸…é™¤æ‰€æœ‰å¸§\r\nLinkå¸§è¯·æ‰‹åŠ¨åˆ " pos:btnPos
		button btnCleanOutKeys "æ¸…æ— é™å¸§" width:btnWidth height:btnHeight visible:false \
		toolTip:"æ¸…èŒƒå›´å¤–å¸§(æ— é™å¸§)" pos:btnPos
		button btnSelBiped "é€‰ Biped" width:btnWidth height:btnHeight visible:false \
		toolTip:"é€‰æ‹©æ‰€æœ‰biped" pos:btnPos
		button btnSelBone "é€‰ Bone" width:btnWidth height:btnHeight  visible:false \
		toolTip:"é€‰æ‹©æ‰€æœ‰bone" pos:btnPos
		button btnEndBone "å¢åˆ æœ«ç«¯" width:btnWidth height:btnHeight visible:false \
		toolTip:"æ·»åŠ é€‰æ‹©çš„Boneæœ«ç«¯ï¼Œå¯å›é€€\r\nå³é”®æ¸…é™¤ï¼ˆæ³¨æ„ \"tempBoneEndAll\" å±‚ï¼‰" pos:btnPos
		button btnQuickPrev "å¿«é€Ÿæ‹å±" width:btnWidth height:btnHeight visible:false \
		toolTip:"å·¦ï¼šå¿«é€Ÿæ‹å±é¢„è§ˆ\r\nå³ï¼šæ‰“å¼€é¢„è§ˆæ–‡ä»¶å¤¹" pos:btnPos
		button btnFastAlign "å¿«é€Ÿå¯¹é½" width:btnWidth height:btnHeight visible:false \
		toolTip:"åŠŸèƒ½å¾…æ·»åŠ " pos:btnPos
		button btnFnKeyType "æ”¹æ»‘åŠ¨å¸§" width:btnWidth height:btnHeight visible:false \
		toolTip:"æ‰¹é‡è½¬æ¢æ»‘åŠ¨å…³é”®å¸§ç­‰,\r\nåç»­å¯èƒ½æŒ‰éœ€ä¼˜åŒ–æ›´å¤šè®¾ç½®" pos:btnPos
		button btnRenameTools "æ”¹åå·¥å…·" width:btnWidth height:btnHeight visible:false \
		toolTip:"è¶…çº§é‡å‘½åå·¥å…·" pos:btnPos
		button btnAnimMirror "åŠ¨ç”»é•œåƒ" width:btnWidth height:btnHeight visible:false \
		toolTip:"ç›®å‰å¼•ç”¨4698toå¤§ä½¬çš„æ’ä»¶\r\nåé¢éšç¼˜æ–°å†™æˆ–ä¼˜åŒ–" pos:btnPos
		checkbutton ckbFnMtlDisplay "ç´ æ¨¡åˆ‡æ¢" width:btnWidth height:btnHeight visible:false \
		toolTip:"å·¦:åˆ‡æ¢æ˜¾ç¤ºéšè—è´´å›¾,æ–¹ä¾¿ç™½æ¨¡é¢„è§ˆ\r\nå³:Clayæ˜¾ç¤ºå¼€å…³(çº¢è‰²æ¨¡å‹æ˜¾ç¤º)\r\næš‚ä¸æ”¯æŒå­æè´¨å’ŒVrayæè´¨..."
		pos:btnPos highlightcolor:myCheckedColor 
		button btnMopherSlider "è¡¨æƒ…æ»‘æ¡" width:btnWidth height:btnHeight visible:false \
		toolTip:"é€‰æ‹©å¸¦morpherçš„meshï¼Œ\r\næ‰“å¼€å¿«é€Ÿè°ƒèŠ‚æ»‘æ¡æ–¹ä¾¿Kè¡¨æƒ…~" pos:btnPos
		button btnBipedScale "CSç¼©æ”¾" width:btnWidth height:btnHeight visible:false \
		toolTip:"æ•ˆæœå±•ç¤ºå¯ç”¨ï¼Œå¯¼å…¥å¼•æ“åˆ«ç”¨\r\nå†æ¬¡ç‚¹å‡»å¯è§£é™¤" pos:btnPos
		button btnBatchExport "æ‰¹é‡å¯¼å‡º" width:btnWidth height:btnHeight visible:false \
		toolTip:"æ‰¹é‡å¯¼å‡º" pos:btnPos
		button btnCameraFromView "è§†è§’ç›¸æœº" width:btnWidth height:btnHeight visible:false \
		toolTip:"æ ¹æ®è‡ªç”±è§†è§’åˆ›å»ºç›¸æœº" pos:btnPos
		button btnMeshToBone "ç¢å—åŠ éª¨" width:btnWidth height:btnHeight visible:false \
		toolTip:"ç ´ç¢ç¢å—å¿«é€ŸåŠ éª¨éª¼" pos:btnPos
		button btnWinbox "çª—å£æ‰¾å›" width:btnWidth height:btnHeight visible:false \
		toolTip:"æ–¹ä¾¿æ‰¾å›æ›²çº¿ç¼–è¾‘å™¨ç­‰çª—å£(å¤šå±å¯¼è‡´çª—å£ä¸¢å¤±)" pos:btnPos
		button btnHideBipedTwists "éš Twist" width:btnWidth height:btnHeight visible:false \
		toolTip:"éšè—æ‰€æœ‰Bipedè‡ªå¸¦Twistsï¼Œå†ç‚¹æ˜¾ç¤º" pos:btnPos
		button btnDelDecimalKeys "åˆ å°æ•°å¸§" width:btnWidth height:btnHeight visible:false \
		toolTip:"åˆ é™¤æ‰€æœ‰å°æ•°å¸§" pos:btnPos
		button btnRescaleWU "è’™çš®ç¼©æ”¾" width:btnWidth height:btnHeight visible:false \
		toolTip:"å¸¦æœ‰Skinçš„ç¼©æ”¾,å¸¦æ‰¹å¤„ç†\r\n(å³é”®æ‰“å¼€è€ç‰ˆæœ¬)" pos:btnPos
		button btnSkinTools "Skinå·¥å…·" width:btnWidth height:btnHeight visible:false \
		toolTip:"Skinå·¥å…·é›†æˆ (ä¿®æ”¹è‡ªSan_oOo)" pos:btnPos
		button btnKeyStepMode "åˆ‡å¸§è®¾ç½®" width:btnWidth height:btnHeight visible:false pos:btnPos \
		tooltip:"å‰ååˆ‡å…³é”®å¸§è®¾ç½®ï¼Œ\r\nå¯é…åˆåˆ å¸§æˆ–å•è½´ä¿®å¸§"
		button btnDemoTool "Demoå·¥å…·" width:btnWidth height:btnHeight visible:false pos:btnPos \
		toolTip:"[å·²æœ‰æƒ³æ³•å¾…è¡¥å……]\r\næ–¹ä¾¿æ¸²æŸ“ä½œå“å’Œç»ƒä¹ çš„å·¥å…·"
		button btnCutSequence "åŠ¨ç”»åˆ†æ®µ" width:btnWidth height:btnHeight visible:false pos:btnPos \
		toolTip:"ä¸ºé•¿åŠ¨ç”»åˆ†æ®µåŠ¨ä½œåŒºé—´ (ä¿®æ”¹è‡ªSan_oOo)"
		button btnXrSkinTool "è’™çš®è¾…åŠ©" width:btnWidth height:btnHeight visible:false \
		tooltip:"by:ä¸œè§äº‘" pos:btnPos
		button btnRetargetTools "é‡é‡å®šå‘" width:btnWidth height:btnHeight visible:false \
		tooltip:"åŠ¨ç”»é‡å®šå‘å·¥å…·" pos:btnPos
		button btnCombineDetachSkin "Skin æ‹†åˆ" width:btnWidth height:btnHeight visible:false \
		tooltip:"æ‹†åˆ†åˆå¹¶ Mesh å¹¶ä¸”ä¿ç•™ Skin ä¿¡æ¯ï¼Œé€‰ä¸­ Mesh æ‰§è¡Œ" pos:btnPos enabled:false
		button btnTemp4 "å¾…æ·»åŠ 4" width:btnWidth height:btnHeight visible:false \
		tooltip:"å¾…æ·»åŠ " pos:btnPos
		button btnTemp5 "å¾…æ·»åŠ 5" width:btnWidth height:btnHeight visible:false \
		tooltip:"å¾…æ·»åŠ " pos:btnPos
		button btnTemp6 "å¾…æ·»åŠ 6" width:btnWidth height:btnHeight visible:false \
		tooltip:"å¾…æ·»åŠ " pos:btnPos
		button btnTemp7 "å¾…æ·»åŠ 7" width:btnWidth height:btnHeight visible:false \
		tooltip:"å¾…æ·»åŠ " pos:btnPos
		button btnTemp8 "å¾…æ·»åŠ 8" width:btnWidth height:btnHeight visible:false \
		tooltip:"å¾…æ·»åŠ " pos:btnPos
		button btnTemp9 "å¾…æ·»åŠ 9" width:btnWidth height:btnHeight visible:false \
		tooltip:"å¾…æ·»åŠ " pos:btnPos
		button btnTemp10 "å¾…æ·»åŠ 10" width:btnWidth height:btnHeight visible:false \
		tooltip:"å¾…æ·»åŠ " pos:btnPos
		button btnTemp11 "å¾…æ·»åŠ 11" width:btnWidth height:btnHeight visible:false \
		tooltip:"å¾…æ·»åŠ " pos:btnPos
		button btnTemp12 "å¾…æ·»åŠ 12" width:btnWidth height:btnHeight visible:false \
		tooltip:"å¾…æ·»åŠ " pos:btnPos
		button btnTemp13 "å¾…æ·»åŠ 13" width:btnWidth height:btnHeight visible:false \
		tooltip:"å¾…æ·»åŠ " pos:btnPos
		button btnTemp14 "å¾…æ·»åŠ 14" width:btnWidth height:btnHeight visible:false \
		tooltip:"å¾…æ·»åŠ " pos:btnPos
		button btnTemp15 "å¾…æ·»åŠ 15" width:btnWidth height:btnHeight visible:false \
		tooltip:"å¾…æ·»åŠ " pos:btnPos
		button btnTemp16 "å¾…æ·»åŠ 16" width:btnWidth height:btnHeight visible:false \
		tooltip:"å¾…æ·»åŠ " pos:btnPos
		button btnTemp17 "å¾…æ·»åŠ 17" width:btnWidth height:btnHeight visible:false \
		tooltip:"å¾…æ·»åŠ " pos:btnPos

		local btnMsWidth = 77.5
		local btnMsPos = [40.5,250]
		checkbutton ckbSwitchMyScripts "åˆ‡æ¢" pos:[5,250] width:35 height:20
		tooltip:"åˆ‡æ¢è‡ªå®šä¹‰è„šæœ¬æŒ‰é’®" border:true highlightcolor:myCheckedColor 
		button btnMyScripts1 "<ï¼‹ï¼‹>" pos:btnMsPos width:btnMsWidth height:20
		tooltip:iniArrMyScripts[1].msName border:true visible:false
		button btnMyScripts2 "<ï¼‹ï¼‹>" pos:(btnMsPos + [btnMsWidth,0]) width:btnMsWidth height:20
		tooltip:iniArrMyScripts[2].msName border:true visible:false
		button btnMyScripts3 "<ï¼‹ï¼‹>" pos:(btnMsPos + [2 * btnMsWidth,0]) width:btnMsWidth height:20
		tooltip:iniArrMyScripts[3].msName border:true visible:false
		button btnMyScripts4 "<ï¼‹ï¼‹>" pos:(btnMsPos + [3 * btnMsWidth,0]) width:btnMsWidth height:20
		tooltip:iniArrMyScripts[4].msName border:true visible:false
		button btnMyScripts5 "<ï¼‹ï¼‹>" pos:btnMyScripts1.pos width:btnMsWidth height:20
		tooltip:iniArrMyScripts[5].msName border:true visible:false
		button btnMyScripts6 "<ï¼‹ï¼‹>" pos:btnMyScripts2.pos width:btnMsWidth height:20
		tooltip:iniArrMyScripts[6].msName border:true visible:false
		button btnMyScripts7 "<ï¼‹ï¼‹>" pos:btnMyScripts3.pos width:btnMsWidth height:20
		tooltip:iniArrMyScripts[7].msName border:true visible:false
		button btnMyScripts8 "<ï¼‹ï¼‹>" pos:btnMyScripts4.pos width:btnMsWidth height:20
		tooltip:iniArrMyScripts[8].msName border:true visible:false

	groupbox gbxTips "" pos:[5,215] width:210 height:30
	
		label lblLink "2019.9[miHoYo_Bullet.S]4869" pos:[12,226] width:145 height:15
		button btnConfig "âš™ï¸è®¾ç½®" pos:[165,222] width:49 height:22 border:false

	local m_PBKeyTimeArray
	local m_PBKeyMiliSecArray
	local m_PBStartTime
	local m_PBPointer
----------------------------------UIåŠä½œè€…ID------------------------------------------------
	fn fnSwitchToolBtnName =
	(
		local strBtnName = fnSwitchBtnString()
		ckbC1.text = strBtnName[1]
		ckbC2.text = strBtnName[2]
		ckbC3.text = strBtnName[3]
		ckbC4.text = strBtnName[4]
	)

	fn fnRefreshMsPanel =
	(
		if switchMSPanel == 0 then 
		(
			btnMyScripts1.visible = true
			btnMyScripts2.visible = true
			btnMyScripts3.visible = true
			btnMyScripts4.visible = true
			btnMyScripts5.visible = false
			btnMyScripts6.visible = false
			btnMyScripts7.visible = false
			btnMyScripts8.visible = false
		)
		else 
		(
			btnMyScripts1.visible = false
			btnMyScripts2.visible = false
			btnMyScripts3.visible = false
			btnMyScripts4.visible = false
			btnMyScripts5.visible = true
			btnMyScripts6.visible = true
			btnMyScripts7.visible = true
			btnMyScripts8.visible = true
		)
	)

	fn fnSwitchMagicBtn toggleID =
	(
		if toggleID == 1 then
		(
			rolBsKeyTools.width        = 220
			rolBsKeyTools.height       = 250
			btnMagicBtn.text           = "âœ§(â‰– â—¡ â‰–)âœ§"
			switchToolPanel            = 0
		)
		else
		(
			rolBsKeyTools.width        = 355
			rolBsKeyTools.height       = 275
			btnMagicBtn.text           = "ãƒ½( = `â–½`)ãƒ"
			switchToolPanel            = 1
		)
	)

	fn fnRefreshMagicBtn =
	(
		if switchToolPanel == 0 then (fnSwitchMagicBtn 1) else (fnSwitchMagicBtn 0)
	)

	fn fnReloadToolsBtn =
	(
		arrSourToolC1 = #(rolBsKeyTools.btnColorTools,rolBsKeyTools.btnFastAlign,
						rolBsKeyTools.btnDelDecimalKeys,rolBsKeyTools.btnAnimMirror,
						rolBsKeyTools.btnDemoTool,rolBsKeyTools.btnBatchExport,
						rolBsKeyTools.ckbIsoMesh,rolBsKeyTools.btnBipedTraj,
						rolBsKeyTools.btnRescaleWU,rolBsKeyTools.btnSkinTools,
						rolBsKeyTools.btnFnFrame,rolBsKeyTools.ckbFnMtlDisplay)
		arrSourToolC2 = #(rolBsKeyTools.btnCameraFromView,rolBsKeyTools.btnMopherSlider,
						rolBsKeyTools.btnSelBiped,rolBsKeyTools.btnSelBone,
						rolBsKeyTools.btnFnTCB,rolBsKeyTools.btnEulerFilter,
						rolBsKeyTools.btnDelOutKeys,rolBsKeyTools.btnCleanOutKeys,
						rolBsKeyTools.btnEndBone,rolBsKeyTools.btnRenameTools,
						rolBsKeyTools.btnBipedScale,rolBsKeyTools.btnSelByColor)
		arrSourToolC3 = #(rolBsKeyTools.btnMeshToBone,rolBsKeyTools.btnWinbox,
						rolBsKeyTools.btnHideBipedTwists,rolBsKeyTools.btnQuickPrev,
						rolBsKeyTools.btnKeyStepMode,rolBsKeyTools.btnFnKeyType,
						rolBsKeyTools.btnCutSequence,rolBsKeyTools.btnXrSkinTool,
						rolBsKeyTools.btnRetargetTools,rolBsKeyTools.btnCombineDetachSkin,
						rolBsKeyTools.btnTemp4,rolBsKeyTools.btnTemp5)
		arrSourToolC4 = #(rolBsKeyTools.btnTemp6,rolBsKeyTools.btnTemp7,
						rolBsKeyTools.btnTemp8,rolBsKeyTools.btnTemp9,
						rolBsKeyTools.btnTemp10,rolBsKeyTools.btnTemp11,
						rolBsKeyTools.btnTemp12,rolBsKeyTools.btnTemp13,
						rolBsKeyTools.btnTemp14,rolBsKeyTools.btnTemp15,
						rolBsKeyTools.btnTemp16,rolBsKeyTools.btnTemp17)
		
		fnLoadToolBtnConfig()
		arrToolsAllTemp = arrSourToolC1 + arrSourToolC2 + arrSourToolC3 + arrSourToolC4
		arrTargetTemp = #()
		for i in iniToolBtnAll where i != undefined do
		(
			local strSortID = i as string
			local indexToolID = (strSortID[1] as number - 1) * 12 + (strSortID[2] + strSortID[3]) as Number
			append arrTargetTemp arrToolsAllTemp[indexToolID]
		)
		arrToolC1 = for i = 1 to arrTargetTemp.count/4 collect arrTargetTemp[i]
		arrToolC2 = for i = (arrTargetTemp.count/4 + 1) to (2 * arrTargetTemp.count/4) collect arrTargetTemp[i]
		arrToolC3 = for i = (2 * arrTargetTemp.count/4 + 1) to (3 * arrTargetTemp.count/4) collect arrTargetTemp[i]
		arrToolC4 = for i = (3 * arrTargetTemp.count/4 + 1) to (4 * arrTargetTemp.count/4) collect arrTargetTemp[i]
	)

	fn fnSwitchToolsBtn idBtn =
	(
		local arrBtnAll = arrToolC1 + arrToolC2 + arrToolC3 + arrToolC4

		for b in arrBtnAll do (b.visible = false)

		str  = "for b = 1 to arrToolC" + idBtn as string + ".count do" + "\r\n"
		str += "(" + "\r\n"
		str += "	arrToolC" + idBtn as string + "[b].visible = true" + "\r\n"
		str += "	if (mod b 2 == 1) then \r\n"
		str += "	("
		str += "		arrToolC" + idBtn as string + "[b].pos = " + [225,45] as string + " + [0,(b - 1) * 16.5]" + "\r\n"
		str += "	)"
		str += "	else if (mod b 2 == 0) then"
		str += "	("
		str += "		arrToolC" + idBtn as string + "[b].pos = " + [285,45] as string + " + [0,(b - 2) * 16.5]" + "\r\n"
		str += "	)"
		str += ")"
		
		execute str
	)

	fn fnSwitchToolBtnChecked Btn =
	(
		arrBtnTemp = #(ckbC1,ckbC2,ckbC3,ckbC4)
		for i = 1 to arrBtnTemp.count do
		(
			if i != Btn then 
			(
				arrBtnTemp[i].checked = false
			)
			else 
			(
				idBtn = Btn
				arrBtnTemp[idBtn].checked = true
			)
		)
	)

	fn fnIsBipRoot obj = 
	(
		if ((classof obj.baseobject) == Biped_Object) do 
		(
			if (obj.controller.rootNode == obj) do (return true)
		)
		return false
	)

	fn fnBipedScale =
	(
		if (selection.count != 0) then 
		(
			for i in selection as Array do
			(
				if ((fnIsBipRoot i) == false) then 
				(
					subAnimSelected = getSubAnimName (i.transform.controller[1][1]) 1
					undo "addDelBipedScale" on
					(
						if (subAnimSelected == #ScaleXYZ) then 
						try (i.transform.controller[1][1].delete 1)catch()
						else if (subAnimSelected == #available) then 
						(
							try
							(
								rootnodeSelected = i.transform.controller.rootnode
								rootnodeSelected.transform.controller.enableSubAnims = true
								i.transform.controller[1][1][1].controller = ScaleXYZ ()
							)catch()
						)
					)
				)
			)
		)
	else (messagebox "è¯·é€‰æ‹©ä¸€æ ¹æˆ–å¤šæ ¹ Biped éª¨éª¼!    \r\n" beep:false title:"é€‰æ‹©æœ‰è¯¯ï¼")
	)

	Fn fnCleanOutRangeKeys inputObject =  ---æ¸…ç†æ— é™å¸§,ä»¥å‰æ”¶é›†çš„,æ‰¾ä¸åˆ°æ¥æºäº†,å¤§æ¦‚æ˜¯éå†å­åŠ¨ç”»
	(
		startTime = AnimationRange.Start
		endTime = AnimationRange.End
		for i = 1 to inputObject.numSubs do
		(
			tempSubAnim = GetSubAnim inputObject i
			tempController = tempSubAnim.Controller
			
			if tempController != undefined do
			(
				tempKeyList = tempController.Keys
				
				outEndKeysIndex = for i = 1 to tempKeyList.Count where tempKeyList[i].Time > endTime collect i
				if outEndKeysIndex.Count > 0 do for i = 1 to outEndKeysIndex.Count do DeleteKey tempKeyList tempKeyList.count
				
				outStartKeysIndex = for i = 1 to tempKeyList.Count where  tempKeyList[i].Time < startTime collect i
				for i = 1 to outStartKeysIndex.Count do DeleteKey tempKeyList 1
			)
			if tempSubAnim.numSubs > 0 do fnCleanOutRangeKeys tempSubAnim
		)
	)

	fn fnDelSelKeys =
	(
		for o in selection where (o.ishidden == false) do 
		(
			if (classof o == Biped_Object) then
			(
				if classof o.controller == Vertical_Horizontal_Turn then  --æ¸…ç†è´¨å¿ƒå¸§
				(
					biped.deleteKeys o.controller.vertical #selection
					biped.deleteKeys o.controller.horizontal #selection
					if (((sysinfo.GetMaxLanguage())[3]=="CHS") and ((maxVersion())[1] < 20000)) then 
						(biped.deleteKeys o.controller.flip #selection)
						else(biped.deleteKeys o.controller.turning #selection)
				)
				else if classof o.controller == BipSlave_Control then  --æ¸…ç†bipedæ­£å¸¸å¸§
				(
					biped.deleteKeys o.controller #selection
					subanimBipedScale = GetSubAnim o.controller[1] 1
					if ((subanimBipedScale != undefined) and \
					(GetSubAnimName subanimBipedScale 1 == #ScaleXYZ)) then  --æ¸…ç†bipedçš„ç¼©æ”¾é’ˆ
					(
						deleteKeys subanimBipedScale.controller #selection
					)
				)
			)
			else (deleteKeys o #selection)   ---æ¸…ç†ébipedå¸§
		)
	)

	fn fnDelAllDecimalKeys arrAllKey = 
	(
		local arrDelKeyIndex = #()
		for i in arrAllKey do ----è·å–å°æ•°å¸§çš„å¸§æ•°
		(
			if (int(i) as time) != i then appendIfUnique arrDelKeyIndex i
		)
		for o in objects do 
		(
			deselectKeys o --å–æ¶ˆä¹‹å‰é€‰æ‹©çš„å¸§é˜²æ­¢è¯¯åˆ 
			for k in arrDelKeyIndex do
			(
				case of 
				(
					(classof o.controller == Vertical_Horizontal_Turn): --åˆ é™¤Bipedè´¨å¿ƒå°æ•°å¸§
					(
						selectkeys o.controller.vertical k
						selectkeys o.controller.horizontal k
						if (((sysinfo.GetMaxLanguage())[3]=="CHS") and ((maxVersion())[1] < 20000)) then 
						(selectkeys o.controller.flip k)
						else(selectkeys o.controller.turning k)
						biped.deleteKeys o.controller.vertical #selection
						biped.deleteKeys o.controller.horizontal #selection
						if (((sysinfo.GetMaxLanguage())[3]=="CHS") and ((maxVersion())[1] < 20000)) then 
						(biped.deleteKeys o.controller.flip #selection)
						else(biped.deleteKeys o.controller.turning #selection)
					)
					(classof o.controller == BipSlave_Control):
					(
						selectkeys o.controller k
						biped.deleteKeys o.controller #selection  --æ¸…ç†bipedæ­£å¸¸å°æ•°å¸§
						subanimBipedScale = GetSubAnim o.controller[1] 1
						if ((subanimBipedScale != undefined) and \
						(GetSubAnimName subanimBipedScale 1 == #ScaleXYZ)) then  --æ¸…ç†bipedçš„ç¼©æ”¾å°æ•°é’ˆ
						(
							selectkeys subanimBipedScale.controller k
							deleteKeys subanimBipedScale.controller #selection
						)
					)
					default:(selectkeys o k;deleteKeys o #selection)   ---æ¸…ç†ébipedå¸§
				)
			)
		)
	)

	-- fn fnAddLinkKeys tempObj =
	-- (
		fn fnAddLinkTimesKeys tempObj i=     --æ·»åŠ linkTimeså…³é”®å¸§
		(
			-- for i = 1 to tempObj.controller.numsubs do 
			-- (
				if ((GetSubAnimName tempObj.controller i) == #Link_Times) then
				(
					if tempObj.controller[i].keys[1] != undefined then
					(
						for i in tempObj.controller[i].keys do 
						(
							appendIfUnique arrLinkKeys i  ---------æ·»åŠ linkå¸§åˆ°æ•°ç»„
							appendIfUnique arrKeysTime i.time
							appendIfUnique arrBlockingKeys i.time
							if i.selected == true then (appendIfUnique arrKeysSelected i.time)
						)
					)
				)
			-- )
		)
		fn fnAddLinkParamsKeys tempObj i=   ----æ·»åŠ LinkParamsä¸‹é¢çš„Transformå¸§
		(
			local tempLinkController
			local keyTimeStartTemp
			local keyTimeEndTemp
			
			-- for i = 1 to tempObj.controller.numsubs do 
			-- (
				if ((GetSubAnimName tempObj.controller i) == #Link_Params) then
				(
					tempLinkController = tempObj.controller[i]
					if tempLinkController[1] != undefined then
					(
						for i = 1 to tempLinkController.numsubs do -----linkå±æ€§çš„boneä¸‹é¢çš„prså¸§------
						(
							if (((tempLinkController[i]).name == "Position") or \
							((tempLinkController[i]).name == "Rotation") or \
							((tempLinkController[i]).name == "Scale")) then
							(
								if tempLinkController[i].keys[1] != undefined then
								(
									keyTimeStartTemp = tempLinkController[i].keys[1].time
									keyTimeEndTemp = tempLinkController[i].keys[tempLinkController[i].keys.count].time
									appendIfUnique arrKeysTime keyTimeStartTemp
									appendIfUnique arrKeysTime keyTimeEndTemp
									for i in tempLinkController[i].keys do 
									(
										appendIfUnique arrBlockingKeys i.time
										if i.selected == true then (
											appendIfUnique arrKeysSelected i.time
										)
									)
								)
							)
						)
					)
				)
			-- )
		)
		-- fnAddLinkTimesKeys tempObj
		-- fnAddLinkParamsKeys tempObj
	-- )

	fn fnAddPrsKeys tempObj i=  ---------æ·»åŠ æ­£å¸¸ébipedçš„prså¸§(æ²¡åŠ link),iæ˜¯å­åŠ¨ç”»ID,åé¢ç”¨åˆ°,æå‰ä¼ å…¥å‡å°‘éå†
	(
		local keyTimeStartTemp
		local keyTimeEndTemp
		
		-- for i = 1 to tempObj.controller.numsubs do 
		-- (
			if (((tempObj.controller[i]).name == "Position") or \
			((tempObj.controller[i]).name == "Rotation") or \
			((tempObj.controller[i]).name == "Scale")) then
			(
				if tempObj.controller[i].keys[1] != undefined then
				(
					keyTimeStartTemp = tempObj.controller[i].keys[1].time
					keyTimeEndTemp = tempObj.controller[i].keys[tempObj.controller[i].keys.count].time
					appendIfUnique arrKeysTime keyTimeStartTemp
					appendIfUnique arrKeysTime keyTimeEndTemp
					for i in tempObj.controller[i].keys do 
					(
						appendIfUnique arrBlockingKeys i.time
						if i.selected == true then (
							appendIfUnique arrKeysSelected i.time
						)
					)
				)
			)
		-- )
	)

	fn fnAddBipedKeys tempObj =------æ”¶é›†Bipedå¸§
	(
		local keyTimeStartTemp
		local keyTimeEndTemp
		local subanimBipedScale

		if classof tempObj.controller != Footsteps then
		(
			if classof tempObj.controller != Vertical_Horizontal_Turn then --ç­›é€‰å‡ºéè´¨å¿ƒçš„bipedå¸§
			(
				if (tempObj.controller.keys[1] != undefined) then
				(
					for i in tempObj.controller.keys do 
					(
						appendIfUnique arrKeysTime i.time   ---æ·»åŠ åˆ°æ•°ç»„
						appendIfUnique arrBlockingKeys i.time
						if i.selected == true then (
							appendIfUnique arrKeysSelected i.time
						)
					)
				)
				subanimBipedScale = GetSubAnim tempObj.controller[1] 1
				if ((subanimBipedScale != undefined) and \
				(GetSubAnimName subanimBipedScale 1 == #ScaleXYZ)) then  ----ç­›é€‰å‡ºbipedçš„ç¼©æ”¾å¸§
				(
					if subanimBipedScale[1].keys[1] != undefined then
					(
						keyTimeStartTemp = subanimBipedScale[1].keys[1].time
						keyTimeEndTemp = subanimBipedScale[1].keys[subanimBipedScale[1].keys.count].time
						appendIfUnique arrKeysTime keyTimeStartTemp
						appendIfUnique arrKeysTime keyTimeEndTemp
						for i in subanimBipedScale[1].keys do 
						(
							appendIfUnique arrBlockingKeys i.time
							if i.selected == true then (
								appendIfUnique arrKeysSelected i.time
							)
						)
					)
				)
			)
			else
			(-------------------ä¸‹é¢æ˜¯æ”¶é›†è´¨å¿ƒçš„å…³é”®å¸§,å‘åœ¨äºä¸­è‹±æ–‡turningåå­—è¿˜ä¸ä¸€æ ·...
				if classof tempObj.controller == Vertical_Horizontal_Turn then
				(
					bipCtrl = tempObj.controller
					vertCtrl = bipCtrl.vertical.controller
					horzCtrl = bipCtrl.horizontal.controller
					if (((sysinfo.GetMaxLanguage())[3]=="CHS") and ((maxVersion())[1] < 20000)) then 
						(turnCtrl = bipCtrl.flip.controller)
						else(turnCtrl = bipCtrl.turning.controller)
					bipCtrlTemp = #(vertCtrl,horzCtrl,turnCtrl)
					for c in bipCtrlTemp do
					(
						if c.keys[1] != undefined then
						(
							keyTimeStartTemp = c.keys[1].time
							keyTimeEndTemp = c.keys[c.keys.count].time
							appendIfUnique arrKeysTime keyTimeStartTemp
							appendIfUnique arrKeysTime keyTimeEndTemp
							for i in c.keys do 
							(
								appendIfUnique arrBlockingKeys i.time
								if i.selected == true then (
									appendIfUnique arrKeysSelected i.time
								)
							)
						)
					)
				)
			)
		)
	)

	fn fnAddKyes tempObj fnLink =   ---æ·»åŠ å¸§(ä¸»è¦æ˜¯é¦–å°¾å¸§),åŠ ä¸ªåˆ¤æ–­æ˜¯å¦å‹¾é€‰link
	(	
		if (classof tempObj != Biped_Object) then
		(
			if tempObj.controller != undefined then
			(
				if (classof tempObj.controller) == prs then
				(
					for i = 1 to tempObj.controller.numsubs do 
					(
						fnAddPrsKeys tempObj i        ---ébipedç‰©ä½“çš„ä½ç§»æ—‹è½¬ç¼©æ”¾å¸§
					)
				)
				if (classof tempObj.controller) == Link_Constraint then
				(
					for i = 1 to tempObj.controller.numsubs do 
					(
						if fnLink == 1 then (fnAddLinkTimesKeys tempObj i)         ---------linkå±æ€§çš„ç‰©ä½“linkå¸§å’Œélinkå¸§
						fnAddLinkParamsKeys tempObj i
					)
				)
			)
		)
		else
		(
			fnAddBipedKeys tempObj   ---------bipedå¸§
		)

		-- arrKeysTime = makeUniqueArray arrKeysTime  ---å»é™¤é‡å¤å¸§æ•°
		sort arrKeysTime  ----å¸§æ•°æ’åº
		sort arrKeysSelected
		if (arrKeysTime.count != 0) then
		(
			case of 
			(
				(arrKeysTime.count > 1):
				(
					keyFirst = arrKeysTime[1]            ------æ‰¾åˆ°é¦–å¸§
					keyEnd = arrKeysTime[arrKeysTime.count]   -----------æ‰¾åˆ°å°¾å¸§
				)
				(arrKeysTime.count == 1):   --é˜²æ­¢é¦–å°¾åŒå¸§çš„ä¿é™©
				(
					keyFirst = arrKeysTime[1]
					keyEnd = keyFirst + 1
				)
			)
		)
		if (arrKeysSelected.count != 0) then
		(
			case of 
			(
				(arrKeysSelected.count > 1):
				(
					keySelFirst = arrKeysSelected[1]            ------æ‰¾åˆ°é¦–å¸§
					keySelEnd = arrKeysSelected[arrKeysSelected.count]   -----------æ‰¾åˆ°å°¾å¸§
				)
				(arrKeysSelected.count == 1):   --é˜²æ­¢é¦–å°¾åŒå¸§çš„ä¿é™©
				(
					keySelFirst = arrKeysSelected[1]
					keySelEnd = keySelFirst + 1
				)
			)
		)
	)

	fn fnCollectKeys = ---------æ”¶é›†å…³é”®å¸§
	(
		arrKeysTime     = #()
		arrKeysSelected = #() ----------------å…ˆæ¸…ç©ºæ•°ç»„
		arrLinkKeys     = #()
		arrBlockingKeys = #()
		case of  -----------å¤„ç†é€‰ä¸­,æœªé€‰ä¸­åˆ™å¤„ç†å…¨éƒ¨
		(
			(selection.count == 0):
			(
				for i in (objects as array) where (i.ishidden == false) do 
				(
					if rolBsKeyTools.btnJudgeLinkKey.checked == false then fnAddKyes i 0
					else 
					fnAddKyes i 1  -----------æ ¹æ®æ˜¯å¦å‹¾é€‰linkå¤„ç†æ”¶é›†å¸§
				)
			)
			default:
			(
				for i in (selection as array) where (i.ishidden == false) do 
				(
					if rolBsKeyTools.btnJudgeLinkKey.checked == false then fnAddKyes i 0
					else 
					fnAddKyes i 1  -----------æ ¹æ®æ˜¯å¦å‹¾é€‰linkå¤„ç†æ”¶é›†å¸§
				)
			)
		)
	)

	fn fnSelLinkKeys keyFirst KeyEnd symbol =  ---------------é€‰æ‹©linkå¸§æ–¹æ³•
	(
		if arrLinkKeys.count != 0 then
		(
			for i in arrLinkKeys do   -------linkå¸§é€‰ä¸­
			(
				i.selected = false ---å…ˆå–æ¶ˆä¹‹å‰linkå¸§é€‰ä¸­çŠ¶æ€
				case of  -------------åˆ¤æ–­linkå¸§ä½ç½®,æ•°å­—æ˜¯éšä¾¿å–çš„æ–¹ä¾¿åˆ¤æ–­æƒ…å†µ
				(
					(symbol == 0):(if i.time <= KeyEnd then i.selected = true)
					(symbol == 1):(if i.time >= keyFirst then i.selected = true)
					(symbol == 2):(i.selected = true)
				)
			)
		)
	)

	fn fnSelKeys keyFirst KeyEnd symbol =  ---------------é€‰æ‹©å¸§çš„æ–¹æ³•
	(
		fn fnSelectKeys keyFirst KeyEnd symbol =  -------å› ä¸ºæœ‰é€‰ä¸­å’Œæ²¡é€‰æ‹©çŠ¶æ€, æ‰€ä»¥åŠ ä¸€ä¸ªæ–¹æ³•ç²¾ç®€ä¸‹
		(
			for i in objects where (i.ishidden == false) do deselectKeys i          --æ¸…é™¤ä¹‹å‰é€‰ä¸­çš„å…³é”®å¸§
			if arrKeysTime.count != 0 then
			(
				selectkeys $ keyFirst KeyEnd  -------------é€‰ä¸­æ­£å¸¸å¸§
				if rolBsKeyTools.btnJudgeLinkKey.checked == true then
				(
					fnSelLinkKeys keyFirst KeyEnd symbol --------------é€‰ä¸­linkå¸§
				)
			)
			else
			(
				if rolBsKeyTools.btnJudgeLinkKey.checked == true then
				(
					fnSelLinkKeys keyFirst KeyEnd symbol
				)
			)
		)
		case of 
		(
			(selection.count == 0):  ----------åˆ¤æ–­æ˜¯å¦æœ‰é€‰ä¸­ç‰©ä½“
			(
				actionMan.executeAction 0 "40021"    ---æ²¡æœ‰é€‰æ‹©ç‰©ä½“åˆ™é€‰æ‹©æ‰€æœ‰ç‰©ä½“
				fnSelectKeys keyFirst KeyEnd symbol
			)
			default:  ----------------
			(
				fnSelectKeys keyFirst KeyEnd symbol
			)
		)
	)

	mapped fn fnMoveKeysAndLinkKeys obj offset =  ----https://forums.cgsociety.org/t/moving-keys-from-link-constraint-keys-access/1575053
	(
		local arrTargetID  = #()
		moveKeys obj offset #selection  ---å…ˆç§»åŠ¨élinkå¸§
		if rolBsKeyTools.btnJudgeLinkKey.checked == true then 
		(
			if classof obj.controller == Link_Constraint do
			(
				nTargets = obj.controller.getNumTargets()  ---å¾—åˆ°linkçš„å¸§æ•°é‡
	
				if nTargets > 0 do
				(
					for i = nTargets to 1 by -1 do  ------å¦‚æœå¤§äº0åˆ™ä»æœ€ålinkå¸§å¼€å§‹ç§»
					(
						fNumber = obj.controller.getFrameNo i
						if ((fNumber >= keySelFirst) and (fNumber <= keySelEnd)) then
						(
							appendIfUnique arrTargetID i
						)
					)
					if offset > 0 then  --------åˆ¤æ–­å‘å‰è¿˜æ˜¯å‘åç§»åŠ¨å¸§
					(
						for i = arrTargetID.count to 1 by -1 do  ------å¦‚æœå¤§äº0åˆ™ä»æœ€ålinkå¸§å¼€å§‹ç§»
						(
							fNumber = obj.controller.getFrameNo arrTargetID[i]
							obj.controller.setFrameNo i (fNumber + offset)
						)
					)
					else
					(
						for i = 1 to arrTargetID.count do  ---å¦‚æœç§»åŠ¨å¸§å°äº0,ä»ç¬¬ä¸€ä¸ªlinkå¸§å¼€å§‹ç§»
						(
							fNumber = obj.controller.getFrameNo arrTargetID[i]
							obj.controller.setFrameNo i (fNumber + offset)
						)
					)
				)
			)
		)
	)

	-- fn fnSplitSelBiped = --åˆ†å¼€é€‰æ‹©å››è‚¢å’Œèº«ä½“,ä¾‹å¦‚åŒä¸€æ¡æ‰‹è‡‚åªé€‰æ‹©æœ€çˆ¶çº§çš„(æ–¹ä¾¿ç§»åŠ¨å¸§)
	-- (
	-- 	arrSelBiped = for i in selection where classof i.controller == BipSlave_Control collect i 

	-- )

	fn fnMoveBipedKeys offsetFrame =  -------ç§»åŠ¨Bipedå¸§
	(
		bipedRoot = #()   -------åˆ¤æ–­é€‰æ‹©äº†å‡ ä¸ªbipedéª¨æ¶
		for i in selection where ((classof i == Biped_Object) and (i.ishidden == false)) do  
		(
			appendIfUnique bipedRoot i.controller.rootNode  --æ·»åŠ åˆ°éª¨æ¶æ•°ç»„
		)
		for c in bipedRoot do  ---æŒ‰æ¯ä¸ªéª¨æ¶å¤„ç†
		(
			ctrlBiped = c.controller
			bipedAll = #(biped.getNode ctrlBiped #pelvis, -----å››è‚¢åŒå¸§å¤„ç†,åªå¤„ç†ä»–é¦–èŠ‚biped
						biped.getNode ctrlBiped #spine,
						biped.getNode ctrlBiped #neck,
						biped.getNode ctrlBiped #larm,
						biped.getNode ctrlBiped #rarm,
						biped.getNode ctrlBiped #lleg,
						biped.getNode ctrlBiped #rleg,
						biped.getNode ctrlBiped #prop1,
						biped.getNode ctrlBiped #prop2,
						biped.getNode ctrlBiped #prop3,
						biped.getNode ctrlBiped #tail)

			vertCtrl = ctrlBiped.vertical.controller  -----è´¨å¿ƒctrlå…³é”®å¸§
			horzCtrl = ctrlBiped.horizontal.controller
			if (sysinfo.GetMaxLanguage())[3]=="CHS" then 
			(turnCtrl = ctrlBiped.flip.controller)
			else(turnCtrl = ctrlBiped.turning.controller)
			bipCtrlTemp = #(vertCtrl,horzCtrl,turnCtrl)
			for c in bipCtrlTemp do
			(
				biped.moveKeys c offsetFrame #selection  -----ç§»åŠ¨é€‰å®šçš„è´¨å¿ƒå¸§
			)
			for nodeBiped in bipedAll where nodeBiped != undefined do  -----ç§»åŠ¨å…¶ä»–bipedçš„é€‰å®šå¸§
			(
				biped.moveKeys nodeBiped.controller offsetFrame #selection
			)
		)
	)		

	mapped fn fnMoveBipedScaleKeys tempObj offsetFrame =  -------ç§»åŠ¨bipedçš„ç¼©æ”¾å¸§
	(
		ctrlBiped = tempObj.controller
		if classof ctrlBiped == BipSlave_Control then  --------ä¸‹é¢åˆ¤å®šå­åŠ¨ç”»æ˜¯å¦ä¸ºscaleXYZ
		(
			if ((ctrlBiped[1][1] != undefined) and ((getSubAnimName ctrlBiped[1][1] 1) == #ScaleXYZ)) then
			(
				movekeys ctrlBiped[1][1][1] offsetFrame #selection
			)
		)
	)

	fn fnMoveAllKeys keyMovedOffset fnRange:off =
	(
		local rangEnd = animationrange.end
		local rangeStart = animationrange.start
		local n = 0  --næ¥åˆ¤å®šæ˜¯å¦æœ‰é€‰ä¸­biped

		if keyMovedOffset != undefined then
		(
			if selection.count != 0 then
			(
				for i in selection where (i.ishidden == false) do
				(
					if classof i != Biped_Object then
					(
						fnMoveKeysAndLinkKeys i keyMovedOffset
					)
					else 
					(
						fnMoveBipedScaleKeys i keyMovedOffset
						n += 1
					)
				)
				if n != 0 then  ----------åˆ†å¼€è§£å†³bipedå¤šç§»åŠ¨çš„é—®é¢˜,å‚»ç“œå¼æ–¹æ³•
				(
					fnMoveBipedKeys keyMovedOffset
				)
			)
			else  ---è·Ÿä¸Šé¢ä¸€æ ·,åªæ˜¯å¯¹æ‰€æœ‰ç‰©ä½“
			(
				for i in objects where (i.ishidden == false) do
				(
					if classof i != Biped_Object then
					(
						fnMoveKeysAndLinkKeys i keyMovedOffset
					)
					else fnMoveBipedScaleKeys i keyMovedOffset
				)
				fnMoveBipedKeys keyMovedOffset
			)
			if fnRange == on then
			(
				if keyMovedOffset > 0 then 
				(
					rangEnd = animationrange.end + keyMovedOffset
					animationrange = interval animationrange.start rangEnd
				)
				else if keyMovedOffset < 0 then 
				(
					rangeStart = animationrange.start + keyMovedOffset
					animationrange = interval rangeStart animationrange.end
				)
			)
			keySelFirst += keyMovedOffset
			keySelEnd  += keyMovedOffset
		)
	)

	fn fnAddTrajLayer strlayerName templayerTarget =
	(
		if (LayerManager.getLayerFromName strlayerName) != undefined then
		(
			templayerTarget = LayerManager.getLayerFromName strlayerName
		)
		else templayerTarget = LayerManager.newLayerFromName strlayerName
		templayerTarget.lock = on
		templayerTarget
	)

	fn fnAddBipedTraj tempBiped =
	(
		pointTraj = point name:("Traj_" + tempBiped.name) size:0 cross:true 
		appendIfUnique arrTraj pointTraj
		freeze pointTraj
		arrBipedSonTemp = tempBiped.children
		bipedTarget = arrBipedSonTemp[(arrBipedSonTemp.count + 1)/2]
		pointTraj.transform = bipedTarget.transform
		pointTraj.parent = tempBiped
		layerTraj.addNode pointTraj
		deleteKeys pointTraj #allKeys
		pointTraj.showTrajectory = true
		-- ResetXForm pointTraj
	)

	fn fnDeleteTraj tempBiped =
	(
		local deleteTraj
		local deleteTrajName = ("Traj_" + tempBiped.name)
		local deleteTraArrID = findItem arrTraj deleteTrajName
		if deleteTraArrID != 0 then
		(
			deleteTraj = arrTraj[deleteTraArrID]
			deleteItem arrTraj deleteTraArrID
		)
		if (getNodeByName deleteTrajName) != undefined then (delete (getNodeByName deleteTrajName))
	)

	fn fnQuickSave =
	(
		local nameCurrentFile = getFilenameFile maxFileName
		local arrTime = for i in (getLocalTime()) collect i as string
		local strNameSplit = "@Backup_"
		local fileSave = ""

		if (matchpattern nameCurrentFile pattern:("*" + strNameSplit + "*")) then
		(
			numSplitString = (findString (getFilenameFile maxFileName) "@Backup_")
			nameCurrentFile = replace nameCurrentFile numSplitString (nameCurrentFile.count - numSplitString + 1) ""
		)

		strNameSplit = strNameSplit + arrTime[2] + "_" + arrTime[4] + "_" + arrTime[5] + "h" + arrTime[6] + "m" + arrTime[7] + "s" + arrTime[8] + "ms"

		fileSave = maxFilePath + nameCurrentFile + strNameSplit + ".max"
		saveMaxFile fileSave
		messagebox ("å·²å¿«é€Ÿå¤‡ä»½è‡³ï¼š\r\n" + fileSave + "                                      ") 
	)

	fn fnCutDisplayKeyRange keyFirst keyEnd =  ---æ˜¾ç¤ºé¦–å°¾å¸§èŒƒå›´
	(
		if ((keyFirst != undefined) and (keyEnd != undefined)) then
		(
			if (arrKeysTime.count != 0) then
			(
				if (arrLinkKeys.count != 0) then
				(
					case of  ------ä¸‡æ¶çš„linkå¸§å¯¼è‡´æ›´å¤šåˆ¤å®š
					(
						((arrLinkKeys[1].time >= keyFirst) and (arrLinkKeys[arrLinkKeys.count].time <= keyEnd)):
						(animationrange = (interval keyFirst keyEnd))
						((arrLinkKeys[1].time < keyFirst) and (arrLinkKeys[arrLinkKeys.count].time <= keyEnd)):
						(animationrange = (interval arrLinkKeys[1].time keyEnd))
						((arrLinkKeys[1].time < keyFirst) and (arrLinkKeys[arrLinkKeys.count].time >= keyEnd)):
						(animationrange = (interval arrLinkKeys[1].time arrLinkKeys[arrLinkKeys.count].time))
						((arrLinkKeys[1].time >= keyFirst) and (arrLinkKeys[arrLinkKeys.count].time > keyEnd)):
						(animationrange = (interval keyFirst arrLinkKeys[arrLinkKeys.count].time))
						((arrLinkKeys[1].time < keyFirst) and (arrLinkKeys[arrLinkKeys.count].time > keyEnd)):
						(animationrange = (interval arrLinkKeys[1].time arrLinkKeys[arrLinkKeys.count].time))
					)
				)
				else
				(
					animationrange = interval keyFirst keyEnd
				)
			)
			else 
			(
				if ((arrLinkKeys.count != 0) and (arrLinkKeys.count > 1)) then 
				(
					animationrange = (interval arrLinkKeys[1].time arrLinkKeys[arrLinkKeys.count].time)
				)
				else 
				(
					if (arrLinkKeys.count == 1) then
					(
						animationrange = (interval arrLinkKeys[1].time (arrLinkKeys[1].time + 1))
					)
				)
			)
		)
	)

	fn fnGetPlaySpeedValue =
	(
		case of
		(
			(timeConfiguration.playbackSpeed == 1):(return 0.25)
			(timeConfiguration.playbackSpeed == 2):(return 0.5)
			(timeConfiguration.playbackSpeed == 3):(return 1)
			(timeConfiguration.playbackSpeed == 4):(return 2)
			(timeConfiguration.playbackSpeed == 5):(return 4)
		)
	)

	-- https://cafe.naver.com/pinksox/6131
	-- ä¼˜åŒ–æ”¯æŒ bone

	fn FramToMilisecond frame = 
	(
		return ((((frame - animationRange.start) as integer) * (10.0 / 48.0) * fnGetPlaySpeedValue()) as integer)
    )

	fn AppendKeyTimeArray m_PBKeyMiliSecArray keys = 
	(
        if keys.count == 0 do return()
        for i = 1 to keys.count do (
            if (keys[i] >= animationRange.start) AND (keys[i] <= animationRange.end) do (
                appendifUnique m_PBKeyMiliSecArray (FramToMilisecond keys[i])
                appendifUnique m_PBKeyTimeArray keys[i]
            )
        )
        appendifUnique m_PBKeyMiliSecArray (FramToMilisecond animationRange.start)
        appendifUnique m_PBKeyTimeArray animationRange.start
        appendifUnique m_PBKeyMiliSecArray (FramToMilisecond animationRange.end)
        appendifUnique m_PBKeyTimeArray animationRange.end
	)

	fn StopBlocking = 
	(
        clock.active = false
        ckbPlayBlocking.state = false
        ckbPlayBlocking.text = "è·³å¸§æ’­"
	)

	fn PlayBlocking = 
	(
		fnCollectKeys ()
		m_PBKeyTimeArray = #()
		m_PBKeyMiliSecArray = #()
		local nowTime = timeStamp()
		AppendKeyTimeArray m_PBKeyMiliSecArray arrBlockingKeys
		if m_PBKeyMiliSecArray.count == 0 do (
			StopBlocking()
			return()
		)
		
		if (isAnimPlaying()) do (
			stopAnimation()
		)		
		
		sort m_PBKeyTimeArray
		sort m_PBKeyMiliSecArray
		m_PBPointer = 1
		while (m_PBKeyTimeArray[m_PBPointer] < sliderTime) do (m_PBPointer += 1)

		m_PBStartTime = timeStamp() - (FramToMilisecond sliderTime)
		sliderTime = m_PBKeyTimeArray[m_PBPointer]
		clock.active = true
		ckbPlayBlocking.text = "åœæ­¢!"
	)

	fn ReplayBlocking = 
	(
		m_PBPointer = 1
		m_PBStartTime = timeStamp()
		sliderTime = m_PBKeyTimeArray[m_PBPointer]
	)

	fn fnAddMyScript btnMyScript idMyScript =
	(
		dirScript = getOpenFileName caption:"è¯·é€‰æ‹©æ·»åŠ çš„Maxè„šæœ¬:" historyCategory:"myScripts" \
		types:"maxscript(*.ms,*.mse)|*.ms*|All(*.*)|*.*" filename:(getDir #scripts + @"\") 
		if (dirScript != undefined) then
		(
			nameMyScript = getFilenameFile dirScript
			btnMyScript.text = nameMyScript
			btnMyScript.tooltip = nameMyScript
			iniArrMyScripts[idMyScript].msName = nameMyScript
			iniArrMyScripts[idMyScript].dir = dirScript
			messagebox "å³é”®å¯é‡æ–°è®¾ç½®è„šæœ¬å¿«æ·é”®!\r\n\r\n(æŒ‰é’®è¾ƒçª„,å»ºè®®å³é”®è®¾ç½®è„šæœ¬æ˜µç§°~)                                "
		)
		stSetConfigAll.fnSetConfigBsKeyTools ()
	)

	fn fnRefreshMyScripts =
	(
		arrMyScriptTemp = #(rolBsKeyTools.btnMyScripts1, \
		rolBsKeyTools.btnMyScripts2, \
		rolBsKeyTools.btnMyScripts3, \
		rolBsKeyTools.btnMyScripts4, \
		rolBsKeyTools.btnMyScripts5, \
		rolBsKeyTools.btnMyScripts6, \
		rolBsKeyTools.btnMyScripts7, \
		rolBsKeyTools.btnMyScripts8)
		for b = 1 to arrMyScriptTemp.count do 
		(
			if iniArrMyScripts[b] != undefined then
			(
				if (iniArrMyScripts[b].msName != undefined) then 
				(
					arrMyScriptTemp[b].text = iniArrMyScripts[b].msName
				)
				else arrMyScriptTemp[b].text = "<ï¼‹ï¼‹>"
			)
		)
	)

	fn fnGetAllBipedTwist =
	(
		arrBipedRootAll = $'Bip00?'
		arrBipedTwistAll = #()
		for r in arrBipedRootAll do
		(
			nn = biped.maxTwistNodes r
			nl = biped.maxTwistLinks r
			ts = biped.getTwistStartId r
			
			for i = ts to ts+nn-1 do
			(
				anode = biped.getNode r i
				if anode != undefined do
				(
				for j = 1 to nl do
					(
						alink = biped.getNode r i link:j
						if alink != undefined do
						(
							appendIfUnique arrBipedTwistAll alink
						)
					)
				)
			)
		)
		for j in arrBipedTwistAll where j != undefined do
		(
			j.isHidden = not (j.isHidden)
		)
	)

	on rolBsKeyTools open do  ----æ‰“å¼€è„šæœ¬æ—¶æ“ä½œ
	(
		fnSwitchToolBtnName()
		------åˆ·æ–°å›¾æ ‡, å›¾æ ‡æ˜¯maxè‡ªå¸¦çš„,ä¸»è¦æ˜¯æ‡’å¾—åš
		btnSelBeforeKeys.images = #("VCRControls_24i.bmp","VCRControls_24i.bmp",28,3,3,3,3,true,true) 
		btnSelAfterKeys.images = #("VCRControls_24i.bmp","VCRControls_24i.bmp",28,11,11,11,11,true,true) 
		btnSelAllKeys.images = #("VCRControls_24i.bmp","VCRControls_24i.bmp",28,26,26,26,26,true,true)
		-- btnMoveKeys.images = #("VCRControls_24i.bmp","VCRControls_24i.bmp",28,21,21,21,21,true,true)
		-- btnMoveAfterKeys.images = #("VCRControls_24i.bmp","VCRControls_24i.bmp",28,13,13,13,13,true,true)
		-- dotnet.AddEventHandler myTimer #elapsed fnRefreshHelpText
		-- myTimer.Start()
		-- timeDIsTemp      = timeDisplayMode  ----å°æ•°å¸§è¿˜æ˜¯æ•´æ•°å¸§
		-- iniPos = (GetDialogPos rolBsKeyTools) 
		stLoadConfigAll.fnLoadConfigBsKeyToolsAll ()  ---------------è„šæœ¬ä½ç½®èµ‹å€¼
		stSetConfigAll.fnSetConfigBsKeyTools ()  ----------------ä¿å­˜ä½ç½®ä¿¡æ¯åˆ°iniæ–‡ä»¶
		fnReloadToolsBtn()
		if(switchMSPanel == 0) then (ckbSwitchMyScripts.checked = false)
		else (ckbSwitchMyScripts.checked = true)
		fnRefPlaySpeedValue ()  -----åˆ¤æ–­æ’­æ”¾é€Ÿåº¦
		fnBsRefFps ()
		fnRefreshMagicBtn ()
		fnRefreshMsPanel ()
		-- if (switchToolPanel == 1) then
		-- (
			fnSwitchToolsBtn idBtn
			fnSwitchToolBtnChecked idBtn
			fnRefreshMyScripts ()
		-- )
		ckbPlayBlocking.state = false
		clock.active = false
		if iniIsIcon do fnSwitchIconStyle()
		if (iniBsAutoCheckUpdate == true) then 
		(fnAutoCheckVersion curVerBsKeyTools verUrlBsKeyTools dlUrlBsKeyTools dlFileBsKeyTools)
		-- print ("iniBsAutoCheckUpdate: " + iniBsAutoCheckUpdate as string)
	)
	
	on rolBsKeyTools close do -- å…³é—­è®°å¿†æµ®åŠ¨çª—å£ä½ç½®
	(
		iniPos = (GetDialogPos rolBsKeyTools)
		stSetConfigAll.fnSetConfigBsKeyTools ()
		try (callbacks.removeScripts #animationRangeChange id:#UpdateTimeRange) catch ()
		try (callbacks.removeScripts #filePostOpen id:#UpdateFps) catch ()
	)
	-----------------------------------------------------------------------------------------
	on rolBsKeyTools rbuttondown pos do 
	(
		popupMenu menuConfig pos:[mouse.screenpos.x + 20,mouse.screenpos.y]
	)

	on btnConfig pressed do (popupMenu menuConfig pos:[mouse.screenpos.x + 20,mouse.screenpos.y])

	on btnConfig rightclick do (popupMenu menuConfig pos:[mouse.screenpos.x + 20,mouse.screenpos.y])

	on rolBsKeyTools mbuttondown pos do 
	(
		try (destroydialog rolBsKeyTools) catch ()
	)
	
	on rolBsKeyTools lbuttondown posMou do
	(
		posMouMoved = posMou
		switchMouseState = on
	)
	
	on rolBsKeyTools lbuttonup posMou do
	(
		switchMouseState = off
	)
	
	on rolBsKeyTools mouseMove pos do
	(
		-- myTimer.Start()
		if switchMouseState == on then
		(
			SetDialogPos rolBsKeyTools (mouse.screenpos - posMouMoved)			
		)
	)
	---------------------ä¸Šé¢è®¾ç½®æ‹–åŠ¨è„šæœ¬çª—å£,å»æ‰æ ‡é¢˜æ åé»˜è®¤æ— æ³•æ‹–åŠ¨---------------------
	on btnSelBiped pressed do ----é€‰æ‹©biped
	(
		-- for o in objects where (o.ishidden == false) do 
		-- (
		-- 	if classof o == Biped_Object then selectmore o
		-- 	-- if (matchpattern o.name pattern:"*Bip*") then selectmore o
		-- )
		if ((selection.count == 1) and (classof $ == Biped_Object) and ($.ishidden == false)) then 
		(
			local tempSel = $
			execute ("select $'" + tempSel.controller.rootNode.name + "*'")
			execute ("deselect $'" + tempSel.controller.rootNode.name + "*Footsteps'")
		)
		else 
		(
			select $'Bip*'
			deselect $'Bip*Footsteps'
		)
	)

	on btnSelBone pressed do ----é€‰æ‹©bone
	(
		clearselection ()
		for o in objects where (o.ishidden == false) do 
		(
			if classof o == BoneGeometry then selectmore o
		)
	)

	on spiStartTime changed valTime do  --------åˆå§‹å¸§å®šä½åˆ°è¾“å…¥çš„å¸§æ•°
	(		
		local rangeStart = valTime as time
		if ((valTime != ".") and (valTime as time != undefined) and \
		(valTime != "") and (rangeStart < animationrange.end)) then
		(
			animationrange = (interval rangeStart animationrange.end)
		)
		else messageBox "----------------------\r\nè¯·è¾“å…¥æ­£ç¡®å¸§æ•°!"
	)

	on spiEndTime changed valTime do  --------åˆå§‹å¸§å®šä½åˆ°è¾“å…¥çš„å¸§æ•°
	(		
		local rangEnd = valTime as time
		if ((valTime != ".") and (valTime as time != undefined) and \ 
		(valTime != "") and (rangEnd > animationrange.start)) then
		(
			animationrange = (interval animationrange.start rangEnd)
		)
		else messageBox "----------------------\r\nè¯·è¾“å…¥æ­£ç¡®å¸§æ•°!"
	)
	
	on btnFnFrame pressed do  -------------åˆ‡æ¢æ•´æ•°å¸§å°æ•°å¸§,æ–¹ä¾¿æ‹–åŠ¨æ»‘æ¡å¹³æ»‘é¢„è§ˆ
	(
		if timeDisplayMode != #frameTicks then 
		(
			timeDisplayMode = #frameTicks
		)
		else 
		(
			timeDisplayMode = #frames
		)
		slidertime -= 1
		slidertime += 1  ----------é»˜è®¤æ”¹äº†è¦åˆ’ä¸€ä¸‹æ»‘æ¡æ‰ç”Ÿæ•ˆ,è„šæœ¬ç›´æ¥æ“ä½œäº†~~æ²¡æ‰¾åˆ°refreshçš„
	)
	
	on btnMagicBtn pressed do  -------------åˆ‡æ¢æ•´æ•°å¸§å°æ•°å¸§,æ–¹ä¾¿æ‹–åŠ¨æ»‘æ¡å¹³æ»‘é¢„è§ˆ
	(
		fnSwitchMagicBtn switchToolPanel
		fnRefreshMsPanel()
	)

	on ckbPlayBlocking changed state do (
        -- if (selection.count == 0) do (
        --     StopBlocking()
        --     return()
        -- )
		if state then (
            PlayBlocking()
        )
        else (
            StopBlocking()
        )
    )
    
    -- Play Blockingìš© í‹± ì´ë²¤íŠ¸ ì²˜ë¦¬
    on clock tick do (
        if (m_PBPointer > m_PBKeyMiliSecArray.count) do return()
		local now = timeStamp()
		local pointer
		if (m_PBKeyMiliSecArray.count == m_PBPointer) then (
			ReplayBlocking()
			pointer = 1
		)
		else (
			pointer = m_PBStartTime + m_PBKeyMiliSecArray[m_PBPointer + 1]
		)
        
        if ( now > pointer ) do (
            m_PBPointer += 1
            sliderTime = m_PBKeyTimeArray[m_PBPointer]
        )
        
        if (m_PBPointer >= m_PBKeyMiliSecArray.count) do (
            ReplayBlocking()
        )

        if keyboard.escPressed do (
            StopBlocking()
		)
		
		if (sliderTime != m_PBKeyTimeArray[m_PBPointer]) do (
			StopBlocking()
		)
    )

	on btnCSTools pressed do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\Quote" + "\\cstools.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)
	on btnSpringMagic pressed do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\Quote" + "\\SpringMagic_New.mse"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)
	on btnSpringMagic rightclick do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\Quote" + "\\SpringMagic_Old.mse"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on btnFileOpen pressed do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts" + "\\BsOpenTools.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on ckbIsoMesh changed state do
	(
		if state then
		(
			hideByCategory.geometry = false
			hideByCategory.shapes = true
			hideByCategory.lights = true
			hideByCategory.cameras = true
			hideByCategory.helpers = true
			hideByCategory.spacewarps = true
			hideByCategory.particles = true
			hideByCategory.bones = true
		)
		else 
		(
			hideByCategory.shapes = false
			hideByCategory.lights = false
			hideByCategory.cameras = false
			hideByCategory.helpers = false
			hideByCategory.spacewarps = false
			hideByCategory.particles = false
			hideByCategory.bones = false
		)
	)
	on btnBipedTraj pressed do 
	(
		layerTraj = (fnAddTrajLayer "Biped_Trajectories" layerTraj) ----æ˜¯å¦åˆ›å»ºè½¨è¿¹å±‚
		if (selection.count > 1) then
		(
			for i in (selection as array) do
			(
				if classof i == Biped_Object then
				(
					if (getNodeByName ("Traj_" + i.name)) != undefined then 
					(
						fnDeleteTraj i
					)
				)
			)
		)
		else if selection.count == 1 then
		(
			if classof $ == Biped_Object then
				(
					if (getNodeByName ("Traj_" + $.name)) != undefined then 
					(
						fnDeleteTraj $
					)
					else fnAddBipedTraj $
				)
		)
	)

	on btnBipedTraj rightclick do
	(
		delLayerObj = #()

		delLayer    = LayerManager.getLayerFromName "Biped_Trajectories"
		
		if delLayer != undefined then
		(
			layerRT = delLayer.layerAsRefTarg
			delLayerObj = refs.dependents layerRT
			delLayer.lock = off
			for i in delLayerObj where ((delLayerObj.count != 0) and (classof i == point)) do delete i
			LayerManager.deleteLayerByName "Biped_Trajectories"
			delLayerObj = #()
		)
	)

	-- on btnBipedTraj rightclick do
	-- (
	-- 	-- bipedRoot = #()   -------åˆ¤æ–­é€‰æ‹©äº†å‡ ä¸ªbipedéª¨æ¶
	-- 	if (selection.count > 0) then
	-- 	(
	-- 		-- for i in (selection as array) where classof i == Biped_Object do  
	-- 		-- (
	-- 		-- 	appendIfUnique bipedRoot i.controller.rootNode  --æ·»åŠ åˆ°éª¨æ¶æ•°ç»„
	-- 		-- )
	-- 		for i in (selection as array) do 
	-- 		(
	-- 			if (classof i == Biped_Object) then
	-- 			(
	-- 				nodeTemp = i.controller.rootNode
	-- 				trajDisFn = nodeTemp.controller.displayTrajectories
	-- 				if trajDisFn == true then nodeTemp.controller.displayTrajectories = false
	-- 				else nodeTemp.controller.displayTrajectories = true
	-- 				exit
	-- 			)
	-- 		)
	-- 	)
	-- )

	on edtMoveKey entered val do   -----ç§»åŠ¨å¸§æ•°è‡ªå®šä¹‰,è¾“å…¥å³å¯
	(
		if ((val != ".") and (val as time != undefined) and (val != "")) then
		(------"."ä»–ä¹Ÿè®¤ä¸ºæ˜¯æ•°å­—...
			keyMovedOffset = val as integer
			rolBsKeyTools.edtMoveKey.text = keyMovedOffset as string + "f"
		)
		else (print "[BskeyTools] warning: è¯·è¾“å…¥æ­£ç¡®ç§»åŠ¨å¸§æ•°!";edtMoveKey.text = "5f")
	)

	on btnSet5 pressed do 
	(
		edtMoveKey.text = "5f"
		keyMovedOffset = 5
	)

	on btnSet5 rightclick do 
	(
		edtMoveKey.text = "-5f"
		keyMovedOffset = -5
	)

	on btnSetAdd pressed do 
	(
		keyMovedOffset += 5
		edtMoveKey.text = keyMovedOffset as string + "f"
	)

	on btnSetAdd rightclick do 
	(
		keyMovedOffset -= 5
		edtMoveKey.text = keyMovedOffset as string + "f"
	)
	-- on btnSetOpposite pressed do
	-- (
	-- 	keyMovedOffset = - keyMovedOffset
	-- 	edtMoveKey.text = keyMovedOffset as string + "f"
	-- )
	on btnMoveKeys pressed do with undo on   ------ç§»åŠ¨é€‰å®šå¸§
	(
		fnCollectKeys ()
		fnMoveAllKeys keyMovedOffset fnRange:off
	)
	on btnMoveKeys rightclick do with undo on
	(
		fnCollectKeys ()
		fnMoveAllKeys keyMovedOffset fnRange:on
	)
	on btnSelBeforeKeys pressed do  ------------é€‰æ‹©æ»‘æ¡ä¹‹å‰å¸§
	(
		symbol = 0
		fnCollectKeys ()
		if arrLinkKeys.count != 0 then
		(
			for i in arrLinkKeys do i.selected = false
		)
		if arrKeysTime.count != 0 then
		(
			if keyFirst <= sliderTime then 
			(
				fnSelKeys keyFirst sliderTime symbol
			)
			else 
			(
				fnSelKeys sliderTime sliderTime symbol
			)
		)
		else
		(
			if arrLinkKeys.count != 0 then
			(
				if arrLinkKeys[1].time <= sliderTime then 
				(
					fnSelLinkKeys arrLinkKeys[1].time sliderTime symbol
				)
				else 
				(
					fnSelLinkKeys sliderTime sliderTime symbol
				)
			)
		)
	)
	
	on btnSelAfterKeys pressed do  -------------é€‰æ‹©æ»‘æ¡ä¹‹åå¸§
	(
		symbol = 1
		fnCollectKeys ()
		if arrKeysTime.count != 0 then
		(
			if arrLinkKeys.count != 0 then
			(
				for i in arrLinkKeys do i.selected = false
			)
			if keyEnd >= sliderTime then 
			(
				fnSelKeys sliderTime keyEnd symbol
			)
			else 
			(
				fnSelKeys sliderTime sliderTime symbol
			)
		)
		else
		(
			if arrLinkKeys.count != 0 then
			(
				if arrLinkKeys[1].time >= sliderTime then 
				(
					fnSelLinkKeys sliderTime arrLinkKeys[1].time symbol
				)
				else 
				(
					fnSelLinkKeys sliderTime sliderTime symbol
				)
			)
		)
	)
	
	on btnSelAllKeys pressed do     ------------------é€‰æ‹©æ‰€æœ‰å¸§
	(
		symbol = 2
		fnCollectKeys ()
		if arrKeysTime.count != 0 then
		(
			fnSelKeys keyFirst keyEnd symbol
		)
		else
		(
			if arrLinkKeys.count != 0 then
			(
				fnSelLinkKeys arrLinkKeys[1].time arrLinkKeys[arrLinkKeys.count].time symbol
			)
		)
	)
	
	on btnSetFps pressed do popupMenu menuSetFps
		
	on btnSetSpeed pressed do popupMenu menuSetSpeed

	on btnJudgeLinkKey changed state do   --åˆ‡æ¢æ˜¯å¦å‹¾é€‰link
	(
		if btnJudgeLinkKey.state == false then
		(
			if arrLinkKeys.count != 0 then
			(
				for i in arrLinkKeys do i.selected = false
			)
		)
		else fnCollectKeys ()
	)

	on btnCleanOutKeys pressed do with undo on-----------æ¸…ç†èŒƒå›´å¤–å¸§(æ— é™å¸§)
	(
		if (queryBox "æ˜¯å¦æ¸…é™¤èŒƒå›´å¤–å…³é”®å¸§ï¼Ÿ\r\n( Link å¸§è¯·æ‰‹åŠ¨åˆ é™¤ )    " \
		title:"æ˜¯å¦æ¸…é™¤èŒƒå›´å¤–å…³é”®å¸§ï¼Ÿ" beep:false) then
		(
			if (selection as array).count == 0 then 
			(
				for tempObject in (objects as Array) do fnCleanOutRangeKeys tempObject
			)
			else
			(
				for tempObject in (selection as Array) do fnCleanOutRangeKeys tempObject
			)
			messagebox "æ¸…ç†æˆåŠŸï¼    " beep:false
		)
	)

	on btnDelOutKeys pressed do with undo on-----------æ¸…ç†é€‰æ‹©å¸§
	(
		if (queryBox "æ˜¯å¦æ¸…é™¤æ‰€æœ‰å¸§ï¼Ÿ\r\n( Link å¸§è¯·æ‰‹åŠ¨åˆ é™¤ )    " \
		title:"æ˜¯å¦æ¸…é™¤æ‰€æœ‰å¸§" beep:false) then
		(
			actionMan.executeAction 0 "40021"  -- Selection: Select All
			fnCollectKeys ()
			fnSelKeys keyFirst keyEnd 2
			fnDelSelKeys ()
			if arrLinkKeys.count != 0 then (
				fnSelLinkKeys arrLinkKeys[1].time arrLinkKeys[arrLinkKeys.count].time 2
			)
		)
	)

	on ckbHideBones changed state do
	(
		if state == false then
		(
			for o in geometry as array where (classof o == BoneGeometry and o.layer.ishidden != true) do o.isHidden = false
			rolBsKeyTools.ckbHideBones.text = "éšBone"
		)
		else
		(
			arrHiddenBones = #()
			for o in geometry as array where (classof o == BoneGeometry) do o.isHidden = true
			rolBsKeyTools.ckbHideBones.text = "æ˜¾Bone"
		)
	)
	
	on ckbHideBiped changed state do
	(
		if state == false then
		(
			for o in geometry as array where (classof o == Biped_Object and o.layer.ishidden != true) do o.isHidden = false
			rolBsKeyTools.ckbHideBiped.text = "éšBip"
		)
		else
		(
			arrHiddenBones = #()
			for o in geometry as array where (classof o == Biped_Object) do o.isHidden = true
			rolBsKeyTools.ckbHideBiped.text = "æ˜¾Bip"
		)
	)

	on ckbFreezeMesh changed state do 
	(
		if state == on then
		(
			rolBsKeyTools.ckbFreezeMesh.text = "è§£æ¨¡å‹"
			for o in objects where (((classof o == Editable_mesh) \
			or (classof o == Editable_Poly) or (classof o == PolyMeshObject)) \
			and (o.isHidden == false)) do
			(
				freeze o
				o.showFrozenInGray = off
			)
		)
		else
		(
			rolBsKeyTools.ckbFreezeMesh.text = "å†»æ¨¡å‹"
			for o in objects where (((classof o == Editable_mesh) \
			or (classof o == Editable_Poly) or (classof o == PolyMeshObject)) \
			and (o.isHidden == false)) do
			(
				unfreeze o
				o.showFrozenInGray = off
			)
		)
	)

	on btnQuicksave pressed do 
	(
		if maxFilePath == "" then 
		(
			messagebox "------------------------------------\r\nå½“å‰åœºæ™¯æœªä¿å­˜è¿‡,\r\nè¯·å…ˆä¿å­˜åˆå§‹ç‰ˆæœ¬~"
			max file saveas
		)
		else fnQuickSave ()
	)

	on btnQuicksave rightclick do (max file saveas)

	on btnCutFrameDisplay pressed do with undo on  ---------------å¸§æ æ˜¾ç¤ºé€‰å®šå¸§èŒƒå›´
	(
		if switchSelKeyRange == 0 then
		(
			fnCollectKeys ()
			arrLastSelRange = #(animationrange.start,animationrange.end)
			fnCutDisplayKeyRange keySelFirst keySelEnd
			switchSelKeyRange = 1
		)
		else 
		(
			animationrange = interval arrLastSelRange[1] arrLastSelRange[2]
			switchSelKeyRange = 0
			arrLastSelRange = #()
		)
	)
	on btnAllFrameDisplay pressed do with undo on  ---------------å¸§æ æ˜¾ç¤ºé¦–å°¾å¸§èŒƒå›´
	(
		if switchAllKeyRange == 0 then
		(
			fnCollectKeys ()
			arrLastAllRange = #(animationrange.start,animationrange.end)
			fnCutDisplayKeyRange keyFirst keyEnd
			switchAllKeyRange = 1
		)
		else 
		(
			animationrange = interval arrLastAllRange[1] arrLastAllRange[2]
			switchAllKeyRange = 0
			arrLastAllRange = #()
		)
	)

	-- on btnZeroFrameDisplay pressed do with undo on  ---------------å¸§æ æ˜¾ç¤º0å¸§
	-- (
	-- 	animationrange = interval 0f animationrange.end
	-- )

	------------åˆ‡æ¢å·¥å…·æ åˆ†ç±»--------------------------------------------
	on ckbC1 changed state do 
	(
		if state == true then 
		(
			fnSwitchToolBtnChecked 1
			fnSwitchToolsBtn 1
		)
		else ckbC1.checked = true
	)
	on ckbC2 changed state do 
	(
		if state == true then 
		(
			fnSwitchToolBtnChecked 2
			fnSwitchToolsBtn 2
		)
		else ckbC2.checked = true
	)
	on ckbC3 changed state do 
	(
		if state == true then 
		(
			fnSwitchToolBtnChecked 3
			fnSwitchToolsBtn 3
		)
		else ckbC3.checked = true
	)
	on ckbC4 changed state do 
	(
		if state == true then 
		(
			fnSwitchToolBtnChecked 4
			fnSwitchToolsBtn 4
		)
		else ckbC4.checked = true
	)
	on ckbSwitchMyScripts changed state do 
	(
		if state then switchMSPanel = 1 else switchMSPanel = 0
		fnRefreshMsPanel()
	)
	--------------------------------------------------------------------

	on btnFnTCB pressed do 
	(
		for i in selection where classof i == BoneGeometry do
		(
			if classof i.rotation.controller == tcb_rotation then
				(i.rotation.controller = Euler_XYZ ())
				else (i.rotation.controller = tcb_rotation ())
		)
	)

	on btnImageComp pressed do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\Quote" + "\\ImageCompHelper.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)
	
	on btnFnKeyType pressed do 
	(
		try(destroydialog rolFnKeys)catch()
		Createdialog rolFnKeys  fgcolor:myFgColor \
		pos:[mouse.screenpos.x,mouse.screenpos.y]
	)

	on btnEulerFilter pressed do 
	(
		for i in selection where classof i == BoneGeometry do
		(
			if classof i.rotation.controller == Euler_XYZ then
			(
				i.rotation.controller = tcb_rotation ()
				i.rotation.controller = Euler_XYZ ()
			)
		)
	)

	on ckbFnBoxDisplay changed state do 
	(
		if state == on then ckbFnBoxDisplay.text = "å®ä½“"
				else ckbFnBoxDisplay.text = "BOXæ˜¾"
		for o in Geometry where (o.isHidden == false) do 
		(
			if ((classof o == BoneGeometry) or (classof o == Biped_Object)) then
			(
				if state == on then o.boxmode = on 
				else o.boxmode = off
			)
		)
	)
	
	on ckbFnMtlDisplay changed state do 
	(
		if state == off then
		(
			-- for mat in (getClassInstances vrayMtl processAllAnimatables:true) do showTextureMap mat on
			for mat in (getClassInstances standard processAllAnimatables:true) do showTextureMap mat on
		)
		else
		(
			-- for mat in (getClassInstances vrayMtl processAllAnimatables:true) do showTextureMap mat off
			for mat in (getClassInstances standard processAllAnimatables:true) do showTextureMap mat off
		)
	)

	on ckbFnMtlDisplay rightclick do 
	(
		local disp = NitrousGraphicsManager.GetActiveViewportSetting() 
		if disp.VisualStyleMode == #clay then disp.VisualStyleMode = #Realistic
		else disp.VisualStyleMode =  #clay
	)

	on btnMopherSlider pressed do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\Quote" + "\\MorphSliders_11.ms")
		macros.run "Tools" "MorphSliders")
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on btnLayerManager pressed do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\Quote" + "\\LayerManagerAlternative.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on btnAnimMirror pressed do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\Quote" + "\\åŠ¨ç”»é•œåƒå·¥å…·.mse"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on btnMyScripts1 pressed do 
	(
		if ((iniArrMyScripts[1] != undefined) and (doesfileexist iniArrMyScripts[1].dir)) then 
		(
			fileIn iniArrMyScripts[1].dir
		)
		else fnAddMyScript btnMyScripts1 1
	)
	on btnMyScripts2 pressed do 
	(
		if ((iniArrMyScripts[2] != undefined) and (doesfileexist iniArrMyScripts[2].dir)) then 
		(
			fileIn iniArrMyScripts[2].dir
		)
		else fnAddMyScript btnMyScripts2 2
	)
	on btnMyScripts3 pressed do 
	(
		if ((iniArrMyScripts[3] != undefined) and (doesfileexist iniArrMyScripts[3].dir)) then 
		(
			fileIn iniArrMyScripts[3].dir
		)
		else fnAddMyScript btnMyScripts3 3
	)
	on btnMyScripts4 pressed do 
	(
		if ((iniArrMyScripts[4] != undefined) and (doesfileexist iniArrMyScripts[4].dir)) then 
		(
			fileIn iniArrMyScripts[4].dir
		)
		else fnAddMyScript btnMyScripts4 4
	)
	on btnMyScripts5 pressed do 
	(
		if ((iniArrMyScripts[5] != undefined) and (doesfileexist iniArrMyScripts[5].dir)) then 
		(
			fileIn iniArrMyScripts[5].dir
		)
		else fnAddMyScript btnMyScripts5 5
	)
	on btnMyScripts6 pressed do 
	(
		if ((iniArrMyScripts[6] != undefined) and (doesfileexist iniArrMyScripts[6].dir)) then 
		(
			fileIn iniArrMyScripts[6].dir
		)
		else fnAddMyScript btnMyScripts6 6
	)
	on btnMyScripts7 pressed do 
	(
		if ((iniArrMyScripts[7] != undefined) and (doesfileexist iniArrMyScripts[7].dir)) then 
		(
			fileIn iniArrMyScripts[7].dir
		)
		else fnAddMyScript btnMyScripts7 7
	)
	on btnMyScripts8 pressed do 
	(
		if ((iniArrMyScripts[8] != undefined) and (doesfileexist iniArrMyScripts[8].dir)) then 
		(
			fileIn iniArrMyScripts[8].dir
		)
		else fnAddMyScript btnMyScripts8 8
	)

	on btnMyScripts1 rightclick do 
	(
		try(destroydialog rolAddMyScripts)catch()
		createDialog rolAddMyScripts fgcolor:myFgColor \
		pos:[mouse.screenpos.x - 150,mouse.screenpos.y +20]
	)
	on btnMyScripts2 rightclick do 
	(
		try(destroydialog rolAddMyScripts)catch()
		createDialog rolAddMyScripts fgcolor:myFgColor \
		pos:[mouse.screenpos.x - 150,mouse.screenpos.y + 20]
	)
	on btnMyScripts3 rightclick do 
	(
		try(destroydialog rolAddMyScripts)catch()
		createDialog rolAddMyScripts fgcolor:myFgColor\
		pos:[mouse.screenpos.x - 150,mouse.screenpos.y + 20]
	)
	on btnMyScripts4 rightclick do 
	(
		try(destroydialog rolAddMyScripts)catch()
		createDialog rolAddMyScripts fgcolor:myFgColor\
		pos:[mouse.screenpos.x - 150,mouse.screenpos.y + 20]
	)
	on btnMyScripts5 rightclick do 
	(
		try(destroydialog rolAddMyScripts)catch()
		createDialog rolAddMyScripts fgcolor:myFgColor\
		pos:[mouse.screenpos.x - 150,mouse.screenpos.y + 20]
	)
	on btnMyScripts6 rightclick do 
	(
		try(destroydialog rolAddMyScripts)catch()
		createDialog rolAddMyScripts fgcolor:myFgColor\
		pos:[mouse.screenpos.x - 150,mouse.screenpos.y + 20]
	)
	on btnMyScripts7 rightclick do 
	(
		try(destroydialog rolAddMyScripts)catch()
		createDialog rolAddMyScripts fgcolor:myFgColor\
		pos:[mouse.screenpos.x - 150,mouse.screenpos.y + 20]
	)
	on btnMyScripts8 rightclick do 
	(
		try(destroydialog rolAddMyScripts)catch()
		createDialog rolAddMyScripts fgcolor:myFgColor\
		pos:[mouse.screenpos.x - 150,mouse.screenpos.y + 20]
	)

	on btnHideUnSel pressed do 
	(
		local arrTempSelObj = #()
		local arrTemp = objects as array
		local arrTempAllObj = for o in arrTemp where o.isHidden == false collect o
		local numTempCurrentSel = selection.count
		if arrTempAllObj.count > numTempCurrentSel then
		(
			if numTempCurrentSel != 0 then 
			(
				arrTempSelObj = selection as array
			)
			for i in arrTempSelObj where (arrTempSelObj.count != 0) do
			(
				num = finditem arrTempAllObj i
				if num != 0 then deleteItem arrTempAllObj num
			)
			arrTempUnSelection = arrTempAllObj
			actionMan.executeAction 0 "281"
		)
	)

	on btnHideUnSel rightclick do
	(
		if arrTempUnSelection.count != 0 then
		(
			for i in arrTempUnSelection do i.isHidden = false
		)
	)

	on btnQuickPrev pressed do 
	(
		createPreview percentSize:100 \
		dspGeometry:true dspShapes:false dspLights:false \
		dspCameras:false dspHelpers:false dspParticles:true dspBones:false \
		dspGrid:true dspSafeFrame:false dspFrameNums:false dspBkg:true \
		rndLevel:#smoothhighlights
	)

	on btnQuickPrev rightclick do (shellLaunch (getdir #preview) "")

	on btnSelByColor pressed do
	(
		for i in selection as array where (i.ishidden == false) do
		(
			for o in objects as array where (i.ishidden == false) do
			(
				if o.wirecolor == i.wirecolor then selectmore o
			)
		)
	)

	on btnBipedScale pressed do (fnBipedScale ())

	on btnBatchExport pressed do 
	(
		messageBox "å¾…æ·»åŠ ...         \r\n" beep:false
	)

	on btnColorTools pressed do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\Quote\\ProColor.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on btnAnimCopyPaste pressed do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\Quote\\CPTools.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on btnPoseTool pressed do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\BsRefTools.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on btnTrajedit pressed do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\Quote\\DTrajEdit.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on btnTrackBarTools pressed do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts" + "\\BsTrackBarTools.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on ckbShadowCut changed state do
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\Quote\\Silhouette.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on btnRenameTools pressed do
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\Quote\\P_ObjectRenamer.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on btnWinbox pressed do
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\Quote\\WinBox.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on btnCameraFromView pressed do
	(
		If (viewport.Gettype() == #view_persp_user) and (not theHold.Holding()) then 
		(
			if ((maxVersion())[1] < 18000) then (macros.run "Lights and Cameras" "Camera_CreateFromView")
			else(macros.run "Lights and Cameras" "StandardCamera_CreateFromView")
		)
		else (messagebox "è¯·æŒ‰â€œPâ€åœ¨è‡ªç”±è§†è§’åˆ›å»ºï¼Œä¹‹åå¯èƒ½ä¼˜åŒ–ä¸ºä»»æ„è§†è§’~                \r\n" beep:false)
	)

	on btnMeshToBone pressed do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\Quote\\AnimMeshToBonesAnim.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on btnLightTable pressed do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\Quote\\LightTable.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on btnCutSequence pressed do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\Quote\\AnimaRange.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on btnEndBone pressed do 
	(
		local tempLayerBoneEnd
		if (LayerManager.getLayerFromName "tempBoneEndAll") != undefined then
		(tempLayerBoneEnd = LayerManager.getLayerFromName "tempBoneEndAll")
		else (tempLayerBoneEnd = LayerManager.newLayerFromName "tempBoneEndAll")
		if selection.count != 0 then with undo on 
		(
			arrSel = selection as array
			for i in 1 to arrSel.count do
			(
				tempChild = execute ("$'" + arrSel[i].name + "'/...*")
				if (tempChild[tempChild.count] != undefined) then 
				(
					parentBone = tempChild[tempChild.count]
				)
				else (parentBone  = arrSel[i])
				parentTrans = parentBone.transform
				parentPos   = parentTrans.translation
		
				newBone = BoneSys.createBone parentPos (parentPos+6) parentBone.dir
				newBone.transform = parentTrans
				newBone.taper     = 90
		
				if iskindof arrSel[i] BoneGeometry==true do 
				(
					in coordSys Local move newBone [parentBone.length,0,0]
					newBone.parent    = parentBone
					newBone.width     = parentBone.width
					newBone.height    = parentBone.height
					newBone.length    = (parentBone.width+parentBone.height)/2
					newBone.wirecolor = parentBone.wirecolor
				)
				append arrBoneEndAll newBone
				tempLayerBoneEnd.addNode newBone
			)
			messageBox "æ³¨æ„ï¼š\r\n\r\nç‚¹ç¡®å®šå®Œæˆæ·»åŠ ï¼Œ\r\n\r\nä¼šåˆ›å»ºæ–°å±‚å­˜æ”¾æœ«ç«¯ï¼Œ\r\n\r\né‡å¯è½¯ä»¶åæ— æ³•å›é€€ï¼Œ\r\n\r\nå¯ç‚¹å‡»å³é”®æˆ–æ‰‹åŠ¨æ¸…é™¤ä¹‹å‰æ·»åŠ çš„æœ«ç«¯ï¼Œ\r\n\r\nï¼ˆåœ¨ tempBoneEndAll å±‚ä¸­ï¼‰                                     "
		)
		else (messagebox "è¯·é€‰æ‹©è¦æ·»åŠ æœ«ç«¯çš„ Bone éª¨éª¼~                    " beep:false)
	)

	on btnEndBone rightclick do with undo on
	(
		if (LayerManager.getLayerFromName "tempBoneEndAll") != undefined then
		(
			tempLayerBoneEnd = LayerManager.getLayerFromName "tempBoneEndAll"
			tempLayerBoneEnd.nodes &arrLayerNodeTemp
			for i in arrLayerNodeTemp do delete i
			(LayerManager.getLayer 0).current = true
			LayerManager.deleteLayerByName "tempBoneEndAll"
			arrBoneEndAll = #()
			messagebox "ç‚¹ç¡®å®šæ¸…ç†æ·»åŠ çš„éª¨éª¼æœ«ç«¯ (åœ¨ tempBoneEndAll å±‚ä¸­çš„éª¨éª¼) ~          "
		)
	)

	on btnHideBipedTwists pressed do (fnGetAllBipedTwist())

	on btnDelDecimalKeys pressed do 
	(
		fnCollectKeys ()
		fnDelAllDecimalKeys arrBlockingKeys
		(messagebox "å·²æ¸…ç†æ‰€æœ‰å°æ•°å¸§ï¼ŒLinkå¸§è¯·è‡ªè¡Œæ¸…ç†                    " beep:false)
	)

	on btnRescaleWU pressed do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\BsBatchRescaleWU.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on btnRescaleWU rightclick do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\Quote\\RescaleWU.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on btnSkinTools pressed do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\Quote\\SkinTools.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on btnKeyStepMode pressed do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\BsKeyStepMode.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on btnSelectionsetTools pressed do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\BsSelSetTools.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)
	on btnXrSkinTool pressed do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\Quote\\Xr_SkinTool.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on btnRetargetTools pressed do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\BsRetargetTools.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)

	on btnCombineDetachSkin pressed do 
	(
		try(FileIn ((getDir #scripts) + "\\BulletScripts\\Quote\\Rigging_CombineSkin.ms"))
		catch(messagebox "æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½è„šæœ¬é”™è¯¯æˆ–å®‰è£…ä¸å®Œå…¨ï¼Œ\r\n\r\nå»ºè®®æŸ¥çœ‹è®¾ç½®ä¸­çš„å¸®åŠ©æˆ–é‡æ–°å®‰è£…ï¼Œè¿˜æœ‰é—®é¢˜çƒ¦è¯·è”ç³»æˆ‘...                            " beep:false)
	)
)
if (iniPos != 0) then (Createdialog rolBsKeyTools fgcolor:myFgColor pos:iniPos style:#())
else (Createdialog rolBsKeyTools fgcolor:myFgColor style:#())

fn fnBsUpdateTimeRange = 
(
	rolBsKeyTools.spiStartTime.value = (animationRange.start.frame as integer)   
	rolBsKeyTools.spiEndTime.value = (animationRange.end.frame as integer)
)
callbacks.addScript #animationRangeChange "fnBsUpdateTimeRange()" id:#UpdateTimeRange
callbacks.addScript #filePostOpen "fnBsRefFps()" id:#UpdateFps
gc()
clearListener()  ---------æ¸…é™¤ä¾¦å¬å™¨