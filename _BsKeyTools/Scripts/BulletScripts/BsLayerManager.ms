-- BsLayerManager v1.0
-- Layer é¢„è®¾ç®¡ç†å™¨ - æ”¯æŒåŠ¨æ€å­—æ®µå’Œé¢„è®¾ä¿å­˜
-- ä½œè€…: Bullet.S
-- åŠŸèƒ½: åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ã€åŠ è½½layeré¢„è®¾ï¼Œæ”¯æŒ{AAA},{BBB}ç­‰åŠ¨æ€å­—æ®µ

try(destroyDialog rolBsLayerManager)catch()

global rolBsLayerManager
global offsetBsLayerManager = [0,0]
global dragStateBsLayerManager = off
global BsLayerManagerConfig = execute ("@\"" + (getDir #maxData) + "\\BsLayerManagerConfig.ini\"")

-- é¢„è®¾æ•°æ®ç»“æ„
struct LayerPreset (
    name,
    layerStructure,
    fieldNames,
    description
)

-- å…¨å±€å˜é‡
global arrLayerPresets = #()
global currentPreset = undefined
global currentPresetIndex = 0
global arrFieldValues = #()
global arrFieldOptions = #("Name", "Type", "Part", "LOD", "Mat") -- å¯æ’å…¥çš„å­—æ®µé€‰é¡¹

(
    rollout rolBsLayerManager "BsLayerManager å±‚é¢„è®¾ç®¡ç†å™¨ v1.0" width:720 height:490
    (
        -- çª—å£æ ‡é¢˜å’Œå…³é—­æŒ‰é’®
        button btnAbout "?" pos:[rolBsLayerManager.width - 40,0] height:16 width:20 tooltip:"å…³äº"
        button btnClose "Ã—" pos:[rolBsLayerManager.width - 20,0] height:16 width:20 tooltip:"å…³é—­"
        label lblTitle rolBsLayerManager.title pos:[5,3] color:[70,130,180]
        
        -- é¡¶éƒ¨å·¥å…·æ  - ä½¿ç”¨å†…ç½®å›¾æ ‡
        groupBox gpbToolbar "" pos:[5,20] width:710 height:35
        button btnNewPreset "â•æ–°å»º" pos:[15,30] width:50 height:20 tooltip:"åˆ›å»ºæ–°é¢„è®¾"
        button btnCopyPreset "ğŸ“‹å¤åˆ¶" pos:[70,30] width:50 height:20 tooltip:"å¤åˆ¶é¢„è®¾"
        button btnDeletePreset "ğŸ—‘åˆ é™¤" pos:[125,30] width:50 height:20 tooltip:"åˆ é™¤é¢„è®¾"
        button btnSaveConfig "ğŸ’¾ä¿å­˜" pos:[180,30] width:50 height:20 tooltip:"ä¿å­˜é…ç½®"
        button btnExportPresets "ğŸ“¤å¯¼å‡º" pos:[235,30] width:50 height:20 tooltip:"å¯¼å‡ºæ‰€æœ‰é¢„è®¾åˆ°æ–‡ä»¶"
        button btnLoadConfig "ğŸ“¥å¯¼å…¥" pos:[290,30] width:50 height:20 tooltip:"ä»é¢„è®¾æ–‡ä»¶å¯¼å…¥"
        button btnCreateLayers "ğŸš€ ç”Ÿæˆ Layers" pos:[600,30] width:110 height:20 tooltip:"ä½¿ç”¨å½“å‰å­—æ®µå€¼ç”ŸæˆLayerç»“æ„"
        
        -- å·¦åˆ—ï¼šé¢„è®¾åˆ—è¡¨åŒºåŸŸ (æ”¶çª„1/3) - è°ƒæ•´groupBoxä½ç½®å‘ä¸Šç§»åŠ¨
        groupBox gpbPresetList "é¢„è®¾åˆ—è¡¨" pos:[5,60] width:155 height:420
        
        -- é¢„è®¾ç¼–è¾‘åŒºåŸŸ - ç§»åˆ°é¢„è®¾åˆ—è¡¨ä¸Šæ–¹
        editText txtPresetName "" pos:[12,80] width:90 height:16 text:""
        button btnUpdatePreset "é‡å‘½å" pos:[108,80] width:42 height:16 tooltip:"æ›´æ–°é¢„è®¾åç§°"
        
        listBox lstPresets "" pos:[15,100] width:135 height:20
        
        -- é¢„è®¾æè¿°ç¼–è¾‘åŒºåŸŸ - è°ƒæ•´ä½ç½®
        editText txtPresetDesc "" pos:[10,375] width:140 height:80 readOnly:false
        button btnUpdateDesc "æ›´æ–°æè¿°" pos:[12,460] width:140 height:16 tooltip:"æ›´æ–°é¢„è®¾æè¿°"
        
        -- ä¸­åˆ—ï¼šé…ç½®åŒºåŸŸ
        groupBox gpbConfig "Layerç»“æ„ç¼–è¾‘" pos:[170,60] width:280 height:420
        
        -- Layerç»“æ„æ¨¡æ¿ç¼–è¾‘åŒºåŸŸ (å®Œå…¨æ‰©å±•)
        editText txtLayerName "Layer:" pos:[180,85] width:200 height:16 text:"00_{Name}_Master" tooltip:"å¯ä½¿ç”¨{å­—æ®µå}ä½œä¸ºå ä½ç¬¦"
        button btnAddLayer "+" pos:[390,85] width:25 height:20 tooltip:"æ·»åŠ Layer"
        button btnRemoveLayer "-" pos:[420,85] width:25 height:20 tooltip:"åˆ é™¤é€‰ä¸­Layer"
        button btnMoveUp "â†‘" pos:[425,140] width:20 height:80 tooltip:"ä¸Šç§»"
        button btnMoveDown "â†“" pos:[425,220] width:20 height:80 tooltip:"ä¸‹ç§»"
        
        -- å­—æ®µæ’å…¥è¾…åŠ©æ§ä»¶
        label lblFieldInsert "æ’å…¥å­—æ®µ:" pos:[180,115] width:70 height:16
        dropDownList ddlFieldInsert "" pos:[245,113] width:100 height:18 items:#("Name", "Type", "Part", "LOD", "Mat") tooltip:"é€‰æ‹©è¦æ’å…¥çš„å­—æ®µ"
        button btnInsertField "æ’å…¥" pos:[355,113] width:40 height:18 tooltip:"æ’å…¥é€‰ä¸­å­—æ®µåˆ°Layeråç§°"
        button btnAddToList "+" pos:[400,113] width:20 height:18 tooltip:"æ·»åŠ æ–°çš„å­—æ®µé€‰é¡¹"
        button btnRemoveFromList "-" pos:[425,113] width:20 height:18 tooltip:"åˆ é™¤é€‰ä¸­çš„å­—æ®µé€‰é¡¹"
        
        listBox lstLayerStructure "" pos:[180,140] width:240 height:12
        
        -- å³åˆ—ï¼šå­—æ®µå€¼ç®¡ç†åŒºåŸŸ
        groupBox gpbFieldValues "å­—æ®µå€¼ç®¡ç†" pos:[460,60] width:255 height:420
        
        -- é¢„è§ˆåŒºåŸŸ
        label lblPreviewTitle "é¢„è§ˆ:" pos:[470,80] width:50 height:16
        editText txtPreview "" pos:[470,100] width:235 height:370 readOnly:true
        
        -- å¯æ»šåŠ¨çš„å­—æ®µåˆ—è¡¨åŒºåŸŸ (æ”¯æŒæ›´å¤šå­—æ®µ)
        listBox lstFieldValues "å­—æ®µåˆ—è¡¨:" pos:[180,305] width:240 height:7
        button btnRefreshFields "ğŸ”„" pos:[425,320] width:20 height:95 tooltip:"åˆ·æ–°å­—æ®µåˆ—è¡¨"
        
        -- å½“å‰é€‰ä¸­å­—æ®µçš„ç¼–è¾‘åŒºåŸŸ
        editText txtFieldName "å­—æ®µå:" pos:[180,430] width:160 height:16 text:""
        editText txtFieldValue "å­—æ®µå€¼:" pos:[180,455] width:160 height:16 text:""
        button btnUpdateField "é…ç½®å­—æ®µå€¼" pos:[355,430] width:80 height:18 tooltip:"æ›´æ–°å­—æ®µ"
        button btnDeleteField "åˆ é™¤å­—æ®µ" pos:[355,455] width:80 height:18 tooltip:"åˆ é™¤å­—æ®µ"
        
        -- çª—å£æ‹–æ‹½
        on rolBsLayerManager lbuttondown posMou do
        (
            setSysCur #move
            offsetBsLayerManager = posMou
            dragStateBsLayerManager = on
        )
        
        on rolBsLayerManager lbuttonup posMou do (dragStateBsLayerManager = off)
        
        on rolBsLayerManager mouseMove pos do
        (
            if dragStateBsLayerManager == on then
                SetDialogPos rolBsLayerManager (mouse.screenpos - offsetBsLayerManager)
        )
        
        -- ä»Layerç»“æ„ä¸­æå–å­—æ®µå
        fn fnExtractFieldsFromStructure =
        (
            local extractedFields = #()
            if currentPreset != undefined and currentPreset.layerStructure.count > 0 then
            (
                for layerInfo in currentPreset.layerStructure do
                (
                    local layerName = layerInfo[1]
                    
                    -- ä½¿ç”¨å¾ªç¯æ–¹å¼æŸ¥æ‰¾æ‰€æœ‰ {å­—æ®µå} æ ¼å¼çš„å ä½ç¬¦
                    local pos = 1
                    local maxLoop = 50 -- é˜²æ­¢æ— é™å¾ªç¯
                    local loopCount = 0
                    
                    while pos <= layerName.count and loopCount < maxLoop do
                    (
                        loopCount += 1
                        -- ä»å½“å‰ä½ç½®å¼€å§‹æŸ¥æ‰¾
                        local searchStr = substring layerName pos -1
                        local openPos = findString searchStr "{"
                        if openPos == undefined then exit
                        
                        -- è½¬æ¢ä¸ºåŸå­—ç¬¦ä¸²ä¸­çš„ç»å¯¹ä½ç½®
                        openPos = openPos + pos - 1
                        
                        -- ä»å¼€æ‹¬å·åå¼€å§‹æŸ¥æ‰¾é—­æ‹¬å·
                        local closeSearchStr = substring layerName (openPos + 1) -1
                        local closePos = findString closeSearchStr "}"
                        if closePos == undefined then exit
                        
                        -- è½¬æ¢ä¸ºåŸå­—ç¬¦ä¸²ä¸­çš„ç»å¯¹ä½ç½®
                        closePos = closePos + openPos
                        
                        if closePos > openPos + 1 then
                        (
                            local fieldName = substring layerName (openPos + 1) (closePos - openPos - 1)
                            if fieldName != "" and findItem extractedFields fieldName == 0 then
                                append extractedFields fieldName
                        )
                        
                        pos = closePos + 1
                    )
                )
            )
            return extractedFields
        )
        
        -- é˜²æ­¢å¾ªç¯æ›´æ–°çš„æ ‡å¿—
        global updatingUI = false
        
        -- è·å–å­—æ®µå€¼æ•°ç»„
        fn fnGetFieldValues =
        (
            return arrFieldValues
        )
        
        -- å­—æ®µå€¼ç®¡ç†
        fn fnUpdateFieldValuesList =
        (
            if updatingUI then return false
            
            -- è‡ªåŠ¨ä»Layerç»“æ„æå–å­—æ®µ
            local extractedFields = fnExtractFieldsFromStructure()
            
            -- æ›´æ–°å½“å‰é¢„è®¾çš„å­—æ®µåˆ—è¡¨
            if currentPreset != undefined then
                currentPreset.fieldNames = extractedFields
            
            local fieldDisplay = #()
            if extractedFields.count > 0 then
            (
                for i = 1 to extractedFields.count do
                (
                    local fieldName = extractedFields[i]
                    local fieldValue = ""
                    
                    -- è·å–å¯¹åº”çš„å­—æ®µå€¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if i <= arrFieldValues.count then
                        fieldValue = arrFieldValues[i]
                    
                    local displayText = fieldName + " = \"" + fieldValue + "\""
                    append fieldDisplay displayText
                )
            )
            lstFieldValues.items = fieldDisplay
            return true
        )
        
        -- å¼ºåˆ¶åˆ·æ–°å­—æ®µåˆ—è¡¨ï¼ˆä¸å—updatingUIæ ‡å¿—å½±å“ï¼‰
        fn fnForceUpdateFieldList =
        (
            -- è‡ªåŠ¨ä»Layerç»“æ„æå–å­—æ®µ
            local extractedFields = fnExtractFieldsFromStructure()
            
            -- æ›´æ–°å½“å‰é¢„è®¾çš„å­—æ®µåˆ—è¡¨
            if currentPreset != undefined then
                currentPreset.fieldNames = extractedFields
            
            local fieldDisplay = #()
            if extractedFields.count > 0 then
            (
                for i = 1 to extractedFields.count do
                (
                    local fieldName = extractedFields[i]
                    local fieldValue = ""
                    
                    -- è·å–å¯¹åº”çš„å­—æ®µå€¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if i <= arrFieldValues.count then
                        fieldValue = arrFieldValues[i]
                    
                    local displayText = fieldName + " = \"" + fieldValue + "\""
                    append fieldDisplay displayText
                )
            )
            lstFieldValues.items = fieldDisplay
            
            -- åŒæ—¶æ›´æ–°é¢„è§ˆ
            if currentPreset != undefined then
            (
                local previewText = "é¢„è®¾: " + currentPreset.name + "\n\n"
                
                -- è·å–å­—æ®µå€¼
                local fieldValues = fnGetFieldValues()
                local hasValues = false
                for val in fieldValues do
                    if val != "" then (hasValues = true; exit)
                
                if currentPreset.layerStructure.count > 0 then
                (
                    previewText += "ç”Ÿæˆçš„Layerç»“æ„:\r\n\r\n"
                    for layerInfo in currentPreset.layerStructure do
                    (
                        local layerName = layerInfo[1]
                        -- å¦‚æœæœ‰å­—æ®µå€¼ï¼Œè¿›è¡Œæ›¿æ¢
                        if hasValues and currentPreset.fieldNames != undefined then
                        (
                            for i = 1 to currentPreset.fieldNames.count do
                            (
                                if i <= fieldValues.count and fieldValues[i] != "" then
                                    layerName = substituteString layerName ("{" + currentPreset.fieldNames[i] + "}") fieldValues[i]
                            )
                        )
                        previewText += layerName + "\n"
                    )
                )
                else
                (
                    previewText += "æš‚æ— Layerç»“æ„\nè¯·åœ¨å·¦ä¾§ç¼–è¾‘åŒºåŸŸæ·»åŠ Layer"
                )
                
                txtPreview.text = previewText
            )
            
            return true
        )
        
        -- è®¾ç½®å­—æ®µå€¼
        fn fnSetFieldValue index value =
        (
            -- ç¡®ä¿æ•°ç»„è¶³å¤Ÿé•¿
            while arrFieldValues.count < index do
                append arrFieldValues ""
            arrFieldValues[index] = value
            
            -- æ›´æ–°å­—æ®µåˆ—è¡¨å’Œé¢„è§ˆ
            fnUpdateFieldValuesList()
            fnForceUpdateFieldList()
        )
        
        -- UIæ›´æ–°å‡½æ•°
        fn fnUpdateUI =
        (
            if updatingUI then return false
            updatingUI = true
            
            try
            (
                if currentPreset != undefined then
                (
                    txtPresetName.text = currentPreset.name
                    txtPresetDesc.text = currentPreset.description
                    
                    -- æ›´æ–°Layerç»“æ„æ¨¡æ¿åˆ—è¡¨
                    local structureDisplay = #()
                    for layerInfo in currentPreset.layerStructure do
                        append structureDisplay layerInfo[1]
                    lstLayerStructure.items = structureDisplay
                    
                    -- æ›´æ–°å­—æ®µå€¼åˆ—è¡¨
                    fnUpdateFieldValuesList()
                    
                    -- æ›´æ–°é¢„è§ˆ
                    local previewText = "é¢„è®¾: " + currentPreset.name + "\n\n"
                    
                    -- è·å–å­—æ®µå€¼
                    local fieldValues = fnGetFieldValues()
                    local hasValues = false
                    for val in fieldValues do
                        if val != "" then (hasValues = true; exit)
                    
                    if currentPreset.layerStructure.count > 0 then
                    (
                        previewText += "ç”Ÿæˆçš„Layerç»“æ„:\r\n\r\n"
                        for layerInfo in currentPreset.layerStructure do
                        (
                            local layerName = layerInfo[1]
                            -- å¦‚æœæœ‰å­—æ®µå€¼ï¼Œè¿›è¡Œæ›¿æ¢
                            if hasValues and currentPreset.fieldNames != undefined then
                            (
                                for i = 1 to currentPreset.fieldNames.count do
                                (
                                    if i <= fieldValues.count and fieldValues[i] != "" then
                                        layerName = substituteString layerName ("{" + currentPreset.fieldNames[i] + "}") fieldValues[i]
                                )
                            )
                            previewText += layerName + "\n"
                        )
                    )
                    else
                    (
                        previewText += "æš‚æ— Layerç»“æ„\nè¯·åœ¨å·¦ä¾§ç¼–è¾‘åŒºåŸŸæ·»åŠ Layer"
                    )
                    
                    txtPreview.text = previewText
                )
                else
                (
                    txtPresetName.text = ""
                    txtPresetDesc.text = ""
                    lstLayerStructure.items = #()
                    lstFieldValues.items = #()
                    txtPreview.text = "è¯·é€‰æ‹©é¢„è®¾"
                )
            )
            catch
            (
                print "UIæ›´æ–°å‡ºé”™"
            )
            
            updatingUI = false
            return true
        )
        
        -- æ›´æ–°å­—æ®µé€‰é¡¹ä¸‹æ‹‰åˆ—è¡¨
        fn fnUpdateFieldOptions =
        (
            ddlFieldInsert.items = arrFieldOptions
            if ddlFieldInsert.items.count > 0 and ddlFieldInsert.selection == 0 then
                ddlFieldInsert.selection = 1
        )
        
        fn fnRefreshPresetList =
        (
            local presetNames = #()
            for i = 1 to arrLayerPresets.count do
            (
                local preset = arrLayerPresets[i]
                local displayName = preset.name
                if preset.layerStructure.count > 0 then
                    displayName += " (" + preset.layerStructure.count as string + ")"
                append presetNames displayName
            )
            lstPresets.items = presetNames
            
            if lstPresets.selection > 0 and lstPresets.selection <= arrLayerPresets.count then
            (
                currentPreset = arrLayerPresets[lstPresets.selection]
                currentPresetIndex = lstPresets.selection
                arrFieldValues = #() -- é‡ç½®å­—æ®µå€¼
                fnUpdateUI()
                -- å¼ºåˆ¶åˆ·æ–°å­—æ®µåˆ—è¡¨
                fnForceUpdateFieldList()
            )
        )
        
        fn fnSavePresets =
        (
            try
            (
                setINISetting BsLayerManagerConfig "BsLayerManager" "PresetCount" (arrLayerPresets.count as string)
                setINISetting BsLayerManagerConfig "BsLayerManager" "FieldOptions" (arrFieldOptions as string)
                
                for i = 1 to arrLayerPresets.count do
                (
                    local preset = arrLayerPresets[i]
                    local sectionName = "Preset_" + i as string
                    setINISetting BsLayerManagerConfig sectionName "Name" preset.name
                    setINISetting BsLayerManagerConfig sectionName "Description" preset.description
                    setINISetting BsLayerManagerConfig sectionName "LayerStructure" (preset.layerStructure as string)
                    setINISetting BsLayerManagerConfig sectionName "FieldNames" (preset.fieldNames as string)
                )
                print "é…ç½®å·²ä¿å­˜"
                return true
            )
            catch
            (
                print "ä¿å­˜å¤±è´¥"
                return false
            )
        )
        
        -- å¯¼å‡ºæ‰€æœ‰é¢„è®¾åˆ°æ–‡ä»¶
        fn fnExportPresets =
        (
            local exportFile = getSaveFileName caption:"å¯¼å‡ºé¢„è®¾æ–‡ä»¶" types:"Layeré¢„è®¾æ–‡ä»¶(*.blm)|*.blm|æ‰€æœ‰æ–‡ä»¶(*.*)|*.*|"
            if exportFile != undefined then
            (
                try
                (
                    -- åˆ›å»ºå¯¼å‡ºæ•°æ®ç»“æ„
                    local exportData = #()
                    
                    -- æ·»åŠ å­—æ®µé€‰é¡¹
                    append exportData ("FieldOptions=" + (arrFieldOptions as string))
                    
                    -- æ·»åŠ é¢„è®¾æ•°æ®
                    append exportData ("PresetCount=" + (arrLayerPresets.count as string))
                    
                    for i = 1 to arrLayerPresets.count do
                    (
                        local preset = arrLayerPresets[i]
                        local sectionName = "Preset_" + i as string
                        -- ä½¿ç”¨å¼•å·åŒ…å›´å­—ç¬¦ä¸²æ¥ä¿æŠ¤ä¸­æ–‡å­—ç¬¦
                        append exportData (sectionName + "_Name=\"" + preset.name + "\"")
                        append exportData (sectionName + "_Description=\"" + preset.description + "\"")
                        append exportData (sectionName + "_LayerStructure=" + (preset.layerStructure as string))
                        append exportData (sectionName + "_FieldNames=" + (preset.fieldNames as string))
                    )
                    
                    -- å†™å…¥æ–‡ä»¶
                    local file = createFile exportFile
                    if file != undefined then
                    (
                        format "-- BsLayerManager Presets Export File\n" to:file
                        format "-- Export Time: %\n" (localTime) to:file
                        format "-- Preset Count: %\n\n" arrLayerPresets.count to:file
                        
                        for line in exportData do
                            format "%\n" line to:file
                        
                        close file
                    )
                    
                    messageBox ("æˆåŠŸå¯¼å‡º " + arrLayerPresets.count as string + " ä¸ªé¢„è®¾åˆ°:\n" + exportFile) title:"å¯¼å‡ºæˆåŠŸ"
                    return true
                )
                catch
                (
                    messageBox "å¯¼å‡ºå¤±è´¥ï¼è¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œæƒé™ã€‚" title:"å¯¼å‡ºé”™è¯¯"
                    return false
                )
            )
            return false
        )
        
        -- ä»æ–‡ä»¶å¯¼å…¥é¢„è®¾
        fn fnImportPresets =
        (
            local importFile = getOpenFileName caption:"é€‰æ‹©é¢„è®¾æ–‡ä»¶" types:"Layeré¢„è®¾æ–‡ä»¶(*.blm)|*.blm|æ‰€æœ‰æ–‡ä»¶(*.*)|*.*|"
            if importFile != undefined then
            (
                if doesFileExist importFile then
                (
                    try
                    (
                        -- è¯¢é—®æ˜¯å¦æ›¿æ¢ç°æœ‰é¢„è®¾
                        local replaceMode = queryBox "æ˜¯å¦æ›¿æ¢å½“å‰æ‰€æœ‰é¢„è®¾ï¼Ÿ\n\né€‰æ‹©'æ˜¯'ï¼šæ¸…ç©ºå½“å‰é¢„è®¾ï¼Œå¯¼å…¥æ–°é¢„è®¾\né€‰æ‹©'å¦'ï¼šåœ¨ç°æœ‰é¢„è®¾åŸºç¡€ä¸Šæ·»åŠ å¯¼å…¥çš„é¢„è®¾" title:"å¯¼å…¥æ¨¡å¼"
                        
                        -- è¯»å–æ–‡ä»¶
                        local file = openFile importFile
                        local importData = #()
                        while not eof file do
                        (
                            local line = readLine file
                            if line != undefined and findString line "=" != undefined and findString line "--" != 1 then
                                append importData line
                        )
                        close file
                        
                        if not replaceMode then
                        (
                            -- å¤‡ä»½å½“å‰é¢„è®¾
                            local backupPresets = deepCopy arrLayerPresets
                            local backupFieldOptions = deepCopy arrFieldOptions
                        )
                        else
                        (
                            -- æ¸…ç©ºå½“å‰é¢„è®¾
                            arrLayerPresets = #()
                        )
                        
                        -- è§£æå¯¼å…¥æ•°æ®
                        local fieldOptionsStr = ""
                        local presetCount = 0
                        
                        for line in importData do
                        (
                            local eqPos = findString line "="
                            if eqPos != undefined then
                            (
                                local key = substring line 1 (eqPos - 1)
                                local value = substring line (eqPos + 1) -1
                                
                                if key == "FieldOptions" then
                                (
                                    try (arrFieldOptions = execute value) catch()
                                )
                                else if key == "PresetCount" then
                                (
                                    try (presetCount = value as integer) catch()
                                )
                            )
                        )
                        
                        -- å¯¼å…¥é¢„è®¾
                        local importedCount = 0
                        for i = 1 to presetCount do
                        (
                            local sectionName = "Preset_" + i as string
                            local presetName = ""
                            local presetDesc = ""
                            local layerStructStr = ""
                            local fieldNamesStr = ""
                            
                            for line in importData do
                            (
                                local eqPos = findString line "="
                                if eqPos != undefined then
                                (
                                    local key = substring line 1 (eqPos - 1)
                                    local value = substring line (eqPos + 1) -1
                                    
                                    -- ç§»é™¤å€¼å‘¨å›´çš„å¼•å·ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                                    if value.count >= 2 and value[1] == "\"" and value[value.count] == "\"" then
                                        value = substring value 2 (value.count - 2)
                                    
                                    if key == (sectionName + "_Name") then presetName = value
                                    else if key == (sectionName + "_Description") then presetDesc = value
                                    else if key == (sectionName + "_LayerStructure") then layerStructStr = value
                                    else if key == (sectionName + "_FieldNames") then fieldNamesStr = value
                                )
                            )
                            
                            if presetName != "" then
                            (
                                local preset = LayerPreset name:presetName description:presetDesc layerStructure:#() fieldNames:#()
                                try (preset.layerStructure = execute layerStructStr) catch (preset.layerStructure = #())
                                try (preset.fieldNames = execute fieldNamesStr) catch (preset.fieldNames = #("Name", "Type"))
                                append arrLayerPresets preset
                                importedCount += 1
                            )
                        )
                        
                        if not replaceMode then
                        (
                            -- åˆå¹¶å¤‡ä»½çš„é¢„è®¾
                            for preset in backupPresets do
                                append arrLayerPresets preset
                        )
                        
                        fnRefreshPresetList()
                        messageBox ("æˆåŠŸå¯¼å…¥ " + importedCount as string + " ä¸ªé¢„è®¾ï¼") title:"å¯¼å…¥æˆåŠŸ"
                        return true
                    )
                    catch
                    (
                        messageBox "å¯¼å…¥å¤±è´¥ï¼æ–‡ä»¶æ ¼å¼å¯èƒ½ä¸æ­£ç¡®ã€‚" title:"å¯¼å…¥é”™è¯¯"
                        return false
                    )
                )
                else
                (
                    messageBox "æ–‡ä»¶ä¸å­˜åœ¨ï¼" title:"å¯¼å…¥é”™è¯¯"
                    return false
                )
            )
            return false
        )
        
        fn fnLoadPresets =
        (
            try
            (
                arrLayerPresets = #()
                if doesFileExist BsLayerManagerConfig then
                (
                    -- åŠ è½½å­—æ®µé€‰é¡¹
                    local fieldOptionsStr = getINISetting BsLayerManagerConfig "BsLayerManager" "FieldOptions"
                    if fieldOptionsStr != "" then
                    (
                        try (arrFieldOptions = execute fieldOptionsStr) catch (arrFieldOptions = #("Name", "Type", "Part", "LOD", "Mat"))
                    )
                    
                    local presetCount = getINISetting BsLayerManagerConfig "BsLayerManager" "PresetCount"
                    if presetCount != "" then
                    (
                        local count = presetCount as integer
                        for i = 1 to count do
                        (
                            local sectionName = "Preset_" + i as string
                            local presetName = getINISetting BsLayerManagerConfig sectionName "Name"
                            local presetDesc = getINISetting BsLayerManagerConfig sectionName "Description"
                            local layerStructStr = getINISetting BsLayerManagerConfig sectionName "LayerStructure"
                            local fieldNamesStr = getINISetting BsLayerManagerConfig sectionName "FieldNames"
                            
                            if presetName != "" then
                            (
                                local preset = LayerPreset name:presetName description:presetDesc layerStructure:#() fieldNames:#()
                                try (preset.layerStructure = execute layerStructStr) catch (preset.layerStructure = #())
                                try (preset.fieldNames = execute fieldNamesStr) catch (preset.fieldNames = #("AAA", "BBB", "CCC"))
                                append arrLayerPresets preset
                            )
                        )
                    )
                )
                fnRefreshPresetList()
                return true
            )
            catch
            (
                print "åŠ è½½å¤±è´¥"
                return false
            )
        )
        
        fn fnCreateLayers =
        (
            if currentPreset == undefined then
            (
                print "è¯·å…ˆé€‰æ‹©é¢„è®¾"
                return false
            )
            
            if currentPreset.layerStructure.count == 0 then
            (
                print "é¢„è®¾æ— Layerç»“æ„"
                return false
            )
            
            local fieldValues = fnGetFieldValues()
            
            -- æ›¿æ¢å­—æ®µå€¼
            fn replaceFields str fieldNames fieldValues =
            (
                local result = str
                for i = 1 to fieldNames.count do
                (
                    if i <= fieldValues.count then
                        result = substituteString result ("{" + fieldNames[i] + "}") fieldValues[i]
                )
                return result
            )
            
            -- åˆ›å»ºlayers
            local createdLayers = #()
            local errorCount = 0
            
            for i = 1 to currentPreset.layerStructure.count do
            (
                local layerInfo = currentPreset.layerStructure[i]
                local layerName = replaceFields layerInfo[1] currentPreset.fieldNames fieldValues
                local parentIndex = layerInfo[2]
                
                try
                (
                    local existingLayer = LayerManager.getLayerFromName layerName
                    if existingLayer == undefined then
                    (
                        LayerManager.newLayerFromName layerName
                        local newLayer = LayerManager.getLayerFromName layerName
                        
                        if newLayer != undefined then
                        (
                            append createdLayers newLayer
                            
                            if parentIndex > 0 and parentIndex <= createdLayers.count then
                                newLayer.setParent createdLayers[parentIndex]
                        )
                    )
                    else errorCount += 1
                )
                catch (errorCount += 1)
            )
            
            print ("åˆ›å»ºäº† " + createdLayers.count as string + " ä¸ªLayers" + 
                   (if errorCount > 0 then (", " + errorCount as string + " ä¸ªå¤±è´¥æˆ–å·²å­˜åœ¨") else ""))
            
            return true
        )
        
        -- äº‹ä»¶å¤„ç†
        on lstPresets selected index do
        (
            if index > 0 and index <= arrLayerPresets.count then
            (
                currentPreset = arrLayerPresets[index]
                currentPresetIndex = index
                arrFieldValues = #() -- é‡ç½®å­—æ®µå€¼
                fnUpdateUI()
                -- å¼ºåˆ¶åˆ·æ–°å­—æ®µåˆ—è¡¨
                fnForceUpdateFieldList()
            )
        )
        
        on lstPresets doubleClicked index do
        (
            if index > 0 and index <= arrLayerPresets.count then
                fnCreateLayers()
        )
        
        on btnNewPreset pressed do
        (
            local newName = "æ–°é¢„è®¾" + (arrLayerPresets.count + 1) as string
            local newPreset = LayerPreset name:newName description:"æ–°å»ºé¢„è®¾" layerStructure:#() fieldNames:#("Name", "Type")
            append arrLayerPresets newPreset
            fnRefreshPresetList()
            lstPresets.selection = arrLayerPresets.count
        )
        
        on btnCopyPreset pressed do
        (
            if currentPreset != undefined then
            (
                local copyPreset = LayerPreset name:(currentPreset.name + "_å‰¯æœ¬") description:currentPreset.description
                copyPreset.layerStructure = deepCopy currentPreset.layerStructure
                copyPreset.fieldNames = deepCopy currentPreset.fieldNames
                append arrLayerPresets copyPreset
                fnRefreshPresetList()
                lstPresets.selection = arrLayerPresets.count
            )
        )
        
        on btnDeletePreset pressed do
        (
            if currentPreset != undefined then
            (
                deleteItem arrLayerPresets currentPresetIndex
                currentPreset = undefined
                currentPresetIndex = 0
                fnRefreshPresetList()
                fnUpdateUI()
                print "é¢„è®¾å·²åˆ é™¤"
            )
        )
        
        on btnSaveConfig pressed do (fnSavePresets())
        on btnExportPresets pressed do (fnExportPresets())
        on btnLoadConfig pressed do (fnImportPresets())
        on btnCreateLayers pressed do (fnCreateLayers())
        
        on btnInsertField pressed do
        (
            if ddlFieldInsert.selection > 0 then
            (
                local selectedField = ddlFieldInsert.items[ddlFieldInsert.selection]
                local currentText = txtLayerName.text
                txtLayerName.text = currentText + "_{" + selectedField + "}"
                print ("å·²æ’å…¥å­—æ®µ: {" + selectedField + "}")
                
                -- ç«‹å³åˆ·æ–°å­—æ®µåˆ—è¡¨
                fnForceUpdateFieldList()
            )
        )
        
        -- æ·»åŠ Layeråç§°æ–‡æœ¬å˜åŒ–äº‹ä»¶
        on txtLayerName changed text do
        (
            -- å¦‚æœæ­£åœ¨ç¼–è¾‘Layeråç§°ï¼Œå®æ—¶æ›´æ–°é€‰ä¸­çš„Layerç»“æ„
            if currentPreset != undefined and lstLayerStructure.selection > 0 and lstLayerStructure.selection <= currentPreset.layerStructure.count then
            (
                local index = lstLayerStructure.selection
                local layerInfo = currentPreset.layerStructure[index]
                currentPreset.layerStructure[index] = #(text, layerInfo[2])
                arrLayerPresets[currentPresetIndex] = currentPreset
                
                -- æ›´æ–°Layerç»“æ„æ˜¾ç¤ºï¼ˆä¸è§¦å‘selectionäº‹ä»¶ï¼‰
                local structureDisplay = #()
                for layerInfo in currentPreset.layerStructure do
                    append structureDisplay layerInfo[1]
                lstLayerStructure.items = structureDisplay
                lstLayerStructure.selection = index -- ä¿æŒé€‰æ‹©
            )
            
            -- å®æ—¶æ›´æ–°å­—æ®µåˆ—è¡¨å’Œé¢„è§ˆ
            fnForceUpdateFieldList()
        )
        
        on btnAddToList pressed do
        (
            -- ä½¿ç”¨å…¨å±€å˜é‡æ¥ä¼ é€’æ•°æ®
            global tempFieldInput = ""
            
            -- åˆ›å»ºä¸€ä¸ªç®€å•çš„è¾“å…¥å¯¹è¯æ¡†
            rollout dlgFieldInput "æ·»åŠ å­—æ®µé€‰é¡¹" width:250 height:100
            (
                editText txtInput "å­—æ®µåç§°:" pos:[10,10] width:230 height:18 text:"NewField"
                button btnOK "ç¡®å®š" pos:[70,40] width:50 height:25
                button btnCancel "å–æ¶ˆ" pos:[130,40] width:50 height:25
                
                on btnOK pressed do
                (
                    tempFieldInput = txtInput.text
                    destroyDialog dlgFieldInput
                )
                
                on btnCancel pressed do
                (
                    tempFieldInput = ""
                    destroyDialog dlgFieldInput
                )
                
                on txtInput entered text do
                (
                    tempFieldInput = text
                    destroyDialog dlgFieldInput
                )
            )
            
            createDialog dlgFieldInput modal:true
            
            if tempFieldInput != "" then
            (
                if findItem arrFieldOptions tempFieldInput == 0 then
                (
                    append arrFieldOptions tempFieldInput
                    fnUpdateFieldOptions()
                    ddlFieldInsert.selection = arrFieldOptions.count
                    print ("å·²æ·»åŠ å­—æ®µé€‰é¡¹: " + tempFieldInput)
                )
                else
                (
                    messageBox ("å­—æ®µé€‰é¡¹ '" + tempFieldInput + "' å·²å­˜åœ¨ï¼") title:"é”™è¯¯"
                )
            )
            
            -- æ¸…ç†å…¨å±€å˜é‡
            tempFieldInput = undefined
        )
        
        on btnRemoveFromList pressed do
        (
            if ddlFieldInsert.selection > 0 and arrFieldOptions.count > 1 then
            (
                local selectedField = arrFieldOptions[ddlFieldInsert.selection]
                if queryBox ("ç¡®å®šè¦åˆ é™¤å­—æ®µé€‰é¡¹ '" + selectedField + "' å—ï¼Ÿ") title:"ç¡®è®¤åˆ é™¤" then
                (
                    deleteItem arrFieldOptions ddlFieldInsert.selection
                    fnUpdateFieldOptions()
                    print ("å·²åˆ é™¤å­—æ®µé€‰é¡¹: " + selectedField)
                )
            )
            else if arrFieldOptions.count <= 1 then
            (
                messageBox "è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªå­—æ®µé€‰é¡¹ï¼" title:"æç¤º"
            )
        )
        
        on btnDeleteField pressed do
        (
            if currentPreset != undefined and lstFieldValues.selection > 0 then
            (
                local index = lstFieldValues.selection
                local fieldName = currentPreset.fieldNames[index]
                
                -- ä»æ‰€æœ‰Layerç»“æ„ä¸­ç§»é™¤è¯¥å­—æ®µçš„å¼•ç”¨
                for i = 1 to currentPreset.layerStructure.count do
                (
                    local layerInfo = currentPreset.layerStructure[i]
                    local newLayerName = substituteString layerInfo[1] ("{" + fieldName + "}") ""
                    currentPreset.layerStructure[i] = #(newLayerName, layerInfo[2])
                )
                
                -- åŒæ—¶åˆ é™¤å¯¹åº”çš„å­—æ®µå€¼
                if index <= arrFieldValues.count then
                    deleteItem arrFieldValues index
                    
                arrLayerPresets[currentPresetIndex] = currentPreset
                fnUpdateUI()
                
                -- ç«‹å³åˆ·æ–°å­—æ®µåˆ—è¡¨å’Œé¢„è§ˆ
                fnForceUpdateFieldList()
                
                txtFieldName.text = ""
                txtFieldValue.text = ""
                print ("å·²åˆ é™¤å­—æ®µ: " + fieldName + " åŠå…¶åœ¨Layerç»“æ„ä¸­çš„å¼•ç”¨")
            )
        )
        
        on btnUpdateField pressed do
        (
            if currentPreset != undefined and lstFieldValues.selection > 0 and txtFieldName.text != "" then
            (
                local index = lstFieldValues.selection
                local oldName = currentPreset.fieldNames[index]
                local newName = txtFieldName.text
                local newValue = txtFieldValue.text
                
                -- åœ¨æ‰€æœ‰Layerç»“æ„ä¸­æ›¿æ¢å­—æ®µå
                for i = 1 to currentPreset.layerStructure.count do
                (
                    local layerInfo = currentPreset.layerStructure[i]
                    local newLayerName = substituteString layerInfo[1] ("{" + oldName + "}") ("{" + newName + "}")
                    currentPreset.layerStructure[i] = #(newLayerName, layerInfo[2])
                )
                
                arrLayerPresets[currentPresetIndex] = currentPreset
                
                -- æ›´æ–°å­—æ®µå€¼
                fnSetFieldValue index newValue
                
                -- ç«‹å³åˆ·æ–°é¢„è§ˆ
                fnForceUpdateFieldList()
                
                print ("å­—æ®µå·²æ›´æ–°: " + oldName + " â†’ " + newName + " = \"" + newValue + "\"")
            )
        )
        
        on lstFieldValues selected index do
        (
            if currentPreset != undefined and index > 0 then
            (
                local extractedFields = fnExtractFieldsFromStructure()
                if index <= extractedFields.count then
                (
                    txtFieldName.text = extractedFields[index]
                    txtFieldValue.text = if index <= arrFieldValues.count then arrFieldValues[index] else ""
                )
            )
        )
        
        on txtFieldValue changed text do
        (
            if not updatingUI and currentPreset != undefined and lstFieldValues.selection > 0 then
            (
                fnSetFieldValue lstFieldValues.selection text
            )
        )
        
        on btnAddLayer pressed do
        (
            if currentPreset != undefined and txtLayerName.text != "" then
            (
                local newLayerInfo = #(txtLayerName.text, 0) -- æš‚æ—¶ä¸æ”¯æŒçˆ¶çº§ï¼Œéƒ½æ˜¯é¡¶çº§
                append currentPreset.layerStructure newLayerInfo
                arrLayerPresets[currentPresetIndex] = currentPreset
                fnUpdateUI()
                txtLayerName.text = "00_{Name}_Master"
                
                -- å¼ºåˆ¶åˆ·æ–°å­—æ®µåˆ—è¡¨
                fnForceUpdateFieldList()
            )
        )
        
        on btnRemoveLayer pressed do
        (
            if currentPreset != undefined and lstLayerStructure.selection > 0 then
            (
                deleteItem currentPreset.layerStructure lstLayerStructure.selection
                arrLayerPresets[currentPresetIndex] = currentPreset
                fnUpdateUI()
                
                -- å¼ºåˆ¶åˆ·æ–°å­—æ®µåˆ—è¡¨
                fnForceUpdateFieldList()
            )
        )
        
        on btnMoveUp pressed do
        (
            if currentPreset != undefined and lstLayerStructure.selection > 1 then
            (
                local index = lstLayerStructure.selection
                local temp = currentPreset.layerStructure[index]
                currentPreset.layerStructure[index] = currentPreset.layerStructure[index-1]
                currentPreset.layerStructure[index-1] = temp
                arrLayerPresets[currentPresetIndex] = currentPreset
                fnUpdateUI()
                lstLayerStructure.selection = index - 1
                
                -- å¼ºåˆ¶åˆ·æ–°å­—æ®µåˆ—è¡¨
                fnForceUpdateFieldList()
            )
        )
        
        on btnMoveDown pressed do
        (
            if currentPreset != undefined and lstLayerStructure.selection > 0 and lstLayerStructure.selection < currentPreset.layerStructure.count then
            (
                local index = lstLayerStructure.selection
                local temp = currentPreset.layerStructure[index]
                currentPreset.layerStructure[index] = currentPreset.layerStructure[index+1]
                currentPreset.layerStructure[index+1] = temp
                arrLayerPresets[currentPresetIndex] = currentPreset
                fnUpdateUI()
                lstLayerStructure.selection = index + 1
                
                -- å¼ºåˆ¶åˆ·æ–°å­—æ®µåˆ—è¡¨
                fnForceUpdateFieldList()
            )
        )
        
        -- æ·»åŠ Layerç»“æ„åˆ—è¡¨é€‰æ‹©å˜åŒ–äº‹ä»¶
        on lstLayerStructure selected index do
        (
            if currentPreset != undefined and index > 0 and index <= currentPreset.layerStructure.count then
            (
                local layerInfo = currentPreset.layerStructure[index]
                txtLayerName.text = layerInfo[1]
                fnForceUpdateFieldList()
            )
        )
        
        on btnAbout pressed do
        (
            local helpText = "ğŸ¯ BsLayerManager v1.0 æ“ä½œè¯´æ˜\n"
            helpText += "==============================\n\n"
            
            helpText += "ğŸ“‹ ã€æ ¸å¿ƒæ¦‚å¿µã€‘\n"
            helpText += "â€¢ é¢„è®¾ï¼šLayerç»“æ„æ¨¡æ¿æ–¹æ¡ˆ\n"
            helpText += "â€¢ å­—æ®µï¼š{Name}ã€{Type} ç­‰å ä½ç¬¦\n"
            helpText += "â€¢ ç”Ÿæˆï¼šç”¨å­—æ®µå€¼æ›¿æ¢å ä½ç¬¦åˆ›å»ºLayer\n\n"
            
            helpText += "ğŸš€ ã€å¿«é€Ÿä½¿ç”¨ã€‘\n"
            helpText += "1. é€‰æ‹©æˆ–æ–°å»ºé¢„è®¾\n"
            helpText += "2. æ·»åŠ Layeræ¨¡æ¿ï¼ˆå¦‚ï¼š00_{Name}_Masterï¼‰\n"
            helpText += "3. è®¾ç½®å­—æ®µå€¼ï¼ˆName=Character, Type=Geoï¼‰\n"
            helpText += "4. æŸ¥çœ‹é¢„è§ˆæ•ˆæœ\n"
            helpText += "5. ç‚¹å‡»'ğŸš€ç”ŸæˆLayers'åˆ›å»º\n\n"
            
            helpText += "ğŸ“ ã€ä¸»è¦åŠŸèƒ½ã€‘\n"
            helpText += "â€¢ é¢„è®¾ç®¡ç†ï¼šâ•æ–°å»º ğŸ“‹å¤åˆ¶ ğŸ—‘åˆ é™¤ ğŸ’¾ä¿å­˜\n"
            helpText += "â€¢ Layerç¼–è¾‘ï¼šæ·»åŠ æ¨¡æ¿ï¼Œä½¿ç”¨{å­—æ®µå}å ä½ç¬¦\n"
            helpText += "â€¢ å­—æ®µç®¡ç†ï¼šè‡ªåŠ¨æå–å­—æ®µï¼Œé…ç½®å­—æ®µå€¼\n"
            helpText += "â€¢ å®æ—¶é¢„è§ˆï¼šå³ä¾§æ˜¾ç¤ºç”Ÿæˆåçš„Layerç»“æ„\n\n"
            
            helpText += "ğŸ’¡ ã€å¸¸ç”¨å­—æ®µã€‘\n"
            helpText += "{Name} - è§’è‰²å  {Type} - ç±»å‹  {Part} - éƒ¨ä½\n"
            helpText += "{LOD} - ç»†èŠ‚çº§åˆ«  {Mat} - æè´¨æ ‡è¯†\n\n"
            
            helpText += "âš¡ ã€ç¤ºä¾‹ã€‘\n"
            helpText += "æ¨¡æ¿ï¼š01_{Name}_{Type}_Geo\n"
            helpText += "å­—æ®µï¼šName=Hero, Type=Body\n"
            helpText += "ç»“æœï¼š01_Hero_Body_Geo\n\n"
            
            helpText += "åŒå‡»é¢„è®¾å¯å¿«é€Ÿç”Ÿæˆ | ğŸ”„å¯æ‰‹åŠ¨åˆ·æ–°\n"
            helpText += "==============================\n"
            helpText += "ä½œè€…ï¼šBullet.S"
            
            messageBox helpText title:"BsLayerManager æ“ä½œè¯´æ˜" beep:false
        )
        
        on btnUpdatePreset pressed do
        (
            if currentPreset != undefined and txtPresetName.text != "" then
            (
                local oldName = currentPreset.name
                currentPreset.name = txtPresetName.text
                arrLayerPresets[currentPresetIndex] = currentPreset
                fnRefreshPresetList()
                -- ä¿æŒå½“å‰é€‰æ‹©
                lstPresets.selection = currentPresetIndex
                print ("é¢„è®¾åç§°å·²æ›´æ–°: " + oldName + " â†’ " + currentPreset.name)
            )
        )
        
        on btnUpdateDesc pressed do
        (
            if currentPreset != undefined and txtPresetDesc.text != undefined then
            (
                local oldDesc = currentPreset.description
                currentPreset.description = txtPresetDesc.text
                arrLayerPresets[currentPresetIndex] = currentPreset
                print ("é¢„è®¾æè¿°å·²æ›´æ–°: " + oldDesc + " â†’ " + currentPreset.description)
            )
        )
        
        on btnRefreshFields pressed do
        (
            fnForceUpdateFieldList()
            print "å­—æ®µåˆ—è¡¨å·²æ‰‹åŠ¨åˆ·æ–°"
        )
        
        on btnClose pressed do
        (
            try (destroydialog rolBsLayerManager) catch ()
        )
        
        on rolBsLayerManager open do
        (   
            updatingUI = false
            arrFieldValues = #()
            
            fnLoadPresets()
            fnUpdateFieldOptions() -- åˆå§‹åŒ–å­—æ®µé€‰é¡¹ä¸‹æ‹‰åˆ—è¡¨
            
            -- åˆ›å»ºé»˜è®¤é¢„è®¾ (ç®€åŒ–)
            if arrLayerPresets.count == 0 then
            (
                local preset1 = LayerPreset name:"è§’è‰²ç»“æ„" description:"æ¸¸æˆè§’è‰²Layerç»“æ„" layerStructure:#() fieldNames:#("Name", "Type")
                append preset1.layerStructure #("00_{Name}_Master", 0)
                append preset1.layerStructure #("01_{Name}_{Type}_Geo", 0)
                append arrLayerPresets preset1
                
                fnRefreshPresetList()
                if arrLayerPresets.count > 0 then
                    lstPresets.selection = 1
            )
            
            -- ç¡®ä¿åœ¨æ‰“å¼€æ—¶å¼ºåˆ¶åˆ·æ–°å­—æ®µåˆ—è¡¨
            if currentPreset != undefined then
                fnForceUpdateFieldList()
        )
        
        on rolBsLayerManager close do (fnSavePresets())
    )
    
    createDialog rolBsLayerManager style:#()
) 