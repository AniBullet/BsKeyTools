/**************************************************************************************************************************
-- By Bullet.S è‡ªç”¨ä¿®æ”¹ç‰ˆ,åŠŸèƒ½å¤§é›†åˆ,å®Œå…¨å¼€æºå…è´¹ä»…ä¾›å­¦ä¹ ä½¿ç”¨,è¯·å‹¿ç”¨äºå•†ä¸šç”¨é€”,å¦åˆ™åæœè‡ªè´Ÿ    
Referenceï¼š SoxBipedAssist_v0.423 & Biped Helper v3.1  
Since 2023.03

v2.1
1.ä¼˜åŒ–æ‰‹æŒ‡å¼¯æ›²åŠŸèƒ½ï¼ˆä¸€æ–¹ç‹‚ä¸‰ï¼‰

v2.0
1.ä¿®å¤å±‚åŠŸèƒ½æŸäº›uié®æŒ¡å¯¼è‡´æŒ‰é’®ä¸çµçš„é—®é¢˜

v1.9
1.ä¿®å¤bipå±‚å†…ä½¿ç”¨æ»‘åŠ¨å¸§å¯¼è‡´å¡æ­»çš„bug

v1.8
1.ä¿®å¤æ‰‹æŒ‡é€‰æ‹©æŠ¥é”™
2.æ·»åŠ bend linkåŠŸèƒ½

v1.7
1.å¤´éƒ¨æŒ‰é’®å³é”®åˆ‡æ¢é¢œæ–‡å­—è„¸è¡¨æƒ…
2.è¡¨æƒ…é€‰æ‹©è‡ªåŠ¨ä¿å­˜åˆ°é…ç½®æ–‡ä»¶
3.æ·»åŠ è¡¨æƒ…è¿˜åŸæŒ‰é’®

2025.05 v1.6
1.åˆ é™¤bipedå¸§æ·»åŠ å›é€€
2.æ·»åŠ CSç¼©æ”¾(æ„Ÿè°¢éœéœå°çŒ«å»ºè®®)

2025.03 update v1.5
1.é‡æ–°æ”¹å›å¤åˆ¶poseçš„é€‰æ‹©è¢«å¤åˆ¶bipedéª¨éª¼åŠŸèƒ½ï¼Œå»æ‰æ¸…é™¤postureçš„æŒ‰é’®

2024.04 update v1.4
1. ä¿®å¤å¤åˆ¶poseå’ŒåŠ å±‚åŠŸèƒ½å›é€€å¯¼è‡´çš„é—ªé€€
2ã€‚ç¨å¾®æ‹“å±•æ‰‹æŒ‡é€‰æ‹©åŠŸèƒ½
3ã€‚IKå¸§åˆ‡æ¢é¢æ¿åŠŸèƒ½ä¼˜åŒ–ï¼Œä¼šä¿æŒä¹‹å‰é¢æ¿
**************************************************************************************************************************/

global rolBsBipedTools
global posBsBipedTools
global dragBsBipedTools = false
global arrAllBipedCom
global iniBsBipedTools = execute ("@\"" + (getDir #maxData) + "\\BsBipedToolsConfig.ini\"")  --é…ç½®æ–‡ä»¶è·¯å¾„
global iniBsBTPos
global rolBsAboutPanel
global offsetBsAboutPanel = [0,0]
global stateBsAboutPanel = 0
global dotLinkLabel1
global dotLinkLabel2
global verBsBipedTools = "v2.1"

try(destroydialog rolBsBipedTools) catch()
try(destroyDialog rolBSLeftHandPivots)catch()
try(destroyDialog rolBSRightHandPivots)catch()
try(destroyDialog rolBSLeftFootPivots)catch()
try(destroyDialog rolBSRightFootPivots)catch()
try(destroyDialog rolBsBipToolsHelp)catch()

rollout rolBsBipToolsHelp ("BsBipTools" + verBsBipedTools + " ä½¿ç”¨æŒ‡å—") width:420 height:480
(
	local strHelpText = ("ğŸ¯ BsBipedTools ä½¿ç”¨æŒ‡å—" + "\r\n" + \
	"==============================" + "\r\n\r\n" + \
	"âš¡ ã€ç‰¹åˆ«åŠŸèƒ½ã€‘" + "\r\n" + \
	"â€¢ Motioné¢æ¿å¼€å…³ (MæŒ‰é’®)ï¼šå·¦é”®ç¦ç”¨å‡å°‘å¡é¡¿ï¼Œå³é”®æ¢å¤" + "\r\n" + \
	"â€¢ ç¦…æ¨¡å¼/XRay/Boxï¼šå¿«é€Ÿåˆ‡æ¢è§†çª—æ˜¾ç¤ºæ¨¡å¼" + "\r\n" + \
	"â€¢ å¤´éƒ¨è¡¨æƒ…ï¼šå³é”®ç‚¹å‡»å¤´éƒ¨æŒ‰é’®åˆ‡æ¢é¢œæ–‡å­—è„¸ï¼Œå³ä¸Šè§’è¿˜åŸ" + "\r\n" + \
	"â€¢ æ‰‹æŒ‡å¼¯æ›²ï¼šåœ¨æ‰‹æŒ‡é¢æ¿ä¸­ä½¿ç”¨Bendæ§ä»¶è°ƒèŠ‚æ‰‹æŒ‡å¼¯æ›²" + "\r\n\r\n" + \
	"ğŸ¯ ã€éª¨éª¼é€‰æ‹©æ“ä½œã€‘" + "\r\n" + \
	"â€¢ å·¦é”®å•å‡»ï¼šç›´æ¥é€‰å–  |  å³é”®å•å‡»ï¼šé€‰æ‹©é•œåƒéª¨éª¼" + "\r\n" + \
	"â€¢ Ctrl + å·¦å‡»ï¼šåŠ é€‰  |  Alt + å·¦å‡»ï¼šå‡é€‰" + "\r\n" + \
	"â€¢ Shift + å·¦å‡»ï¼šé€‰æ‹©éª¨éª¼åŠå…¶æ‰€æœ‰å­çº§" + "\r\n" + \
	"â€¢ Ctrl + Alt + å·¦å‡»ï¼šéª¨éª¼æ—‹è½¬å½’é›¶" + "\r\n\r\n" + \
	"ğŸ› ï¸ ã€è¾…åŠ©å·¥å…·ã€‘" + "\r\n" + \
	"â€¢ Copy Paste Toolsï¼šå§¿æ€å¤åˆ¶ç²˜è´´å’Œé•œåƒ" + "\r\n" + \
	"â€¢ Layer Toolsï¼šBipedå±‚çº§ç®¡ç†" + "\r\n" + \
	"â€¢ Loop Key Toolsï¼šå¾ªç¯å…³é”®å¸§å·¥å…·" + "\r\n" + \
	"â€¢ Others Toolsï¼šå…¶ä»–å®ç”¨åŠŸèƒ½é›†åˆ" + "\r\n\r\n" + \
	"ğŸ’¡ ã€ä½¿ç”¨æç¤ºã€‘" + "\r\n" + \
	"å¸§ç›¸å…³æŒ‰é’®æœ‰ä¸°å¯Œçš„ç»„åˆé”®åŠŸèƒ½ï¼Œè¯·æŸ¥çœ‹æ‚¬åœæç¤º" + "\r\n" + \
	"å·¦å‡» / å³å‡» / Ctrl / Shift éƒ½æœ‰ä¸åŒä¾¿æ·åŠŸèƒ½" + "\r\n\r\n" + \
	"==============================" + "\r\n" + \
	"å‡å°‘å¡é¡¿ï¼Œä¾¿æ·Kå¸§ | ä½œè€…ï¼šBullet.S" + "\r\n\r\n")

	label lblHelp strHelpText width:400 height:400 pos:[10,10]
	-- é“¾æ¥åŒºåŸŸ
	groupBox grpLinks "ç›¸å…³é“¾æ¥" pos:[10,420] width:400 height:50
	label lblAuthor "ä½œè€…ï¼š" pos:[20,440] width:40 height:15
	hyperLink hplHome "Bullet.S" address:"https://www.anibullet.com/" pos:[60,440] width:60 height:15
	hyperLink hplHelpDocs "å¸®åŠ©æ–‡æ¡£" address:"https://anibullet.github.io/" pos:[130,440] width:60 height:15
	label lblRef "å‚è€ƒï¼š" pos:[200,440] width:40 height:15
	hyperLink hplSox "SoxBipedAssist" address:"http://cafe.naver.com/pinksox/6131" pos:[240,440] width:80 height:15
	hyperLink hplBH "BipedHelper" address:"https://sites.google.com/view/lbtools-guide/home/biped-helper" pos:[330,440] width:70 height:15
)

fn f_getPivotIndex ctrl =
(
	if ctrl.keys.count > 0 then
	(
		local keyIndex = getKeyIndex ctrl slidertime
		if keyIndex > 0 then
		(
			local key = biped.getKey ctrl keyIndex
			if key.ikSpace > 0 then
			(
				return (biped.getKey ctrl keyIndex).ikPivotIndex
			)
		)
	)
	return 0	
)

fn f_changePivot ctrl index =
(
	if ctrl.keys.count > 0 then
	(
		local keyIndex = getKeyIndex ctrl slidertime
		if keyIndex > 0 then
		(
			local key = biped.getKey ctrl keyIndex
			if key.ikSpace > 0 then
			(
				key.ikPivotIndex = index
				return true
			)
			else
			(
				messagebox "é”™è¯¯ï¼šå¿…é¡»æ˜¯å›ºå®šå¸§æˆ–æ»‘åŠ¨å¸§ã€‚                       " title:"é€‰æ‹© Pivots"
			)
		)
		else
		(
			messagebox "é”™è¯¯ï¼šå½“å‰æ—¶é—´æ»‘å—æ²¡æœ‰å¸§ã€‚                        " title:"é€‰æ‹© Pivots"
		)
	)
	else
	(
		messagebox "é”™è¯¯ï¼šæ‰¾ä¸åˆ°å¸§ã€‚\r\nè®¾ç½®ä¸€ä¸ªå›ºå®šå¸§æˆ–æ»‘åŠ¨å¸§ã€‚                             " title:"é€‰æ‹© Pivots"
	)
	
	return false
)

rollout rolBSLeftHandPivots "L-Hand" width:90
(
	local lrg = 16
	local sml = 12

	checkbutton chkbtn_pinkyTip "" across:4 width:sml height:sml align:#left offset:[-8,0] tooltip:"pinky tip"
	checkbutton chkbtn_ringTip "" width:sml height:sml offset:[-8,0] tooltip:"ring tip"
	checkbutton chkbtn_middleTip "" width:sml height:sml offset:[-8,0] tooltip:"middle tip"
	checkbutton chkbtn_indexTip "" width:sml height:sml offset:[-8,0] tooltip:"index tip"
	
	checkbutton chkbtn_pinky2 "" width:sml height:sml across:4 align:#left offset:[-8,0] tooltip:"pinky 2"
	checkbutton chkbtn_ring2 "" width:sml height:sml offset:[-8,0] tooltip:"ring 2"
	checkbutton chkbtn_middle2 "" width:sml height:sml offset:[-8,0] tooltip:"middle 2"
	checkbutton chkbtn_index2 "" width:sml height:sml offset:[-8,0] tooltip:"index 2"
	
	checkbutton chkbtn_pinky1 "" width:sml height:sml across:4 align:#left offset:[-8,0] tooltip:"pinky 1"
	checkbutton chkbtn_ring1 "" width:sml height:sml offset:[-8,0] tooltip:"ring 1"
	checkbutton chkbtn_middle1 "" width:sml height:sml offset:[-8,0] tooltip:"middle 1"
	checkbutton chkbtn_index1 "" width:sml height:sml offset:[-8,0] tooltip:"index 1"
	
	checkbutton chkbtn_palmFront "" width:lrg height:lrg across:3 align:#left offset:[-8,0] tooltip:"palm front"
	checkbutton chkbtn_palmMiddle "" width:lrg height:lrg offset:[-9,0] tooltip:"palm middle"
	checkbutton chkbtn_palmBack "" width:lrg height:lrg offset:[-8,0] tooltip:"palm back"
	
	checkbutton chkbtn_wristFront "" width:lrg height:lrg across:3 align:#left offset:[-8,0] tooltip:"wrist front"
	checkbutton chkbtn_wristMiddle "" width:lrg height:lrg offset:[-9,0] tooltip:"wrist middle"
	checkbutton chkbtn_wristBack "" width:lrg height:lrg offset:[-8,0] tooltip:"wrist back"
	
	checkbutton chkbtn_wristCenter "" width:lrg height:lrg align:#left offset:[14,0] tooltip:"wrist center"
	
	checkbutton chkbtn_thumbTip "" width:sml height:sml align:#right offset:[7,-92] tooltip:"thumb tip"
	checkbutton chkbtn_thumb2 "" width:sml height:sml align:#right offset:[7,0] tooltip:"thumb 2"
	checkbutton chkbtn_thumb1 "" width:sml height:sml align:#right offset:[7,0] tooltip:"thumb 1"
	
	fn f_uncheckAll =
	(
		chkbtn_wristCenter.checked = false
		chkbtn_wristFront.checked = false
		chkbtn_wristMiddle.checked = false
		chkbtn_wristBack.checked = false
		chkbtn_palmFront.checked = false
		chkbtn_palmMiddle.checked = false
		chkbtn_palmBack.checked = false
		chkbtn_thumb1.checked = false
		chkbtn_thumb2.checked = false
		chkbtn_thumbTip.checked = false
		chkbtn_index1.checked = false
		chkbtn_index2.checked = false
		chkbtn_indexTip.checked = false
		chkbtn_middle1.checked = false
		chkbtn_middle2.checked = false
		chkbtn_middleTip.checked = false
		chkbtn_ring1.checked = false
		chkbtn_ring2.checked = false
		chkbtn_ringTip.checked = false
		chkbtn_pinky1.checked = false
		chkbtn_pinky2.checked = false
		chkbtn_pinkyTip.checked = false
	)
	
	fn f_updateButton state chkbtn index =
	(
		f_uncheckAll();
		if state then
		(
			if (f_changePivot rolBsBipedTools.m_LHand[1].controller index) then
			(
				chkbtn.checked = true
			)
		)
		else
		(
			if (f_getPivotIndex rolBsBipedTools.m_LHand[1].controller) > 0 then
			(
				chkbtn.checked = true
			)
		)
	)
	
	on rolBSLeftHandPivots open do
	(
		case (f_getPivotIndex rolBsBipedTools.m_LHand[1].controller) of
		(
			1: chkbtn_wristCenter.checked = true
			2: chkbtn_wristFront.checked = true
			3: chkbtn_wristMiddle.checked = true
			4: chkbtn_wristBack.checked = true
			5: chkbtn_palmFront.checked = true
			6: chkbtn_palmMiddle.checked = true
			7: chkbtn_palmBack.checked = true
			8: chkbtn_thumb1.checked = true
			9: chkbtn_thumb2.checked = true
			10: chkbtn_thumbTip.checked = true
			11: chkbtn_index1.checked = true
			12: chkbtn_index2.checked = true
			13: chkbtn_indexTip.checked = true
			14: chkbtn_middle1.checked = true
			15: chkbtn_middle2.checked = true
			16: chkbtn_middleTip.checked = true
			17: chkbtn_ring1.checked = true
			18: chkbtn_ring2.checked = true
			19: chkbtn_ringTip.checked = true
			20: chkbtn_pinky1.checked = true
			21: chkbtn_pinky2.checked = true
			22: chkbtn_pinkyTip.checked = true
			default: f_uncheckAll()
		)
	)
	
	on rolBSLeftHandPivots close do
	(
		
	)
	
	on chkbtn_wristCenter changed state do (f_updateButton state chkbtn_wristCenter 1)
	on chkbtn_wristFront changed state do (f_updateButton state chkbtn_wristFront 2)
	on chkbtn_wristMiddle changed state do (f_updateButton state chkbtn_wristMiddle 3)
	on chkbtn_wristBack changed state do (f_updateButton state chkbtn_wristBack 4)
	on chkbtn_palmFront changed state do (f_updateButton state chkbtn_palmFront 5)
	on chkbtn_palmMiddle changed state do (f_updateButton state chkbtn_palmMiddle 6)
	on chkbtn_palmBack changed state do (f_updateButton state chkbtn_palmBack 7)
	on chkbtn_thumb1 changed state do (f_updateButton state chkbtn_thumb1 8)
	on chkbtn_thumb2 changed state do (f_updateButton state chkbtn_thumb2 9)
	on chkbtn_thumbTip changed state do (f_updateButton state chkbtn_thumbTip 10)
	on chkbtn_index1 changed state do (f_updateButton state chkbtn_index1 11)
	on chkbtn_index2 changed state do (f_updateButton state chkbtn_index2 12)
	on chkbtn_indexTip changed state do (f_updateButton state chkbtn_indexTip 13)
	on chkbtn_middle1 changed state do (f_updateButton state chkbtn_middle1 14)
	on chkbtn_middle2 changed state do (f_updateButton state chkbtn_middle2 15)
	on chkbtn_middleTip changed state do (f_updateButton state chkbtn_middleTip 16)
	on chkbtn_ring1 changed state do (f_updateButton state chkbtn_ring1 17)
	on chkbtn_ring2 changed state do (f_updateButton state chkbtn_ring2 18)
	on chkbtn_ringTip changed state do (f_updateButton state chkbtn_ringTip 19)
	on chkbtn_pinky1 changed state do (f_updateButton state chkbtn_pinky1 20)
	on chkbtn_pinky2 changed state do (f_updateButton state chkbtn_pinky2 21)
	on chkbtn_pinkyTip changed state do (f_updateButton state chkbtn_pinkyTip 22)
) --// end rollout

rollout rolBSRightHandPivots "R-Hand" width:90
(
	local lrg = 16
	local sml = 12
	
	checkbutton chkbtn_indexTip "" across:4 width:sml height:sml align:#right offset:[8,0] tooltip:"index tip"
	checkbutton chkbtn_middleTip "" width:sml height:sml offset:[12,0] tooltip:"middle tip"
	checkbutton chkbtn_ringTip "" width:sml height:sml offset:[12,0] tooltip:"ring tip"
	checkbutton chkbtn_pinkyTip "" width:sml height:sml offset:[12,0] tooltip:"pinky tip"

	checkbutton chkbtn_index2 "" width:sml height:sml across:4 align:#right offset:[8,0] tooltip:"index 2"
	checkbutton chkbtn_middle2 "" width:sml height:sml offset:[12,0] tooltip:"middle 2"
	checkbutton chkbtn_ring2 "" width:sml height:sml offset:[12,0] tooltip:"ring 2"
	checkbutton chkbtn_pinky2 "" width:sml height:sml offset:[12,0] tooltip:"pinky 2"
	
	checkbutton chkbtn_index1 "" width:sml height:sml across:4 align:#right offset:[8,0] tooltip:"index 1"
	checkbutton chkbtn_middle1 "" width:sml height:sml offset:[12,0] tooltip:"middle 1"
	checkbutton chkbtn_ring1 "" width:sml height:sml offset:[12,0] tooltip:"ring 1"
	checkbutton chkbtn_pinky1 "" width:sml height:sml offset:[12,0] tooltip:"pinky 1"

	checkbutton chkbtn_palmFront "" width:lrg height:lrg across:3 align:#right offset:[7,0] tooltip:"palm front"
	checkbutton chkbtn_palmMiddle "" width:lrg height:lrg offset:[11,0] tooltip:"palm middle"
	checkbutton chkbtn_palmBack "" width:lrg height:lrg offset:[12,0] tooltip:"palm back"		

	checkbutton chkbtn_wristFront "" width:lrg height:lrg across:3 align:#right offset:[7,0] tooltip:"wrist front"
	checkbutton chkbtn_wristMiddle "" width:lrg height:lrg offset:[11,0] tooltip:"wrist middle"
	checkbutton chkbtn_wristBack "" width:lrg height:lrg offset:[12,0] tooltip:"wrist back"
	
	checkbutton chkbtn_wristCenter "" width:lrg height:lrg align:#right offset:[-14,0] tooltip:"wrist center"
	
	checkbutton chkbtn_thumbTip "" width:sml height:sml align:#right offset:[-58,-92] tooltip:"thumb tip"
	checkbutton chkbtn_thumb2 "" width:sml height:sml align:#right offset:[-58,0] tooltip:"thumb 2"
	checkbutton chkbtn_thumb1 "" width:sml height:sml align:#right offset:[-58,0] tooltip:"thumb 1"
		
	fn f_uncheckAll =
	(
		chkbtn_wristCenter.checked = false
		chkbtn_wristFront.checked = false
		chkbtn_wristMiddle.checked = false
		chkbtn_wristBack.checked = false
		chkbtn_palmFront.checked = false
		chkbtn_palmMiddle.checked = false
		chkbtn_palmBack.checked = false
		chkbtn_thumb1.checked = false
		chkbtn_thumb2.checked = false
		chkbtn_thumbTip.checked = false
		chkbtn_index1.checked = false
		chkbtn_index2.checked = false
		chkbtn_indexTip.checked = false
		chkbtn_middle1.checked = false
		chkbtn_middle2.checked = false
		chkbtn_middleTip.checked = false
		chkbtn_ring1.checked = false
		chkbtn_ring2.checked = false
		chkbtn_ringTip.checked = false
		chkbtn_pinky1.checked = false
		chkbtn_pinky2.checked = false
		chkbtn_pinkyTip.checked = false
	)
	
	fn f_updateButton state chkbtn index =
	(
		f_uncheckAll();
		if state then
		(
			if (f_changePivot rolBsBipedTools.m_RHand[1].controller index) then
			(
				chkbtn.checked = true
			)
		)
		else
		(
			if (f_getPivotIndex rolBsBipedTools.m_RHand[1].controller) > 0 then
			(
				chkbtn.checked = true
			)
		)
	)

	on rolBSRightHandPivots open do
	(
		case (f_getPivotIndex rolBsBipedTools.m_RHand[1].controller) of
		(
			1: chkbtn_wristCenter.checked = true
			2: chkbtn_wristFront.checked = true
			3: chkbtn_wristMiddle.checked = true
			4: chkbtn_wristBack.checked = true
			5: chkbtn_palmFront.checked = true
			6: chkbtn_palmMiddle.checked = true
			7: chkbtn_palmBack.checked = true
			8: chkbtn_thumb1.checked = true
			9: chkbtn_thumb2.checked = true
			10: chkbtn_thumbTip.checked = true
			11: chkbtn_index1.checked = true
			12: chkbtn_index2.checked = true
			13: chkbtn_indexTip.checked = true
			14: chkbtn_middle1.checked = true
			15: chkbtn_middle2.checked = true
			16: chkbtn_middleTip.checked = true
			17: chkbtn_ring1.checked = true
			18: chkbtn_ring2.checked = true
			19: chkbtn_ringTip.checked = true
			20: chkbtn_pinky1.checked = true
			21: chkbtn_pinky2.checked = true
			22: chkbtn_pinkyTip.checked = true
			default: f_uncheckAll()
		)
	)
	
	on rolBSRightHandPivots close do
	(
		
	)
	
	on chkbtn_wristCenter changed state do (f_updateButton state chkbtn_wristCenter 1)
	on chkbtn_wristFront changed state do (f_updateButton state chkbtn_wristFront 2)
	on chkbtn_wristMiddle changed state do (f_updateButton state chkbtn_wristMiddle 3)
	on chkbtn_wristBack changed state do (f_updateButton state chkbtn_wristBack 4)
	on chkbtn_palmFront changed state do (f_updateButton state chkbtn_palmFront 5)
	on chkbtn_palmMiddle changed state do (f_updateButton state chkbtn_palmMiddle 6)
	on chkbtn_palmBack changed state do (f_updateButton state chkbtn_palmBack 7)
	on chkbtn_thumb1 changed state do (f_updateButton state chkbtn_thumb1 8)
	on chkbtn_thumb2 changed state do (f_updateButton state chkbtn_thumb2 9)
	on chkbtn_thumbTip changed state do (f_updateButton state chkbtn_thumbTip 10)
	on chkbtn_index1 changed state do (f_updateButton state chkbtn_index1 11)
	on chkbtn_index2 changed state do (f_updateButton state chkbtn_index2 12)
	on chkbtn_indexTip changed state do (f_updateButton state chkbtn_indexTip 13)
	on chkbtn_middle1 changed state do (f_updateButton state chkbtn_middle1 14)
	on chkbtn_middle2 changed state do (f_updateButton state chkbtn_middle2 15)
	on chkbtn_middleTip changed state do (f_updateButton state chkbtn_middleTip 16)
	on chkbtn_ring1 changed state do (f_updateButton state chkbtn_ring1 17)
	on chkbtn_ring2 changed state do (f_updateButton state chkbtn_ring2 18)
	on chkbtn_ringTip changed state do (f_updateButton state chkbtn_ringTip 19)
	on chkbtn_pinky1 changed state do (f_updateButton state chkbtn_pinky1 20)
	on chkbtn_pinky2 changed state do (f_updateButton state chkbtn_pinky2 21)
	on chkbtn_pinkyTip changed state do (f_updateButton state chkbtn_pinkyTip 22)
) --// end rollout

rollout rolBSLeftFootPivots "L-Foot" width:90
(
	local lrg = 16

	checkbutton chkbtn_frontLeft "" across:3 width:lrg height:lrg align:#left offset:[0,0] tooltip:"front left"
	checkbutton chkbtn_frontMiddle "" width:lrg height:lrg offset:[0,0] tooltip:"front middle"
	checkbutton chkbtn_frontRight "" width:lrg height:lrg offset:[3,0] tooltip:"front right"
	checkbutton chkbtn_ankle "" width:lrg height:lrg align:#left offset:[13,0] tooltip:"ankle"
	checkbutton chkbtn_backLeft "" across:3 width:lrg height:lrg align:#left offset:[0,0] tooltip:"back left"
	checkbutton chkbtn_backMiddle "" width:lrg height:lrg offset:[0,0] tooltip:"back middle"
	checkbutton chkbtn_backRight "" width:lrg height:lrg offset:[3,0] tooltip:"back right"

	fn f_uncheckAll =
	(
		chkbtn_ankle.checked = false
		chkbtn_backLeft.checked = false
		chkbtn_backMiddle.checked = false
		chkbtn_backRight.checked = false
		chkbtn_frontLeft.checked = false
		chkbtn_frontMiddle.checked = false
		chkbtn_frontRight.checked = false
	)
	
	fn f_updateButton state chkbtn index =
	(
		f_uncheckAll();
		if state then
		(
			if (f_changePivot rolBsBipedTools.m_LFoot[1].controller index) then
			(
				chkbtn.checked = true
			)
		)
		else
		(
			if (f_getPivotIndex rolBsBipedTools.m_LFoot[1].controller) > 0 then
			(
				chkbtn.checked = true
			)
		)
	)

	on rolBSLeftFootPivots open do
	(
		case (f_getPivotIndex rolBsBipedTools.m_LFoot[1].controller) of
		(
			1: chkbtn_ankle.checked = true
			2: chkbtn_backLeft.checked = true
			3: chkbtn_backMiddle.checked = true
			4: chkbtn_backRight.checked = true
			5: chkbtn_frontLeft.checked = true
			6: chkbtn_frontMiddle.checked = true
			7: chkbtn_frontRight.checked = true
			default: f_uncheckAll()
		)
	)
	
	on rolBSLeftFootPivots close do
	(
		
	)
	
	on chkbtn_ankle changed state do (f_updateButton state chkbtn_ankle 1)
	on chkbtn_backLeft changed state do (f_updateButton state chkbtn_backLeft 2)
	on chkbtn_backMiddle changed state do (f_updateButton state chkbtn_backMiddle 3)
	on chkbtn_backRight changed state do (f_updateButton state chkbtn_backRight 4)
	on chkbtn_frontLeft changed state do (f_updateButton state chkbtn_frontLeft 5)
	on chkbtn_frontMiddle changed state do (f_updateButton state chkbtn_frontMiddle 6)
	on chkbtn_frontRight changed state do (f_updateButton state chkbtn_frontRight 7)	
) --// end rollout

rollout rolBSRightFootPivots "R-Foot" width:90
(
	local lrg = 16

	checkbutton chkbtn_frontLeft "" across:3 width:lrg height:lrg align:#left offset:[0,0] tooltip:"front left"
	checkbutton chkbtn_frontMiddle "" width:lrg height:lrg offset:[0,0] tooltip:"front middle"
	checkbutton chkbtn_frontRight "" width:lrg height:lrg offset:[3,0] tooltip:"front right"
	checkbutton chkbtn_ankle "" width:lrg height:lrg align:#left offset:[39,0] tooltip:"ankle"
	checkbutton chkbtn_backLeft "" across:3 width:lrg height:lrg align:#left offset:[0,0] tooltip:"back left"
	checkbutton chkbtn_backMiddle "" width:lrg height:lrg offset:[0,0] tooltip:"back middle"
	checkbutton chkbtn_backRight "" width:lrg height:lrg offset:[3,0] tooltip:"back right"

	fn f_uncheckAll =
	(
		chkbtn_ankle.checked = false
		chkbtn_backLeft.checked = false
		chkbtn_backMiddle.checked = false
		chkbtn_backRight.checked = false
		chkbtn_frontLeft.checked = false
		chkbtn_frontMiddle.checked = false
		chkbtn_frontRight.checked = false
	)
	
	fn f_updateButton state chkbtn index =
	(
		f_uncheckAll();
		if state then
		(
			if (f_changePivot rolBsBipedTools.m_RFoot[1].controller index) then
			(
				chkbtn.checked = true
			)
		)
		else
		(
			if (f_getPivotIndex rolBsBipedTools.m_RFoot[1].controller) > 0 then
			(
				chkbtn.checked = true
			)
		)
	)

	on rolBSRightFootPivots open do
	(
		case (f_getPivotIndex rolBsBipedTools.m_RFoot[1].controller) of
		(
			1: chkbtn_ankle.checked = true
			2: chkbtn_backLeft.checked = true
			3: chkbtn_backMiddle.checked = true
			4: chkbtn_backRight.checked = true
			5: chkbtn_frontLeft.checked = true
			6: chkbtn_frontMiddle.checked = true
			7: chkbtn_frontRight.checked = true
			default: f_uncheckAll()
		)
	)
	
	on rolBSRightFootPivots close do
	(
		
	)
	
	on chkbtn_ankle changed state do (f_updateButton state chkbtn_ankle 1)
	on chkbtn_backLeft changed state do (f_updateButton state chkbtn_backLeft 2)
	on chkbtn_backMiddle changed state do (f_updateButton state chkbtn_backMiddle 3)
	on chkbtn_backRight changed state do (f_updateButton state chkbtn_backRight 4)
	on chkbtn_frontLeft changed state do (f_updateButton state chkbtn_frontLeft 5)
	on chkbtn_frontMiddle changed state do (f_updateButton state chkbtn_frontMiddle 6)
	on chkbtn_frontRight changed state do (f_updateButton state chkbtn_frontRight 7)
) --// end rollout

rollout rolBSFingers "BsBipedTools_Fingers" width:300 height:230
(
	-- â† æ–°å¢ï¼šæ‰‹æŒ‡ç»“æ„å˜é‡
	local rIsKnuckles = false
	local lIsKnuckles = false
	local mc_spreadMaxAngle = 45.0
	-- æ–°å¢æˆªæ–­ â†’

	checkbutton chbTips "æš‚ä¸æ”¯æŒ4èŠ‚æ‰‹æŒ‡" pos:[100,5] height:20 highlightColor:rolBsBipedTools.mcScanBiped checked:true

	checkbutton chbRFingers "R Fingers" pos:[40,160] width:100 highlightColor:rolBsBipedTools.mcRightFinger checked:true
	checkbutton chbLFingers "L Fingers" pos:[160,160] width:100 highlightColor:rolBsBipedTools.mcLeftFinger checked:true
	
	--R Index Finger (æ•´ä½“å³ç§»20åƒç´ å±…ä¸­)
	checkbutton select_rhand1_btn "R Hand"	enabled:true pos:[40,30] width:80 height:30 highlightColor:rolBsBipedTools.mcRight checked:true toolTip:""
	checkbutton select_rfing11_btn ""	enabled:true pos:[100,85] width:20 height:22 highlightColor:rolBsBipedTools.mcRightFinger checked:true toolTip:""
	checkbutton select_rfing12_btn ""	enabled:true pos:[100,107] width:20 height:20 highlightColor:rolBsBipedTools.mcRightFinger checked:true toolTip:""
	checkbutton select_rfing13_btn ""	enabled:true pos:[100,127] width:20 height:17 highlightColor:rolBsBipedTools.mcRightFinger checked:true toolTip:""

	--R Middle Finger
	checkbutton select_rfing21_btn ""	enabled:true pos:[80,85]	width:20 height:23 highlightColor:rolBsBipedTools.mcRightFinger checked:true toolTip:""
	checkbutton select_rfing22_btn ""	enabled:true pos:[80,108]	width:20 height:23 highlightColor:rolBsBipedTools.mcRightFinger checked:true toolTip:""
	checkbutton select_rfing23_btn ""	enabled:true pos:[80,131]	width:20 height:20 highlightColor:rolBsBipedTools.mcRightFinger checked:true ttoolTip:""
	
	--R Ring Finger
	checkbutton select_rfing31_btn ""	enabled:true pos:[60,85]	width:20 height:22 highlightColor:rolBsBipedTools.mcRightFinger checked:true toolTip:""
	checkbutton select_rfing32_btn ""	enabled:true pos:[60,107]	width:20 height:20 highlightColor:rolBsBipedTools.mcRightFinger checked:true toolTip:""
	checkbutton select_rfing33_btn ""	enabled:true pos:[60,127]	width:20 height:17 highlightColor:rolBsBipedTools.mcRightFinger checked:true toolTip:""
	
	--R Pinkie Finger
	checkbutton select_rfing41_btn ""	enabled:true pos:[40,85]	width:20 height:20 highlightColor:rolBsBipedTools.mcRightFinger checked:true toolTip:""
	checkbutton select_rfing42_btn ""	enabled:true pos:[40,105]	width:20 height:17 highlightColor:rolBsBipedTools.mcRightFinger checked:true toolTip:""
	checkbutton select_rfing43_btn ""	enabled:true pos:[40,122]	width:20 height:16 highlightColor:rolBsBipedTools.mcRightFinger checked:true toolTip:""
	
	--R Thumb
	checkbutton select_rthumb1_btn ""	enabled:true pos:[120,69]	width:20 height:30 highlightColor:rolBsBipedTools.mcRightThumb checked:true toolTip:""
	checkbutton select_rthumb2_btn ""	enabled:true pos:[120,99]	width:18 height:19 highlightColor:rolBsBipedTools.mcRightThumb checked:true toolTip:""
	checkbutton select_rthumb3_btn ""	enabled:true pos:[120,118]	width:16 height:18 highlightColor:rolBsBipedTools.mcRightThumb checked:true toolTip:""

	--LEFT HAND (å³ç§»åˆ°åˆé€‚ä½ç½®)
	--L Index Finger
	checkbutton select_lhand1_btn "L Hand"	enabled:true pos:[180,30]	width:80 height:30 highlightColor:rolBsBipedTools.mcLeft checked:true toolTip:""
	checkbutton select_lfing11_btn ""	enabled:true pos:[180,85]	width:20 height:22 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""
	checkbutton select_lfing12_btn ""	enabled:true pos:[180,107]	width:20 height:20 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""
	checkbutton select_lfing13_btn ""	enabled:true pos:[180,127]	width:20 height:17 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""
	
	--L Middle Finger
	checkbutton select_lfing21_btn ""	enabled:true pos:[200,85]	width:20 height:23 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""
	checkbutton select_lfing22_btn ""	enabled:true pos:[200,108]	width:20 height:23 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""
	checkbutton select_lfing23_btn ""	enabled:true pos:[200,131]	width:20 height:20 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""
	
	--L Ring Finger
	checkbutton select_lfing31_btn ""	enabled:true pos:[220,85]	width:20 height:22 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""
	checkbutton select_lfing32_btn ""	enabled:true pos:[220,107]	width:20 height:20 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""
	checkbutton select_lfing33_btn ""	enabled:true pos:[220,127]	width:20 height:17 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""

	--L Pinkie Finger
	checkbutton select_lfing41_btn ""	enabled:true pos:[240,85]	width:20 height:20 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""
	checkbutton select_lfing42_btn ""	enabled:true pos:[240,105]	width:20 height:17 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""
	checkbutton select_lfing43_btn ""	enabled:true pos:[240,122]	width:20 height:16 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""

	--L Thumb
	checkbutton select_lthumb1_btn ""	enabled:true pos:[160,69]	width:20 height:30 highlightColor:rolBsBipedTools.mcLeftThumb checked:true toolTip:""
	checkbutton select_lthumb2_btn ""	enabled:true pos:[162,99]	width:18 height:19 highlightColor:rolBsBipedTools.mcLeftThumb checked:true toolTip:""
	checkbutton select_lthumb3_btn ""	enabled:true pos:[164,118]	width:16 height:18 highlightColor:rolBsBipedTools.mcLeftThumb checked:true toolTip:""

	checkbutton btnFingerLineR1 "0" enabled:true pos:[120,44] width:20 height:25 checked:true toolTip:"é€‰æ‹©å•æ¡æ‰‹æŒ‡"
	checkbutton btnFingerLineR2 "1" enabled:true pos:[100,60] width:20 height:25 checked:true toolTip:"é€‰æ‹©å•æ¡æ‰‹æŒ‡"
	checkbutton btnFingerLineR3 "2" enabled:true pos:[80,60] width:20 height:25 checked:true toolTip:"é€‰æ‹©å•æ¡æ‰‹æŒ‡"
	checkbutton btnFingerLineR4 "3" enabled:true pos:[60,60] width:20 height:25 checked:true toolTip:"é€‰æ‹©å•æ¡æ‰‹æŒ‡"
	checkbutton btnFingerLineR5 "4" enabled:true pos:[40,60] width:20 height:25 checked:true toolTip:"é€‰æ‹©å•æ¡æ‰‹æŒ‡"
	checkbutton btnFingerLineL1 "0" enabled:true pos:[160,44] width:20 height:25 checked:true toolTip:"é€‰æ‹©å•æ¡æ‰‹æŒ‡"
	checkbutton btnFingerLineL2 "1" enabled:true pos:[180,60] width:20 height:25 checked:true toolTip:"é€‰æ‹©å•æ¡æ‰‹æŒ‡"
	checkbutton btnFingerLineL3 "2" enabled:true pos:[200,60] width:20 height:25 checked:true toolTip:"é€‰æ‹©å•æ¡æ‰‹æŒ‡"
	checkbutton btnFingerLineL4 "3" enabled:true pos:[220,60] width:20 height:25 checked:true toolTip:"é€‰æ‹©å•æ¡æ‰‹æŒ‡"
	checkbutton btnFingerLineL5 "4" enabled:true pos:[240,60] width:20 height:25 checked:true toolTip:"é€‰æ‹©å•æ¡æ‰‹æŒ‡"
		
	-- UI æ§ä»¶ - ç«–ç›´æ‰‹æŒ‡å¼ å¼€æ»‘å— (ä¸¤ä¾§å¯¹ç§°å¸ƒå±€ï¼ŒåŠ å¤§å°ºå¯¸)
	slider uiRSpread "" range:[1,-0.3,0] width:25 height:120 pos:[10,35] tooltip:"å³æ‰‹æ‰‹æŒ‡å¼ å¼€\nå‘ä¸‹æ‹–åŠ¨å¼ å¼€" orient:#vertical
	slider uiLSpread "" range:[1,-0.3,0] width:25 height:120 pos:[270,35] tooltip:"å·¦æ‰‹æ‰‹æŒ‡å¼ å¼€\nå‘ä¸‹æ‹–åŠ¨å¼ å¼€" orient:#vertical
	
	-- æ‰‹æŒ‡å¼¯æ›²æ§ä»¶ (åº•éƒ¨å±…ä¸­å¯¹é½)
	label lblRBend "å³æ‰‹å¼¯æ›²:" pos:[60,190] width:60 height:15
	spinner uiRBendStart "" width:50 range:[-45,90,0] scale:1 type:#integer pos:[30,205] tooltip:"å³æ‰‹å¼¯æ›²èµ·å§‹è§’åº¦"
	spinner uiRBendEnd "" width:50 range:[-45,90,0] scale:1 type:#integer pos:[85,205] tooltip:"å³æ‰‹å¼¯æ›²ç»“æŸè§’åº¦"
	
	label lblLBend "å·¦æ‰‹å¼¯æ›²:" pos:[195,190] width:60 height:15
	spinner uiLBendStart "" width:50 range:[-45,90,0] scale:1 type:#integer pos:[165,205] tooltip:"å·¦æ‰‹å¼¯æ›²èµ·å§‹è§’åº¦"
	spinner uiLBendEnd "" width:50 range:[-45,90,0] scale:1 type:#integer pos:[220,205] tooltip:"å·¦æ‰‹å¼¯æ›²ç»“æŸè§’åº¦"
	

	fn GetFinger side index =
	(
		if side == "L" then sideFinger = #lfingers 
		else if side == "R" then sideFinger = #rfingers

		selObj = biped.getNode rolBsBipedTools.m_workingBipRoot sideFinger link:index
		if selObj != undefined then
		(
			if ( selObj.isHidden == false ) or rolBsBipedTools.uiChkSelHiddenObj.state then (
				return #(selObj)
			)
			else (
				return #()
			)
		)
		else
		(
			return undefined
		)
	)

	  -- â† æ–°å¢ï¼šè·å–Bipedåç§°
	fn getBipedName =
	( 
	    if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) then return ""
	    try
	    ( 
	      local bipName = rolBsBipedTools.m_workingBipRoot.name
	      return bipName
	    ) 
	    catch() 
	    return ""
	) 

	-- â† æ–°å¢ï¼šè·å–Bipedæ§åˆ¶å™¨
	fn getBipedController =
	( 
	    if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) then return undefined
	    try
	    ( 
	      if classof rolBsBipedTools.m_workingBipRoot.controller == Vertical_Horizontal_Turn then
	        return rolBsBipedTools.m_workingBipRoot.controller
	    ) 
	    catch() 
	    return undefined
	) 

	 -- æ£€æµ‹æ˜¯å¦ä¸ºKnucklesæ¨¡å¼
	fn detectKnucklesMode =
	( 
	    local isKnuckles = false
	    try
	    ( 
	      local bipCtrl = getBipedController() 
	      if bipCtrl != undefined then
	      ( 
	        try
	        ( 
	          isKnuckles = bipCtrl.knuckles
	        ) 
	        catch() 
	      ) 
	    ) 
	    catch() 
	    return isKnuckles
	) 
	
  -- â† æ–°å¢ï¼šæ£€æµ‹æ‰‹æŒ‡ç»“æ„ï¼ˆè¿”å›æ¯æ ¹æ‰‹æŒ‡çš„èŠ‚æ•°ï¼‰
  fn DetectFingerStructure side =
  ( 
    local bipedName = getBipedName() 
    if bipedName == "" then return undefined
    
    local handSide = side
    local fingerInfo = #()  -- å­˜å‚¨æ¯æ ¹æ‰‹æŒ‡çš„ä¿¡æ¯ï¼š#(fingerIndex, segmentCount)
    
    -- æ£€æµ‹Finger0-4æ¯æ ¹æ‰‹æŒ‡
    for fingerIdx = 0 to 4 do
    ( 
      local segmentCount = 0
      local fingerName = "Finger" + fingerIdx as string
      
      -- æ£€æµ‹æœ€å¤š4èŠ‚ï¼ˆKnucklesæ¨¡å¼ï¼‰
      for segIdx = 0 to 3 do
      ( 
        local boneName = if segIdx == 0 then
          (bipedName + " " + handSide + " " + fingerName)
        else
          (bipedName + " " + handSide + " " + fingerName + segIdx as string)
        
        local bone = getNodeByName boneName
        if bone != undefined and not isDeleted bone then
          segmentCount = segIdx + 1
        else
          exit  -- é‡åˆ°ä¸å­˜åœ¨çš„èŠ‚å°±åœæ­¢æ£€æµ‹
      ) 
      
      append fingerInfo #(fingerIdx, segmentCount)
    ) 
    
    return fingerInfo
  ) 
  -- æ›´æ–°æŒ‰é’®å¯ç”¨/ç¦ç”¨çŠ¶æ€
  fn UpdateFingerButtonStates =
  ( 
    local bipedName = getBipedName() 
    if bipedName == "" then
    ( 
      -- æ²¡æœ‰bipedæ—¶ç¦ç”¨æ‰€æœ‰æŒ‰é’®
      local allBtns = #(
        select_rthumb1_btn, select_rthumb2_btn, select_rthumb3_btn,
        select_rfing11_btn, select_rfing12_btn, select_rfing13_btn,
        select_rfing21_btn, select_rfing22_btn, select_rfing23_btn,
        select_rfing31_btn, select_rfing32_btn, select_rfing33_btn,
        select_rfing41_btn, select_rfing42_btn, select_rfing43_btn,
        select_lthumb1_btn, select_lthumb2_btn, select_lthumb3_btn,
        select_lfing11_btn, select_lfing12_btn, select_lfing13_btn,
        select_lfing21_btn, select_lfing22_btn, select_lfing23_btn,
        select_lfing31_btn, select_lfing32_btn, select_lfing33_btn,
        select_lfing41_btn, select_lfing42_btn, select_lfing43_btn,
        btnFingerLineR1, btnFingerLineR2, btnFingerLineR3, btnFingerLineR4, btnFingerLineR5,
        btnFingerLineL1, btnFingerLineL2, btnFingerLineL3, btnFingerLineL4, btnFingerLineL5
      )
      for btn in allBtns do
      ( 
        btn.enabled = false
        btn.highlightColor = (color 128 128 128)
      )
      return()
    )
    
    -- æ£€æµ‹å³æ‰‹æ‰‹æŒ‡ç»“æ„
    local rFingerInfo = DetectFingerStructure "R"
    local rIsKnuckles = detectKnucklesMode()
    
    -- æ£€æµ‹å·¦æ‰‹æ‰‹æŒ‡ç»“æ„
    local lFingerInfo = DetectFingerStructure "L"
    local lIsKnuckles = detectKnucklesMode()
    
    -- å³æ‰‹æŒ‰é’®æ•°ç»„ï¼š[æ‰‹æŒ‡ç´¢å¼•][èŠ‚ç´¢å¼•] = æŒ‰é’®
    local rBtnMap = #(
      #(select_rthumb1_btn, select_rthumb2_btn, select_rthumb3_btn),      -- Finger0
      #(select_rfing11_btn, select_rfing12_btn, select_rfing13_btn),      -- Finger1
      #(select_rfing21_btn, select_rfing22_btn, select_rfing23_btn),      -- Finger2
      #(select_rfing31_btn, select_rfing32_btn, select_rfing33_btn),      -- Finger3
      #(select_rfing41_btn, select_rfing42_btn, select_rfing43_btn)       -- Finger4
    )
    
    -- å·¦æ‰‹æŒ‰é’®æ•°ç»„
    local lBtnMap = #(
      #(select_lthumb1_btn, select_lthumb2_btn, select_lthumb3_btn),
      #(select_lfing11_btn, select_lfing12_btn, select_lfing13_btn),
      #(select_lfing21_btn, select_lfing22_btn, select_lfing23_btn),
      #(select_lfing31_btn, select_lfing32_btn, select_lfing33_btn),
      #(select_lfing41_btn, select_lfing42_btn, select_lfing43_btn)
    )
    
    -- å•æŒ‡é€‰æ‹©æŒ‰é’®
    local rLineBtns = #(btnFingerLineR1, btnFingerLineR2, btnFingerLineR3, btnFingerLineR4, btnFingerLineR5)
    local lLineBtns = #(btnFingerLineL1, btnFingerLineL2, btnFingerLineL3, btnFingerLineL4, btnFingerLineL5)
    
    -- æ›´æ–°å³æ‰‹æŒ‰é’®
    for i = 1 to 5 do
    ( 
      local fingerIdx = i - 1
      local segCount = rFingerInfo[i][2]
      local btns = rBtnMap[i]
      
      -- Knucklesæ¨¡å¼ï¼šéœ€è¦è·³è¿‡ç¬¬ä¸€èŠ‚ï¼ˆæŒéª¨èŠ‚ï¼‰
      local actualSegCount = if rIsKnuckles and fingerIdx != 0 then
        (if segCount > 1 then segCount - 1 else 0)
      else
        segCount
      
      -- æ›´æ–°3ä¸ªèŠ‚æŒ‰é’®
      for j = 1 to 3 do
      ( 
        if j <= actualSegCount then
        ( 
          btns[j].enabled = true
          btns[j].highlightColor = if fingerIdx == 0 then
            rolBsBipedTools.mcRightThumb
          else
            rolBsBipedTools.mcRightFinger
        )
        else
        ( 
          btns[j].enabled = false
          btns[j].highlightColor = (color 128 128 128)
        )
      )
      
      -- æ›´æ–°å•æŒ‡é€‰æ‹©æŒ‰é’®
      if segCount > 0 then
      ( 
        rLineBtns[i].enabled = true
        rLineBtns[i].highlightColor = if fingerIdx == 0 then
          (rolBsBipedTools.mcRightThumb * 0.7)
        else
          (rolBsBipedTools.mcRightFinger * 0.7)
      )
      else
      ( 
        rLineBtns[i].enabled = false
        rLineBtns[i].highlightColor = (color 128 128 128)
      )
    )
    
    -- æ›´æ–°å·¦æ‰‹æŒ‰é’®
    for i = 1 to 5 do
    ( 
      local fingerIdx = i - 1
      local segCount = lFingerInfo[i][2]
      local btns = lBtnMap[i]
      
      -- Knucklesæ¨¡å¼ï¼šéœ€è¦è·³è¿‡ç¬¬ä¸€èŠ‚ï¼ˆæŒéª¨èŠ‚ï¼‰
      local actualSegCount = if lIsKnuckles and fingerIdx != 0 then
        (if segCount > 1 then segCount - 1 else 0)
      else
        segCount
      
      -- æ›´æ–°3ä¸ªèŠ‚æŒ‰é’®
      for j = 1 to 3 do
      ( 
        if j <= actualSegCount then
        ( 
          btns[j].enabled = true
          btns[j].highlightColor = if fingerIdx == 0 then
            rolBsBipedTools.mcLeftThumb
          else
            rolBsBipedTools.mcLeftFinger
        )
        else
        ( 
          btns[j].enabled = false
          btns[j].highlightColor = (color 128 128 128)
        )
      )
      
      -- æ›´æ–°å•æŒ‡é€‰æ‹©æŒ‰é’®
      if segCount > 0 then
      ( 
        lLineBtns[i].enabled = true
        lLineBtns[i].highlightColor = if fingerIdx == 0 then
          (rolBsBipedTools.mcLeftThumb * 0.7)
        else
          (rolBsBipedTools.mcLeftFinger * 0.7)
      )
      else
      ( 
        lLineBtns[i].enabled = false
        lLineBtns[i].highlightColor = (color 128 128 128)
      )
    )
  )
  -- æ–°å¢æˆªæ–­ â†’


	-- â† æ–°å¢ï¼šé€‰æ‹©å•æ ¹æ‰‹æŒ‡æ‰€æœ‰éª¨éª¼
	fn SelectWholeFinger side fingerIndex =
	( 
	    local bipedName = getBipedName() 
	    if bipedName == "" then return false
	    
	    local isKnuckles = detectKnucklesMode() 
	    local handSide = side
	    local fingerBones = #() 
	    
	    if fingerIndex == 0 then
	    ( 
	      -- æ‹‡æŒ‡ï¼šFinger0, Finger01, Finger02, (Finger03åœ¨Knuckleså¯èƒ½ä¸å­˜åœ¨)
	      local f0 = getNodeByName (bipedName + " " + handSide + " Finger0") 
	      local f01 = getNodeByName (bipedName + " " + handSide + " Finger01") 
	      local f02 = getNodeByName (bipedName + " " + handSide + " Finger02") 
	      local f03 = getNodeByName (bipedName + " " + handSide + " Finger03") 
	      if f0 != undefined and not isDeleted f0 then append fingerBones f0
	      if f01 != undefined and not isDeleted f01 then append fingerBones f01
	      if f02 != undefined and not isDeleted f02 then append fingerBones f02
	      if f03 != undefined and not isDeleted f03 then append fingerBones f03
	    ) 
	    else
	    ( 
		    -- Finger1-4
		    local fingerName = "Finger" + fingerIndex as string
		      
		    if isKnuckles then
		    ( 
		        -- Knucklesæ¨¡å¼ï¼šåŒ…å«æŒéª¨èŠ‚(Finger1/2/3/4) + 3æŒ‡èŠ‚(Finger11/21/31/41ç­‰)
		        local f0 = getNodeByName (bipedName + " " + handSide + " " + fingerName) 
		        local f1 = getNodeByName (bipedName + " " + handSide + " " + fingerName + "1") 
		        local f2 = getNodeByName (bipedName + " " + handSide + " " + fingerName + "2") 
		        local f3 = getNodeByName (bipedName + " " + handSide + " " + fingerName + "3") 
		        if f0 != undefined and not isDeleted f0 then append fingerBones f0
		        if f1 != undefined and not isDeleted f1 then append fingerBones f1
		        if f2 != undefined and not isDeleted f2 then append fingerBones f2
		        if f3 != undefined and not isDeleted f3 then append fingerBones f3
		    ) 
		    else
		    ( 
		        -- æ ‡å‡†æ¨¡å¼ï¼šFinger1/2/3/4 + Finger11/21ç­‰
		        local f0 = getNodeByName (bipedName + " " + handSide + " " + fingerName) 
		        local f1 = getNodeByName (bipedName + " " + handSide + " " + fingerName + "1") 
		        local f2 = getNodeByName (bipedName + " " + handSide + " " + fingerName + "2") 
		        if f0 != undefined and not isDeleted f0 then append fingerBones f0
		        if f1 != undefined and not isDeleted f1 then append fingerBones f1
		        if f2 != undefined and not isDeleted f2 then append fingerBones f2
		    ) 
	    ) 
	    
	    if fingerBones.count > 0 then
	    ( 
	      select fingerBones
	      return true
	    ) 
	    return false
	) 

	-- é€‰æ‹©æ‰€æœ‰æ‰‹æŒ‡ï¼ˆåŒ…å«æ‹‡æŒ‡Finger0ï¼‰
	fn SelectAllFingers side =
	( 
	    local bipedName = getBipedName() 
	    if bipedName == "" then return false
	    
	    local isKnuckles = detectKnucklesMode() 
	    local handSide = side
	    local allFingerBones = #() 
	    
	    -- é€‰æ‹©Finger0-4æ‰€æœ‰éª¨éª¼ï¼ˆåŒ…å«æ‹‡æŒ‡ï¼‰
	    for fingerIdx = 0 to 4 do
	    ( 
	      local fingerName = "Finger" + fingerIdx as string
	      
	      if isKnuckles then
	      ( 
	        -- Knucklesæ¨¡å¼ï¼š4èŠ‚ï¼ˆæ‹‡æŒ‡3èŠ‚ï¼‰
	        if fingerIdx == 0 then
	        ( 
	          -- æ‹‡æŒ‡ï¼šFinger0, Finger01, Finger02
	          local f0 = getNodeByName (bipedName + " " + handSide + " " + fingerName) 
	          local f1 = getNodeByName (bipedName + " " + handSide + " " + fingerName + "1") 
	          local f2 = getNodeByName (bipedName + " " + handSide + " " + fingerName + "2") 
	          if f0 != undefined and not isDeleted f0 then append allFingerBones f0
	          if f1 != undefined and not isDeleted f1 then append allFingerBones f1
	          if f2 != undefined and not isDeleted f2 then append allFingerBones f2
	        )
	        else
	        ( 
	          -- å…¶ä»–æ‰‹æŒ‡ï¼šåŒ…å«æŒéª¨èŠ‚ + 3æŒ‡èŠ‚
	          local f0 = getNodeByName (bipedName + " " + handSide + " " + fingerName) 
	          local f1 = getNodeByName (bipedName + " " + handSide + " " + fingerName + "1") 
	          local f2 = getNodeByName (bipedName + " " + handSide + " " + fingerName + "2") 
	          local f3 = getNodeByName (bipedName + " " + handSide + " " + fingerName + "3") 
	          if f0 != undefined and not isDeleted f0 then append allFingerBones f0
	          if f1 != undefined and not isDeleted f1 then append allFingerBones f1
	          if f2 != undefined and not isDeleted f2 then append allFingerBones f2
	          if f3 != undefined and not isDeleted f3 then append allFingerBones f3
	        )
	      ) 
	      else
	      ( 
	        -- æ ‡å‡†æ¨¡å¼ï¼š3èŠ‚
	        local f0 = getNodeByName (bipedName + " " + handSide + " " + fingerName) 
	        local f1 = getNodeByName (bipedName + " " + handSide + " " + fingerName + "1") 
	        local f2 = getNodeByName (bipedName + " " + handSide + " " + fingerName + "2") 
	        if f0 != undefined and not isDeleted f0 then append allFingerBones f0
	        if f1 != undefined and not isDeleted f1 then append allFingerBones f1
	        if f2 != undefined and not isDeleted f2 then append allFingerBones f2
	      ) 
	    ) 
	    
	    if allFingerBones.count > 0 then
	    ( 
	      select allFingerBones
	      return true
	    ) 
	    return false
	)
	-- æ–°å¢æˆªæ–­ â†’

	-- â† æ–°å¢ï¼šæ™ºèƒ½è·å–æ‰‹æŒ‡éª¨éª¼ï¼ˆæ ¹æ®æ¨¡å¼è‡ªåŠ¨æ˜ å°„ï¼‰
	fn GetFingerBone side fingerIdx segmentIdx =
	( 
	    local bipedName = getBipedName() 
	    if bipedName == "" then return undefined
	    
	    local isKnuckles = detectKnucklesMode() 
	    local handSide = side
	    local boneName = ""
	    
	    -- æ‹‡æŒ‡ç‰¹æ®Šå¤„ç†
	    if fingerIdx == 0 then
	    ( 
	      if segmentIdx == 1 then boneName = bipedName + " " + handSide + " Finger0"
	      else if segmentIdx == 2 then boneName = bipedName + " " + handSide + " Finger01"
	      else if segmentIdx == 3 then boneName = bipedName + " " + handSide + " Finger02"
	    ) 
	    else
	    ( 
	      local fingerName = "Finger" + fingerIdx as string
	      
	      if isKnuckles then
	      ( 
	        -- Knucklesæ¨¡å¼ï¼šè·³è¿‡æŒéª¨èŠ‚ï¼Œç›´æ¥æ˜ å°„åˆ°Finger11/12/13
	        if segmentIdx == 1 then boneName = bipedName + " " + handSide + " " + fingerName + "1"
	        else if segmentIdx == 2 then boneName = bipedName + " " + handSide + " " + fingerName + "2"
	        else if segmentIdx == 3 then boneName = bipedName + " " + handSide + " " + fingerName + "3"
	      ) 
	      else
	      ( 
	        -- æ ‡å‡†æ¨¡å¼ï¼šå…ˆæ£€æŸ¥æ˜¯å¦æœ‰æ ¹èŠ‚ç‚¹Finger1/2/3/4
	        local rootNode = getNodeByName (bipedName + " " + handSide + " " + fingerName)
	        
	        if rootNode != undefined and not isDeleted rootNode then
	        ( 
	          -- æœ‰æ ¹èŠ‚ç‚¹ï¼ˆ3èŠ‚æ¨¡å¼ï¼‰ï¼šFinger1 â†’ Finger11 â†’ Finger12
	          if segmentIdx == 1 then boneName = bipedName + " " + handSide + " " + fingerName
	          else if segmentIdx == 2 then boneName = bipedName + " " + handSide + " " + fingerName + "1"
	          else if segmentIdx == 3 then boneName = bipedName + " " + handSide + " " + fingerName + "2"
	        ) 
	        else
	        ( 
	          -- æ— æ ¹èŠ‚ç‚¹ï¼ˆ2èŠ‚æ¨¡å¼ï¼‰ï¼šç›´æ¥ä»Finger11å¼€å§‹
	          if segmentIdx == 1 then boneName = bipedName + " " + handSide + " " + fingerName + "1"
	          else if segmentIdx == 2 then boneName = bipedName + " " + handSide + " " + fingerName + "2"
	          else if segmentIdx == 3 then return undefined  -- ç¬¬3èŠ‚ä¸å­˜åœ¨
	        ) 
	      ) 
	    ) 
	    
	    if boneName != "" then
	    ( 
	      local bone = getNodeByName boneName
	      if bone != undefined and not isDeleted bone then
	        return bone
	    ) 
	    
	    return undefined
	) 




	on select_lhand1_btn changed state do (
		select_lhand1_btn.state = true
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) do ( rolBsBipedTools.SetButtonState false; return ())
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			rolBsBipedTools.Straighten rolBsBipedTools.m_LHand ((eulerangles -90 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(rolBsBipedTools.CompSelect selBackup rolBsBipedTools.m_LHand) catch (
			rolBsBipedTools.m_LHand = rolBsBipedTools.GetLHand()
			select rolBsBipedTools.m_LHand
		)
	)

	on select_lhand1_btn rightclick do 
	(
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) do ( rolBsBipedTools.SetButtonState false; return ())
		rolBsBipedTools.m_RHand = rolBsBipedTools.GetRHand()
		select rolBsBipedTools.m_RHand
	)

	
	on select_rhand1_btn changed state do (
		select_rhand1_btn.state = true
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) do ( rolBsBipedTools.SetButtonState false; return ())
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			rolBsBipedTools.Straighten rolBsBipedTools.m_RHand ((eulerangles 90 0 0) as quat)
			return ()
		)

		selBackup = selection as array

		try(rolBsBipedTools.CompSelect selBackup rolBsBipedTools.m_RHand) catch (
			rolBsBipedTools.m_RHand = rolBsBipedTools.GetRHand()
			select rolBsBipedTools.m_RHand
			
		)
	)

	on select_rhand1_btn rightclick do 
	(
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) do ( rolBsBipedTools.SetButtonState false; return ())
		rolBsBipedTools.m_LHand = rolBsBipedTools.GetLHand()
		select rolBsBipedTools.m_LHand
	)

	on chbTips changed state do
	(
		chbTips.state = true
	)

	on chbRFingers changed state do
	( 
	    chbRFingers.state = true
	    if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) do (return ()) 
	    SelectAllFingers "R"
	) 

	-- å³æ‰‹æ‹‡æŒ‡
	on select_rthumb1_btn changed state do ( 
	    select_rthumb1_btn.state = true
	    local bone = GetFingerBone "R" 0 1
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
	) 

	on select_rthumb2_btn changed state do ( 
	    select_rthumb2_btn.state = true
	    local bone = GetFingerBone "R" 0 2
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
	)

	on select_rthumb3_btn changed state do ( 
	    select_rthumb3_btn.state = true
	    local bone = GetFingerBone "R" 0 3
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
	) 

	-- å³æ‰‹é£ŸæŒ‡
	on select_rfing11_btn changed state do ( 
	    select_rfing11_btn.state = true
	    local bone = GetFingerBone "R" 1 1
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
	  ) 

	on select_rfing12_btn changed state do ( 
	    select_rfing12_btn.state = true
	    local bone = GetFingerBone "R" 1 2
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
	  ) 

	on select_rfing13_btn changed state do ( 
	    select_rfing13_btn.state = true
	    local bone = GetFingerBone "R" 1 3
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
	  ) 

  	-- å³æ‰‹ä¸­æŒ‡
	on select_rfing21_btn changed state do ( 
	    select_rfing21_btn.state = true
	    local bone = GetFingerBone "R" 2 1
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
	) 

	  on select_rfing22_btn changed state do ( 
	    select_rfing22_btn.state = true
	    local bone = GetFingerBone "R" 2 2
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
	  ) 

	on select_rfing23_btn changed state do ( 
	    select_rfing23_btn.state = true
	    local bone = GetFingerBone "R" 2 3
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
	) 


 	 -- å³æ‰‹æ— åæŒ‡
 	 on select_rfing31_btn changed state do ( 
	    select_rfing31_btn.state = true
	    local bone = GetFingerBone "R" 3 1
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
 	 ) 

 	 on select_rfing32_btn changed state do ( 
	    select_rfing32_btn.state = true
	    local bone = GetFingerBone "R" 3 2
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
 	 ) 

 	 on select_rfing33_btn changed state do ( 
	    select_rfing33_btn.state = true
	    local bone = GetFingerBone "R" 3 3
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
  	) 

 	 -- å³æ‰‹å°æŒ‡
 	 on select_rfing41_btn changed state do ( 
	    select_rfing41_btn.state = true
	    local bone = GetFingerBone "R" 4 1
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
  	) 

  	on select_rfing42_btn changed state do ( 
	    select_rfing42_btn.state = true
	    local bone = GetFingerBone "R" 4 2
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
  	) 

 	 on select_rfing43_btn changed state do ( 
	    select_rfing43_btn.state = true
	    local bone = GetFingerBone "R" 4 3
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
  	)


	on chbLFingers changed state do
	( 
	    chbLFingers.state = true
	    if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) do (return ()) 
	    SelectAllFingers "L"
	)

	-- å·¦æ‰‹æ‹‡æŒ‡
  	on select_lthumb1_btn changed state do ( 
	    select_lthumb1_btn.state = true
	    local bone = GetFingerBone "L" 0 1
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
  	) 

 	 on select_lthumb2_btn changed state do ( 
	    select_lthumb2_btn.state = true
	    local bone = GetFingerBone "L" 0 2
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
  	) 

 	 on select_lthumb3_btn changed state do ( 
	    select_lthumb3_btn.state = true
	    local bone = GetFingerBone "L" 0 3
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
 	 ) 

  	-- å·¦æ‰‹é£ŸæŒ‡
  	on select_lfing11_btn changed state do ( 
	    select_lfing11_btn.state = true
	    local bone = GetFingerBone "L" 1 1
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
  	) 

  	on select_lfing12_btn changed state do ( 
	    select_lfing12_btn.state = true
	    local bone = GetFingerBone "L" 1 2
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
  	) 

  	on select_lfing13_btn changed state do ( 
	    select_lfing13_btn.state = true
	    local bone = GetFingerBone "L" 1 3
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
  	) 

  	-- å·¦æ‰‹ä¸­æŒ‡
  	on select_lfing21_btn changed state do ( 
	    select_lfing21_btn.state = true
	    local bone = GetFingerBone "L" 2 1
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
  	) 

  	on select_lfing22_btn changed state do ( 
	    select_lfing22_btn.state = true
	    local bone = GetFingerBone "L" 2 2
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
  	) 

  	on select_lfing23_btn changed state do ( 
	    select_lfing23_btn.state = true
	    local bone = GetFingerBone "L" 2 3
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
  	) 

 	 -- å·¦æ‰‹æ— åæŒ‡
  	on select_lfing31_btn changed state do ( 
	    select_lfing31_btn.state = true
	    local bone = GetFingerBone "L" 3 1
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
  	) 

  	on select_lfing32_btn changed state do ( 
	    select_lfing32_btn.state = true
	    local bone = GetFingerBone "L" 3 2
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
  	) 

  	on select_lfing33_btn changed state do ( 
	    select_lfing33_btn.state = true
	    local bone = GetFingerBone "L" 3 3
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
 	 ) 

  	-- å·¦æ‰‹å°æŒ‡
  	on select_lfing41_btn changed state do ( 
	    select_lfing41_btn.state = true
	    local bone = GetFingerBone "L" 4 1
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
  	) 

 	 on select_lfing42_btn changed state do ( 
	    select_lfing42_btn.state = true
	    local bone = GetFingerBone "L" 4 2
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
  	) 

  	on select_lfing43_btn changed state do ( 
	    select_lfing43_btn.state = true
	    local bone = GetFingerBone "L" 4 3
	    if bone == undefined do return()
	    
	    selBackup = selection as array
	    
	    if keyboard.controlPressed and keyboard.altpressed do ( 
	      rolBsBipedTools.Straighten #(bone) ((eulerangles 0 0 0) as quat) 
	      return () 
	    ) 
	    
	    try(rolBsBipedTools.CompSelect selBackup #(bone)) catch (select bone)
  	)

-- å³æ‰‹å•æ ¹æ‰‹æŒ‡é€‰æ‹©æŒ‰é’®
  on btnFingerLineR1 changed state do ( 
    btnFingerLineR1.state = true
    SelectWholeFinger "R" 0
  ) 
  
  on btnFingerLineR2 changed state do ( 
    btnFingerLineR2.state = true
    SelectWholeFinger "R" 1
  ) 
  
  on btnFingerLineR3 changed state do ( 
    btnFingerLineR3.state = true
    SelectWholeFinger "R" 2
  ) 
  
  on btnFingerLineR4 changed state do ( 
    btnFingerLineR4.state = true
    SelectWholeFinger "R" 3
  ) 
  
  on btnFingerLineR5 changed state do ( 
    btnFingerLineR5.state = true
    SelectWholeFinger "R" 4
  ) 

	
  -- å·¦æ‰‹å•æ ¹æ‰‹æŒ‡é€‰æ‹©æŒ‰é’®
  on btnFingerLineL1 changed state do ( 
    btnFingerLineL1.state = true
    SelectWholeFinger "L" 0
  ) 
  
  on btnFingerLineL2 changed state do ( 
    btnFingerLineL2.state = true
    SelectWholeFinger "L" 1
  ) 
  
  on btnFingerLineL3 changed state do ( 
    btnFingerLineL3.state = true
    SelectWholeFinger "L" 2
  ) 
  
  on btnFingerLineL4 changed state do ( 
    btnFingerLineL4.state = true
    SelectWholeFinger "L" 3
  ) 
  
  on btnFingerLineL5 changed state do ( 
    btnFingerLineL5.state = true
    SelectWholeFinger "L" 4
  )
	
	-- çº¿æ€§æ’å€¼å‡½æ•°
	function LerpFloat a b bias = (
		return a + (b - a) * bias
	)

	function MakeClosest quat1 quat2 = -- modifies quat2 and also returns quat2
	(
		local dot = quat1.x*quat2.x + quat1.y*quat2.y + quat1.z*quat2.z+quat1.w*quat2.w
		if (dot < 0.0) do (quat2.x = -quat2.x; quat2.y = -quat2.y;quat2.z = -quat2.z; quat2.w = -quat2.w)
		quat2
	)
	
	-- æ‰‹æŒ‡å¼ å¼€å‡½æ•° (å®Œå…¨å‚è€ƒBipedAssistå®ç°ï¼Œ6ä¸ªå‚æ•°)
	-- æ‰‹æŒ‡å¼ å¼€å‡½æ•°ï¼ˆä¼˜åŒ–ç‰ˆ - åªå¯¹æ ¹æŒ‡èŠ‚æ“ä½œï¼‰
	function SpreadFingers fingersArr minAngle maxAngle spread bendStart bendEnd isKnucklesMode side =
	( 
	    if fingersArr.count < 1 do return() 
	    if fingersArr.count == 1 then
	    ( 
	      return() 
	    ) 
	    
	    local spreadMultiplier = if side == "L" then -1.0 else 1.0
	    
	    for fingerIndex = 1 to fingersArr.count do
	    ( 
		    if fingersArr[fingerIndex].count > 0 then
		    ( 
		      	local tFingerBias = ((fingerIndex - 1) as float) / ((fingersArr.count - 1) as float) 
		        local tWeightedAngle = LerpFloat bendStart bendEnd tFingerBias
		        local tSpreadMaxAngle = LerpFloat minAngle maxAngle tFingerBias
		        local tSpreadMaxQuat = eulerToQuat (eulerAngles 0 (tSpreadMaxAngle * spreadMultiplier) tWeightedAngle) order:1
		        local tSpreadMinQuat = eulerToQuat (eulerAngles 0 0 tWeightedAngle) order:1
		        MakeClosest tSpreadMinQuat tSpreadMaxQuat
		        local tRot = slerp tSpreadMinQuat tSpreadMaxQuat spread
		        
		        try
		        ( 
		          tRot = tRot * fingersArr[fingerIndex][1].parent.transform.rotation
		          biped.setTransform fingersArr[fingerIndex][1] #rotation tRot false
		        ) 
		        catch() 
		    ) 
	    ) 
	)
		
	-- æ‰‹æŒ‡å¼¯æ›²å‡½æ•° (å®Œå…¨å‚è€ƒBipedAssistå®ç°)
	-- æ‰‹æŒ‡å¼¯æ›²å‡½æ•°ï¼ˆä¼˜åŒ–ç‰ˆ - å¯¹æ‰€æœ‰æŒ‡èŠ‚æ“ä½œï¼‰
	function BendFingers fingersArr bendStart bendEnd spread isKnucklesMode side = ( 
	    if fingersArr.count < 1 do return() 
	    
	    local spreadMultiplier = if side == "L" then -1.0 else 1.0
	    
	    if fingersArr.count == 1 then
	    ( 
	      local avgAngle = (bendStart + bendEnd) / 2.0
	      
	      if fingersArr[1].count > 0 then
	      ( 
	        try
	        ( 
	          local tRot = eulerToQuat (eulerAngles avgAngle 0 0) order:6
	          tRot = tRot * fingersArr[1][1].parent.transform.rotation
	          biped.setTransform fingersArr[1][1] #rotation tRot false
	          
	          if fingersArr[1].count >= 2 do
	          ( 
	            for i = 2 to fingersArr[1].count do
	            ( 
	              tRot = eulerToQuat (eulerAngles avgAngle 0 0) order:6
	              tRot = tRot * fingersArr[1][i].parent.transform.rotation
	              biped.setTransform fingersArr[1][i] #rotation tRot false
	            ) 
	          ) 
	        ) 
	        catch() 
	      ) 
	      return() 
	    ) 
	    
	    for fingerIndex = 1 to fingersArr.count do
	    ( 
	        if fingersArr[fingerIndex].count > 0 then
	        ( 
		        local tFingerBias = ((fingerIndex - 1) as float) / ((fingersArr.count - 1) as float) 
		        local tWeightedAngle = LerpFloat bendStart bendEnd tFingerBias
		        local tSpreadSliderValue = ((tFingerBias - 0.5) * 2.0) * spread * mc_spreadMaxAngle * spreadMultiplier
		        local tBendY = LerpFloat tSpreadSliderValue 0 ((tWeightedAngle as float) / 90.0) 
		        local tBendX = LerpFloat 0 -tSpreadSliderValue ((tWeightedAngle as float) / 90.0) 
		        
		        try
		        ( 
		          local tRot = eulerToQuat (eulerAngles tWeightedAngle tBendY tBendX) order:6
		          tRot = tRot * fingersArr[fingerIndex][1].parent.transform.rotation
		          biped.setTransform fingersArr[fingerIndex][1] #rotation tRot false
		          
		          if fingersArr[fingerIndex].count >= 2 do
		          ( 
		            for i = 2 to fingersArr[fingerIndex].count do
		            ( 
		              tRot = eulerToQuat (eulerAngles tWeightedAngle 0 0) order:6
		              tRot = tRot * fingersArr[fingerIndex][i].parent.transform.rotation
		              biped.setTransform fingersArr[fingerIndex][i] #rotation tRot false
		            ) 
		          ) 
		        ) 
		        catch() 
		    ) 
	    ) 
	)

	  function GetFingerArray side isKnucklesMode =
	  ( 
	    local fingerArr = #() 
	    local bipedName = getBipedName() 
	    
	    if bipedName == "" or bipedName == undefined then return fingerArr
	    
	    local handSide = side
	    
	    if isKnucklesMode then
	    ( 
	      -- Knucklesæ¨¡å¼ï¼šè·³è¿‡æŒéª¨èŠ‚(Finger1/2/3/4)ï¼Œä»Finger11/21/31/41å¼€å§‹
	      
	      -- Finger1 (é£ŸæŒ‡) - 3èŠ‚
	      local finger1 = #() 
	      local f1_1 = getNodeByName (bipedName + " " + handSide + " Finger11") 
	      local f1_2 = getNodeByName (bipedName + " " + handSide + " Finger12") 
	      local f1_3 = getNodeByName (bipedName + " " + handSide + " Finger13") 
	      if f1_1 != undefined and not isDeleted f1_1 then append finger1 f1_1
	      if f1_2 != undefined and not isDeleted f1_2 then append finger1 f1_2
	      if f1_3 != undefined and not isDeleted f1_3 then append finger1 f1_3
	      if finger1.count > 0 do append fingerArr finger1
	      
	      -- Finger2 (ä¸­æŒ‡) - 3èŠ‚
	      local finger2 = #() 
	      local f2_1 = getNodeByName (bipedName + " " + handSide + " Finger21") 
	      local f2_2 = getNodeByName (bipedName + " " + handSide + " Finger22") 
	      local f2_3 = getNodeByName (bipedName + " " + handSide + " Finger23") 
	      if f2_1 != undefined and not isDeleted f2_1 then append finger2 f2_1
	      if f2_2 != undefined and not isDeleted f2_2 then append finger2 f2_2
	      if f2_3 != undefined and not isDeleted f2_3 then append finger2 f2_3
	      if finger2.count > 0 do append fingerArr finger2
	      
	      -- Finger3 (æ— åæŒ‡) - 3èŠ‚
	      local finger3 = #() 
	      local f3_1 = getNodeByName (bipedName + " " + handSide + " Finger31") 
	      local f3_2 = getNodeByName (bipedName + " " + handSide + " Finger32") 
	      local f3_3 = getNodeByName (bipedName + " " + handSide + " Finger33") 
	      if f3_1 != undefined and not isDeleted f3_1 then append finger3 f3_1
	      if f3_2 != undefined and not isDeleted f3_2 then append finger3 f3_2
	      if f3_3 != undefined and not isDeleted f3_3 then append finger3 f3_3
	      if finger3.count > 0 do append fingerArr finger3
	      
	      -- Finger4 (å°æŒ‡) - 3èŠ‚
	      local finger4 = #() 
	      local f4_1 = getNodeByName (bipedName + " " + handSide + " Finger41") 
	      local f4_2 = getNodeByName (bipedName + " " + handSide + " Finger42") 
	      local f4_3 = getNodeByName (bipedName + " " + handSide + " Finger43") 
	      if f4_1 != undefined and not isDeleted f4_1 then append finger4 f4_1
	      if f4_2 != undefined and not isDeleted f4_2 then append finger4 f4_2
	      if f4_3 != undefined and not isDeleted f4_3 then append finger4 f4_3
	      if finger4.count > 0 do append fingerArr finger4
	      
	    ) 
	    else
	    ( 
	      -- æ ‡å‡†3èŠ‚æ¨¡å¼ï¼šFinger1-4å„3èŠ‚ï¼ˆåŒ…å«Finger1/2/3/4æ ¹èŠ‚ï¼‰ï¼Œè·³è¿‡æ‹‡æŒ‡
	      
	      -- Finger1 (é£ŸæŒ‡) - 3èŠ‚
	      local finger1 = #() 
	      local f1_0 = getNodeByName (bipedName + " " + handSide + " Finger1") 
	      local f1_1 = getNodeByName (bipedName + " " + handSide + " Finger11") 
	      local f1_2 = getNodeByName (bipedName + " " + handSide + " Finger12") 
	      if f1_0 != undefined and not isDeleted f1_0 then append finger1 f1_0
	      if f1_1 != undefined and not isDeleted f1_1 then append finger1 f1_1
	      if f1_2 != undefined and not isDeleted f1_2 then append finger1 f1_2
	      if finger1.count > 0 do append fingerArr finger1
	      
	      -- Finger2 (ä¸­æŒ‡) - 3èŠ‚
	      local finger2 = #() 
	      local f2_0 = getNodeByName (bipedName + " " + handSide + " Finger2") 
	      local f2_1 = getNodeByName (bipedName + " " + handSide + " Finger21") 
	      local f2_2 = getNodeByName (bipedName + " " + handSide + " Finger22") 
	      if f2_0 != undefined and not isDeleted f2_0 then append finger2 f2_0
	      if f2_1 != undefined and not isDeleted f2_1 then append finger2 f2_1
	      if f2_2 != undefined and not isDeleted f2_2 then append finger2 f2_2
	      if finger2.count > 0 do append fingerArr finger2
	      
	      -- Finger3 (æ— åæŒ‡) - 3èŠ‚
	      local finger3 = #() 
	      local f3_0 = getNodeByName (bipedName + " " + handSide + " Finger3") 
	      local f3_1 = getNodeByName (bipedName + " " + handSide + " Finger31") 
	      local f3_2 = getNodeByName (bipedName + " " + handSide + " Finger32") 
	      if f3_0 != undefined and not isDeleted f3_0 then append finger3 f3_0
	      if f3_1 != undefined and not isDeleted f3_1 then append finger3 f3_1
	      if f3_2 != undefined and not isDeleted f3_2 then append finger3 f3_2
	      if finger3.count > 0 do append fingerArr finger3
	      
	      -- Finger4 (å°æŒ‡) - 3èŠ‚
	      local finger4 = #() 
	      local f4_0 = getNodeByName (bipedName + " " + handSide + " Finger4") 
	      local f4_1 = getNodeByName (bipedName + " " + handSide + " Finger41") 
	      local f4_2 = getNodeByName (bipedName + " " + handSide + " Finger42") 
	      if f4_0 != undefined and not isDeleted f4_0 then append finger4 f4_0
	      if f4_1 != undefined and not isDeleted f4_1 then append finger4 f4_1
	      if f4_2 != undefined and not isDeleted f4_2 then append finger4 f4_2
	      if finger4.count > 0 do append fingerArr finger4
	      
	    ) 
	    
	    return fingerArr
	  )
	-- å³æ‰‹å¼ å¼€äº‹ä»¶
	on uiRSpread rightClick do (
		uiRSpread.value = 0
		uiRSpread.changed 0
	)
	
	on uiRSpread changed var do ( 
	    if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) do return() 
	    rIsKnuckles = detectKnucklesMode()  -- åŠ¨æ€æ£€æµ‹
	    local m_RFingers = GetFingerArray "R" rIsKnuckles
	    if m_RFingers.count > 0 then ( 
	      BendFingers m_RFingers uiRBendStart.value uiRBendEnd.value var rIsKnuckles "R"
	      if var != 0 then
	        SpreadFingers m_RFingers (-mc_spreadMaxAngle) mc_spreadMaxAngle var uiRBendStart.value uiRBendEnd.value rIsKnuckles "R"
	    ) 
	) 
	
	-- å·¦æ‰‹å¼ å¼€äº‹ä»¶
	on uiLSpread rightClick do (
		uiLSpread.value = 0
		uiLSpread.changed 0
	)
	
	on uiLSpread changed var do ( 
	    if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) do return() 
	    lIsKnuckles = detectKnucklesMode()  -- åŠ¨æ€æ£€æµ‹
	    local m_LFingers = GetFingerArray "L" lIsKnuckles
	    if m_LFingers.count > 0 then ( 
	      BendFingers m_LFingers uiLBendStart.value uiLBendEnd.value var lIsKnuckles "L"
	      if var != 0 then
	        SpreadFingers m_LFingers (-mc_spreadMaxAngle) mc_spreadMaxAngle var uiLBendStart.value uiLBendEnd.value lIsKnuckles "L"
	    ) 
	) 
	
	-- å³æ‰‹å¼¯æ›²äº‹ä»¶ (é£ŸæŒ‡ã€ä¸­æŒ‡ã€æ— åæŒ‡)
	on uiRBendEnd changed var do ( 
	    if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) do return() 
	    rIsKnuckles = detectKnucklesMode()  -- åŠ¨æ€æ£€æµ‹
	    local m_RFingers = GetFingerArray "R" rIsKnuckles
	    if m_RFingers.count > 0 then ( 
	      BendFingers m_RFingers uiRBendStart.value uiRBendEnd.value uiRSpread.value rIsKnuckles "R"
	      if uiRSpread.value != 0 then
	        SpreadFingers m_RFingers (-mc_spreadMaxAngle) mc_spreadMaxAngle uiRSpread.value uiRBendStart.value uiRBendEnd.value rIsKnuckles "R"
	    ) 
	) 

	
	on uiRBendStart changed var do ( 
	    if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) do return() 
	    rIsKnuckles = detectKnucklesMode()  -- åŠ¨æ€æ£€æµ‹
	    local m_RFingers = GetFingerArray "R" rIsKnuckles
	    if m_RFingers.count > 0 then ( 
	      BendFingers m_RFingers uiRBendStart.value uiRBendEnd.value uiRSpread.value rIsKnuckles "R"
	      if uiRSpread.value != 0 then
	        SpreadFingers m_RFingers (-mc_spreadMaxAngle) mc_spreadMaxAngle uiRSpread.value uiRBendStart.value uiRBendEnd.value rIsKnuckles "R"
	    ) 
	) 
	
	-- å·¦æ‰‹å¼¯æ›²äº‹ä»¶ (ä¸­æŒ‡ã€æ— åæŒ‡ã€å°æŒ‡)
	on uiLBendStart changed var do ( 
	    if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) do return() 
	    lIsKnuckles = detectKnucklesMode()  -- åŠ¨æ€æ£€æµ‹
	    local m_LFingers = GetFingerArray "L" lIsKnuckles
	    if m_LFingers.count > 0 then ( 
	      BendFingers m_LFingers uiLBendStart.value uiLBendEnd.value uiLSpread.value lIsKnuckles "L"
	      if uiLSpread.value != 0 then
	        SpreadFingers m_LFingers (-mc_spreadMaxAngle) mc_spreadMaxAngle uiLSpread.value uiLBendStart.value uiLBendEnd.value lIsKnuckles "L"
	    ) 
	) 
	
	on uiLBendEnd changed var do ( 
	    if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) do return() 
	    lIsKnuckles = detectKnucklesMode()  -- åŠ¨æ€æ£€æµ‹
	    local m_LFingers = GetFingerArray "L" lIsKnuckles
	    if m_LFingers.count > 0 then ( 
	      BendFingers m_LFingers uiLBendStart.value uiLBendEnd.value uiLSpread.value lIsKnuckles "L"
	      if uiLSpread.value != 0 then
	        SpreadFingers m_LFingers (-mc_spreadMaxAngle) mc_spreadMaxAngle uiLSpread.value uiLBendStart.value uiLBendEnd.value lIsKnuckles "L"
	    ) 
	)

	on rolBSFingers open do
	( 
	    -- æ‰“å¼€é¢æ¿æ—¶æ›´æ–°æŒ‰é’®çŠ¶æ€
	    UpdateFingerButtonStates()
	)
)

fn fnLoadBsBTConfig =
(
	local oldPrintAllElements  = options.printAllelements
	options.printAllelements = true
	attr = (GetINISetting iniBsBipedTools "BsBipedTools" "BsBTPos") as string  --å…ˆæå–æ–‡ä»¶ä¸­çš„è®°å½•
	if (attr == "") or (attr == "undefined") then 
	(
		attr = execute "0"
	)
	else 
	(
		attr = execute attr
	)
	options.printAllelements = oldPrintAllElements
	iniBsBTPos = attr
)
fnLoadBsBTConfig()

fn fnSetBsBTConfig =
(
	SetINISetting iniBsBipedTools "BsBipedTools" "BsBTPos" (iniBsBTPos as string)
)

fn fnGetThemeColor =
(
	local curColorThemeFile = colorMan.getFileName()
	local maxuiBgColor = (colorman.getcolor #background) * 255
	
	if (curColorThemeFile != undefined) then
	(
		if (matchpattern curColorThemeFile pattern:"*light*") then
		(
			outThemeColor = "Light"
		)
		else
		(
			case maxuiBgColor of 
			(
				([68,68,68]):
				(
					outThemeColor = "Dark"
				)
				([186,186,186]):
				(
					outThemeColor = "Light"
				)
				default:
				(
					outThemeColor = "Dark"
				)
			)
		)
	)
	else
	(
		case maxuiBgColor of 
		(
			([68,68,68]):
			(
				outThemeColor = "Dark"
			)
			([186,186,186]):
			(
				outThemeColor = "Light"
			)
			default:
			(
				outThemeColor = "Dark"
			)
		)
	)
	return outThemeColor
	----è·å–å½“å‰ä¸»é¢˜æ˜¯æ·±è‰²è¿˜æ˜¯æµ…è‰²,æ¥æ›´æ”¹æ–‡å­—é¢œè‰² fnGetColorTheme.ms
)

rollout rolBsBipedTools "BsBipedTools" width:180 height:585
(
	local colorTheme = fnGetThemeColor()

	fn fnChangeThemeColor myColor =
	(
		colorTheme = fnGetThemeColor()
		if colorTheme == "Light" then (return myColor) else (return myColor/1.5)
	)

	fn fnBipedComlocalization ctrl =
	(
		if (((sysinfo.GetMaxLanguage())[3]=="CHS") and ((maxVersion())[1] < 20000)) then 
		(
			return ctrl.flip.controller
		)
		else
		(
			return ctrl.turning.controller
		)
	)

	fn fnAddBipedKey =
	(
		for i in selection as array where iskindof i.baseObject Biped_Object do
		(
			if ( classof i.controller == Vertical_Horizontal_Turn ) then
			(
				biped.addNewKey i.controller.vertical.controller slidertime
				biped.addNewKey i.controller.horizontal.controller slidertime
				biped.addNewKey (fnBipedComlocalization i.controller) slidertime
			)
			else 
			(
				try (biped.addNewKey i.controller sliderTime ) catch ()
			)
		)
	)

	fn fnGetAllBipedCom = 
	(
		allBips = #()
		for obj in geometry where not isDeleted obj and classof obj.baseobject == Biped_Object and (classof obj.controller == Vertical_Horizontal_Turn) do
		(
			append allBips obj
		)
		return allBips
	)

	fn fnGetAllSelRootNode = 
	(
		allRootNode = #()
		for obj in selection as array where (classof obj == Biped_object) and ((classof obj.controller == Vertical_Horizontal_Turn) or (classof obj.controller == BipSlave_Control)) do
		(
			if finditem allRootNode obj.controller.rootnode != 0 then 
			(
				Continue
			)
			else 
			(
				appendifUnique allRootNode obj.controller.rootnode
			)
		)
		return allRootNode
	)

	local a_layerNames = #()
	local a_layersActiveState = #()
	local ctrl = undefined
	local numLayers = 0
	local layerIndex = 1
	local postureObjsFile = getDir #plugcfg + "\BsBipedTools_PostureObjs.txt"
	
	-- é¢œæ–‡å­—è„¸æ•°ç»„ (å¤šæ ·åŒ–ç®€æ´ç‰ˆï¼Œæ— è„¸æ¡†)
	local headFaces = #("ï½¡â—•á´—â—•ï½¡", \
		"^_^", "T_T", "O_O", "o_o", "x_x", "Q_Q", "-_-", ">_<", "<_<", ">_>",
		"v_v", "u_u", "U_U", "o_O", "O_o", "Â¬_Â¬", "TÏ‰T", "OwO", "UwU", "TwT",
		"owo", "uwu", "ToT", "TAT", "XD", "OvO", "oVo", "TvT", "T^T", "T.T",
		"à²¥_à²¥", "à²¥ï¹à²¥", "à²¥â€¿à²¥", "à²¥ç›Šà²¥", "à²¥âŒ£à²¥", "à²¥â€¸à²¥", "à²¥à²¥"
	)
		local currentFaceIndex = 1
	
	-- ä¿å­˜è„¸å‹ç´¢å¼•åˆ°é…ç½®æ–‡ä»¶
	fn fnSaveHeadFace =
	(
		SetINISetting iniBsBipedTools "BsBipedTools" "HeadFaceIndex" (currentFaceIndex as string)
	)
	
	-- è¿˜åŸè„¸å‹åˆ°åˆå§‹çŠ¶æ€
	fn fnResetHeadFace =
	(
		if (queryBox "ç¡®å®šè¦è¿˜åŸå¤´éƒ¨è¡¨æƒ…åˆ°åˆå§‹çŠ¶æ€å—ï¼Ÿ" title:"è¿˜åŸè¡¨æƒ…ç¡®è®¤") then
		(
			currentFaceIndex = 1
			uiHead.text = headFaces[1]
			fnSaveHeadFace()
			messageBox "å¤´éƒ¨è¡¨æƒ…å·²è¿˜åŸåˆ°åˆå§‹çŠ¶æ€ï¼" title:"BsBipedTools"
		)
	)

	local mc_setKeyColor = fnChangeThemeColor (color 240 180 180)
	local mc_spineColor  = fnChangeThemeColor (color 52 171 187)
	local mcLeft         = fnChangeThemeColor (color 120 120 193)
	local mcRight        = fnChangeThemeColor (color 53 176 53)
	local mcHead         = fnChangeThemeColor (color 160 229 248)
	local mcPevils       = fnChangeThemeColor (color 220 208 148)
	local mcLoopSel      = fnChangeThemeColor (color 200 160 200)
	local mcIK           = fnChangeThemeColor (color 223 225 71)
	local mcFK           = fnChangeThemeColor (color 160 160 160)
	local mcAllBiped     = fnChangeThemeColor (color 200 180 221)
	local mcScanBiped    = fnChangeThemeColor (color 250 200 200)
	local mcMotionPanel  = fnChangeThemeColor (color 223 225 200)
	local mcSelTools     = fnChangeThemeColor (color 20 180 180)
	local mcInPlace      = fnChangeThemeColor (color 192 192 255)
	local mcLeftFinger   = fnChangeThemeColor (color 163 61 180)
	local mcRightFinger  = fnChangeThemeColor (color 176 191 46)
	local mcLeftThumb    = fnChangeThemeColor (color 191 46 46)
	local mcRightThumb   = fnChangeThemeColor (color 241 228 157)

	label lblVersion verBsBipedTools height:15 width:30 align:#left pos:[3,0]
	button btnResetFace "â—•" offset:[25, -5] height:15 width:15 border:false align:#right pos:[100,0] tooltip:"è¿˜åŸå¤´éƒ¨è¡¨æƒ…åˆ°åˆå§‹çŠ¶æ€"
	button btnMini "â˜" offset:[45, -5] height:15 width:20 border:false align:#right pos:[120,0]
	button uiAbout "?" offset:[-15, -5] height:15 width:20 border:false align:#left pos:[140,0]
	button btnClose "X" offset:[15, -5] height:15 width:20 border:false align:#right pos:[160,0]
	
	dropdownlist ddlAllBipedCom items:#() selection:1 \
	tooltip:"é€‰æ‹©bipedéª¨æ¶" width:70 pos:[10, 20] across:2
	checkButton uiChkBtnScanBiped "All Biped" pos:[85, 20] width:60 checked:true highlightColor:mcScanBiped \
	tooltip:"å¦‚æœBipedå‘ç”Ÿå˜åŒ–ï¼Œè¯·é‡æ–°æ‰«æã€‚\r\nå¦‚æœæœ‰å¤šä¸ª Bipedï¼Œè¯·åœ¨å·¦è¾¹ä¸‹æ‹‰é€‰æ‹©ã€‚\r\nè¿˜å¯ç”¨æ¥é€‰ä¸­å½“å‰éª¨æ¶æ‰€æœ‰Bipedéª¨éª¼~"
	checkButton uiToggleMotionPanel "M" pos:[150, 20] width:20 checked:true highlightColor:mcMotionPanel \
	tooltip:"å·¦é”®ç¦ç”¨Motioné¢æ¿ (å¤§å¤§å‡å°‘å¡é¡¿)\r\nå³é”®æ¢å¤ (å¦‚æœªæ¢å¤è¯·å³å‡»å¤šæ¬¡)\r\næ³¨æ„è§‚å¯ŸæŒ‰é’®é¢œè‰² (ä½†é¢œè‰²é‡å¯å¤±æ•ˆ)\r\n(æ³¨æ„:æŸäº›BipedåŠŸèƒ½ä¾èµ–Motioné¢æ¿åˆ·æ–°)"
	
	checkButton uiCkbZen "Zen" checked:true width:25 height:23 pos:[10,50] highlightColor:mcMotionPanel \
	tooltip:"ç¦…æ¨¡å¼åˆ‡æ¢ï¼ˆæœ€å¤§åŒ–è§†çª—ï¼‰"
	checkButton uiCkbHideBip "HB" checked:true width:20 height:23 pos:[40,50] highlightColor:mcMotionPanel \
	tooltip:"å·¦é”®åˆ‡æ¢éšè—æ˜¾ç¤ºBipedéª¨éª¼\r\nå³é”®ç›´æ¥éšè—"

	checkButton uiCkbXray "Xray" checked:true width:20 height:23 pos:[120,50] highlightColor:mcMotionPanel \
	tooltip:"å·¦é”®Xrayæ¨¡å¼åˆ‡æ¢\r\nå³é”®ç›´æ¥å¼€å¯"
	checkButton uiCkbShowBox "Box" checked:true width:25 height:23 pos:[145,50] highlightColor:mcMotionPanel \
	tooltip:"å·¦é”®Boxæ¨¡å¼åˆ‡æ¢\r\nå³é”®ç›´æ¥å¼€å¯"

	checkBox uiChkSelHiddenObj "Select hidden biped" checked:true pos:[-99, -99]
	
	checkButton uiHead "" width: 50 height:33 checked:true highlightColor:mcHead pos:[65, 50]  --è¡¨æƒ…ä»Soxå·¥å…·å¾—åˆ°çµæ„Ÿ~~
	checkButton uiNecks "Necks" width: 40 height:23 checked:true highlightColor:mc_spineColor align:#center pos:[70, 85]
	
	checkButton uiRArms "" checked:true highlightColor:mcRight width:25 align:#left pos:[15, 85] across:2
	checkButton uiLArms "" checked:true highlightColor:mcLeft width:25 align:#right pos:[140, 85]
	
	checkButton uiRClavicle "Clavicle" width:55 height:18 checked:true highlightColor:mcRight across:2 pos:[25, 110]
	checkButton uiLClavicle "Clavicle" width:55 height:18 checked:true highlightColor:mcLeft pos:[100, 110]
	
	checkButton uiAllSpine height:64 width:26 checked:true highlightColor:mc_spineColor pos:[60, 130] align:#center
	checkButton uiSpine3 "3" width:30 height:16 checked:true highlightColor:mc_spineColor align:#center pos:[90, 130]
	checkButton uiSpine2 "2" width:30 height:16 checked:true highlightColor:mc_spineColor align:#center pos:[90, 146]
	checkButton uiSpine1 "1" width:30 height:16 checked:true highlightColor:mc_spineColor align:#center pos:[90, 162]
	checkButton uiSpine0 "0" width:30 height:16 checked:true highlightColor:mc_spineColor align:#center pos:[90, 178]
	
	checkButton uiCOM "COM" checked:true width:50 height:30 highlightColor:mcHead pos:[65, 195]
	checkButton uiPelvis "Pelvis" checked:true highlightColor:mcPevils width:60 height:18 pos:[60, 225]
	
	checkButton uiRUpArm "R" width:25  height:30 pos:[20, 131] checked:true highlightColor:mcRight across:2
	checkButton uiLUpArm "L" width:25  height:30 pos:[135, 131] checked:true highlightColor:mcLeft
	checkButton uiRForArm "R" width:25  height:30 pos:[20, 161] checked:true highlightColor:mcRight across:2
	checkButton uiLForArm "L" width:25  height:30 pos:[135, 161] checked:true highlightColor:mcLeft
	checkButton uiRHand "Hand" pos:[10, 191] height:25 checked:true highlightColor:mcRight across:2
	checkButton uiLHand "Hand" pos:[130, 191] height:25 checked:true highlightColor:mcLeft
	
	checkButton uiPropR "Prop" width:35 height:18 checked:true highlightColor:mcSelTools pos:[13, 223]
	checkButton uiPropL "Prop" width:35 height:18 checked:true highlightColor:mcSelTools pos:[133, 223]

	checkButton uiRThigh "R" width:30  height:30 align:#right checked:true highlightColor:mcRight pos:[58, 245] across:2
	checkButton uiLThigh "L" width:30 height:30 align:#left checked:true highlightColor:mcLeft pos:[93, 245]
	checkButton uiRCalf "R" width:30  height:30 checked:true highlightColor:mcRight align:#right  pos:[58, 275] across:2
	checkButton uiLCalf "L" width:30  height:30 checked:true highlightColor:mcLeft align:#left pos:[93, 275]
	checkButton uiRFoot "R Foot" checked:true highlightColor:mcRight align:#right pos:[45, 305] width:40 height:25 across:2
	checkButton uiLFoot "L Foot" checked:true highlightColor:mcLeft align:#left pos:[95, 305] width:40 height:25
	
	checkButton uiRLegs "" checked:true highlightColor:mcRight width:25 align:#left pos:[23, 265] across:2
	checkButton uiLLegs "" checked:true highlightColor:mcLeft width:25 align:#right pos:[132, 265]
	
	checkButton uiRToe "Toe" checked:true highlightColor:mcRight width:30 height:20 align:#left pos:[15, 310] across:2
	checkButton uiLToe "Toe" checked:true highlightColor:mcLeft width:30 height:20 align:#right pos:[135, 310]
	
	checkButton uiAllFoot "" width:50 checked:true highlightColor:mcSelTools align:#center  pos:[65, 335]
	-- checkButton uiAllBip "All Biped" width:100 checked:true highlightColor:mcAllBiped pos:[0, -4] align:#center
	checkButton uiFingers "" width:50 checked:true highlightColor:mcSelTools pos:[10, 335]
	checkButton uiPivot "" width:50 checked:true highlightColor:mcSelTools pos:[120, 335]
	

	groupbox grpKinInfo "" pos:[-10, 358] width:200 height:100
	
	checkbutton uiCbtHorTrack "" pos:[10, 370] width:30 height:25 border:false
	checkbutton uiCbtVerTrack "" pos:[40, 370] width:30 height:25 border:false
	checkbutton uiCbtTurnTrack "" pos:[70, 370] width:30 height:25 border:false
	button uiBtnComLock "" pos:[105, 370] width:30 height:25 border:false 
	checkbutton uiBtnInPlace "" pos:[140,370] width:30 height:25 \
	tooltip:"åŸåœ°æ¨¡å¼å»å‰åä½ç§»\r\nIn Place Mode Y\r\nå³é”®çœŸåŸåœ°æ¨¡å¼" \
	border:false highlightColor:mcInPlace

	checkButton uiBtnSetAllKey "" pos:[10, 400] across:4 width:25 height:25 border:false \
	tooltip:"å·¦é”®é€‰æ‹©Kå¸§,\r\nå³é”®Bipedå…¨å¸§." checked:true highlightColor:mcFK
	checkButton uiBtnDeleteKey "" width:25 height:25 tooltip:"å·¦é”®åˆ é™¤æ‰€é€‰Bipedå½“å‰æ»‘æ¡å¸§\r\nå³é”®æ¸…é™¤Bipedæ‰€æœ‰å¸§" \
	pos:[37, 400] border:false checked:true highlightColor:mcFK
	checkButton uiBtnLimbPK "" width:25 height:25 tooltip:"Shift + å•å‡» - åº”ç”¨äºæ‰€æœ‰å¸§ï¼Œ\r\nCtrl + å•å‡» - åº”ç”¨äºé€‰å®šå¸§ã€‚\r\nï¼ˆä¼šå¡ä¸€ä¸‹å› ä¸ºå¿…é¡»è¦Motioné¢æ¿ï¼‰" \
	pos:[65, 400] border:false checked:true highlightColor:mcFK
	checkButton uiBtnLimbIK "" width:25 height:25 tooltip:"Shift + å•å‡» - åº”ç”¨äºæ‰€æœ‰å¸§ï¼Œ\r\nCtrl + å•å‡» - åº”ç”¨äºé€‰å®šå¸§ã€‚\r\nï¼ˆä¼šå¡ä¸€ä¸‹å› ä¸ºå¿…é¡»è¦Motioné¢æ¿ï¼‰" \
	pos:[90, 400] border:false checked:true highlightColor:mcFK
	checkButton uiBtnLimbFK "" width:25 height:25 tooltip:"Shift + å•å‡» - åº”ç”¨äºæ‰€æœ‰å¸§ï¼Œ\r\nCtrl + å•å‡» - åº”ç”¨äºé€‰å®šå¸§ã€‚\r\nï¼ˆä¼šå¡ä¸€ä¸‹å› ä¸ºå¿…é¡»è¦Motioné¢æ¿ï¼‰" \
	pos:[115, 400] border:false checked:true highlightColor:mcFK
	checkButton uiBtnTraj "" width:25 height:25
	pos:[145, 400] border:false checked:true highlightColor:mcFK
	
	
	dropdownlist uiDropPlaySpeed pos:[8, 430] items:#("1/4", "1/2", "1", "2", "4") selection:3 tooltip:"æ’­æ”¾é€Ÿåº¦" width:50 
	checkbutton uiPlayBlock "" pos:[60, 430] width:30 height:21 tooltip:"æ’­æ”¾Blocking(æ— è¿‡åº¦)" border:true
	button uiBtnFrameTick "" pos:[90, 430] width:30 height:21 tooltip:"æ•´æ•°å¸§/å°æ•°å¸§åˆ‡æ¢\r\nä¾¿äºæ‹–æ»‘æ¡ç»†è°ƒåŠ¨ç”»" border:true
	checkbutton uiFigureMode "" pos:[120,430] width:25 height:21 tooltip:"å½¢ä½“ç¼–è¾‘æ¨¡å¼\r\nFigure Mode" border:true highlightColor:mcInPlace
	button uiWorkbench "" pos:[145,430] width:27 height:21 tooltip:"Bipedæ›²çº¿ç¼–è¾‘\r\nWorkbench" border:true
    
	dotNetControl dotnetTabs "System.Windows.Forms.TabControl" pos:[2,460] height:160 width:45

	--copy paste tools
	checkbutton uiCbtCopy "" pos:[50,465] width:30 height:25 visible:false checked:true highlightColor:mcFK tooltip:"å¤åˆ¶Poseture"
	checkbutton uiCbtPaste "" pos:[80,465] width:30 height:25 visible:false checked:true highlightColor:mcFK tooltip:"ç²˜è´´Poseture"
	checkbutton uiCbtPasteOpposite "" pos:[110,465] width:30 height:25 visible:false checked:true highlightColor:mcFK tooltip:"é•œåƒç²˜è´´Poseture"
	checkbutton uiCbtSelPostureObjs "" pos:[140,465] width:35 height:25 visible:false checked:true highlightColor:mcFK tooltip:"é€‰æ‹©å¤åˆ¶poseçš„Bipedéª¨éª¼"
	checkbutton uiCbtMirrorRArm "å³â†’å·¦è‡‚" pos:[50,495] width:60 height:25 visible:false checked:true highlightColor:mcRight
	checkbutton uiCbtMirrorLArm "å·¦â†’å³è‡‚" pos:[115,495] width:60 height:25 visible:false checked:true highlightColor:mcLeft
	checkbutton uiCbtMirrorRLeg "å³â†’å·¦è…¿" pos:[50,523] width:60 height:25 visible:false checked:true highlightColor:mcRight
	checkbutton uiCbtMirrorLLeg "å·¦â†’å³è…¿" pos:[115,523] width:60 height:25 visible:false checked:true highlightColor:mcLeft
	checkbutton uiCbtGrabPose "é€Ÿå­˜Pose" pos:[50,550] width:60 height:25 visible:false checked:true highlightColor:mcFK
	checkbutton uiCbtLoadPose "åŠ è½½Pose" pos:[115,550] width:60 height:25 visible:false checked:true highlightColor:mcFK

	--layers tools
	button uiCbtDown "" pos:[50,465] width:20 height:20 visible:false border:false
	button uiCbtUp "" pos:[70,465] width:20 height:20 visible:false border:false
	label uiLblLayerID "0" pos:[95,469] width:20 height:16 visible:false style_sunkenedge:true readonly:true
	label uiLblActive "æ´»åŠ¨" pos:[130,470] width:25 height:25 visible:false
	checkbox uiChkActive "" pos:[160,465] width:60 height:25 visible:false checked:true
	dropDownList ddlLayers "" pos:[50,489] width:110 visible:false
	checkbutton uiCbtRefreshLayer "R" pos:[160,490] width:15 height:20 visible:false checked:true highlightColor:mcScanBiped tooltip:"åˆ·æ–°"
	button uiCbtAddLayer "" pos:[52,514] width:30 height:20 visible:false border:false
	button uiCbtDelLayer "" pos:[82,514] width:30 height:20 visible:false border:false
	button uiCbtDownLayer "" pos:[112,514] width:30 height:20 visible:false border:false
	button uiCbtSnapKeys "" pos:[142,514] width:30 height:20 visible:false border:false tooltip:"å·¦é”®å¸é™„å½“å‰å¸§ï¼Œå³é”®å¸é™„å¸§æ æ‰€æœ‰å¸§"
	checkbutton uiCbtLeftArm "" pos:[52,537] width:30 height:20 visible:false checked:false highlightColor:mcHead border:false
	checkbutton uiCbtRightArm "" pos:[82,537] width:30 height:20 visible:false checked:false highlightColor:mcHead border:false
	checkbutton uiCbtLeftLeg "" pos:[112,537] width:30 height:20 visible:false checked:false highlightColor:mcHead border:false
	checkbutton uiCbtRightLeg "" pos:[142,537] width:30 height:20 visible:false checked:false highlightColor:mcHead border:false
	button uiCbtUpdate "æ›´æ–°" pos:[50,560] width:65 height:20 visible:false --border:false
	checkbox uiChkIKonly "ä»…IK" pos:[130,560] width:100 height:20 visible:false checked:false highlightColor:mcHead tooltip:"æ²¡æ‰¾åˆ°è·å–çŠ¶æ€çš„api...åªèƒ½updateè®¾ç½®"

	--loopkey tools
	checkButton uiBtnLoopGet "èŒƒå›´" tooltip:"è·å–å½“å‰æ—¶é—´è½´\r\nGet current timerange" checked:true width:43 \
	highlightColor:mcAllBiped align:#left pos:[50, 465] height:20 across:3 visible:false
	spinner uiSpnLoopStart tooltip:"Loop Range" type:#integer range:[-9999,9999,0] width:50 align:#left pos:[48, 493] visible:false
	spinner uiSpnLoopEnd tooltip:"Loop Range" type:#integer range:[-9999,9999,30] width:50 align:#left pos:[101, 493] visible:false
	checkButton uiCkbClearUserDef "X" border:true pos:[159, 465] height:70 width:16 checked:true highlightColor:mcAllBiped visible:false \
	tooltip:"æ¸…é™¤ éª¨æ¶ä¿å­˜çš„å¾ªç¯å¸§è‡ªå®šä¹‰å±æ€§å€¼ã€‚\r\nï¼ˆå¯¹æ–‡ä»¶æœ¬èº«æ— ä»»ä½•å½±å“ï¼‰ "
	checkButton uiBtnGotoMirror "è·³è½¬å¯¹ç§°å¸§" checked:true highlightColor:mcAllBiped tooltip:"æ»‘æ¡è·³è½¬åˆ°é•œåƒå¸§\r\nGoto symmetry key" \
	align:#left pos:[50, 515] height:20 width:103 across:2 visible:false

	checkButton uiBtnLoopSel "é€‰æ‹©å¸§" height:20 width:57 pos:[95, 465] checked:true highlightColor:mcAllBiped align:#left \
	tooltip:"é€‰æ‹©å¾ªç¯å†…çš„æ‰€æœ‰å¸§\r\nSelect keys in the looping range." visible:false

	-- groupbox grpKeyList "å…³é”®å¸§ä¹¦ç­¾" pos:[50, 535] width:140 height:45
	button btnKey1 "Key" width:30 height:20 pos:[50, 540] border:true
	button btnKey2 "Key" width:30 height:20 pos:[82, 540] border:true
	button btnKey3 "Key" width:30 height:20 pos:[114, 540] border:true
	button btnKey4 "Key" width:30 height:20 pos:[146, 540] border:true
	button btnKey5 "Key" width:30 height:20 pos:[50, 560] border:true
	button btnKey6 "Key" width:30 height:20 pos:[82, 560] border:true
	button btnKey7 "Key" width:30 height:20 pos:[114, 560] border:true
	button btnKey8 "Key" width:30 height:20 pos:[146, 560] border:true


	--other tools
	checkButton uiBtn0 "0" pos:[50,465] width:30 height:25 tooltip:"æ›²æŸ„æ‰“ç›´ Continuity (TCB)\r\nCtrl/Shift å¯æ‰¹å¤„ç†\r\nESCå¯ä¸­æ–­" border:true visible:false checked:true highlightColor:mcInPlace
	checkButton uiBtn25 "25" pos:[82,465] width:30 height:25 tooltip:"æ›²æŸ„é»˜è®¤ Continuity (TCB)\r\nCtrl/Shift å¯æ‰¹å¤„ç†\r\nESCå¯ä¸­æ–­" border:true visible:false checked:true highlightColor:mcInPlace
	checkButton uiBtnLoadBip "S" pos:[114, 465] width:30 height:25 tooltip:"" border:true visible:false checked:true highlightColor:mcInPlace
	checkButton uiBtnSaveBip "L" pos:[146, 465] width:30 height:25 tooltip:"" border:true visible:false checked:true highlightColor:mcInPlace

	-- label uiLblTitle "BsBipedTools_v1.0" height:16 width:rolBsBipedTools.width pos:[5, 585]
	timer clock "PlayClock" interval:1 active:false -- ê°€ì¥ ë¹ ë¥¸ ì¸í„°ë²Œë¡œ
--/////////////////////////////////////////////////////////////////////////////////////////////////
    button btnAddScale "æ·»åŠ ç¼©æ”¾" pos:[50,495] width:62
    button btnRemoveScale "ç§»é™¤ç¼©æ”¾" pos:[114,495] width:62
	checkButton ckbBendLink "å¼¯æ›²" pos:[50,520] width:30 highlightColor:mcInPlace
	checkButton ckbTwistLink "æ‰­æ›²" pos:[82,520] width:30 highlightColor:mcInPlace
	checkButton ckbTwistIndiv "è‡ªèº«" pos:[114,520] width:30 highlightColor:mcInPlace
	checkButton ckbSmoothTwist "å¹³æ»‘" pos:[146,520] width:30 highlightColor:mcInPlace
	button btnZeroTwist "å½’é›¶æ‰­æ›²" pos:[50,540] width:62
	button btnZeroAllLink "å½’é›¶æ‰€æœ‰" pos:[114,540] width:62
	
	local arrLoopTools = #("å¾ªç¯",#(uiBtnLoopGet,uiSpnLoopStart,uiSpnLoopEnd,uiCkbClearUserDef,uiBtnLoopSel,uiBtnGotoMirror,\
		btnKey1,btnKey2,btnKey3,btnKey4,btnKey5,btnKey6,btnKey7,btnKey8))
	local arrOtherTools = #("å…¶ä»–",#(uiBtn0,uiBtn25,uiBtnLoadBip,uiBtnSaveBip,btnAddScale,btnRemoveScale,ckbBendLink,ckbTwistLink,ckbTwistIndiv,\
		ckbSmoothTwist,btnZeroTwist,btnZeroAllLink)) 
	local arrLayerTools = #("å±‚å±‚",#(uiCbtRefreshLayer,uiCbtDown,uiCbtUp,uiLblLayerID,uiLblActive,uiChkActive,uiCbtAddLayer,\
		uiCbtDelLayer,uiCbtDownLayer,uiCbtSnapKeys,uiCbtLeftArm,uiCbtRightArm,uiCbtLeftLeg,uiCbtRightLeg,uiCbtUpdate,uiChkIKonly,ddlLayers))
	local arrCopyTools = #("å¤åˆ¶",#(uiCbtCopy,uiCbtPaste,uiCbtPasteOpposite,uiCbtSelPostureObjs,uiCbtMirrorLArm,uiCbtMirrorRArm,\
		uiCbtMirrorLLeg,uiCbtMirrorRLeg,uiCbtGrabPose,uiCbtLoadPose))
	local arrAllToolsTab = #(arrCopyTools,arrLayerTools,arrLoopTools,arrOtherTools)

	local m_goto1; local m_goto2; local m_goto3; local m_goto4; local m_goto5; local m_goto6; local m_goto7; local m_goto8

	
	fn fnRefreshTwistState =
	(
		if selection.count == 1 and classOf selection[1] == Biped_Object then
        (
            bipRoot = selection[1].controller.rootNode
            try (
                local ctrl = bipRoot.controller
                ckbBendLink.state = ctrl.bendLinksMode
                ckbTwistLink.state = ctrl.twistLinksMode
                ckbTwistIndiv.state = ctrl.twistIndMode
                
                -- æ£€æŸ¥SmoothTwistçŠ¶æ€
                try (
                    ckbSmoothTwist.state = bipRoot.controller.SmoothTwistMode
                ) catch (
                    ckbSmoothTwist.state = false
                )
            )
            catch ()
        )
        else
        (
            ckbBendLink.state = false
            ckbTwistLink.state = false
            ckbTwistIndiv.state = false
            ckbSmoothTwist.state = false
        )
	)

	fn fnSetTwistLink ctrl index =
	(
		case index of
		(
			(1):(ctrl.bendLinksMode = true;ctrl.twistLinksMode = ctrl.twistIndMode = ctrl.SmoothTwistMode = false)
			(2):(ctrl.twistLinksMode = true;ctrl.bendLinksMode = ctrl.twistIndMode = ctrl.SmoothTwistMode = false)
			(3):(ctrl.twistIndMode = true;ctrl.twistLinksMode = ctrl.bendLinksMode = ctrl.SmoothTwistMode = false)
			(4):(ctrl.SmoothTwistMode = true;ctrl.twistLinksMode = ctrl.twistIndMode = ctrl.bendLinksMode = false)
		)
		fnRefreshTwistState()
	)

	fn fnChangeToolsVisble id =
	(
		for i = 1 to arrAllToolsTab.count do 
		(
			if i == id then
			(
				for j in arrAllToolsTab[i][2] do j.visible = true
			)
			else (for j in arrAllToolsTab[i][2] do j.visible = false)
		)
	)

	-- fn fnDotnetBitmap fName =
	-- (
	-- 	if doesFileExist fName then
	-- 	(
	-- 		local img = (dotnetclass "System.Drawing.Image").fromfile fName 
	-- 		local retBmp = dotnetObject "System.Drawing.Bitmap" (img.Width) (img.height)
	-- 		local g = (dotnetclass "system.drawing.graphics").fromImage retBmp
	-- 		g.drawimage img 0 0 	
	-- 		img.Dispose();
	-- 		retBmp
	-- 	)
	-- 	else return undefined
	-- )

	fn fnInitDotTabs =
	(
		-- imgTab1 = fnDotnetBitmap @"D:\Download\paste (2).png"
		-- imgTab2 = fnDotnetBitmap @"D:\Download\å›¾å±‚ (4).png"
		-- imgTab3 = fnDotnetBitmap @"D:\Download\å›¾å±‚ (4).png"
		-- imgTab4 = fnDotnetBitmap @"D:\Download\å›¾å±‚ (4).png"
		-- -- imgTab1 = dotNetObject "System.Drawing.Bitmap" imgPath
		-- imageList = dotNetObject "System.Windows.Forms.ImageList"

		-- imageList.ImageSize = dotNetObject "System.Drawing.Size" 20 20
		-- imageList.images.add(imgTab1)
		-- imageList.images.add(imgTab2)
		-- imageList.images.add(imgTab3)
		-- imageList.images.add(imgTab4)

		dotnetTabs.sizeMode  = dotnetTabs.sizeMode.Fixed
		dotnetTabs.itemSize  = dotNetObject "System.Drawing.Size" 29 40
		dotnetTabs.dock      = dotnetTabs.dock.Fill
		dotnetTabs.Drawmode  = dotnetTabs.Drawmode.OwnerDrawFixed
		dotnetTabs.alignment = (dotnetclass "system.Windows.Forms.Tabalignment").left

		for aTab = 1 to arrAllToolsTab.count do
		(
			dotnetTabs.TabPages.add arrAllToolsTab[aTab][1]
			-- dotnetTabs.TabPages.item[aTab - 1].ImageIndex = aTab - 1
			-- dotnetTabs.TabPages.item[aTab - 1].text = ""
			-- print  aTab[1]
		)
		-- dotnetTabs.imagelist = imageList
	)

	on dotnetTabs Selected itm do
	(
		arrID = (itm.TabPageIndex + 1)
		if LastSubRollout != arrID do --do not update if the same tab clicked twice
		(
			fnChangeToolsVisble arrID
		) 
	)

	fn fnApplyIcons =
	(
		uiBtnSetAllKey.images      = #("bip_ikkey_i.bmp","bip_ikkey_i.bmp",8,1,1,1,1,true,true)
		uiBtnDeleteKey.images      = #("bip_keyframe_i.bmp","bip_keyframe_i.bmp",46,3,3,3,3,true,true)
		uiBtnLimbPK.images         = #("bip_ikkey_i.bmp","bip_ikkey_i.bmp",8,3,3,3,3,true,true)
		uiBtnLimbIK.images         = #("bip_ikkey_i.bmp","bip_ikkey_i.bmp",8,5,5,5,5,true,true)
		uiBtnLimbFK.images         = #("bip_ikkey_i.bmp","bip_ikkey_i.bmp",8,7,7,7,7,true,true)
		uiPlayBlock.images         = #("bip_mfltrans_i.bmp","bip_mfltrans_i.bmp",26,21,21,21,21,true,true)
		uiToggleMotionPanel.images = #("bip_pivselbig_i.bmp","bip_pivselbig_i.bmp",6,6,6,6,6,true,true)
		uiCkbShowBox.images        = #("UVWUnwrapView_16i.bmp","UVWUnwrapView_16a.bmp",28,9,9,9,9,true,false)
		uiCkbXray.images           = #("bip_modes_i.bmp","bip_modes_i.bmp",8,2,2,2,2,true,true)
		uiCkbHideBip.images        = #("bip_tracksel_i.bmp","bip_tracksel_i.bmp",10,7,7,7,7,true,true)
		uiCkbZen.images            = #("FileLinkActionItems_16i.bmp","FileLinkActionItems_16i.bmp",9,5,5,5,5,true,true)
		uiBtnFrameTick.images      = #("AutoGrid_16i.bmp","AutoGrid_16i.bmp",2,2,2,2,2,true,true)
		uiBtnTraj.images           = #("bip_keyframe_i.bmp","bip_keyframe_i.bmp",46,29,29,29,29,true,true)
		uiRArms.images             = #("AddPreset_16i.bmp","AddPreset_16i.bmp",1,1,1,1,1,true,true)
		uiLArms.images             = #("AddPreset_16i.bmp","AddPreset_16i.bmp",1,1,1,1,1,true,true)
		uiRLegs.images             = #("AddPreset_16i.bmp","AddPreset_16i.bmp",1,1,1,1,1,true,true)
		uiLLegs.images             = #("AddPreset_16i.bmp","AddPreset_16i.bmp",1,1,1,1,1,true,true)
		uiAllFoot.images           = #("bip_modes_i.bmp","bip_modes_i.bmp",8,4,3,4,3,true,true)
		uiBtnInPlace.images        = #("bip_general_i.bmp","bip_general_i.bmp",30,27,27,27,27,true,true)
		uiBtnSaveBip.images        = #("bip_general_i.bmp","bip_general_i.bmp",30,7,7,7,7,true,true)
		uiBtnLoadBip.images        = #("bip_general_i.bmp","bip_general_i.bmp",30,5,5,5,5,true,true)
		uiFigureMode.images        = #("bip_modes_i.bmp","bip_modes_i.bmp",8,1,1,1,1,true,true)
		uiWorkbench.images         = #("bip_workbench_i.bmp","bip_workbench_i.bmp",10,7,7,7,7,true,true)
		uiCbtCopy.images           = #("bip_keyframe_i.bmp","bip_keyframe_i.bmp",46,9,9,9,9,true,true)
		uiCbtSelPostureObjs.images = #("bip_mflshare_i.bmp","bip_mflshare_i.bmp",2,2,2,2,2,true,true)
		uiCbtPaste.images          = #("bip_keyframe_i.bmp","bip_keyframe_i.bmp",46,17,17,17,17,true,true)
		uiCbtPasteOpposite.images  = #("bip_keyframe_i.bmp","bip_keyframe_i.bmp",46,19,19,19,19,true,true)
		uiCbtUp.images             = #("bip_layer_i.bmp","bip_layer_i.bmp",24,1,1,1,1,true,true)
		uiCbtDown.images           = #("bip_layer_i.bmp","bip_layer_i.bmp",24,3,3,3,3,true,true)
		uiCbtAddLayer.images       = #("bip_layer_i.bmp","bip_layer_i.bmp",24,5,5,5,5,true,true)
		uiCbtDelLayer.images       = #("bip_layer_i.bmp","bip_layer_i.bmp",24,7,7,7,7,true,true)
		uiCbtDownLayer.images      = #("bip_layer_i.bmp","bip_layer_i.bmp",24,13,13,13,13,true,true)
		uiCbtSnapKeys.images       = #("bip_layer_i.bmp","bip_layer_i.bmp",24,15,15,15,15,true,true)
		uiCbtLeftArm.images        = #("bip_layer_i.bmp","bip_layer_i.bmp",24,17,17,17,17,true,true)
		uiCbtRightArm.images       = #("bip_layer_i.bmp","bip_layer_i.bmp",24,19,19,19,19,true,true)
		uiCbtLeftLeg.images        = #("bip_layer_i.bmp","bip_layer_i.bmp",24,21,21,21,21,true,true)
		uiCbtRightLeg.images       = #("bip_layer_i.bmp","bip_layer_i.bmp",24,23,23,23,23,true,true)
		uiFingers.images           = #("curvecontrol_defstat_i.bmp","curvecontrol_defstat_i.bmp",13,5,5,5,5,true,true)
		uiPivot.images             = #("bip_mflshare_i.bmp","bip_mflshare_i.bmp",2,2,2,2,2,true,true)
		uiCbtHorTrack.images       = #("bip_tracksel_i.bmp","bip_tracksel_i.bmp",10,1,1,1,1,true,true)
		uiCbtVerTrack.images       = #("bip_tracksel_i.bmp","bip_tracksel_i.bmp",10,3,3,3,3,true,true)
		uiCbtTurnTrack.images      = #("bip_tracksel_i.bmp","bip_tracksel_i.bmp",10,5,5,5,5,true,true)
		uiBtnComLock.images        = #("LockButtonExt_i.bmp","LockButtonExt_i.bmp",2,1,1,1,1,true,true)
	)

	fn fnDeleteUserProp nodeBipRoot prop = if getUserProp nodeBipRoot prop != undefined do
	(
		buff = (getUserPropBuffer nodeBipRoot) as stringStream 
		newb = stringStream ""
		while not eof buff do
		(
			str = readLine buff
			if str != "" and not matchpattern str pattern:("*" + prop + "*=*") do format "%\n" str to:newb
		)
		setUserPropBuffer nodeBipRoot (replace_LF_with_CRLF (newb as string))
		return ok
	)

    local m_workingBipRoot -- í˜„ì¬ ì‘ì—…ì¤‘ì¸ ë°”ì´íŒ¨ë“œì˜ ë£¨íŠ¸ ë…¸ë“œ
    
	-- ì‹œì¸ì„±ì„ ìœ„í•´ ì˜ˆì™¸ì ìœ¼ë¡œ m_ ë’¤ì— ëŒ€ë¬¸ì ì‚¬ìš©
	-- ëª¨ë“  ë¶€ìœ„ ë³€ìˆ˜ë“¤ì€ ë°°ì—´
	local m_Head
	local m_RArms
	local m_Necks
	local m_LArms
	local m_RClavicle
	local m_LClavicle
	local m_RUpArm
	local m_AllSpine
	local m_Spine2
	local m_Spine1
	local m_Spine0
	local m_LUpArm
	local m_RForArm
	local m_LForArm
	local m_RHand
	local m_COM
	local m_LHand
	local m_Pelvis
	local m_RThigh
	local m_LThigh
	local m_RCalf
	local m_LCalf
	local m_RFoot
	local m_LFoot
	local m_RToe
	local m_LToe
	local m_RLegs
	local m_AllFoot
	local m_LLegs
	local m_AllBip
	local m_LProp
	local m_RProp
    
    local m_PBKeyTimeArray      -- ë¸”ëŸ­í‚¹ ì• ë‹ˆë©”ì´ì…˜ìš© í‚¤ íƒ€ì„ ë°°ì—´ ë¡œì»¬ ë³€ìˆ˜ (Frame)
    local m_PBKeyMiliSecArray  -- ë¸”ëŸ­í‚¹ ì• ë‹ˆë©”ì´ì…˜ìš© í‚¤ íƒ€ì„ ë°°ì—´ ë¡œì»¬ ë³€ìˆ˜ (ë°€ë¦¬ì„¸ì»¨ë“œ)
    local m_PBStartTime     -- ë¸”ëŸ­í‚¹ ì• ë‹ˆë©”ì´ì…˜ ë°˜ë³µ ì‹œì‘ì‹œê°„ ë¹„êµìš© ê¸°ë¡
    local m_PBPointer       -- ì–´ë””ê¹Œì§€ ì¬ìƒì¤‘ì¸ì§€ ê¸°ë¡í•˜ëŠ” í¬ì¸í„°
    local m_PBPlaySpeed     -- ì¬ìƒ ì†ë„ ê°€ì† ê°ì†ìš©, uiDropPlaySpeed ì™€ ì—°ë™ë¨
	
	struct BipType
	(
		limbName,
		linkIndex
    )
    
    function SetPBPlaySpeed = (
        case timeConfiguration.playbackSpeed of (
        1: (m_PBPlaySpeed = 4.0) -- 1/4 ì†ë„ë¼ì„œ 4ë°° ë” í° ì‹œê°„ ê°’ì„ ì ìš©í•´ì•¼í•¨
        2: (m_PBPlaySpeed = 2.0)
        3: (m_PBPlaySpeed = 1.0)
        4: (m_PBPlaySpeed = 0.5)
        5: (m_PBPlaySpeed = 0.25) -- 4ë°° ì†ë„ë¼ì„œ 0.25ë°° ì‘ì€ ì‹œê°„ê°’ì„ ì ìš©í•´ì•¼í•¨
        )
    )

	-- ë°”ì´íŒ¨ë“œ COMì¸ì§€ ê²€ì‚¬
	fn IfBipRoot obj = (
		if ((classof obj.baseobject) == Biped_Object and ((classof obj.controller == Vertical_Horizontal_Turn) or (classof obj.controller == BipSlave_Control))) do (
			if (obj.controller.rootNode == obj) do (return true)
		)
		return false
	)

	fn SaveRangeLoop = (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do return ()
		setUserProp m_workingBipRoot "BsBT_RangeLoopStart" uiSpnLoopStart.value
		setUserProp m_workingBipRoot "BsBT_RangeLoopEnd" uiSpnLoopEnd.value
	)

	fn LoadRangeLoop = (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do return ()
		try (
			uiSpnLoopStart.value = getUserProp m_workingBipRoot "BsBT_RangeLoopStart"
			uiSpnLoopEnd.value = getUserProp m_workingBipRoot "BsBT_RangeLoopEnd"
		) catch ()
	)

	function LoadGoto = (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do return ()
		try (
			m_goto1 = getUserProp m_workingBipRoot "BsBT_Goto1"
			if (m_goto1 == "undefined") do (m_goto1 = undefined)
			m_goto2 = getUserProp m_workingBipRoot "BsBT_Goto2"
			if (m_goto2 == "undefined") do (m_goto2 = undefined)
			m_goto3 = getUserProp m_workingBipRoot "BsBT_Goto3"
			if (m_goto3 == "undefined") do (m_goto3 = undefined)
			m_goto4 = getUserProp m_workingBipRoot "BsBT_Goto4"
			if (m_goto4 == "undefined") do (m_goto4 = undefined)
			m_goto5 = getUserProp m_workingBipRoot "BsBT_Goto5"
			if (m_goto5 == "undefined") do (m_goto5 = undefined)
			m_goto6 = getUserProp m_workingBipRoot "BsBT_Goto6"
			if (m_goto6 == "undefined") do (m_goto6 = undefined)
			m_goto7 = getUserProp m_workingBipRoot "BsBT_Goto7"
			if (m_goto7 == "undefined") do (m_goto7 = undefined)
			m_goto8 = getUserProp m_workingBipRoot "BsBT_Goto8"
			if (m_goto8 == "undefined") do (m_goto8 = undefined)
		) catch ()
	)

    function SaveGoto ui val index = (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do return ()
		local pString = "BsBT_Goto" + (index as string)
		try (
			setUserProp m_workingBipRoot pString val
		) catch ()
	)

	function SetGotoBtnTextSub ui val = (
		local tString
		if (val == undefined) then (tString = "Key") else (tString = (val as string))
		ui.text = tString
		ui.tooltip = tString
	)

	function SetGotoBtnText = (
		SetGotoBtnTextSub btnKey1 m_goto1
		SetGotoBtnTextSub btnKey2 m_goto2
		SetGotoBtnTextSub btnKey3 m_goto3
		SetGotoBtnTextSub btnKey4 m_goto4
		SetGotoBtnTextSub btnKey5 m_goto5
		SetGotoBtnTextSub btnKey6 m_goto6
		SetGotoBtnTextSub btnKey7 m_goto7
		SetGotoBtnTextSub btnKey8 m_goto8
	)

	-- m_goto1 ë“±ì˜ ë³€ìˆ˜ë¥¼ ì°¸ì¡° í˜•ì‹ìœ¼ë¡œ &val ë§¤ê°œë³€ìˆ˜ì— ì „ë‹¬
	function GotoFrame ui &val index setKey:false = (
		if (setKey) then (
			if (ui.text == "Key") then 
			(
				val = int sliderTime
				SetGotoBtnText()
				SaveGoto ui val index
			)
			else
			(
				if (queryBox "å½“å‰å·²è®¾å®šè·³è½¬å¸§,æ˜¯å¦æ¸…é™¤ï¼Ÿ                   " beep:false) then
				(
					val = undefined
					SetGotoBtnText()
					SaveGoto ui val index
				)
			)
			return ()
		)
		else 
		(
			if (ui.text == "Key") then 
			(
				val = int sliderTime
				SetGotoBtnText()
				SaveGoto ui val index
			)
			else
			(
				if (val != undefined) do (
					try (
						sliderTime = val
					) catch ()
				)
			)
		)
	)
	
		-- ë¦¬í„´ ìŠ¤íŠ¸ëŸ­ì³ì˜ ë©¤ë²„ : limbName, linkIndex
	function GetBipedType obj = (
		if ( obj == undefined ) do return undefined
		if ( (classof obj.baseobject) != Biped_Object ) do return (bipType limbName:#nonBiped linkIndex:0)
		
		-- biped.maxNumLinks $ ì´ ë°©ë²•ìœ¼ë¡œ ë°”ì´íŒ¨ë“œì˜ ìµœëŒ€ ë§í¬ ìˆ˜ë¥¼ ì•Œì•„ë‚¼ ìˆ˜ ìˆë‹¤. ë³´í†µ 25ì´ì§€ë§Œ ë„‰ë„‰í•˜ê²Œ 30
		loopCount = 30
		types = #(
			#larm,
			#rarm,
			#lfingers,
			#rfingers,
			#lleg,
			#rleg,
			#ltoes,
			#rtoes,
			#spine,
			#tail,
			#head,
			#pelvis,
			#vertical,
			#horizontal,
			#turn,
			#footprints,
			#neck,
			#pony1,
			#pony2,
			#prop1,
			#prop2,
			#prop3,
			#lfArmTwist,
			#rfArmTwist,
			#lUparmTwist,
			#rUparmTwist,
			#lThighTwist,
			#rThighTwist,
			#lCalfTwist,
			#rCalfTwist,
			#lHorseTwist,
			#rHorseTwist			
		)
		
		for o in types do (
			for p = 1 to loopCount do (
				if ( try ( obj == biped.getNode obj o link:p ) catch false ) do (
					returnType = (bipType limbName:o linkIndex:p)
					return returnType
				)
			)
		)
		
		-- ë§¥ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ Xtra ë³¸ì„ ì „í˜€ ì§€ì›í•˜ì§€ ì•Šì•„ì„œ ì–´ì©” ìˆ˜ ì—†ì´ ë°”ì´íŒ¨ë“œ í´ë˜ìŠ¤ì¸ë° ì •ì²´ë¥¼ ì•Œì•„ë‚´ì§€ ëª»í•œê±´ ëª¨ë‘ Xtraë¡œ ì •ì˜
		-- https://forums.cgsociety.org/t/biped-xtra-maxscript-commands/1570351/5 ìˆ¨ê²¨ì§„ ë°”ì´íŒ¨ë“œ Xtra í•¨ìˆ˜ë“¤ì„ ì¢€ ì‚´í´ë´ì•¼í• ë“¯.
		return (bipType limbName:#xtra linkIndex:0)
	)
	
	-- í˜„ì¬ ì˜¤ë¸Œì íŠ¸ê°€ ì• ë‹ˆë©”ì´ì…˜ í‚¤ ì§€ì •ì´ ê°€ëŠ¥í•œ ë°”ì´íŒ¨ë“œì¸ì§€ë¥¼ ê²€ì‚¬ true ì™€ false ë¦¬í„´
	function IfKeyableBip obj =
	(
		if ( classof obj.baseobject != Biped_object ) do return false
		
		tType = GetBipedType obj
		
		returnBool = case tType.limbName of
		(
			#footprints: false
			#lfArmTwist: false
			#rfArmTwist: false
			#lUparmTwist: false
			#rUparmTwist: false
			#lThighTwist: false
			#rThighTwist: false
			#lCalfTwist: false
			#rCalfTwist: false
			#lHorseTwist: false
			#rHorseTwist: false
			default: true
		)
		return returnBool
	)
	
	-- ë°”ì´íŒ¨ë“œ ë¶€ìœ„ë“¤ ì¤‘ Limb, COM, NoKey, Etc ë¥¼ êµ¬ë¶„í•˜ì—¬ ë¦¬í„´ (ì• ë‹ˆë©”ì´ì…˜ í‚¤ ë³µì œ ë°©ì‹ì´ ë‹¤ë¦„)
	function GetBipKeyType obj = (
		if ( classof obj.baseobject != Biped_object ) do return false
		
		tType = GetBipedType obj

		if tType.limbName == #vertical OR\
			tType.limbName == #horizontal OR\
			tType.limbName == #turn do (
			return "COM"
		)

		if tType.limbName == #larm OR\
			tType.limbName == #rarm OR\
			tType.limbName == #lleg OR\
			tType.limbName == #rleg OR\
			tType.limbName == #ltoes OR\
			tType.limbName == #rtoes do (
				return "Limb"
		)

		if tType.limbName == #lfArmTwist OR\
			tType.limbName == #rfArmTwist OR\
			tType.limbName == #lUparmTwist OR\
			tType.limbName == #rUparmTwist OR\
			tType.limbName == #lThighTwist OR\
			tType.limbName == #rThighTwist OR\
			tType.limbName == #lCalfTwist OR\
			tType.limbName == #rCalfTwist OR\
			tType.limbName == #lHorseTwist OR\
			tType.limbName == #rHorseTwist OR\
			tType.limbName == #footprints do (
				return "NoKey"
		)
		
		return "Etc"
	)

	-- ë°”ì´íŒ¨ë“œ Limb ì „ìš© ê¸°ëŠ¥ì„ ìœ„í•´ Limb ì¸ì§€ ì²´í¬í•˜ëŠ” í•¨ìˆ˜
	function IfLimb obj = (
		if ( classof obj.baseobject != Biped_object ) do return false
		tType = GetBipedType obj
		if tType.limbName == #larm OR\
			tType.limbName == #rarm OR\
			tType.limbName == #lleg OR\
			tType.limbName == #rleg OR\
			tType.limbName == #ltoes OR\
			tType.limbName == #rtoes do (
				return true
		)
		return false
	)
	
    fn DeselectAllKeys obj = (
		-- ì²˜ìŒì—” ë³µì¡í•œ ë°©ë²•ìœ¼ë¡œ ì¼ì¼ì´ í‚¤ í•˜ë‚˜ì”© ë£¨í”„ ëŒì•„ê°€ë©° ì„ íƒ í•´ì œí–ˆëŠ”ë°, ë­‰ëš±ê·¸ë ¤ì„œ controller ë¡œ í•˜ë‹ˆ ì˜ ë˜ëŠ”ë“¯
		deselectKeys obj.controller
	)
	
	-- ì´ í•¨ìˆ˜ëŠ” ì‚­ì œ ì „ Deselect ëŠ” ê³ ë ¤í•˜ì§€ ì•ŠìŒ. (ê¸°ì¡´ì— Deselect ë˜ì–´ì„œ ì§„ì…í•œ ê²ƒì„ ì „ì œë¡œ í•¨)
	fn TrimKeys controller frameStart frameEnd ifBip = (
		local firstKeyTime
		local lastKeyTime
		if (ifBip) then (
			local keyCount = numKeys controller
			if keyCount < 1 do return()
			firstKeyTime = (getKey controller 1).time
			lastKeyTime = (getKey controller keyCount).time
		)
		else (
			firstKeyTime = -99999
			lastKeyTime = 99999
		)

		if (firstKeyTime < frameStart) do (
			-- ë³´ì¡´ êµ¬ê°„ë³´ë‹¤ ì•ìª½ì— í‚¤ê°€ ìˆëŠ” ê²½ìš°
			selectKeys controller (interval firstKeyTime (frameStart - 1))
		)
		if (lastKeyTime > frameEnd) do (
			-- ë³´ì¡´ êµ¬ê°„ë³´ë‹¤ ë’¤ìª½ì— í‚¤ê°€ ìˆëŠ” ê²½ìš°
			selectKeys controller (interval lastKeyTime (frameEnd + 1))
		)

		if (ifBip) then (
			biped.deleteKeys controller #selection
		)
		else (
			deleteKeys controller #selection
		)
	)

    -- obj ì˜ ëª¨ë“  ìì‹ë“¤ì„ ë°°ì—´ë¡œ ë¦¬í„´. ë°°ì—´ ìˆœì„œëŠ” ê³„ì¸µêµ¬ì¡° ìˆœì„œëŒ€ë¡œ
	function fnGetAllChildren obj = (
		if ( obj == undefined ) do return undefined
		
		local tAllChildren = #()
		if ( obj.children.count != 0 ) do (
			for o in obj.children where not isDeleted o and (classof o.baseobject == Biped_Object or (classof o.controller == Vertical_Horizontal_Turn)) do (
				append tAllChildren o
				if ( o.children.count != 0 ) do (
					tAllChildren = tAllChildren +  (fnGetAllChildren o)		-- recursive
				)
			)
		)
		return tAllChildren
	)

	fn fnSelAllChildrens arrObj =
	(
		clearselection()
		for o in arrObj where isvalidnode o do
		(
			selectmore o
			selectmore (fnGetAllChildren o)
		)
	)
	
    fn SetComBtnText state = (
        if state then (
            uiCOM.text = m_workingBipRoot.name
        )
        else (
            uiCOM.text = "COM"
        )
    )

    fn SetButtonState state = (
        uiHead.state = state
        uiRArms.state = state
        uiNecks.state = state
        uiLArms.state = state
        uiRClavicle.state = state
        uiLClavicle.state = state
        uiRUpArm.state = state
		uiAllSpine.state = state
		uiSpine3.state = state
		uiSpine2.state = state
		uiSpine1.state = state
		uiSpine0.state = state
        uiLUpArm.state = state
        uiRForArm.state = state
        uiLForArm.state = state
        uiRHand.state = state
        uiCOM.state = state
        if state == false do uiCOM.text = "COM"
        uiLHand.state = state
        uiPelvis.state = state
        uiRThigh.state = state
        uiLThigh.state = state
        uiRCalf.state = state
        uiLCalf.state = state
        uiRFoot.state = state
		uiLFoot.state = state
		uiRToe.state = state
		uiLToe.state = state
        uiRLegs.state = state
        uiAllFoot.state = state
        uiLLegs.state   = state
		-- uiAllBip.state = state
		uiPlayBlock.state = state
		uiFingers.state   = state
		uiPropR.state      = state
		uiPivot.state     = state
		uiPropL.state     = state
		uiCkbHideBip.state = state
		uiCkbXray.state = state
		uiCkbShowBox.state = state
		uiCkbZen.state = state
		uiCbtMirrorLLeg.state = state
		uiCbtMirrorRLeg.state = state
		uiCbtMirrorLArm.state = state
		uiCbtMirrorRArm.state = state
    )

	-- ì”¬ ë‚´ ë°”ì´íŒ¨ë“œ ì˜¤ë¸Œì íŠ¸ë¥¼ ëª¨ë‘ ì¡°ì‚¬í•˜ì—¬ ë°”ì´íŒ¨ë“œê°€ í•˜ë‚˜ë§Œ ìˆìœ¼ë©´ ê·¸ ë°”ì´íŒ¨ë“œë¥¼ m_workingBipRootì— ì„¸íŒ….
	-- í˜„ì¬ ì„ íƒëœ ì˜¤ë¸Œì íŠ¸ê°€ ë°”ì´íŒ¨ë“œë©´ ê·¸ê²ƒì„ ì„¸íŒ…
	-- ì„ íƒì´ ì„±ê³µí•˜ë©´ true, ì‹¤íŒ¨í•˜ë©´ false ë¦¬í„´
	function AutoGetBipRoot = 
	(
		if rolBsBipedTools.ddlAllBipedCom.selection != 0 then 
		(
			bipedCom = arrAllBipedCom[rolBsBipedTools.ddlAllBipedCom.selection]
			if not isDeleted bipedCom and isvalidnode bipedCom then 
			(
				if ( try(classof bipedCom.baseobject == Biped_object) catch false ) do (
					try
					(
						m_workingBipRoot = bipedCom.controller.rootnode
						SetComBtnText true
						return true
					)
					catch()
				)
			)
		)
		for o in objects where not isDeleted o and isvalidnode o do (
			try(
				if (classof o.baseobject == Biped_object) do (
					m_workingBipRoot = o.controller.rootnode
					SetComBtnText true
					if not isDeleted m_workingBipRoot then return true
				)
			)catch()
		)
		m_workingBipRoot = undefined -- ì”¬ì„ ìƒˆë¡œ ì˜¤í”ˆí•œë‹¤ê±°ë‚˜ í•˜ë©´ ì‚­ì œëœ ì˜¤ë¸Œì íŠ¸ë¥¼ ê¸°ì–µí•˜ê³  ìˆì„ ìˆ˜ ìˆì–´ì„œ (undefined ì•„ë‹˜) ë°˜ë“œì‹œ undefined ë¡œ ì´ˆê¸°í™”í•´ì¤˜ì•¼í•¨.
		SetComBtnText false
		SetButtonState false
		return false
	)

	fn fnGetDisplayNames =
	(
		local a_displayNames = deepCopy a_layerNames
		for i = 1 to a_displayNames.count-1 do
		(
			if (biped.getLayerActive ctrl i) then
			(
				a_displayNames[i+1] = a_layerNames[i+1]
			)
			else
			(
				a_displayNames[i+1] = "* " + a_layerNames[i+1]
			)	
		)
		
		a_displayNames
	)

	fn fnSyncBipedPanel =
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
		numLayers = biped.numLayers m_workingBipRoot.controller
		layerIndex = biped.getCurrentLayer m_workingBipRoot.controller
	)

	fn fnIsValidBiped =
	(
		if m_workingBipRoot != undefined AND NOT isDeleted m_workingBipRoot then
		(
			return true
		)
		return false
	)
	
	mapped fn fnProcessTCB obj val =
	(
		if fnIsValidBiped() then
		(
			try
			(
				if obj == m_workingBipRoot then
				(
					(biped.getKey obj.controller[1].controller (getkeyindex obj.controller[1].controller slidertime)).continuity = val
					(biped.getKey obj.controller[2].controller (getkeyindex obj.controller[2].controller slidertime)).continuity = val
					(biped.getKey obj.controller[3].controller (getkeyindex obj.controller[3].controller slidertime)).continuity = val
				)
				else
				(
					(biped.getKey obj.controller (getkeyindex obj.controller slidertime)).continuity = val
				)
			)catch()
		)
	)

	fn fnEvaluateTCB val =
	(
		if fnIsValidBiped() then
		(
			if selection.count > 0 do
			(
				if keyboard.shiftPressed OR keyboard.controlPressed then
				(
					slidertime = 0
					for t = animationRange.start to animationRange.end while not keyboard.escPressed do
					(
						at time t (rolBsBipedTools.fnProcessTCB (selection as array) val)
						slidertime += 1
					)
					messagebox "æ‰€é€‰ç‰©ä½“çš„ TCB å€¼æ‰¹é‡å¤„ç†å®Œæ¯•ã€‚" title:"BsBipedTools"
				)
				else
				(
					rolBsBipedTools.fnProcessTCB (selection as array) val
				)
			)
		)
	)

	fn fnBSUpdateLayers =
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
		if fnIsValidBiped() then
		(
			ctrl = m_workingBipRoot.controller
			if m_LHand[1] != undefined then uiCbtLeftArm.checked = biped.getLimbRetargetState m_LHand[1]
			if m_RHand[1] != undefined then uiCbtRightArm.checked = biped.getLimbRetargetState m_RHand[1]
			if m_LFoot[1] != undefined then uiCbtLeftLeg.checked = biped.getLimbRetargetState m_LFoot[1]
			if m_RFoot[1] != undefined then uiCbtRightLeg.checked = biped.getLimbRetargetState m_RFoot[1]
			a_layerNames = #(("# "+(biped.getLayerName ctrl 0)+" #"))
			numLayers = biped.numLayers ctrl
			if numLayers > 0 then
			(
				layerIndex = biped.getCurrentLayer ctrl
				uiLblLayerID.text = layerIndex as string
				for i = 1 to numLayers do
				(
					append a_layerNames (biped.getLayerName ctrl i)
				)
				if numLayers > 1 then
				(
					uiCbtLeftArm.enabled  = false
					uiCbtRightArm.enabled = false
					uiCbtLeftLeg.enabled  = false
					uiCbtRightLeg.enabled = false
					uiCbtLeftArm.images   = #("bip_layer_i.bmp","bip_layer_i.bmp",24,18,18,18,18,true,true)
					uiCbtRightArm.images  = #("bip_layer_i.bmp","bip_layer_i.bmp",24,20,20,20,20,true,true)
					uiCbtLeftLeg.images   = #("bip_layer_i.bmp","bip_layer_i.bmp",24,22,22,22,22,true,true)
					uiCbtRightLeg.images  = #("bip_layer_i.bmp","bip_layer_i.bmp",24,24,24,24,24,true,true)
				)
				else
				(
					uiCbtLeftArm.enabled  = true
					uiCbtRightArm.enabled = true
					uiCbtLeftLeg.enabled  = true
					uiCbtRightLeg.enabled = true
					uiCbtLeftArm.images   = #("bip_layer_i.bmp","bip_layer_i.bmp",24,17,17,17,17,true,true)
					uiCbtRightArm.images  = #("bip_layer_i.bmp","bip_layer_i.bmp",24,19,19,19,19,true,true)
					uiCbtLeftLeg.images   = #("bip_layer_i.bmp","bip_layer_i.bmp",24,21,21,21,21,true,true)
					uiCbtRightLeg.images  = #("bip_layer_i.bmp","bip_layer_i.bmp",24,23,23,23,23,true,true)
				)
			)
			else
			(
				layerIndex = 0
				uiLblLayerID.text = "0"
				uiChkActive.enabled = false
			)

			if layerIndex > 0 then
			(
				uiChkActive.enabled = true
				uiChkActive.checked = (biped.getLayerActive ctrl layerIndex)
				uiCbtDelLayer.enabled = true
				uiCbtDownLayer.enabled = true
				uiCbtSnapKeys.enabled = true
				uiCbtDelLayer.images  = #("bip_layer_i.bmp","bip_layer_i.bmp",24,7,7,7,7,true,true)
				uiCbtDownLayer.images = #("bip_layer_i.bmp","bip_layer_i.bmp",24,13,13,13,13,true,true)
				uiCbtSnapKeys.images  = #("bip_layer_i.bmp","bip_layer_i.bmp",24,15,15,15,15,true,true)
			)
			else
			(
				uiChkActive.enabled = false
				uiCbtDelLayer.enabled = false
				uiCbtDownLayer.enabled = false
				uiCbtSnapKeys.enabled = false
				uiCbtDelLayer.images  = #("bip_layer_i.bmp","bip_layer_i.bmp",24,8,8,8,8,true,true)
				uiCbtDownLayer.images = #("bip_layer_i.bmp","bip_layer_i.bmp",24,14,14,14,14,true,true)
				uiCbtSnapKeys.images  = #("bip_layer_i.bmp","bip_layer_i.bmp",24,16,16,16,16,true,true)
			)
			
			ddlLayers.items = fnGetDisplayNames()
			ddlLayers.selection = layerIndex + 1
		)
		else
		(
			layerIndex = 0
			numLayers = 0
			uiLblLayerID.text = ""
			ddlLayers.items = #("")
			ddlLayers.selection = 1
			uiChkActive.enabled = false
		)
		
		if layerIndex == numLayers then
		(
			uiCbtUp.enabled = false
			uiCbtUp.images = #("bip_layer_i.bmp","bip_layer_i.bmp",24,2,2,2,2,true,true)
		)
		else 
		(
			uiCbtUp.enabled = true
			uiCbtUp.images = #("bip_layer_i.bmp","bip_layer_i.bmp",24,1,1,1,1,true,true)
		)
		if layerIndex == 0 then
		(
			uiCbtDown.enabled = false
			uiCbtDown.images = #("bip_layer_i.bmp","bip_layer_i.bmp",24,4,4,4,4,true,true)
		)
		else
		(
			uiCbtDown.enabled = true
			uiCbtDown.images = #("bip_layer_i.bmp","bip_layer_i.bmp",24,3,3,3,3,true,true)
		)
		redrawViews()
	)

	fn fnLockComTrack com =
	(
		with redraw off 
		(
			-- max motion mode
			theactionman = actionMan.executeAction
			tableId = 972555510
			-- max select
			theactionman tableId "40185"
			numTrackSel = com.controller.trackSelection
			if numTrackSel != 7 then (com.controller.trackSelection = 7)
			else if numTrackSel == 7 then (com.controller.trackSelection = 0)
			-- max move
		)
	)

	fn fnGetComTrackSelection com =
	(
		case com.controller.trackSelection of
		(
			1:(return [1,0,0])
			2:(return [0,1,0])
			3:(return [0,0,1])
			4:(return [1,1,0])
			5:(return [1,0,1])
			6:(return [0,1,1])
			7:(return [1,1,1])
			default:(return [0,0,0])
		)
	)

	-- fn fnSetComTrackSelection com =
	-- (
	-- 	numTrackSel = 0
	-- 	typeTrackSel = [0,0,0]
	-- 	typeTrackSel[1] = if rolBsBipedTools.uiCbtHorTrack.state then 1 else 0
	-- 	typeTrackSel[2] = if rolBsBipedTools.uiCbtVerTrack.state then 1 else 0
	-- 	typeTrackSel[3] = if rolBsBipedTools.uiCbtTurnTrack.state then 1 else 0
	-- 	case typeTrackSel of 
	-- 	(
	-- 		([1,0,0]):(numTrackSel = 1)
	-- 		([0,1,0]):(numTrackSel = 2)
	-- 		([0,0,1]):(numTrackSel = 3)
	-- 		([1,1,0]):(numTrackSel = 4)
	-- 		([1,0,1]):(numTrackSel = 5)
	-- 		([0,1,1]):(numTrackSel = 6)
	-- 		([1,1,1]):(numTrackSel = 7)
	-- 		default:(numTrackSel = 0)
	-- 	)
	-- 	if numTrackSel >= 5 and numTrackSel <= 7 then (fnLockComTrack com)
	-- 	com.controller.trackSelection = numTrackSel
	-- )

	fn fnRefreshTrackSelection com =
	(
		if fnIsValidBiped() then
		(
			typeTrackSel = rolBsBipedTools.fnGetComTrackSelection com
			if selection.count == 0 then typeTrackSel = [0,0,0]
			rolBsBipedTools.uiCbtHorTrack.state  = if typeTrackSel[1] == 1 then true else false
			rolBsBipedTools.uiCbtVerTrack.state  = if typeTrackSel[2] == 1 then true else false
			rolBsBipedTools.uiCbtTurnTrack.state = if typeTrackSel[3] == 1 then true else false
		)
	)

	-- ë°°ì—´ ë¹¼ê¸°
	function ArraySubtract arrFrom arrSub = (
		if arrSub.count == 0 do (return arrFrom)
		
		for o in arrSub do (
			foundNum = findItem arrFrom o
			if foundNum != 0 do (
				deleteItem arrFrom foundNum
			)
		)
		return arrFrom
	)
	
	-- ê¸°ì¡´ selection ë°±ì—…ê³¼ ì´ë²ˆì— ì„ íƒí•  selArr ì„ ì…ë ¥ë°›ì•„ ì ì ˆí•˜ê²Œ ì„ íƒí•œë‹¤. ë¶€ìˆ˜ì ìœ¼ë¡œ ëª¨ì…˜íŒ¨ë„ë¡œì˜ ë³€ê²½ë„ ê°™ì´ ìˆ˜í–‰
    -- selBackup ì„ ì‚¬ìš©í• ì§€ëŠ” ë¯¸ì •
    -- selBackup ì€ selection as array
	function CompSelect selBackup selArr = (
		-- ë‹¨ì¶•í‚¤ ì¡°í•©ì´ ì•„ë¬´ê²ƒë„ ëˆŒëŸ¬ì ¸ìˆì§€ ì•Šìœ¼ë©´ ë¹ ë¥´ê²Œ ê·¸ëƒ¥ ì„ íƒ í›„ ë¦¬í„´
		if (keyboard.controlPressed == false) and (keyboard.altPressed == false) and (keyboard.shiftPressed == false) do (
			undo on (
				select selArr
			)
			return()
		)

		if keyboard.shiftPressed do 
		(
			fnSelAllChildrens selArr
			return()
		)

		if keyboard.controlPressed and not keyboard.altPressed do (
			selArr += selBackup
		)
		
		if keyboard.altPressed and not keyboard.controlPressed do (
			selArr = ArraySubtract selBackup selArr
		)
		
		undo on (
			if selArr.count == 0 then (
				clearSelection()
			)
			else (
				--setCommandPanelTaskMode mode:#motion
				select selArr
			)
		)
	)

	-- ë°”ì´íŒ¨ë“œ ë°°ì—´ì´ ì •ìƒì ì¸ì§€ ì²´í¬í•˜ì—¬ ë¦¬í„´
	fn IfExistBips bipArr = (
		if (bipArr == undefined) do return false
		if (bipArr.count == 0) do return false
		for obj in bipArr do (
			-- ì‚­ì œëœ ì˜¤ë¸Œì íŠ¸ì— ëŒ€í•´ ì²˜ë¦¬í•˜ë ¤ê³  í•˜ë©´ ì—ëŸ¬ê°€ ë‚˜ë¯€ë¡œ try ì²˜ë¦¬
			try (
				if (obj == undefined) do return false
				if ((classof obj.baseobject) != Biped_Object) do return false
			) catch (return false)
		)
		return true
	)

	-- ì´í•˜ ë°”ì´íŒ¨ë“œ ë¶€ìœ„ë“¤ì„ ì–»ì–´ì˜¤ëŠ” í•¨ìˆ˜ë“¤ì€ m_workingBipRootë¥¼ ëŒ€ìƒìœ¼ë¡œ ì‘ë™
	fn GetHead = (
		selObj = biped.getNode m_workingBipRoot #head
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetRArms = (
		tArr = #()
		for i = 1 to 4 do (
			selObj = biped.getNode m_workingBipRoot #rarm link:i
			if selObj != undefined do -- ë°”ì´íŒ¨ë“œ ìŠ¤íŠ¸ëŸ­ì²˜ ì„¤ì •ì— ë”°ë¼ íŒ”ì´ ì—†ëŠ” ë“± ì˜ˆì™¸ê°€ ìˆì„ ìˆ˜ ìˆìŒ
			(
				if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state do (
					append tArr selObj
				)
			)
		)
		return tArr
	)
	fn GetNecks = (
		tArr = #()
		testBool = true
		tIndex = 1
		while testBool do (
			selObj = biped.getNode m_workingBipRoot #neck link:tIndex
			if ( selObj == undefined ) then (
				testBool = false
			)
			else (
				if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state do (
					append tArr selObj
				)
			)
			tIndex += 1
		)
		return tArr
	)
	fn GetLArms = (
		tArr = #()
		for i = 1 to 4 do (
			selObj = biped.getNode m_workingBipRoot #larm link:i
			if selObj != undefined do -- ë°”ì´íŒ¨ë“œ ìŠ¤íŠ¸ëŸ­ì²˜ ì„¤ì •ì— ë”°ë¼ íŒ”ì´ ì—†ëŠ” ë“± ì˜ˆì™¸ê°€ ìˆì„ ìˆ˜ ìˆìŒ
			(
				if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state do (
					append tArr selObj
				)
			)
		)
		return tArr
	)
	fn GetRClavicle = (
		selObj = biped.getNode m_workingBipRoot #rarm link:1
		if selObj == undefined do -- ë°”ì´íŒ¨ë“œ ìŠ¤íŠ¸ëŸ­ì²˜ ì„¤ì •ì— ë”°ë¼ íŒ”ì´ ì—†ëŠ” ë“± ì˜ˆì™¸ê°€ ìˆì„ ìˆ˜ ìˆìŒ
		(
			return #()
		)
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetLClavicle = (
		selObj = biped.getNode m_workingBipRoot #larm link:1
		if selObj == undefined do -- ë°”ì´íŒ¨ë“œ ìŠ¤íŠ¸ëŸ­ì²˜ ì„¤ì •ì— ë”°ë¼ íŒ”ì´ ì—†ëŠ” ë“± ì˜ˆì™¸ê°€ ìˆì„ ìˆ˜ ìˆìŒ
		(
			return #()
		)
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetRUpArm = (
		selObj = biped.getNode m_workingBipRoot #rarm link:2
		if selObj == undefined do -- ë°”ì´íŒ¨ë“œ ìŠ¤íŠ¸ëŸ­ì²˜ ì„¤ì •ì— ë”°ë¼ íŒ”ì´ ì—†ëŠ” ë“± ì˜ˆì™¸ê°€ ìˆì„ ìˆ˜ ìˆìŒ
		(
			return #()
		)
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetAllSpine = (
		tArr = #()
		testBool = true
		tIndex = 1
		while testBool do (
			selObj = biped.getNode m_workingBipRoot #spine link:tIndex
			if ( selObj == undefined ) then (
				testBool = false
			)
			else (
				if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state do (
					append tArr selObj
				)
			)
			tIndex += 1
		)
		return tArr
	)
	fn GetSpine index = (
		selObj = biped.getNode m_workingBipRoot #spine link:(index + 1)
		if selObj == undefined do return #()
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetLUpArm = (
		selObj = biped.getNode m_workingBipRoot #larm link:2
		if selObj == undefined do -- ë°”ì´íŒ¨ë“œ ìŠ¤íŠ¸ëŸ­ì²˜ ì„¤ì •ì— ë”°ë¼ íŒ”ì´ ì—†ëŠ” ë“± ì˜ˆì™¸ê°€ ìˆì„ ìˆ˜ ìˆìŒ
		(
			return #()
		)
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetRForArm = (
		selObj = biped.getNode m_workingBipRoot #rarm link:3
		if selObj == undefined do -- ë°”ì´íŒ¨ë“œ ìŠ¤íŠ¸ëŸ­ì²˜ ì„¤ì •ì— ë”°ë¼ íŒ”ì´ ì—†ëŠ” ë“± ì˜ˆì™¸ê°€ ìˆì„ ìˆ˜ ìˆìŒ
		(
			return #()
		)
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetLForArm = (
		selObj = biped.getNode m_workingBipRoot #larm link:3
		if selObj == undefined do -- ë°”ì´íŒ¨ë“œ ìŠ¤íŠ¸ëŸ­ì²˜ ì„¤ì •ì— ë”°ë¼ íŒ”ì´ ì—†ëŠ” ë“± ì˜ˆì™¸ê°€ ìˆì„ ìˆ˜ ìˆìŒ
		(
			return #()
		)
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetRHand = (
		selObj = biped.getNode m_workingBipRoot #rarm link:4
		if selObj == undefined do -- ë°”ì´íŒ¨ë“œ ìŠ¤íŠ¸ëŸ­ì²˜ ì„¤ì •ì— ë”°ë¼ íŒ”ì´ ì—†ëŠ” ë“± ì˜ˆì™¸ê°€ ìˆì„ ìˆ˜ ìˆìŒ
		(
			return #()
		)
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	--fn GetCOM = ()
	fn GetLHand = (
		selObj = biped.getNode m_workingBipRoot #larm link:4
		if selObj == undefined do -- ë°”ì´íŒ¨ë“œ ìŠ¤íŠ¸ëŸ­ì²˜ ì„¤ì •ì— ë”°ë¼ íŒ”ì´ ì—†ëŠ” ë“± ì˜ˆì™¸ê°€ ìˆì„ ìˆ˜ ìˆìŒ
		(
			return #()
		)
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetPelvis = (
		selObj = biped.getNode m_workingBipRoot #pelvis
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetRThigh = (
		selObj = biped.getNode m_workingBipRoot #rleg link:1
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetLThigh = (
		selObj = biped.getNode m_workingBipRoot #lleg link:1
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetRCalf = (
		selObj = biped.getNode m_workingBipRoot #rleg link:2
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetLCalf = (
		selObj = biped.getNode m_workingBipRoot #lleg link:2
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetRFoot = (
		local footIndex = 4 -- HorseLinkê°€ ìˆëŠ” ê²½ìš°
		if (biped.getNode m_workingBipRoot #rleg link:4) == undefined do (
			footIndex = 3
		)
		selObj = biped.getNode m_workingBipRoot #rleg link:footIndex
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetLFoot = (
		local footIndex = 4 -- HorseLinkê°€ ìˆëŠ” ê²½ìš°
		if (biped.getNode m_workingBipRoot #lleg link:4) == undefined do (
			footIndex = 3
		)
		selObj = biped.getNode m_workingBipRoot #lleg link:footIndex
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetRToe = (
		selObj = biped.getNode m_workingBipRoot #rtoes link:1
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetLToe = (
		selObj = biped.getNode m_workingBipRoot #ltoes link:1
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetRLegs = (
		tArr = #()
		for i = 1 to 4 do (
			selObj = biped.getNode m_workingBipRoot #rleg link:i
			if selObj != undefined do (		-- HorseLink ê°€ ìˆê¸°ë„ í•˜ê³  ì—†ê¸°ë„ í•  ìˆ˜ ìˆìŒ
				if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state do (
					append tArr selObj
				)
			)
		)
		append tArr (biped.getNode m_workingBipRoot #rtoes link:1)
		return tArr
	)
	fn GetAllFoot = (
		tArr = #()
		selObj = GetLFoot()
		if ( selObj[1].isHidden == false ) or uiChkSelHiddenObj.state do ( append tArr selObj[1] )
		selObj = GetRFoot()
		if ( selObj[1].isHidden == false ) or uiChkSelHiddenObj.state do ( append tArr selObj[1] )
		return tArr
	)
	fn GetLLegs = (
		tArr = #()
		for i = 1 to 4 do (
			selObj = biped.getNode m_workingBipRoot #lleg link:i
			if selObj != undefined do (		-- HorseLink ê°€ ìˆê¸°ë„ í•˜ê³  ì—†ê¸°ë„ í•  ìˆ˜ ìˆìŒ
				if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state do (
					append tArr selObj
				)
			)
		)
		append tArr (biped.getNode m_workingBipRoot #ltoes link:1)
		return tArr
	)
	fn GetAllBip = (
		local retBips = #()
		for o in objects do (
			if ( classof o.baseobject == Biped_object ) and \
			((classof o.controller == Vertical_Horizontal_Turn) or (classof o.controller == BipSlave_Control)) do
			(
				-- ê°™ì€Bip001ì˜ ìì‹ì´ë©´
				if ( o.controller.rootNode == m_workingBipRoot AND (classof o.controller) != Footsteps) do
				(
					append retBips o
				)
			)
		)
		return retBips
	)

	fn GetLProp =
	(
		selObj = biped.getNode m_workingBipRoot #prop2 link:1
		if selObj != undefined then
		(
			if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
				return #(selObj)
			)
			else (
				return #()
			)
		)
		else
		(
			return #()
		)
	)
	
	fn GetRProp =
	(
		selObj = biped.getNode m_workingBipRoot #prop1 link:1
		if selObj != undefined then
		(
			if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
				return #(selObj)
			)
			else (
				return #()
			)
		)
		else
		(
			return #()
		)
	)

	-- Go to Mirror frame ë²„íŠ¼ì´ ì‘ë™í•˜ê¸° ìœ„í•œ ì¡°ê±´ ê²€ì‚¬ í›„ ë²„íŠ¼ enable ì„¸íŒ…
	-- ë£¨í•‘ êµ¬ê°„ í”„ë ˆì„ì´ ì§ìˆ˜ì—¬ì•¼í•˜ê³  ì¼ì • ìˆ˜ ì´ìƒì´ì—¬ì•¼í•¨
	fn SetGotoMirrorEnable = (
		--uiBtnGotoMirror
		local fCount = uiSpnLoopEnd.value - uiSpnLoopStart.value
		if (fCount < 2) do (
			uiBtnGotoMirror.enabled = false
			return ()
		)

		local fCountHalf = fCount / 2.0
		-- í™€ìˆ˜ì¸ì§€?
		if float (int fCountHalf) != fCountHalf do (
			uiBtnGotoMirror.enabled = false
			return ()
		)
		uiBtnGotoMirror.enabled = true
	)
    
	-- ì‘ì—…ìš© ë°”ì´íŒ¨ë“œ ë£¨íŠ¸ ë…¸ë“œë¼ë˜ê°€, ì„ íƒìš© ë°°ì—´ ë³€ìˆ˜ ë“±ì„ ë¯¸ë¦¬ ì„¸íŒ…
	function InitLocalVars = (
		try(arrAllBipedCom = rolBsBipedTools.fnGetAllBipedCom())catch()
		-- print arrAllBipedCom
		rolBsBipedTools.ddlAllBipedCom.items = for i in arrAllBipedCom where not isDeleted i and i.name != undefined collect i.name
		for i in (selection as array) where (selection.count != 0 and (isValidNode i) and (iskindof i.baseobject Biped_Object) and \
		((classof i.controller == Vertical_Horizontal_Turn) or (classof i.controller == BipSlave_Control)) ) do 
		(
			selBipedId = finditem arrAllBipedCom i.controller.rootnode
			rolBsBipedTools.ddlAllBipedCom.selection = selBipedId
			exit
		)
		--uiBtnLoopDupe.enabled = false -- ê°œë°œì¤‘ì¸ ê¸°ëŠ¥ ë´‰ì¸
		AutoGetBipRoot()
        if m_workingBipRoot == undefined then (
            SetButtonState false
            return ()
        )
        else (
            SetButtonState true
		)
		uiChkBtnScanBiped.text = "Scanning..."
		
		-- ëª¨ë“  ë¶€ìœ„ ë³€ìˆ˜ë“¤ì€ ë°°ì—´
		m_Head = GetHead()
		m_RArms = GetRArms()
		if (m_RArms.count == 0) then (uiRArms.enabled = false; uiRArms.state = false) else (uiRArms.enabled = true; uiRArms.state = true)
		m_Necks = GetNecks()
		m_LArms = GetLArms()
		if (m_LArms.count == 0) then (uiLArms.enabled = false; uiLArms.state = false) else (uiLArms.enabled = true; uiLArms.state = true)
		m_RClavicle = GetRClavicle()
		if (m_RClavicle.count == 0) then (uiRClavicle.enabled = false; uiRClavicle.state = false) else (uiRClavicle.enabled = true; uiRClavicle.state = true)
		m_LClavicle = GetLClavicle()
		if (m_LClavicle.count == 0) then (uiLClavicle.enabled = false; uiLClavicle.state = false) else (uiLClavicle.enabled = true; uiLClavicle.state = true)
		m_RUpArm = GetRUpArm()
		if (m_RUpArm.count == 0) then (uiRUpArm.enabled = false; uiRUpArm.state = false) else (uiRUpArm.enabled = true; uiRUpArm.state = true)
		m_AllSpine = GetAllSpine()
		m_Spine3 = GetSpine 3
		if (m_Spine3.count == 0) then (uiSpine3.enabled = false; uiSpine3.state = false) else (uiSpine3.enabled = true; uiSpine3.state = true)
		m_Spine2 = GetSpine 2
		if (m_Spine2.count == 0) then (uiSpine2.enabled = false; uiSpine2.state = false) else (uiSpine2.enabled = true; uiSpine2.state = true)
		m_Spine1 = GetSpine 1
		if (m_Spine1.count == 0) then (uiSpine1.enabled = false; uiSpine1.state = false) else (uiSpine1.enabled = true; uiSpine1.state = true)
		m_Spine0 = GetSpine 0
		if (m_Spine0.count == 0) then (uiSpine0.enabled = false; uiSpine0.state = false) else (uiSpine0.enabled = true; uiSpine0.state = true)
		m_LUpArm = GetLUpArm()
		if (m_LUpArm.count == 0) then (uiLUpArm.enabled = false; uiLUpArm.state = false) else (uiLUpArm.enabled = true; uiLUpArm.state = true)
		m_RForArm = GetRForArm()
		if (m_RForArm.count == 0) then (uiRForArm.enabled = false; uiRForArm.state = false) else (uiRForArm.enabled = true; uiRForArm.state = true)
		m_LForArm = GetLForArm()
		if (m_LForArm.count == 0) then (uiLForArm.enabled = false; uiLForArm.state = false) else (uiLForArm.enabled = true; uiLForArm.state = true)
		m_RHand = GetRHand()
		if (m_RHand.count == 0) then (uiRHand.enabled = false; uiRHand.state = false) else (uiRHand.enabled = true; uiRHand.state = true)
		--m_COM = GetCOM()
		m_LHand = GetLHand()
		if (m_LHand.count == 0) then (uiLHand.enabled = false; uiLHand.state = false) else (uiLHand.enabled = true; uiLHand.state = true)
		m_Pelvis = GetPelvis()
		m_RThigh = GetRThigh()
		m_LThigh = GetLThigh()
		m_RCalf = GetRCalf()
		m_LCalf = GetLCalf()
		m_RFoot = GetRFoot()
		m_LFoot = GetLFoot()
		m_RToe = GetRToe()
		m_LToe = GetLToe()
		m_RLegs = GetRLegs()
		m_AllFoot = GetAllFoot()
		m_LLegs = GetLLegs()
		m_AllBip = GetAllBip()
		m_LProp = GetLProp()
		m_RProp = GetRProp()

		uiChkBtnScanBiped.text = "All Biped"

		LoadRangeLoop()
		-- LoadRangeA()
		-- LoadRangeB()
		LoadGoto()
		SetGotoBtnText()

		uiDropPlaySpeed.selection = timeConfiguration.playbackSpeed

        SetGotoMirrorEnable ()
        
        uiPlayBlock.state = false
		clock.active = false
		m_PBKeyTimeArray = #()
		m_PBKeyMiliSecArray = #()
        SetPBPlaySpeed()
		if selection.count == 1 then 
		(
			try
			(
				uiFigureMode.state = $.controller.rootnode.controller.figureMode
				uiBtnInPlace.state = false
				if $.controller.rootnode.controller.inPlaceYMode == true then
				(
					uiBtnInPlace.images = #("bip_general_i.bmp","bip_general_i.bmp",30,27,27,27,27,true,true)
					uiBtnInPlace.state = true
				)
				else if $.controller.rootnode.controller.inPlaceMode == true then
				(
					uiBtnInPlace.images = #("bip_general_i.bmp","bip_general_i.bmp",30,23,23,23,23,true,true)
					uiBtnInPlace.state = true
				)
			)
			catch
			(
				uiFigureMode.state = false
				uiBtnInPlace.state = false
			)
		)
		else 
		(
			uiFigureMode.state = false
			uiBtnInPlace.state = false
		)
		fnRefreshTrackSelection m_workingBipRoot
		fnSyncBipedPanel()
		fnBSUpdateLayers()
		fnRefreshTwistState()
	)

	-- ë³´ì •ì¹˜ íšŒì „ê°’ì„ ì…ë ¥ë°›ê³  ë˜‘ë°”ë¡œ í´ì£¼ëŠ” ê¸°ëŠ¥ì„ í•œë‹¤. bipsëŠ” ë°°ì—´. ë³´ì •ì¹˜ íšŒì „ê°’ì€ Toe ë“±ì—ì„œ 90ë„ ì¶”ê°€ íšŒì „ì´ í•„ìš”í•¨
	function Straighten bips offsetRotation = (
		for bip in bips do (
			if (bip != undefined AND (isDeleted bip) == false) do (
				biped.setTransform bip #rotation (offsetRotation * bip.parent.transform.rotation) animButtonState
			)
		)
	)

	-- Straighten í•¨ìˆ˜ì™€ ê°™ì€ ê¸°ëŠ¥ì´ì§€ë§Œ ë¶€ëª¨ ëŒ€ì‹ ì— ë‹¤ë¥¸ í”„ë¡ì‹œ ì˜¤ë¸Œì íŠ¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•œë‹¤.
	-- ë°”ì´íŒ¨ë“œì˜ Triangle Pelvis ì˜µì…˜ë•Œë¬¸ì— í—ˆë²…ì§€ ë¶€ëª¨ê°€ ì²™ì¶”ì¸ ê²½ìš°ê°€ ì¢…ì¢… ìˆì–´ì„œ ê°•ì œë¡œ Pelvisë¥¼ ì§€ì •
	function StraightenByProxy bips proxy offsetRotation = (
		for bip in bips do (
			if (bip != undefined AND (isDeleted bip) == false) do (
				biped.setTransform bip #rotation (offsetRotation * proxy.transform.rotation) animButtonState
			)
		)
	)

	fn fnMsgMissingBiped =
	(
		messageBox "é”™è¯¯ï¼šåœºæ™¯ä¸­ç¼ºå°‘å…ˆå‰é€‰æ‹©çš„ Bipedï¼å·²é‡å¯å·¥å…·ï¼                                                " title:"BsBipedTools"
		setIniSetting iniBsBipedTools "BipedPanel" "CurrentBip" "1"
		try (destroydialog rolBsBipedTools) catch()
		if (iniBsBTPos != 0) then 
		(Createdialog rolBsBipedTools pos:iniBsBTPos style:#() fgcolor:(if fnGetThemeColor() == "Light" then (color 28 89 177) else (color 165 222 228)))
		else (Createdialog rolBsBipedTools style:#() fgcolor:(if fnGetThemeColor() == "Light" then (color 28 89 177) else (color 165 222 228)))
	)

	fn fnMirrorPosture a_bipObjs =
	(
		if isValidNode m_workingBipRoot AND NOT isDeleted m_workingBipRoot then
		(
			try
			(
				local bRootCtrl = m_workingBipRoot.controller
				biped.createCopyCollection bRootCtrl "MirrorTemp"
				local colIndex = biped.numCopyCollections bRootCtrl
				local copyCol = biped.getCopyCollection bRootCtrl colIndex
				biped.copyBipPosture bRootCtrl copyCol a_bipObjs #snapAuto
				local mirroreBH_pose = getCopy copyCol #posture 1
				with Animate on
				(
					undo "MirrorPosture" on
					(
						biped.pasteBipPosture bRootCtrl mirroreBH_pose true #pstdefault true true true false
					)
				)
				biped.deleteCopyCollection bRootCtrl colIndex
			)
			catch(messageBox "é”™è¯¯ï¼šé•œåƒå¤±è´¥ï¼Œè¯·é‡æ–°å°è¯•ã€‚                       " title:"BsBipedTools")
		)
	)
	
	fn fnStorePostureObjs a_objs =
	(
		local txtFile = openFile postureObjsFile mode:"w"
		for obj in a_objs do
		(
			format "%\n" obj.name to:txtFile
		)
		close txtFile
	)
	
	fn fnRetrievePostureObjs =
	(
		if doesFileExist postureObjsFile do
		(
			local a_objs = #()
			local txtFile = openFile postureObjsFile mode:"r"
			while NOT eof txtFile do
			(
				append a_objs (getNodeByName (readLine txtFile))
			)
			close txtFile
			a_objs
		)
	)
	
	fn fnFilterBipedParts a_selObjs =
	(
		local a_bipedParts = #()
		
		for obj in a_selObjs do
		(
			if classof obj.baseObject == Biped_Object do
			(
				append a_bipedParts obj
			)
		)
		a_bipedParts
	)

	on uiCbtCopy changed state do
	(
		uiCbtCopy.state = true
		try
		(
			if selection.count > 0 then
			(
				local a_objs = selection as array
				--// Make sure only Biped parts are selected for copying by filtering out non-Biped parts
				a_objs = fnFilterBipedParts a_objs
				if a_objs.count > 0 then
				(
					fnStorePostureObjs a_objs
					if isValidNode m_workingBipRoot AND NOT isDeleted m_workingBipRoot then
					(
						local bRootCtrl = m_workingBipRoot.controller
						biped.createCopyCollection bRootCtrl "CopyPosture"
						local colIndex = biped.numCopyCollections bRootCtrl
						local copyCol = biped.getCopyCollection bRootCtrl colIndex
						biped.copyBipPosture bRootCtrl copyCol a_objs #snapAuto
						biped.saveCopyPasteFile bRootCtrl (getDir #plugcfg + "\BsBipedTools_PoseGrabbed.cpy")
						biped.deleteCopyCollection bRootCtrl colIndex
					)
				)
				else
				(
					messageBox "é”™è¯¯ï¼šæ²¡æœ‰é€‰æ‹© Biped å¯¹è±¡ã€‚                       " title:"BsBipedTools"
				)
			)
			else
			(
				messageBox "é”™è¯¯ï¼šè¯·é€‰æ‹©ä¸€äº›è¦å¤åˆ¶çš„ Biped å¯¹è±¡ã€‚                            " title:"BsBipedTools"
			)
		)
		catch(messageBox "é”™è¯¯ï¼šè¯·é‡æ–°å°è¯•å¤åˆ¶ç²˜è´´Poseã€‚                       " title:"BsBipedTools")
	)
	
	on uiCbtPaste changed state do
	(
		uiCbtPaste.state = true
		try
		(
			local postureFile = getDir #plugcfg + "\BsBipedTools_PoseGrabbed.cpy"
			if doesFileExist postureFile then
			(
				if isValidNode m_workingBipRoot AND NOT isDeleted m_workingBipRoot then
				(
					local bRootCtrl = m_workingBipRoot.controller
					biped.loadCopyPasteFile bRootCtrl postureFile
					local colIndex = biped.numCopyCollections bRootCtrl
					local copyCol = biped.getCopyCollection bRootCtrl colIndex
					local copyBH_posture = getCopy copyCol #posture 1
					if copyBH_posture != false then
					(
						with Animate on
						(
							undo "PastePosture" on
							(
								biped.pasteBipPosture bRootCtrl copyBH_posture false #pstdefault true true true false
							)
						)
					)
					else
					(
						messagebox "é”™è¯¯ï¼šç¡®ä¿ Copy/Paste Posture ä¸åŒ…å«åä¸º"CopyPosture"çš„é›†åˆã€‚                            " title:"BsBipedTools"
					)
					local colIndex = biped.numCopyCollections bRootCtrl
					biped.deleteCopyCollection bRootCtrl colIndex
				)
			)
			else
			(
				messageBox "é”™è¯¯ï¼šè¯·å…ˆå¤åˆ¶ä¸€ä¸ª Poseã€‚                          " title:"BsBipedTools"
			)
		)
		catch (messageBox "é”™è¯¯ï¼šè¯·é‡æ–°å°è¯•å¤åˆ¶ç²˜è´´Poseã€‚                       " title:"BsBipedTools")
	)

	on uiCbtPasteOpposite changed state do
	(
		uiCbtPasteOpposite.state = true
		try
		(
			local postureFile = getDir #plugcfg + "\BsBipedTools_PoseGrabbed.cpy"
			if doesFileExist postureFile then
			(
				if isValidNode m_workingBipRoot AND NOT isDeleted m_workingBipRoot then
				(
					local bRootCtrl = m_workingBipRoot.controller
					biped.loadCopyPasteFile bRootCtrl postureFile
					local colIndex = biped.numCopyCollections bRootCtrl
					local copyCol = biped.getCopyCollection bRootCtrl colIndex
					local copyBH_posture = getCopy copyCol #posture 1
					if copyBH_posture != false then
					(
						with Animate on
						(
							undo "PastePosture" on
							(
								biped.pasteBipPosture bRootCtrl copyBH_posture true #pstdefault true true true false
							)
						)
					)
					else
					(
						messagebox "é”™è¯¯ï¼šç¡®ä¿ Copy/Paste Posture ä¸åŒ…å«åä¸º"CopyPosture"çš„é›†åˆã€‚                            " title:"BsBipedTools"
					)
					local colIndex = biped.numCopyCollections bRootCtrl
					biped.deleteCopyCollection bRootCtrl colIndex
				)
			)
			else
			(
				messageBox "é”™è¯¯ï¼šè¯·å…ˆå¤åˆ¶ä¸€ä¸ª Poseã€‚                          " title:"BsBipedTools"
			)
		)
		catch (messageBox "é”™è¯¯ï¼šè¯·é‡æ–°å°è¯•å¤åˆ¶ç²˜è´´Poseã€‚                       " title:"BsBipedTools")
	)
	
	on uiCbtSelPostureObjs changed state do
	(
		uiCbtSelPostureObjs.state = true
		try
			(
				local a_objs = fnRetrievePostureObjs()
				if a_objs != undefined then
				(
					try
					(
						select a_objs
					)catch(messageBox "é”™è¯¯: æ— æ³•é€‰æ‹©ç”¨äºå¤åˆ¶å§¿åŠ¿çš„Bipedéª¨éª¼ã€‚                                " title:"BsBipedTools")
				)
			)catch()
	)
	
	on uiCbtMirrorLArm changed state do
	(
		uiCbtMirrorLArm.state = true
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		-- local arrMirror = makeUniqueArray (m_LArms + m_LHand)
		fnMirrorPosture m_LArms
	)
	
	on uiCbtMirrorRArm changed state do
	(
		uiCbtMirrorRArm.state = true
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		-- local arrMirror = makeUniqueArray (m_RArms + m_RHand)
		fnMirrorPosture m_RArms
	)
	
	on uiCbtMirrorLLeg changed state do
	(
		uiCbtMirrorLLeg.state = true
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		fnMirrorPosture m_LLegs
	)
	
	on uiCbtMirrorRLeg changed state do
	(
		uiCbtMirrorRLeg.state = true
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		fnMirrorPosture m_RLegs
	)

	on uiChkBtnScanBiped changed state do (
		uiChkBtnScanBiped.state = true
		InitLocalVars() -- å·¥ä½œç”¨ åŒè¶³äººå½¢ æ ¹èŠ‚ç‚¹ç­‰ï¼Œé€‰æ‹©ç”¨æ•°ç»„å˜é‡ç­‰é¢„è®¾
		if (m_workingBipRoot != undefined) do (select m_AllBip)
	)

	on uiBtnSetAllKey changed state do with undo on
	(
		uiBtnSetAllKey.state = true
		for i in selection as array where iskindof i.baseObject Biped_Object do
		(
			if ( classof i.controller == Vertical_Horizontal_Turn ) then
			(
				biped.addNewKey i.controller.vertical.controller slidertime
				biped.addNewKey i.controller.horizontal.controller slidertime
				biped.addNewKey (fnBipedComlocalization i.controller) slidertime
			)
			else 
			(
				try (biped.addNewKey i.controller sliderTime ) catch ()
			)
		)
	)
	
	on uiBtnSetAllKey rightclick do (
		uiBtnSetAllKey.state = true
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		if (m_workingBipRoot.transform.controller.figureMode) do (
			messageBox "ä¸èƒ½åœ¨ä½“å½¢æ¨¡å¼ä¸­æ·»åŠ å…³é”®å¸§ã€‚                              " title:"BsBipedTools"
			return ()
		)

		selBackup = selection as array

		-- é¢„å­˜æ•°ç»„æœ‰é—®é¢˜åˆ™é‡æ–°åˆå§‹åŒ–æ•°ç»„
		if (IfExistBips m_AllBip) == false do (
			m_AllBip = GetAllBip()
		)
		if (IfExistBips m_AllBip) == false do return () -- è¿˜æ˜¯æœ‰é—®é¢˜åˆ™ç›´æ¥è¿”å›
		
		undo on
		(
			for o in m_AllBip do
			(
				if ( o == m_workingBipRoot ) then
				(
					biped.addNewKey o.controller.vertical.controller slidertime
					biped.addNewKey o.controller.horizontal.controller slidertime
					biped.addNewKey (fnBipedComlocalization o.controller) slidertime
				)
				else
				(
					try ( biped.addNewKey o.controller slidertime ) catch ()		-- Footstep å¯¹è±¡å¯¼è‡´ try å¤„ç†
				)
			) -- for end
		) -- undo end	
		clearSelection()
		select selBackup
	)

	on uiBtnLimbPK changed state do (
		uiBtnLimbPK.state = on -- ä»»ä½•çŠ¶æ€ä¸‹æŒ‰é’®çŠ¶æ€éƒ½ä¿æŒæŒ‰ä¸‹
		if ((rolBsBipedTools.m_workingBipRoot != undefined) and (not (isDeleted rolBsBipedTools.m_workingBipRoot))) then
		(
			layerIndex = biped.getCurrentLayer rolBsBipedTools.m_workingBipRoot.controller
			if layerIndex == 0 then 
			(
				local tempPanel = getCommandPanelTaskMode()
				setCommandPanelTaskMode mode:#motion -- biped.setSlidingKey ç­‰åŠŸèƒ½åªåœ¨ Motion é¢æ¿æ­£å¸¸å·¥ä½œï¼Œå…¶ä»–åœ°æ–¹ä¼šå¯¼è‡´é”™è¯¯å§¿åŠ¿è¦†ç›–
				local timeBefore = sliderTime
				-- disableSceneRedraw()
				undo on (
					for obj in selection do (
						if (IfLimb obj) do (
							if (keyboard.shiftPressed OR keyboard.controlPressed) then (
								local keys = obj.controller.keys
								local animRangeBackup = animationRange -- æš‚æ—¶å¯ä»¥ä¿®æ”¹å¤–éƒ¨çš„å…³é”®å¸§ï¼Œè®°å½•å½“å‰çš„åŠ¨ç”»åŒºé—´
								animationRange = Interval keys[1].time keys[keys.count].time
								for i = 1 to keys.count do (
									if keyboard.shiftPressed do (
										-- Shift æŒ‰ä¸‹åˆ™ä¸è€ƒè™‘å…³é”®å¸§é€‰æ‹©ï¼Œå…¨éƒ¨ä¿®æ”¹
										sliderTime = keys[i].time -- ä½¿ç”¨ at time æ–¹å¼ä¼šå¯¼è‡´ sliderTime çš„å§¿åŠ¿ç”Ÿæˆå…³é”®å¸§ï¼Œæ‰€ä»¥ç›´æ¥æ”¹å˜ sliderTime è¿›è¡Œ
										biped.SetPlantedKey obj
									)
									if keyboard.controlPressed do (
										-- Ctrl æŒ‰ä¸‹åˆ™åªä¿®æ”¹é€‰ä¸­çš„å…³é”®å¸§
										if keys[i].selected == true do (
											sliderTime = keys[i].time -- ä½¿ç”¨ at time æ–¹å¼ä¼šå¯¼è‡´ sliderTime çš„å§¿åŠ¿ç”Ÿæˆå…³é”®å¸§ï¼Œæ‰€ä»¥ç›´æ¥æ”¹å˜ sliderTime è¿›è¡Œ
											biped.SetPlantedKey obj
										)
									)
								)
								animationRange = animRangeBackup -- æ¢å¤åŸæ¥çš„åŠ¨ç”»åŒºé—´
							)
							else (
								biped.SetPlantedKey obj
							)
						)
					) -- for
				) -- Undo
				if tempPanel != #motion do setCommandPanelTaskMode mode:tempPanel
				-- enableSceneRedraw()
				sliderTime = timeBefore
			)
			else (messagebox "bip å±‚å†…æ— æ³•ä½¿ç”¨æ­¤åŠŸèƒ½!                                     " beep:false title:"BsBipedTools")
		)
	)

	on uiBtnLimbIK changed state do (
		uiBtnLimbIK.state = on -- ä»»ä½•çŠ¶æ€ä¸‹æŒ‰é’®çŠ¶æ€éƒ½ä¿æŒæŒ‰ä¸‹
		if ((rolBsBipedTools.m_workingBipRoot != undefined) and (not (isDeleted rolBsBipedTools.m_workingBipRoot))) then
		(
			layerIndex = biped.getCurrentLayer rolBsBipedTools.m_workingBipRoot.controller
			if layerIndex == 0 then 
			(
				local tempPanel = getCommandPanelTaskMode()
				setCommandPanelTaskMode mode:#motion -- biped.setSlidingKey ç­‰åŠŸèƒ½åªåœ¨ Motion é¢æ¿æ­£å¸¸å·¥ä½œï¼Œå…¶ä»–åœ°æ–¹ä¼šå¯¼è‡´é”™è¯¯å§¿åŠ¿è¦†ç›–
				local timeBefore = sliderTime
				-- disableSceneRedraw()
				undo on (
					for obj in selection do (
						if (IfLimb obj) do (
							if (keyboard.shiftPressed OR keyboard.controlPressed) then (
								local keys = obj.controller.keys
								local animRangeBackup = animationRange -- æš‚æ—¶å¯ä»¥ä¿®æ”¹å¤–éƒ¨çš„å…³é”®å¸§ï¼Œè®°å½•å½“å‰çš„åŠ¨ç”»åŒºé—´
								animationRange = Interval keys[1].time keys[keys.count].time
								for i = 1 to keys.count do (
									if keyboard.shiftPressed do (
										-- Shift æŒ‰ä¸‹åˆ™ä¸è€ƒè™‘å…³é”®å¸§é€‰æ‹©ï¼Œå…¨éƒ¨ä¿®æ”¹
										sliderTime = keys[i].time -- ä½¿ç”¨ at time æ–¹å¼ä¼šå¯¼è‡´ sliderTime çš„å§¿åŠ¿ç”Ÿæˆå…³é”®å¸§ï¼Œæ‰€ä»¥ç›´æ¥æ”¹å˜ sliderTime è¿›è¡Œ
										biped.setSlidingKey obj
									)
									if keyboard.controlPressed do (
										-- Ctrl æŒ‰ä¸‹åˆ™åªä¿®æ”¹é€‰ä¸­çš„å…³é”®å¸§
										if keys[i].selected == true do (
											sliderTime = keys[i].time -- ä½¿ç”¨ at time æ–¹å¼ä¼šå¯¼è‡´ sliderTime çš„å§¿åŠ¿ç”Ÿæˆå…³é”®å¸§ï¼Œæ‰€ä»¥ç›´æ¥æ”¹å˜ sliderTime è¿›è¡Œ
											biped.setSlidingKey obj
										)
									)
								)
								animationRange = animRangeBackup -- æ¢å¤åŸæ¥çš„åŠ¨ç”»åŒºé—´
							)
							else (
								biped.setSlidingKey obj
							)
						)
					) -- for
				) -- Undo
				if tempPanel != #motion do setCommandPanelTaskMode mode:tempPanel
				-- enableSceneRedraw()
				sliderTime = timeBefore
			)
			else (messagebox "bip å±‚å†…æ— æ³•ä½¿ç”¨æ­¤åŠŸèƒ½!                                     " beep:false title:"BsBipedTools")
		)
	)

	on uiBtnLimbFK changed state do (
		uiBtnLimbFK.state = on -- ä»»ä½•çŠ¶æ€ä¸‹æŒ‰é’®çŠ¶æ€éƒ½ä¿æŒæŒ‰ä¸‹
		if ((rolBsBipedTools.m_workingBipRoot != undefined) and (not (isDeleted rolBsBipedTools.m_workingBipRoot))) then
		(
			layerIndex = biped.getCurrentLayer rolBsBipedTools.m_workingBipRoot.controller
			if layerIndex == 0 then 
			(
				local tempPanel = getCommandPanelTaskMode()
				setCommandPanelTaskMode mode:#motion -- biped.setSlidingKey ç­‰åŠŸèƒ½åªåœ¨ Motion é¢æ¿æ­£å¸¸å·¥ä½œï¼Œå…¶ä»–åœ°æ–¹ä¼šå¯¼è‡´é”™è¯¯å§¿åŠ¿è¦†ç›–
				local timeBefore = sliderTime
				-- disableSceneRedraw()
				undo on (
					for obj in selection do (
						if (IfLimb obj) do (
							if (keyboard.shiftPressed OR keyboard.controlPressed) then (
								local keys = obj.controller.keys
								local animRangeBackup = animationRange -- ì ì‹œ ë°”ê¹¥ì— ìˆëŠ” í‚¤ë“¤ë„ ìˆ˜ì •í•  ìˆ˜ ìˆë„ë¡ í˜„ì¬ì˜ ì• ë‹ˆë©”ì´ì…˜ êµ¬ê°„ì„ ê¸°ì–µí•œë‹¤.
								animationRange = Interval keys[1].time keys[keys.count].time
								for i = 1 to keys.count do (
									if keyboard.shiftPressed do (
										-- Shiftê°€ ëˆŒë ¤ìˆìœ¼ë©´ í‚¤ ì„ íƒê³¼ ìƒê´€ ì—†ì´ ëª¨ë‘ ë³€ê²½
										sliderTime = keys[i].time -- at time ë°©ì‹ìœ¼ë¡œ í•˜ë©´ sliderTimeì˜ ìì„¸ë¡œ í‚¤ê°€ ìƒì„±ë˜ëŠ” ë¬¸ì œê°€ ìˆì–´ì„œ ì‹¤ì œ sliderTimeì„ ë³€ê²½ì‹œì¼œì„œ ì§„í–‰
										biped.setFreeKey obj
									)
									if keyboard.controlPressed do (
										-- Ctrlì´ ëˆŒë ¤ìˆìœ¼ë©´ ì„ íƒëœ í‚¤ë“¦ë§Œ ë³€ê²½
										if keys[i].selected == true do (
											sliderTime = keys[i].time -- at time ë°©ì‹ìœ¼ë¡œ í•˜ë©´ sliderTimeì˜ ìì„¸ë¡œ í‚¤ê°€ ìƒì„±ë˜ëŠ” ë¬¸ì œê°€ ìˆì–´ì„œ ì‹¤ì œ sliderTimeì„ ë³€ê²½ì‹œì¼œì„œ ì§„í–‰
											biped.setFreeKey obj
										)
									)
								)
								animationRange = animRangeBackup -- ë‹¤ì‹œ ì›ë˜ëŒ€ë¡œì˜ ì• ë‹ˆë©”ì´ì…˜ êµ¬ê°„ìœ¼ë¡œ ë³µêµ¬
							)
							else (
								biped.setFreeKey obj
							)
						)
					) -- for
				) -- Undo
				if tempPanel != #motion do setCommandPanelTaskMode mode:tempPanel
				-- enableSceneRedraw()
				sliderTime = timeBefore
			)
			else (messagebox "bip å±‚å†…æ— æ³•ä½¿ç”¨æ­¤åŠŸèƒ½!                                     " beep:false title:"BsBipedTools")
		)
	)

	on uiHead changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiHead.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			Straighten m_Head ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array
		
		try(CompSelect selBackup m_Head) catch (
			m_Head = GetHead()
			select m_Head
		)
	)

	on uiHead rightclick do 
	(
		-- åˆ‡æ¢é¢œæ–‡å­—è„¸
		currentFaceIndex += 1
		if currentFaceIndex > headFaces.count then currentFaceIndex = 1
		uiHead.caption = headFaces[currentFaceIndex]
		uiHead.state = on
		-- ä¿å­˜åˆ°é…ç½®æ–‡ä»¶
		SetINISetting iniBsBipedTools "BsBipedTools" "HeadFaceIndex" (currentFaceIndex as string)
	)

	on btnResetFace pressed do 
	(
		-- è¿˜åŸè„¸å‹åˆ°åˆå§‹çŠ¶æ€
		if (queryBox "ç¡®å®šè¦è¿˜åŸå¤´éƒ¨è¡¨æƒ…åˆ°åˆå§‹çŠ¶æ€å—ï¼Ÿ" title:"è¿˜åŸè¡¨æƒ…ç¡®è®¤") then
		(
			currentFaceIndex = 1
			uiHead.caption = headFaces[currentFaceIndex]
			uiHead.state = on
			SetINISetting iniBsBipedTools "BsBipedTools" "HeadFaceIndex" (currentFaceIndex as string)
			messageBox "å¤´éƒ¨è¡¨æƒ…å·²è¿˜åŸåˆ°åˆå§‹çŠ¶æ€ï¼" title:"BsBipedTools"
		)
	)

	on uiNecks changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiNecks.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			Straighten m_Necks ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_Necks) catch (
			m_Necks = GetNecks()
			select m_Necks
			
		)
	)
	
	on uiRArms changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRArms.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		selBackup = selection as array

		try(CompSelect selBackup m_RArms) catch (
			m_RArms = GetRArms()
			select m_RArms
			
		)
	)

	on uiRArms rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRArms.state = on
		m_LArms = GetLArms()
		select m_LArms
	) 
	
	on uiLArms changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLArms.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		selBackup = selection as array

		try(CompSelect selBackup m_LArms) catch (
			m_LArms = GetLArms()
			select m_LArms
			
		)
	)

	on uiLArms rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLArms.state = on
		m_RArms = GetRArms()
		select m_RArms
	) 
	
	on uiRClavicle changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRClavicle.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			StraightenByProxy m_RClavicle m_AllSpine[m_AllSpine.count] ((eulerangles 0 90 -180) as quat)
			return ()
		)

		selBackup = selection as array

		try(CompSelect selBackup m_RClavicle) catch (
			m_RClavicle = GetRClavicle()
			select m_RClavicle
			
		)
	)

	on uiRClavicle rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRClavicle.state = on
		m_LClavicle = GetLClavicle()
		select m_LClavicle
	) 

	on uiLClavicle changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLClavicle.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			StraightenByProxy m_LClavicle m_AllSpine[m_AllSpine.count] ((eulerangles 0 -90 -180) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_LClavicle) catch (
			m_LClavicle = GetLClavicle()
			select m_LClavicle
			
		)
	)

	on uiLClavicle rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLClavicle.state = on
		m_RClavicle = GetRClavicle()
		select m_RClavicle
	)
	
	on uiRUpArm changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRUpArm.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			Straighten m_RUpArm ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_RUpArm) catch (
			m_RUpArm = GetRUpArm()
			select m_RUpArm
			
		)
	)

	on uiRUpArm rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRUpArm.state = on
		m_LUpArm = GetLUpArm()
		select m_LUpArm
	)

	on uiAllSpine changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiAllSpine.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			Straighten m_AllSpine ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_AllSpine) catch (
			m_AllSpine = GetAllSpine()
			select m_AllSpine
			
		)
	)

	on uiSpine3 changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiSpine3.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			Straighten m_Spine3 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		-- ê¸°ì¡´ selection ë°±ì—…ê³¼ ì´ë²ˆì— ì„ íƒí•  selArr ì„ ì…ë ¥ë°›ì•„ í‚¤ë³´ë“œ ì¡°í•©ìœ¼ë¡œ ì ì ˆí•˜ê²Œ ì„ íƒí•œë‹¤. ë¶€ìˆ˜ì ìœ¼ë¡œ ëª¨ì…˜íŒ¨ë„ë¡œì˜ ë³€ê²½ë„ ê°™ì´ ìˆ˜í–‰
		try(CompSelect selBackup m_Spine3) catch (
			m_Spine3 = GetSpine 3
			select m_Spine3
		)
	)

	on uiSpine2 changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiSpine2.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			Straighten m_Spine2 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_Spine2) catch (
			m_Spine2 = GetSpine 2
			select m_Spine2
			
		)
	)

	on uiSpine1 changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiSpine1.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			Straighten m_Spine1 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_Spine1) catch (
			m_Spine1 = GetSpine 1
			select m_Spine1
			
		)
	)

	on uiSpine0 changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiSpine0.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			Straighten m_Spine0 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_Spine0) catch (
			m_Spine0 = GetSpine 0
			select m_Spine0
			
		)
	)

	on uiLUpArm changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLUpArm.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			Straighten m_LUpArm ((eulerangles 0 0 0) as quat)
			return ()
		)

		selBackup = selection as array

		try(CompSelect selBackup m_LUpArm) catch (
			m_LUpArm = GetLUpArm()
			select m_LUpArm
			
		)
	)

	on uiLUpArm rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLUpArm.state = on
		m_RUpArm = GetRUpArm()
		select m_RUpArm
	)
	
	on uiRForArm changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRForArm.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			Straighten m_RForArm ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_RForArm) catch (
			m_RForArm = GetRForArm()
			select m_RForArm
			
		)
	)

	on uiRForArm rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRForArm.state = on
		m_LForArm = GetLForArm()
		select m_LForArm
	)

	on uiLForArm changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLForArm.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			Straighten m_LForArm ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_LForArm) catch (
			m_LForArm = GetLForArm()
			select m_LForArm
			
		)
	)

	on uiLForArm rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLForArm.state = on
		m_RForArm = GetRForArm()
		select m_RForArm
	)
	
	on uiRHand changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRHand.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			Straighten m_RHand ((eulerangles 90 0 0) as quat)
			return ()
		)

		selBackup = selection as array

		try(CompSelect selBackup m_RHand) catch (
			m_RHand = GetRHand()
			select m_RHand
			
		)
	)

	on uiRHand rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRHand.state = on
		m_LHand = GetLHand()
		select m_LHand
	)

	on uiCOM changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiCOM.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		selBackup = selection as array
        
        -- ìƒˆë¡œìš´ ì”¬ì„ ì—´ë©´ m_workingBipRootì´ undefinedëŠ” ì•„ë‹ˆì§€ë§Œ ì—ëŸ¬ ë°œìƒí•¨
        try (
            if ( m_workingBipRoot.isHidden == false ) or uiChkSelHiddenObj.state then (
                CompSelect selBackup #(m_workingBipRoot)
            )
            else (
                clearselection()
            )
        )
        catch (
            if (AutoGetBipRoot() == false) do ( SetButtonState false; return ())
            if ( m_workingBipRoot.isHidden == false ) or uiChkSelHiddenObj.state then (
                CompSelect selBackup #(m_workingBipRoot)
            )
            else (
                clearselection()
            )
        )
		
	)
	
	on uiLHand changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLHand.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			Straighten m_LHand ((eulerangles -90 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_LHand) catch (
			m_LHand = GetLHand()
			select m_LHand
		)
	)

	on uiLHand rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLHand.state = on
		m_RHand = GetRHand()
		select m_RHand
	)
	
	on uiPelvis changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiPelvis.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			Straighten m_Pelvis ((eulerangles -90 -90 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_Pelvis) catch (
			m_Pelvis = GetPelvis()
			select m_Pelvis
			
		)
	)
	
	on uiRThigh changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRThigh.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			StraightenByProxy m_RThigh m_Pelvis[1] ((eulerangles 0 180 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_RThigh) catch (
			m_RThigh = GetRThigh()
			select m_RThigh
			
		)
	)

	on uiRThigh rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRThigh.state = on
		m_LThigh = GetLThigh()
		select m_LThigh
	)

	on uiLThigh changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLThigh.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			StraightenByProxy m_LThigh m_Pelvis[1] ((eulerangles 0 -180 0) as quat)
			return ()
		)
		
		selBackup = selection as array
		
		try(CompSelect selBackup m_LThigh) catch (
			m_LThigh = GetLThigh()
			select m_LThigh
			
		)
	)

	on uiLThigh rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLThigh.state = on
		m_RThigh = GetRThigh()
		select m_RThigh
	)
	
	on uiRCalf changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRCalf.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			Straighten m_RCalf ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_RCalf) catch (
			m_RCalf = GetRCalf()
			select m_RCalf
			
		)
	)

	on uiRCalf rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRCalf.state = on
		m_LCalf = GetLCalf()
		select m_LCalf
	)

	on uiLCalf changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLCalf.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			Straighten m_LCalf ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_LCalf) catch (
			m_LCalf = GetLCalf()
			select m_LCalf
			
		)
	)

	on uiLCalf rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLCalf.state = on
		m_RCalf = GetRCalf()
		select m_RCalf
	)
	
	on uiRFoot changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRFoot.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			Straighten m_RFoot ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_RFoot) catch (
			m_RFoot = GetRFoot()
			select m_RFoot
			
		)
	)

	on uiRFoot rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRFoot.state = on
		m_LFoot = GetLFoot()
		select m_LFoot
	)
	
	on uiLFoot changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLFoot.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			Straighten m_LFoot ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_LFoot) catch (
			m_LFoot = GetLFoot()
			select m_LFoot
			
		)
	)

	on uiLFoot rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLFoot.state = on
		m_RFoot = GetRFoot()
		select m_RFoot
	)

	on uiRToe changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRToe.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡

		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			Straighten m_RToe ((eulerangles 0 0 90) as quat)
			return ()
		)

		selBackup = selection as array
		
		try(CompSelect selBackup m_RToe) catch (
			m_RToe = GetRToe()
			select m_RToe
			
		)
	)

	on uiRToe rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRToe.state = on
		m_LToe = GetLToe()
		select m_LToe
	)

	on uiLToe changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLToe.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡

		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift ë¥¼ ëˆ„ë¥´ë©´ ë˜‘ë°”ë¡œ í´ëŠ” ê¸°ëŠ¥
			Straighten m_LToe ((eulerangles 0 0 90) as quat)
			return ()
		)

		selBackup = selection as array

		try(CompSelect selBackup m_LToe) catch (
			m_LToe = GetLToe()
			select m_LToe
			
		)
	)

	on uiLToe rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLToe.state = on
		m_RToe = GetRToe()
		select m_RToe
	)
	
	on uiRLegs changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRLegs.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		selBackup = selection as array

		try(CompSelect selBackup m_RLegs) catch (
			m_RLegs = GetRLegs()
			select m_RLegs
			
		)
	)

	on uiRLegs rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRLegs.state = on
		m_LLegs = GetLLegs()
		select m_LLegs
	)
	
	on uiAllFoot changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiAllFoot.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		selBackup = selection as array

		try(CompSelect selBackup m_AllFoot) catch (
			m_AllFoot = GetAllFoot()
			select m_AllFoot
		)
	)
	
	on uiLLegs changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLLegs.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡
		selBackup = selection as array

		try(CompSelect selBackup m_LLegs) catch (
			m_LLegs = GetLLegs()
			select m_LLegs
			
		)
	)

	on uiLLegs rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLLegs.state = on
		m_RLegs = GetRLegs()
		select m_RLegs
	)

	on uiPropL changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiPropL.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡

		selBackup = selection as array

		try(CompSelect selBackup m_LProp) catch (
			m_LProp = GetLProp()
			select m_LProp
		)
	)

	on uiPropL rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiPropL.state = on
		m_RProp = GetRProp()
		select m_RProp
	)

	on uiPropR changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiPropR.state = on -- ì–´ë–¤ ìƒíƒœì—ì„œë„ ë²„íŠ¼ ìŠ¤í…Œì´íŠ¸ëŠ” ëˆŒë ¤ìˆë„ë¡

		selBackup = selection as array

		try(CompSelect selBackup m_RProp) catch (
			m_RProp = GetRProp()
			select m_RProp
		)
	)

	on uiPropR rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiPropR.state = on
		m_LProp = GetLProp()
		select m_RProp
	)
	
	on uiSpnLoopStart changed var do (
		SaveRangeLoop()
		SetGotoMirrorEnable() -- Go to Mirror frame ë²„íŠ¼ í™œì„±/ë¹„í™œì„± ì„¤ì •
	)
	on uiSpnLoopEnd changed var do (
		SaveRangeLoop()
		SetGotoMirrorEnable() -- Go to Mirror frame ë²„íŠ¼ í™œì„±/ë¹„í™œì„± ì„¤ì •
	)

	on uiBtnGotoMirror changed state do (
		uiBtnGotoMirror.state = on
		local now = int sliderTime
		if (now < uiSpnLoopStart.value) OR (now > uiSpnLoopEnd.value) do return ()

		if now == uiSpnLoopEnd.value do (now = uiSpnLoopStart.value) -- ë£¨í”„ ë í”„ë ˆì„ì—ì„œ ë²„íŠ¼ì´ ëˆŒëŸ¬ì¡Œìœ¼ë©´ ì²« í”„ë ˆì„ìœ¼ë¡œ ê°„ì£¼í•¨
		local fCount = uiSpnLoopEnd.value - uiSpnLoopStart.value
		fCount *= 0.5
		local targetFrame = (int sliderTime) + fCount
		if targetFrame == uiSpnLoopEnd.value do (
			sliderTime = uiSpnLoopStart.value
			return ()
		)
		if targetFrame > uiSpnLoopEnd.value then (
			sliderTime = uiSpnLoopStart.value + (targetFrame - uiSpnLoopEnd.value)
			return ()
		)
		else (
			sliderTime = targetFrame
			return ()
		)
	)

	-- IK Blend, Body/Object ë“±ì˜ í‚¤ê°’ì„ ì¡°ì‚¬í•´ì„œ Planted, Sliding, Free ì…‹ ì¤‘ í•˜ë‚˜ì˜ íƒ€ì…ì„ ë¦¬í„´í•œë‹¤.
	fn GetLimbKeyType key = (
		-- ikSpace 0 = Body, 1 = Object
		if key.ikBlend == 1 AND key.ikSpace == 1 AND key.ikJoinedPivot == true do return "Planted"
		if key.ikBlend == 1 AND key.ikSpace == 1 AND key.ikJoinedPivot == false  do return "Sliding"
		return "Free"
	)

	on uiBtnLoopSel changed state do (
		uiBtnLoopSel.state = true

		for obj in selection do (
			DeselectAllKeys obj
			-- ì„ íƒì‹œ ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” ì„¸ë¶€ ì»¨íŠ¸ë¡¤ëŸ¬ ëª…ì‹œ ì—†ì–´ë„ ëŒ€ì¶© ì˜ ì„ íƒí•´ì¤Œ
			selectKeys obj.controller (interval uiSpnLoopStart.value uiSpnLoopEnd.value)
		)
	)
	
	on uiBtnLoopGet changed state do (
		uiBtnLoopGet.state = true
		undo on (
			uiSpnLoopStart.value = animationRange.start as integer / TicksPerFrame
			uiSpnLoopEnd.value = animationRange.end as integer / TicksPerFrame
			SaveRangeLoop()
		)
	)

	on uiDropPlaySpeed selected sel do (
        timeConfiguration.playbackSpeed = sel
        SetPBPlaySpeed()
    )

    -- í”„ë ˆì„ì„ í‹±ìœ¼ë¡œ, í‹±ì„ ë°€ë¦¬ì„¸ì»¨ë“œë¡œ (integer ë¦¬í„´)
    function FramToMilisecond frame = (
		-- animationRange.startë¥¼ ë¹¼ì£¼ì§€ ì•Šìœ¼ë©´ 0í”„ë ˆì„ì´ ì•„ë‹Œ ê³³ì—ì„œ ì‹œì‘í•  ë•Œ ë”œë ˆì´ ë°œìƒí•¨
		return ((((frame - animationRange.start) as integer) * (10.0 / 48.0) * m_PBPlaySpeed) as integer)
    )

    function AppendKeyTimeArray m_PBKeyMiliSecArray keys = (
        if keys.count == 0 do return()
        for i = 1 to keys.count do (
            if (keys[i].time >= animationRange.start) AND (keys[i].time <= animationRange.end) do (
                appendifUnique m_PBKeyMiliSecArray (FramToMilisecond keys[i].time)
                appendifUnique m_PBKeyTimeArray keys[i].time
            )
        )
        -- ì• ë‹ˆë©”ì´ì…˜ ë ˆì¸ì§€ì˜ ì‹œì‘ê³¼ ëì€ ë¬´ì¡°ê±´ í¬í•¨ì‹œí‚´
        appendifUnique m_PBKeyMiliSecArray (FramToMilisecond animationRange.start)
        appendifUnique m_PBKeyTimeArray animationRange.start
        appendifUnique m_PBKeyMiliSecArray (FramToMilisecond animationRange.end)
        appendifUnique m_PBKeyTimeArray animationRange.end
	)
	
	function StopBlocking = (
        clock.active = false
        uiPlayBlock.state = false
        uiPlayBlock.text = "è·³å¸§æ’­"
	)
    
    function PlayBlocking = (
		m_PBKeyTimeArray = #() -- ë¸”ëŸ­í‚¹ ì• ë‹ˆë©”ì´ì…˜ìš© í‚¤ íƒ€ì„ ë°°ì—´ ë¡œì»¬ ë³€ìˆ˜ (Frame)
        m_PBKeyMiliSecArray = #() -- ë¸”ëŸ­í‚¹ ì• ë‹ˆë©”ì´ì…˜ìš© í‚¤ íƒ€ì„ ë°°ì—´ ë¡œì»¬ ë³€ìˆ˜ (ë°€ë¦¬ì„¸ì»¨ë“œ)
        local nowTime = timeStamp()
        for obj in selection do (
            if (classof obj.baseObject) == Biped_Object do (
                if (IfBipRoot obj) then (
					turnCtrlObj = (fnBipedComlocalization obj.transform.controller)
                    AppendKeyTimeArray m_PBKeyMiliSecArray obj.transform.controller.horizontal.controller.keys
                    AppendKeyTimeArray m_PBKeyMiliSecArray obj.transform.controller.vertical.controller.keys
                    AppendKeyTimeArray m_PBKeyMiliSecArray turnCtrlObj.keys
                )
                else (
                    AppendKeyTimeArray m_PBKeyMiliSecArray obj.transform.controller.keys
                )
            )
		)
		if m_PBKeyMiliSecArray.count == 0 do (
			StopBlocking()
			return() -- ì¼ë°˜ ì˜¤ë¸Œì íŠ¸ë¥¼ ì„ íƒí•˜ë©´ ë°°ì—´ì´ ë¹„ì–´ìˆìŒ
		)
		
		if (isAnimPlaying()) do (
			stopAnimation()
		)		
		
        sort m_PBKeyTimeArray
        sort m_PBKeyMiliSecArray
        m_PBPointer = 1
        while (m_PBKeyTimeArray[m_PBPointer] < sliderTime) do (
            m_PBPointer += 1
        )

        m_PBStartTime = timeStamp() - (FramToMilisecond sliderTime)
		sliderTime = m_PBKeyTimeArray[m_PBPointer] -- ì¼ë‹¨ ìŠ¬ë¼ì´ë” íƒ€ì„ì„ ë™ê¸°í™” (ì•ˆí•˜ë©´ ê°•ì œë¡œ ìŠ¤í†±ë¨)
		clock.active = true
		uiPlayBlock.text = "Stop"
    )
	
	function ReplayBlocking = (
		m_PBPointer = 1
        m_PBStartTime = timeStamp()
        sliderTime = m_PBKeyTimeArray[m_PBPointer]
	)

	on uiPlayBlock changed state do (
        if (selection.count == 0) do (
            StopBlocking()
            return()
        )
		if state then (
            PlayBlocking()
        )
        else (
            StopBlocking()
        )
    )
    
    -- Play Blockingìš© í‹± ì´ë²¤íŠ¸ ì²˜ë¦¬
    on clock tick do (
        if (m_PBPointer > m_PBKeyMiliSecArray.count) do return()
		local now = timeStamp()
		local pointer
		if (m_PBKeyMiliSecArray.count == m_PBPointer) then (
			ReplayBlocking()
			pointer = 1
		)
		else (
			pointer = m_PBStartTime + m_PBKeyMiliSecArray[m_PBPointer + 1] -- ë‹¤ìŒ í‚¤í”„ë ˆì„ê³¼ í˜„ì¬ ì‹œê°„ì„ ë¹„êµ
		)
        
        -- í˜„ì¬ ì‹œê°„ì´ ë‹¤ìŒ í”„ë ˆì„ì„ ë„˜ì–´ì„œë©´ í¬ì¸í„° ì¦ê°€, ìŠ¬ë¼ì´ë” ë³€ê²½
        if ( now > pointer ) do (
            m_PBPointer += 1
            sliderTime = m_PBKeyTimeArray[m_PBPointer]
        )
        
        -- í¬ì¸í„°ê°€ ë§ˆì§€ë§‰ í”„ë ˆì„ì„ ê°€ë¦¬í‚¤ë©´ ì²˜ìŒìœ¼ë¡œ ë˜ëŒë¦¬ê³  ì‹œì‘ì‹œê°„ ë¦¬ì…‹
        if (m_PBPointer >= m_PBKeyMiliSecArray.count) do (
            ReplayBlocking()
        )

        if keyboard.escPressed do (
            StopBlocking()
		)
		
		-- ì™¸ë¶€ ìš”ì¸ì— ì˜í•´ ê°•ì œë¡œ ìŠ¬ë¼ì´ë” ì‹œê°„ì´ ë³€ê²½ë˜ë©´ ì‚¬ìš©ìì— ì˜í•œ í”Œë ˆì´ ì·¨ì†Œë¡œ ê°„ì£¼
		if (sliderTime != m_PBKeyTimeArray[m_PBPointer]) do (
			StopBlocking()
		)
    )

	on uiAbout pressed do (
		-- shellLaunch "http://cafe.naver.com/pinksox/6131" ""
		-- rolBsAboutPanel.Show()
		try(destroyDialog rolBsBipToolsHelp)catch()
		Createdialog rolBsBipToolsHelp style:#(#style_titlebar, #style_sysmenu, #style_toolwindow)
	)
	
	on rolBsBipedTools open do (
		
		if NOT (doesFileExist postureObjsFile) do
		(
			local txtFile = openFile postureObjsFile mode:"w"
			close txtFile
		)

		fnLoadBsBTConfig()
		-- åŠ è½½ä¿å­˜çš„è„¸å‹
		local savedIndex = (GetINISetting iniBsBipedTools "BsBipedTools" "HeadFaceIndex") as integer
		if savedIndex != undefined and savedIndex > 0 and savedIndex <= headFaces.count then
		(
			currentFaceIndex = savedIndex
		)
		else
		(
			currentFaceIndex = 1
		)
		-- è®¾ç½®è¡¨æƒ…ï¼ˆåœ¨UIåˆ›å»ºåï¼‰
		uiHead.caption = headFaces[currentFaceIndex]
		fnApplyIcons()
        InitLocalVars() -- ì‘ì—…ìš© ë°”ì´íŒ¨ë“œ ë£¨íŠ¸ ë…¸ë“œë¼ë˜ê°€, ì„ íƒìš© ë°°ì—´ ë³€ìˆ˜ ë“±ì„ ë¯¸ë¦¬ ì„¸íŒ…
        
		fnInitDotTabs()
		fnChangeToolsVisble (dotnetTabs.SelectedIndex + 1)
		if fnIsValidBiped() then 
		(
			ctrl = m_workingBipRoot.controller
			if m_LHand[1] != undefined then uiCbtLeftArm.checked = biped.getLimbRetargetState m_LHand[1]
			if m_RHand[1] != undefined then uiCbtRightArm.checked = biped.getLimbRetargetState m_RHand[1]
			if m_LFoot[1] != undefined then uiCbtLeftLeg.checked = biped.getLimbRetargetState m_LFoot[1]
			if m_RFoot[1] != undefined then uiCbtRightLeg.checked = biped.getLimbRetargetState m_RFoot[1]
		)

        callbacks.addScript #filePostOpen "rolBsBipedTools.InitLocalVars ()" id:#BsBTCallbackOpen
		callbacks.addScript #systemPostNew "rolBsBipedTools.InitLocalVars ()" id:#BsBTCallbackNew
		callbacks.addScript #systemPostReset "rolBsBipedTools.InitLocalVars ()" id:#BsBTCallbackReset
		callbacks.addScript #selectionSetChanged "rolBsBipedTools.InitLocalVars ()" id:#BsBTSelChange
		callbacks.addScript #sceneUndo "rolBsBipedTools.InitLocalVars()" id:#BsBTUpdateLayers
		
		fnSetBsBTConfig()

	)
	
	on rolBsBipedTools close do (
        callbacks.removeScripts id:#BsBTCallbackOpen
		callbacks.removeScripts id:#BsBTCallbackNew
		callbacks.removeScripts id:#BsBTCallbackReset
		callbacks.removeScripts id:#BsBTSelChange
		callbacks.removeScripts id:#BsBTUpdateLayers
		fnSetBsBTConfig()
	)

	on rolBsBipedTools mbuttondown pos do 
	(
		try (destroydialog rolBsBipedTools) catch ()
	)
	
	on rolBsBipedTools lbuttondown posMou do
	(
		setSysCur #move
		posBsBipedTools = posMou
		dragBsBipedTools = on
	)
	
	on rolBsBipedTools lbuttonup posMou do
	(
		dragBsBipedTools = off
		iniBsBTPos = (GetDialogPos rolBsBipedTools)
		fnSetBsBTConfig()
	)
	
	on rolBsBipedTools mouseMove pos do
	(
		if dragBsBipedTools == on then
		(
			SetDialogPos rolBsBipedTools (mouse.screenpos - posBsBipedTools)
		)
	)

	on btnClose pressed do 
	(
		try (destroydialog rolBsBipedTools) catch ()
	)

	on btnMini pressed do 
	(
		if rolBsBipedTools.height == 458 then rolBsBipedTools.height = 585
		else rolBsBipedTools.height = 458
	)

	on ddlAllBipedCom selected sel do
	(
		try
		(
			select arrAllBipedCom[sel]
			InitLocalVars()
		)
		catch()
	)

	on uiBtnDeleteKey rightclick do
	(
		uiBtnDeleteKey.state = on 
		allBipedRootNode = fnGetAllSelRootNode()
		-- print allBipedRootNode
		for i in allBipedRootNode where isvalidnode i do 
		(
			if (queryBox ("æ˜¯å¦æ¸…é™¤ " + i.name + " éª¨æ¶çš„æ‰€æœ‰å¸§?                        ") title:"BsBipedTools") do
			(
				biped.clearAllAnimation i.controller
			)
		)
	)

	on uiBtnDeleteKey changed state do
	(
		uiBtnDeleteKey.state = on
		undo on (	
			for b in selection as array where iskindof b.baseObject Biped_Object do
			(
				deselectKeys b.controller
				selectKeys b.controller sliderTime
				if ( classof b.controller == Vertical_Horizontal_Turn ) then
				(
					local arrComSelType = fnGetComTrackSelection b
					ctrlTurn = (fnBipedComlocalization b.controller)
					if arrComSelType[1] == 1 then
					(
						deleteKeys b.controller.horizontal.controller.keys #selection
					)
					if arrComSelType[2] == 1 then
					(
						deleteKeys b.controller.vertical.controller.keys #selection
					)
					if arrComSelType[3] == 1 then
					(
						deleteKeys ctrlTurn.keys #selection
					)
				)
				else
				(
					deleteKeys b.controller.keys #selection
				)
			)
		)
	)

	on uiToggleMotionPanel changed state do
	(
		uiToggleMotionPanel.state = on 
		try
		(
			suspendEditing which:#motion
			uiToggleMotionPanel.highlightColor = green
		)
		catch()
		-- messagebox "å·²ç¦ç”¨Motioné¢æ¿,èƒ½å¤§å¤§é™ä½é€‰æ‹©å¡é¡¿,\r\n\r\nå¦‚éœ€æ¢å¤è¯·å³å‡»,ç¦ç”¨äº†å‡ æ¬¡å³å‡»å‡ æ¬¡æ¢å¤!                         " title:"BsBipedTools"
	)

	on uiToggleMotionPanel rightclick do
	(
		uiToggleMotionPanel.state = on 
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
		try
		(
			resumeEditing which:#motion
			uiToggleMotionPanel.highlightColor = mcMotionPanel
		)
		catch()
		-- messagebox "å·²æ¢å¤Motioné¢æ¿,\r\n\r\nå¦‚éœ€ç¦ç”¨è¯·å·¦å‡»!                        " title:"BsBipedTools"
	)

	on uiCkbZen changed state do
	( 
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiCkbZen.state = on
		stateExpertMode = cui.getexpertmode()
		if stateExpertMode then 
		(
			cui.expertModeOff()
		)
		else
		(
			cui.expertModeOn()
		)
	)

	on uiCkbShowBox changed state do
	( 
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiCkbShowBox.state = on
		try(
			for o in m_AllBip where (o.isHidden == false) and (not isDeleted o) do 
			(
				if o.boxmode == off then o.boxmode = on 
				else o.boxmode = off
			)
		)
		catch(messageBox "éª¨éª¼å¯èƒ½æœ‰å˜åŠ¨ï¼Œè¯·å…ˆç‚¹å‡» All Biped åˆ·æ–°éª¨éª¼!         " title:"BsBipedTools")
	)

	on uiCkbShowBox rightclick do
	( 
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiCkbShowBox.state = on
		try(
			for o in m_AllBip where (o.isHidden == false) and (not isDeleted o) do 
			(
				o.boxmode = on
			)
		)
		catch(messageBox "éª¨éª¼å¯èƒ½æœ‰å˜åŠ¨ï¼Œè¯·å…ˆç‚¹å‡» All Biped åˆ·æ–°éª¨éª¼!         " title:"BsBipedTools")
	)

	on uiCkbXray changed state do
	( 
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiCkbXray.state = on
		try(
			for o in m_AllBip where (o.isHidden == false) and (not isDeleted o) do 
			(
				if o.xray == off then o.xray = on 
				else o.xray = off
			)
		)
		catch(messageBox "éª¨éª¼å¯èƒ½æœ‰å˜åŠ¨ï¼Œè¯·å…ˆç‚¹å‡» All Biped åˆ·æ–°éª¨éª¼!         " title:"BsBipedTools")
	)

	on uiCkbXray rightclick do
	( 
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiCkbXray.state = on
		try(
			for o in m_AllBip where (o.isHidden == false) and (not isDeleted o) do 
			(
				o.xray = on
			)
		)
		catch(messageBox "éª¨éª¼å¯èƒ½æœ‰å˜åŠ¨ï¼Œè¯·å…ˆç‚¹å‡» All Biped åˆ·æ–°éª¨éª¼!         " title:"BsBipedTools")
	)
	
	on uiCkbHideBip changed state do
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiCkbHideBip.state = on 
		try(
			for o in m_AllBip where (not isDeleted o) do 
			(
				if o.isHidden == off then o.isHidden = on 
				else o.isHidden = off
			)
			-- m_workingBipRoot.controller.displayFootsteps = false
			hide $*Footsteps
		)
		catch(messageBox "éª¨éª¼å¯èƒ½æœ‰å˜åŠ¨ï¼Œè¯·å…ˆç‚¹å‡» All Biped åˆ·æ–°éª¨éª¼!         " title:"BsBipedTools")
	)

	on uiCkbHideBip rightclick do
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiCkbHideBip.state = on 
		try(
			for o in m_AllBip where (not isDeleted o) do 
			(
				o.isHidden = on
			)
			-- m_workingBipRoot.controller.displayFootsteps = false
			hide $*Footsteps
		)
		catch(messageBox "éª¨éª¼å¯èƒ½æœ‰å˜åŠ¨ï¼Œè¯·å…ˆç‚¹å‡» All Biped åˆ·æ–°éª¨éª¼!         " title:"BsBipedTools")
	)

	on uiBtnFrameTick pressed do 
	(
		if timeDisplayMode != #frameTicks then 
		(
			timeDisplayMode = #frameTicks
		)
		else 
		(
			timeDisplayMode = #frames
		)
		disableSceneRedraw()
		trackbar.visible = false
		trackbar.visible = true
		enableSceneRedraw()
	)

	on uiBtnTraj changed state do 
	(
		uiBtnTraj.state = on 
		try
		(
			allBipedRootNode = fnGetAllSelRootNode()
			for i in allBipedRootNode where isvalidnode i do 
			(
				if i.controller.displaytrajectories then
				(
					i.controller.displaytrajectories = false
				)
				else
				(
					setCommandPanelTaskMode #motion
					i.controller.displaytrajectories = true
				)
			)
		)catch()
	)

	on uiCkbClearUserDef changed state do 
	(
		uiCkbClearUserDef.state = on
		allBipedRootNode = fnGetAllSelRootNode()
		print allBipedRootNode
		for i in allBipedRootNode where isvalidnode i do 
		(
			if (queryBox ("æ˜¯å¦æ¸…é™¤ " + i.name + " éª¨æ¶ä¿å­˜çš„å¾ªç¯å¸§è‡ªå®šä¹‰å±æ€§å€¼?\r\n\r\nï¼ˆå¯¹æ–‡ä»¶æœ¬èº«æ— ä»»ä½•å½±å“ï¼‰                                               ")) do
			(
				try 
				(
					fnDeleteUserProp i "BsBT_RangeLoopStart"
					fnDeleteUserProp i "BsBT_RangeLoopEnd"
					fnDeleteUserProp i "BsBT_Goto1"
					fnDeleteUserProp i "BsBT_Goto2"
					fnDeleteUserProp i "BsBT_Goto3"
					fnDeleteUserProp i "BsBT_Goto4"
					fnDeleteUserProp i "BsBT_Goto5"
					fnDeleteUserProp i "BsBT_Goto6"
					fnDeleteUserProp i "BsBT_Goto7"
					fnDeleteUserProp i "BsBT_Goto8"
					btnKey1.text = btnKey2.text = btnKey3.text = btnKey4.text = btnKey5.text = btnKey6.text = btnKey7.text = btnKey8.text = "Key"
					m_goto1 = m_goto2 = m_goto3 = m_goto4 = m_goto5 = m_goto6 = m_goto7 = m_goto8 = undefined
				)
				catch()
			)
		)
	)

	on uiWorkbench pressed do 
	(
		BipWorkBench.Open()
	)

	on uiFigureMode changed state do
	(
		arrBipCom = fnGetAllSelRootNode()
		for i in arrBipCom where arrBipCom.count != 0 do
		(
			if biped.getCurrentLayer i.controller == 0 then i.controller.figureMode = state
			else 
			(
				uiFigureMode.state = false
				messageBox "å½“å‰ä¸å¤„äº Original Layerï¼Œæ— æ³•æ‰“å¼€å½¢ä½“æ¨¡å¼ï¼                                " title:"BsBipedTools"
			)
		)
	)

	on uiBtnInPlace changed state do
	(
		uiBtnInPlace.images = #("bip_general_i.bmp","bip_general_i.bmp",30,27,27,27,27,true,true)
		arrBipCom = fnGetAllSelRootNode()
		for i in arrBipCom where isvalidnode i do
		(
			if i.controller.figureMode == false then i.controller.inPlaceYMode  = state
			else 
			(
				uiBtnInPlace.state = false
				messagebox (i.name + "  ä¸èƒ½åœ¨ä½“å½¢æ¨¡å¼ä¸­æ‰“å¼€åŸåœ°æ¨¡å¼ã€‚                              ")  title:"BsBipedTools"
			)
		)
	)
	on uiBtnInPlace rightclick do
	(
		uiBtnInPlace.images = #("bip_general_i.bmp","bip_general_i.bmp",30,23,23,23,23,true,true)
		uiBtnInPlace.state  = not uiBtnInPlace.state
		arrBipCom = fnGetAllSelRootNode()
		for i in arrBipCom where isvalidnode i do
		(
			if i.controller.figureMode == false then i.controller.inPlaceMode  = uiBtnInPlace.state
			else 
			(
				uiBtnInPlace.state = false
				messagebox (i.name + "  ä¸èƒ½åœ¨ä½“å½¢æ¨¡å¼ä¸­æ‰“å¼€åŸåœ°æ¨¡å¼ã€‚                              ")  title:"BsBipedTools"
			)
		)
	)

	on uiCbtDown pressed do
	(
		if fnIsValidBiped() then
		(
			fnSyncBipedPanel()
			layerIndex = layerIndex - 1
			if layerIndex >= 0 then
			(
				biped.setCurrentLayer ctrl layerIndex
				uiCbtUp.enabled = true
				uiCbtUp.images = #("bip_layer_i.bmp","bip_layer_i.bmp",24,1,1,1,1,true,true)
				if layerIndex == 0 then
				(
					uiCbtDown.enabled = false
					uiCbtDown.images = #("bip_layer_i.bmp","bip_layer_i.bmp",24,4,4,4,4,true,true)
				)
			)
			else
			(
				layerIndex = 0
			)
		)	
		fnBSUpdateLayers()
	)

	on uiCbtUp pressed do
	(
		if fnIsValidBiped() then
		(
			fnSyncBipedPanel()
			layerIndex = layerIndex + 1
			if layerIndex <= numLayers then
			(
				biped.setCurrentLayer ctrl layerIndex
				uiCbtDown.enabled = true
				uiCbtDown.images = #("bip_layer_i.bmp","bip_layer_i.bmp",24,3,3,3,3,true,true)
				if layerIndex == numLayers then
				(
					uiCbtUp.enabled = false
					uiCbtUp.images = #("bip_layer_i.bmp","bip_layer_i.bmp",24,2,2,2,2,true,true)
				)
			)
			else
			(
				layerIndex = numLayers
				uiCbtUp.enabled = false
				uiCbtUp.images = #("bip_layer_i.bmp","bip_layer_i.bmp",24,2,2,2,2,true,true)
			)
		)
		fnBSUpdateLayers()
	)

	on uiChkActive changed state do
	(
		if fnIsValidBiped() then
		(
			fnSyncBipedPanel()
			if state then
			(
				biped.setLayerActive ctrl layerIndex true
			)
			else
			(
				biped.setLayerActive ctrl layerIndex false
			)
		)
		fnBSUpdateLayers()
	)

	on ddlLayers selected val do
	(
		if fnIsValidBiped() then
		(
			fnSyncBipedPanel()
			local index = val - 1
			if index <= numLayers then
			(
				biped.setCurrentLayer ctrl index
			)
		)
		fnBSUpdateLayers()
	)

	on uiCbtRefreshLayer changed state do
	(
		uiCbtRefreshLayer.state = true
		if fnIsValidBiped() then
		(
			fnBSUpdateLayers()
		)
	)

	on uiCbtLeftArm changed state do
	(
		if fnIsValidBiped() then 
		(
			if m_LHand[1] != undefined then (with undo on (biped.setLimbRetargetState m_LHand[1] state))
		)
	)
	
	on uiCbtRightArm changed state do
	(
		if fnIsValidBiped() then 
		(
			if m_RHand[1] != undefined then (with undo on (biped.setLimbRetargetState m_RHand[1] state))
		)
	)
	
	on uiCbtLeftLeg changed state do
	(
		if fnIsValidBiped() then 
		(
			if m_LFoot[1] != undefined then (with undo on (biped.setLimbRetargetState m_LFoot[1] state))
		)
	)
	
	on uiCbtRightLeg changed state do
	(
		if fnIsValidBiped() then 
		(
			if m_RFoot[1] != undefined then (with undo on (biped.setLimbRetargetState m_RFoot[1] state))
		)
	)
		
	on uiCbtUpdate pressed do
	(
		if fnIsValidBiped() then
		(
			with undo on (biped.retargetToBaseLayer ctrl uiChkIKonly.state)
			redrawViews()
		)
	)

	on uiCbtGrabPose changed state do
	(
		uiCbtGrabPose.state = true
		if isValidNode m_workingBipRoot AND NOT isDeleted m_workingBipRoot then
		(
			local bRootCtrl = m_workingBipRoot.controller
			biped.createCopyCollection bRootCtrl "PoseGrabber"
			local colIndex = biped.numCopyCollections bRootCtrl
			local copyCol = biped.getCopyCollection bRootCtrl colIndex
			biped.copyBipPose bRootCtrl copyCol #snapAuto
			local grabbeBH_pose = getCopy copyCol #pose 1
			biped.saveCopyPasteFile bRootCtrl (getDir #plugcfg + "\BsBipedTools_PoseGrabbed.cpy")
			biped.deleteCopyCollection bRootCtrl colIndex
		)
		else
		(
			fnMsgMissingBiped()			
		)	
	)
	
	on uiCbtLoadPose changed state do
	(
		uiCbtLoadPose.state = true
		if isValidNode m_workingBipRoot AND NOT isDeleted m_workingBipRoot then
		(
			local poseFile = getDir #plugcfg + "\BsBipedTools_PoseGrabbed.cpy"
			if doesFileExist poseFile then
			(
				local bRootCtrl = m_workingBipRoot.controller
				biped.loadCopyPasteFile bRootCtrl poseFile
				local colIndex = biped.numCopyCollections bRootCtrl
				local copyCol = biped.getCopyCollection bRootCtrl colIndex
				local grabbeBH_pose = getCopy copyCol #pose 1
				with Animate on
				(
					--// Requires two paste operations to work properly (Biped oddness)
					biped.pasteBipPose bRootCtrl grabbeBH_pose false #pstdefault true true true false
					biped.pasteBipPose bRootCtrl grabbeBH_pose false #pstdefault true true true false
				)
				local colIndex = biped.numCopyCollections bRootCtrl
				biped.deleteCopyCollection bRootCtrl colIndex
			)
			else
			(
				messageBox "é”™è¯¯: ä¸´æ—¶ Pose æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆæš‚å­˜Poseï¼                              " title:"BsBipedTools"
			)
		)
		else
		(
			fnMsgMissingBiped()			
		)	
	)

	on uiPivot changed state do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiPivot.state = true

		try(destroyDialog rolBSLeftHandPivots)catch()
		try(destroyDialog rolBSRightHandPivots)catch()
		try(destroyDialog rolBSLeftFootPivots)catch()
		try(destroyDialog rolBSRightFootPivots)catch()

		case of 
		(
			(selection[1] == m_LHand[1]):(Createdialog rolBSLeftHandPivots pos:(mouse.screenPos + [40,-50]) parent:rolBsBipedTools.hwnd fgcolor:(if fnGetThemeColor() == "Light" then (color 28 89 177) else (color 165 222 228)) style:#(#style_titlebar, #style_sysmenu, #style_toolwindow))
			(selection[1] == m_RHand[1]):(Createdialog rolBSRightHandPivots pos:(mouse.screenPos + [40,-50]) parent:rolBsBipedTools.hwnd fgcolor:(if fnGetThemeColor() == "Light" then (color 28 89 177) else (color 165 222 228)) style:#(#style_titlebar, #style_sysmenu, #style_toolwindow))
			(selection[1] == m_LFoot[1]):(Createdialog rolBSLeftFootPivots pos:(mouse.screenPos + [40,-50]) parent:rolBsBipedTools.hwnd fgcolor:(if fnGetThemeColor() == "Light" then (color 28 89 177) else (color 165 222 228)) style:#(#style_titlebar, #style_sysmenu, #style_toolwindow))
			(selection[1] == m_RFoot[1]):(Createdialog rolBSRightFootPivots pos:(mouse.screenPos + [40,-50]) parent:rolBsBipedTools.hwnd fgcolor:(if fnGetThemeColor() == "Light" then (color 28 89 177) else (color 165 222 228)) style:#(#style_titlebar, #style_sysmenu, #style_toolwindow))
			default:(messageBox "è¯·å…ˆé€‰æ‹©æ‰‹æˆ–è„šä»»æ„ä¸€æ ¹éª¨éª¼ï¼Œå¹¶ä¸”è®¾ç½®æ»‘åŠ¨å¸§æˆ–å›ºå®šå¸§!                            " title:"BsBipedTools")
		)
	)

	on uiFingers changed state do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiFingers.state = true

		try(destroyDialog rolBSFingers)catch()

		Createdialog rolBSFingers pos:(mouse.screenPos - [310,100]) parent:rolBsBipedTools.hwnd style:#(#style_titlebar, #style_sysmenu, #style_toolwindow)
	)

	on uiBtnLoadBip changed state do
	(
		uiBtnLoadBip.state = true
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ((messageBox "è¯·å…ˆç¡®è®¤å­˜åœ¨Bipedéª¨éª¼!                            " title:"BsBipedTools");return ())
		biped.loadBipFileDlg m_workingBipRoot.controller
	)

	on uiBtnSaveBip changed state do
	(
		uiBtnSaveBip.state = true
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ((messageBox "è¯·å…ˆç¡®è®¤å­˜åœ¨Bipedéª¨éª¼!                            " title:"BsBipedTools");return ())
		biped.saveBipFileDlg m_workingBipRoot.controller
	)

	on uiCbtAddLayer pressed do
	(
		with undo on
		(
			if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
			fnBSUpdateLayers()
			ctrlCom = m_workingBipRoot.controller
			numCurLayer = biped.getCurrentLayer ctrlCom
			countAllLayers = biped.numLayers ctrlCom
			numNewLayerIndex = numCurLayer + 1
			numNewLayerName = (countAllLayers + 1) as string
			biped.createLayer ctrlCom numNewLayerIndex ("Layer " + numNewLayerName )
		)
		fnBSUpdateLayers()
	)

	on uiCbtDelLayer pressed do
	(
		with undo on
		(
			if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
			fnBSUpdateLayers()
			ctrlCom = m_workingBipRoot.controller
			numCurLayer = biped.getCurrentLayer ctrlCom
			biped.deleteLayer ctrlCom numCurLayer
		)
		fnBSUpdateLayers()
	)

	on uiCbtDownLayer pressed do
	(
		with undo on
		(
			if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
			fnBSUpdateLayers()
			ctrlCom = m_workingBipRoot.controller
			numCurLayer = biped.getCurrentLayer ctrlCom
			biped.collapseAtLayer ctrlCom (numCurLayer - 1)
		)
		fnBSUpdateLayers()
	)

	on uiCbtSnapKeys pressed do
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
		fnBSUpdateLayers()
		ctrlCom = m_workingBipRoot.controller
		for obj in selection as array where not isDeleted obj and classof obj.baseobject == Biped_Object do 
		(
			if (classof obj.controller == Vertical_Horizontal_Turn) then
			(
				numCurLayer = biped.getCurrentLayer ctrlCom
				biped.setCurrentLayer ctrlCom (numCurLayer - 1)
				tranPos = biped.getTransform obj #pos
				tranRot = biped.getTransform obj #rotation
				biped.setCurrentLayer ctrlCom numCurLayer
				biped.setTransform obj #pos tranPos true
				biped.setTransform obj #rotation tranRot true
			)
			else
			(
				biped.setSnapKey obj
			)
		)
	)

	on uiCbtSnapKeys rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
		fnBSUpdateLayers()
		ctrlCom = m_workingBipRoot.controller
		numCurLayer = biped.getCurrentLayer ctrlCom
		for obj in selection as array where not isDeleted obj and classof obj.baseobject == Biped_Object do 
		(
			local arrAllBipedKeys = #()
			biped.setCurrentLayer ctrlCom (numCurLayer - 1)
			if (classof obj.controller == Vertical_Horizontal_Turn) then
			(
				arrKeyVer = for i in obj.controller.vertical.controller.keys collect i.time
				arrKeyHor = for i in obj.controller.horizontal.controller.keys collect i.time
				arrKeyTurn = for i in (fnBipedComlocalization obj.controller).keys collect i.time
				arrAllBipedKeys = arrKeyVer + arrKeyHor + arrKeyTurn
				arrAllBipedKeys = makeUniqueArray arrAllBipedKeys
				sort arrAllBipedKeys
				for t in arrAllBipedKeys where arrAllBipedKeys.count != 0 do 
				(
					-- at time t with animate on 
					slidertime = t
					with animate on
					(
						biped.createCopyCollection obj.controller "tempBipedComKeys"
						copycol= biped.getcopycollection obj.controller (biped.numCopyCollections obj.controller)
						icpmxbipcopy = biped.copybippose obj.controller copycol #snapview
						biped.setCurrentLayer ctrlCom numCurLayer
						biped.pastebippose obj.controller icpmxbipcopy false #pstdefault false true false false
						biped.deleteCopyCollection obj.controller (biped.numCopyCollections obj.controller)
					)
				)
			)
			else 
			(
				arrAllBipedKeys = for i in obj.controller.keys collect i.time
				biped.setCurrentLayer ctrlCom numCurLayer
				for t in arrAllBipedKeys where arrAllBipedKeys.count != 0 do 
				(
					at time t with animate on 
					(
						try (biped.addNewKey obj.controller t) catch ()
					)
				)
			)
		)
	)
	on uiCbtHorTrack changed state do 
	(
		-- fnSetComTrackSelection m_workingBipRoot
		uiCbtHorTrack.state = true
		uiCbtVerTrack.state = uiCbtTurnTrack.state = false
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
		m_workingBipRoot.controller.trackSelection = 1
		select m_workingBipRoot
	)
	on uiCbtVerTrack changed state do 
	(
		-- fnSetComTrackSelection m_workingBipRoot
		uiCbtVerTrack.state = true
		uiCbtHorTrack.state = uiCbtTurnTrack.state = false
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
		m_workingBipRoot.controller.trackSelection = 2
		select m_workingBipRoot
	)
	on uiCbtTurnTrack changed state do 
	(
		-- fnSetComTrackSelection m_workingBipRoot
		-- if not state then fnLockComTrack m_workingBipRoot
		uiCbtTurnTrack.state = true
		uiCbtVerTrack.state = uiCbtHorTrack.state = false
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
		m_workingBipRoot.controller.trackSelection = 3
		select m_workingBipRoot
	)

	on uiBtnComLock pressed do  -- éçŠ¶æ€æ˜¾ç¤º,åªæ˜¯åˆ‡æ¢æŒ‰é’®,å› ä¸ºæ²¡æ‰¾åˆ°API,å¹²è„†å…¨é”åˆ‡æ¢
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
		fnLockComTrack m_workingBipRoot
		fnRefreshTrackSelection m_workingBipRoot
	)

	on uiBtn0 changed state do
	(
		uiBtn0.state = true
		fnEvaluateTCB 0.0
	)
	on uiBtn25 changed state do
	(
		uiBtn25.state = true
		fnEvaluateTCB 25.0
	)

	on btnKey1 pressed do (GotoFrame btnKey1 &m_goto1 1)
	on btnKey2 pressed do (GotoFrame btnKey2 &m_goto2 2)
	on btnKey3 pressed do (GotoFrame btnKey3 &m_goto3 3)
	on btnKey4 pressed do (GotoFrame btnKey4 &m_goto4 4)
	on btnKey5 pressed do (GotoFrame btnKey5 &m_goto5 5)
	on btnKey6 pressed do (GotoFrame btnKey6 &m_goto6 6)
	on btnKey7 pressed do (GotoFrame btnKey7 &m_goto7 7)
	on btnKey8 pressed do (GotoFrame btnKey8 &m_goto8 8)

	on btnKey1 rightclick do (GotoFrame btnKey1 &m_goto1 1 setKey:true)
	on btnKey2 rightclick do (GotoFrame btnKey2 &m_goto2 2 setKey:true)
	on btnKey3 rightclick do (GotoFrame btnKey3 &m_goto3 3 setKey:true)
	on btnKey4 rightclick do (GotoFrame btnKey4 &m_goto4 4 setKey:true)
	on btnKey5 rightclick do (GotoFrame btnKey5 &m_goto5 5 setKey:true)
	on btnKey6 rightclick do (GotoFrame btnKey6 &m_goto6 6 setKey:true)
	on btnKey7 rightclick do (GotoFrame btnKey7 &m_goto7 7 setKey:true)
	on btnKey8 rightclick do (GotoFrame btnKey8 &m_goto8 8 setKey:true)
	
--///////////////////////////////////////////////////////////	
on btnAddScale pressed do
    (
        if (selection.count != 0) then
        (
            --.transform.controller.Biped_SubAnim.controller.BipScaleList.controller.Available.controller = ScaleXYZ ()
            for i in selection do
            (
                if (classOf i ==Biped_Object) and (i.transform.controller[1].name != "Vertical") do --è´¨å¿ƒä¸ä½œç¼©æ”¾
                (
                    undo "bipedscale" on
                    (try
                        (
                        bip_ed = i.transform.controller.rootnode
                        bip_ed.transform.controller.enableSubAnims = true
                        i.transform.controller[1][1][1].controller = ScaleXYZ ()
                        )catch()
                    )
                )
            )
        )
        else
        (
            messagebox "è¯·é€‰æ‹©ä¸€æ ¹æˆ–å¤šæ ¹ Biped éª¨éª¼!\n\r" beep:true title:"é€‰æ‹©æœ‰è¯¯ï¼"
        )
    )

    on btnRemoveScale pressed do
    (
        if (selection.count != 0) then
        (
            for i in selection do
            (
                if (classOf i ==Biped_Object) and (i.transform.controller[1].name != "Vertical") do --è´¨å¿ƒä¸ä½œç¼©æ”¾
                (
                    undo "bipedscale_key" on --åˆ é™¤ç¼©æ”¾å¸§ ï¼Œ
                    (
                        --deletekeys i.transform.controller[1][1][1].controller.keys #allKeys
                        lstctr = i.transform.controller[1][1]
                        try (lstctr.delete 1)catch()
                    )
                )
            )
        )
        else
        (
            messagebox "è¯·é€‰æ‹©ä¸€æ ¹æˆ–å¤šæ ¹ Biped éª¨éª¼!\n\r" beep:true title:"é€‰æ‹©æœ‰è¯¯ï¼"
        )
    )

	on ckbBendLink changed state do
	(
		local ctrl = m_workingBipRoot.controller
		if state then 
		(
			fnSetTwistLink ctrl 1
		)
		else ctrl.bendLinksMode = false
	)

	on ckbTwistLink changed state do
	(
		local ctrl = m_workingBipRoot.controller
		if state then 
		(
			fnSetTwistLink ctrl 2
		)
		else ctrl.twistLinksMode = false
	)

	on ckbTwistIndiv changed state do
	(
		local ctrl = m_workingBipRoot.controller
		if state then 
		(
			fnSetTwistLink ctrl 3
		)
		else ctrl.twistIndMode = false
	)

	on ckbSmoothTwist changed state do
	(
		local ctrl = m_workingBipRoot.controller
		if state then 
		(
			fnSetTwistLink ctrl 4
		)
		else ctrl.SmoothTwistMode = false
	)

	on btnZeroTwist pressed do
	(
		if selection.count == 1 and classOf selection[1] == Biped_Object then (with undo on (biped.zeroTwist selection[1]))
		fnRefreshTwistState()
	)
	
	on btnZeroAllLink pressed do
	(
		if selection.count == 1 and classOf selection[1] == Biped_Object then (with undo on (biped.zeroAll selection[1]))
		fnRefreshTwistState()
	)
	
--////////////////////////////////////////////////////////		
	
	
)
if (iniBsBTPos != 0) then 
(Createdialog rolBsBipedTools pos:iniBsBTPos style:#() fgcolor:(if fnGetThemeColor() == "Light" then (color 28 89 177) else (color 165 222 228)))
else (Createdialog rolBsBipedTools style:#() fgcolor:(if fnGetThemeColor() == "Light" then (color 28 89 177) else (color 165 222 228)))
clearListener()