/**************************************************************************************************************************
-- By Bullet.S Ëá™Áî®‰øÆÊîπÁâà,ÂäüËÉΩÂ§ßÈõÜÂêà,ÂÆåÂÖ®ÂºÄÊ∫êÂÖçË¥π‰ªÖ‰æõÂ≠¶‰π†‰ΩøÁî®,ËØ∑ÂãøÁî®‰∫éÂïÜ‰∏öÁî®ÈÄî,Âê¶ÂàôÂêéÊûúËá™Ë¥ü    
ReferenceÔºö SoxBipedAssist_v0.423 & Biped Helper v3.1  
Since 2023.03

2025.12 v1.7
1.Â§¥ÈÉ®ÊåâÈíÆÂè≥ÈîÆÂàáÊç¢È¢úÊñáÂ≠óËÑ∏Ë°®ÊÉÖ
2.Ë°®ÊÉÖÈÄâÊã©Ëá™Âä®‰øùÂ≠òÂà∞ÈÖçÁΩÆÊñá‰ª∂
3.Ê∑ªÂä†Ë°®ÊÉÖËøòÂéüÊåâÈíÆ

2025.05 v1.6
1.Âà†Èô§bipedÂ∏ßÊ∑ªÂä†ÂõûÈÄÄ
2.Ê∑ªÂä†CSÁº©Êîæ(ÊÑüË∞¢ÈúçÈúçÂ∞èÁå´Âª∫ËÆÆ)

2025.03 update v1.5
1.ÈáçÊñ∞ÊîπÂõûÂ§çÂà∂poseÁöÑÈÄâÊã©Ë¢´Â§çÂà∂bipedÈ™®È™ºÂäüËÉΩÔºåÂéªÊéâÊ∏ÖÈô§postureÁöÑÊåâÈíÆ

2024.04 update v1.4
1. ‰øÆÂ§çÂ§çÂà∂poseÂíåÂä†Â±ÇÂäüËÉΩÂõûÈÄÄÂØºËá¥ÁöÑÈó™ÈÄÄ
2„ÄÇÁ®çÂæÆÊãìÂ±ïÊâãÊåáÈÄâÊã©ÂäüËÉΩ
3„ÄÇIKÂ∏ßÂàáÊç¢Èù¢ÊùøÂäüËÉΩ‰ºòÂåñÔºå‰ºö‰øùÊåÅ‰πãÂâçÈù¢Êùø
**************************************************************************************************************************/

global rolBsBipedTools
global posBsBipedTools
global dragBsBipedTools = false
global arrAllBipedCom
global iniBsBipedTools = execute ("@\"" + (getDir #maxData) + "\\BsBipedToolsConfig.ini\"")  --ÈÖçÁΩÆÊñá‰ª∂Ë∑ØÂæÑ
global iniBsBTPos
global rolBsAboutPanel
global offsetBsAboutPanel = [0,0]
global stateBsAboutPanel = 0
global dotLinkLabel1
global dotLinkLabel2
global verBsBipedTools = "v1.7"

try(destroydialog rolBsBipedTools) catch()
try(destroyDialog rolBSLeftHandPivots)catch()
try(destroyDialog rolBSRightHandPivots)catch()
try(destroyDialog rolBSLeftFootPivots)catch()
try(destroyDialog rolBSRightFootPivots)catch()
try(destroyDialog rolBsBipToolsHelp)catch()

rollout rolBsBipToolsHelp ("BsBipTools" + verBsBipedTools + " ‰ΩøÁî®ÊåáÂçó") width:420 height:480
(
	local strHelpText = ("üéØ BsBipedTools ‰ΩøÁî®ÊåáÂçó" + "\r\n" + \
	"==============================" + "\r\n\r\n" + \
	"‚ö° „ÄêÁâπÂà´ÂäüËÉΩ„Äë" + "\r\n" + \
	"‚Ä¢ MotionÈù¢ÊùøÂºÄÂÖ≥ (MÊåâÈíÆ)ÔºöÂ∑¶ÈîÆÁ¶ÅÁî®ÂáèÂ∞ëÂç°È°øÔºåÂè≥ÈîÆÊÅ¢Â§ç" + "\r\n" + \
	"‚Ä¢ Á¶ÖÊ®°Âºè/XRay/BoxÔºöÂø´ÈÄüÂàáÊç¢ËßÜÁ™óÊòæÁ§∫Ê®°Âºè" + "\r\n" + \
	"‚Ä¢ Â§¥ÈÉ®Ë°®ÊÉÖÔºöÂè≥ÈîÆÁÇπÂáªÂ§¥ÈÉ®ÊåâÈíÆÂàáÊç¢È¢úÊñáÂ≠óËÑ∏ÔºåÂè≥‰∏äËßíËøòÂéü" + "\r\n" + \
	"‚Ä¢ ÊâãÊåáÂºØÊõ≤ÔºöÂú®ÊâãÊåáÈù¢Êùø‰∏≠‰ΩøÁî®BendÊéß‰ª∂Ë∞ÉËäÇÊâãÊåáÂºØÊõ≤" + "\r\n\r\n" + \
	"üéØ „ÄêÈ™®È™ºÈÄâÊã©Êìç‰Ωú„Äë" + "\r\n" + \
	"‚Ä¢ Â∑¶ÈîÆÂçïÂáªÔºöÁõ¥Êé•ÈÄâÂèñ  |  Âè≥ÈîÆÂçïÂáªÔºöÈÄâÊã©ÈïúÂÉèÈ™®È™º" + "\r\n" + \
	"‚Ä¢ Ctrl + Â∑¶ÂáªÔºöÂä†ÈÄâ  |  Alt + Â∑¶ÂáªÔºöÂáèÈÄâ" + "\r\n" + \
	"‚Ä¢ Shift + Â∑¶ÂáªÔºöÈÄâÊã©È™®È™ºÂèäÂÖ∂ÊâÄÊúâÂ≠êÁ∫ß" + "\r\n" + \
	"‚Ä¢ Ctrl + Alt + Â∑¶ÂáªÔºöÈ™®È™ºÊóãËΩ¨ÂΩíÈõ∂" + "\r\n\r\n" + \
	"üõ†Ô∏è „ÄêËæÖÂä©Â∑•ÂÖ∑„Äë" + "\r\n" + \
	"‚Ä¢ Copy Paste ToolsÔºöÂßøÊÄÅÂ§çÂà∂Á≤òË¥¥ÂíåÈïúÂÉè" + "\r\n" + \
	"‚Ä¢ Layer ToolsÔºöBipedÂ±ÇÁ∫ßÁÆ°ÁêÜ" + "\r\n" + \
	"‚Ä¢ Loop Key ToolsÔºöÂæ™ÁéØÂÖ≥ÈîÆÂ∏ßÂ∑•ÂÖ∑" + "\r\n" + \
	"‚Ä¢ Others ToolsÔºöÂÖ∂‰ªñÂÆûÁî®ÂäüËÉΩÈõÜÂêà" + "\r\n\r\n" + \
	"üí° „Äê‰ΩøÁî®ÊèêÁ§∫„Äë" + "\r\n" + \
	"Â∏ßÁõ∏ÂÖ≥ÊåâÈíÆÊúâ‰∏∞ÂØåÁöÑÁªÑÂêàÈîÆÂäüËÉΩÔºåËØ∑Êü•ÁúãÊÇ¨ÂÅúÊèêÁ§∫" + "\r\n" + \
	"Â∑¶Âáª / Âè≥Âáª / Ctrl / Shift ÈÉΩÊúâ‰∏çÂêå‰æøÊç∑ÂäüËÉΩ" + "\r\n\r\n" + \
	"==============================" + "\r\n" + \
	"ÂáèÂ∞ëÂç°È°øÔºå‰æøÊç∑KÂ∏ß | ‰ΩúËÄÖÔºöBullet.S" + "\r\n\r\n")

	label lblHelp strHelpText width:400 height:400 pos:[10,10]
	-- ÈìæÊé•Âå∫Âüü
	groupBox grpLinks "Áõ∏ÂÖ≥ÈìæÊé•" pos:[10,420] width:400 height:50
	label lblAuthor "‰ΩúËÄÖÔºö" pos:[20,440] width:40 height:15
	hyperLink hplHome "Bullet.S" address:"https://www.anibullet.com/" pos:[60,440] width:60 height:15
	hyperLink hplHelpDocs "Â∏ÆÂä©ÊñáÊ°£" address:"https://anibullet.github.io/" pos:[130,440] width:60 height:15
	label lblRef "ÂèÇËÄÉÔºö" pos:[200,440] width:40 height:15
	hyperLink hplSox "SoxBipedAssist" address:"http://cafe.naver.com/pinksox/6131" pos:[240,440] width:80 height:15
	hyperLink hplBH "BipedHelper" address:"https://sites.google.com/view/lbtools-guide/home/biped-helper" pos:[330,440] width:70 height:15
)

fn f_getPivotIndex ctrl =
(
	if ctrl.keys.count > 0 then
	(
		local keyIndex = getKeyIndex ctrl slidertime
		if keyIndex > 0 then
		(
			local key = biped.getKey ctrl keyIndex
			if key.ikSpace > 0 then
			(
				return (biped.getKey ctrl keyIndex).ikPivotIndex
			)
		)
	)
	return 0	
)

fn f_changePivot ctrl index =
(
	if ctrl.keys.count > 0 then
	(
		local keyIndex = getKeyIndex ctrl slidertime
		if keyIndex > 0 then
		(
			local key = biped.getKey ctrl keyIndex
			if key.ikSpace > 0 then
			(
				key.ikPivotIndex = index
				return true
			)
			else
			(
				messagebox "ÈîôËØØÔºöÂøÖÈ°ªÊòØÂõ∫ÂÆöÂ∏ßÊàñÊªëÂä®Â∏ß„ÄÇ                       " title:"ÈÄâÊã© Pivots"
			)
		)
		else
		(
			messagebox "ÈîôËØØÔºöÂΩìÂâçÊó∂Èó¥ÊªëÂùóÊ≤°ÊúâÂ∏ß„ÄÇ                        " title:"ÈÄâÊã© Pivots"
		)
	)
	else
	(
		messagebox "ÈîôËØØÔºöÊâæ‰∏çÂà∞Â∏ß„ÄÇ\r\nËÆæÁΩÆ‰∏Ä‰∏™Âõ∫ÂÆöÂ∏ßÊàñÊªëÂä®Â∏ß„ÄÇ                             " title:"ÈÄâÊã© Pivots"
	)
	
	return false
)

rollout rolBSLeftHandPivots "L-Hand" width:90
(
	local lrg = 16
	local sml = 12

	checkbutton chkbtn_pinkyTip "" across:4 width:sml height:sml align:#left offset:[-8,0] tooltip:"pinky tip"
	checkbutton chkbtn_ringTip "" width:sml height:sml offset:[-8,0] tooltip:"ring tip"
	checkbutton chkbtn_middleTip "" width:sml height:sml offset:[-8,0] tooltip:"middle tip"
	checkbutton chkbtn_indexTip "" width:sml height:sml offset:[-8,0] tooltip:"index tip"
	
	checkbutton chkbtn_pinky2 "" width:sml height:sml across:4 align:#left offset:[-8,0] tooltip:"pinky 2"
	checkbutton chkbtn_ring2 "" width:sml height:sml offset:[-8,0] tooltip:"ring 2"
	checkbutton chkbtn_middle2 "" width:sml height:sml offset:[-8,0] tooltip:"middle 2"
	checkbutton chkbtn_index2 "" width:sml height:sml offset:[-8,0] tooltip:"index 2"
	
	checkbutton chkbtn_pinky1 "" width:sml height:sml across:4 align:#left offset:[-8,0] tooltip:"pinky 1"
	checkbutton chkbtn_ring1 "" width:sml height:sml offset:[-8,0] tooltip:"ring 1"
	checkbutton chkbtn_middle1 "" width:sml height:sml offset:[-8,0] tooltip:"middle 1"
	checkbutton chkbtn_index1 "" width:sml height:sml offset:[-8,0] tooltip:"index 1"
	
	checkbutton chkbtn_palmFront "" width:lrg height:lrg across:3 align:#left offset:[-8,0] tooltip:"palm front"
	checkbutton chkbtn_palmMiddle "" width:lrg height:lrg offset:[-9,0] tooltip:"palm middle"
	checkbutton chkbtn_palmBack "" width:lrg height:lrg offset:[-8,0] tooltip:"palm back"
	
	checkbutton chkbtn_wristFront "" width:lrg height:lrg across:3 align:#left offset:[-8,0] tooltip:"wrist front"
	checkbutton chkbtn_wristMiddle "" width:lrg height:lrg offset:[-9,0] tooltip:"wrist middle"
	checkbutton chkbtn_wristBack "" width:lrg height:lrg offset:[-8,0] tooltip:"wrist back"
	
	checkbutton chkbtn_wristCenter "" width:lrg height:lrg align:#left offset:[14,0] tooltip:"wrist center"
	
	checkbutton chkbtn_thumbTip "" width:sml height:sml align:#right offset:[7,-92] tooltip:"thumb tip"
	checkbutton chkbtn_thumb2 "" width:sml height:sml align:#right offset:[7,0] tooltip:"thumb 2"
	checkbutton chkbtn_thumb1 "" width:sml height:sml align:#right offset:[7,0] tooltip:"thumb 1"
	
	fn f_uncheckAll =
	(
		chkbtn_wristCenter.checked = false
		chkbtn_wristFront.checked = false
		chkbtn_wristMiddle.checked = false
		chkbtn_wristBack.checked = false
		chkbtn_palmFront.checked = false
		chkbtn_palmMiddle.checked = false
		chkbtn_palmBack.checked = false
		chkbtn_thumb1.checked = false
		chkbtn_thumb2.checked = false
		chkbtn_thumbTip.checked = false
		chkbtn_index1.checked = false
		chkbtn_index2.checked = false
		chkbtn_indexTip.checked = false
		chkbtn_middle1.checked = false
		chkbtn_middle2.checked = false
		chkbtn_middleTip.checked = false
		chkbtn_ring1.checked = false
		chkbtn_ring2.checked = false
		chkbtn_ringTip.checked = false
		chkbtn_pinky1.checked = false
		chkbtn_pinky2.checked = false
		chkbtn_pinkyTip.checked = false
	)
	
	fn f_updateButton state chkbtn index =
	(
		f_uncheckAll();
		if state then
		(
			if (f_changePivot rolBsBipedTools.m_LHand[1].controller index) then
			(
				chkbtn.checked = true
			)
		)
		else
		(
			if (f_getPivotIndex rolBsBipedTools.m_LHand[1].controller) > 0 then
			(
				chkbtn.checked = true
			)
		)
	)
	
	on rolBSLeftHandPivots open do
	(
		case (f_getPivotIndex rolBsBipedTools.m_LHand[1].controller) of
		(
			1: chkbtn_wristCenter.checked = true
			2: chkbtn_wristFront.checked = true
			3: chkbtn_wristMiddle.checked = true
			4: chkbtn_wristBack.checked = true
			5: chkbtn_palmFront.checked = true
			6: chkbtn_palmMiddle.checked = true
			7: chkbtn_palmBack.checked = true
			8: chkbtn_thumb1.checked = true
			9: chkbtn_thumb2.checked = true
			10: chkbtn_thumbTip.checked = true
			11: chkbtn_index1.checked = true
			12: chkbtn_index2.checked = true
			13: chkbtn_indexTip.checked = true
			14: chkbtn_middle1.checked = true
			15: chkbtn_middle2.checked = true
			16: chkbtn_middleTip.checked = true
			17: chkbtn_ring1.checked = true
			18: chkbtn_ring2.checked = true
			19: chkbtn_ringTip.checked = true
			20: chkbtn_pinky1.checked = true
			21: chkbtn_pinky2.checked = true
			22: chkbtn_pinkyTip.checked = true
			default: f_uncheckAll()
		)
	)
	
	on rolBSLeftHandPivots close do
	(
		
	)
	
	on chkbtn_wristCenter changed state do (f_updateButton state chkbtn_wristCenter 1)
	on chkbtn_wristFront changed state do (f_updateButton state chkbtn_wristFront 2)
	on chkbtn_wristMiddle changed state do (f_updateButton state chkbtn_wristMiddle 3)
	on chkbtn_wristBack changed state do (f_updateButton state chkbtn_wristBack 4)
	on chkbtn_palmFront changed state do (f_updateButton state chkbtn_palmFront 5)
	on chkbtn_palmMiddle changed state do (f_updateButton state chkbtn_palmMiddle 6)
	on chkbtn_palmBack changed state do (f_updateButton state chkbtn_palmBack 7)
	on chkbtn_thumb1 changed state do (f_updateButton state chkbtn_thumb1 8)
	on chkbtn_thumb2 changed state do (f_updateButton state chkbtn_thumb2 9)
	on chkbtn_thumbTip changed state do (f_updateButton state chkbtn_thumbTip 10)
	on chkbtn_index1 changed state do (f_updateButton state chkbtn_index1 11)
	on chkbtn_index2 changed state do (f_updateButton state chkbtn_index2 12)
	on chkbtn_indexTip changed state do (f_updateButton state chkbtn_indexTip 13)
	on chkbtn_middle1 changed state do (f_updateButton state chkbtn_middle1 14)
	on chkbtn_middle2 changed state do (f_updateButton state chkbtn_middle2 15)
	on chkbtn_middleTip changed state do (f_updateButton state chkbtn_middleTip 16)
	on chkbtn_ring1 changed state do (f_updateButton state chkbtn_ring1 17)
	on chkbtn_ring2 changed state do (f_updateButton state chkbtn_ring2 18)
	on chkbtn_ringTip changed state do (f_updateButton state chkbtn_ringTip 19)
	on chkbtn_pinky1 changed state do (f_updateButton state chkbtn_pinky1 20)
	on chkbtn_pinky2 changed state do (f_updateButton state chkbtn_pinky2 21)
	on chkbtn_pinkyTip changed state do (f_updateButton state chkbtn_pinkyTip 22)
) --// end rollout

rollout rolBSRightHandPivots "R-Hand" width:90
(
	local lrg = 16
	local sml = 12
	
	checkbutton chkbtn_indexTip "" across:4 width:sml height:sml align:#right offset:[8,0] tooltip:"index tip"
	checkbutton chkbtn_middleTip "" width:sml height:sml offset:[12,0] tooltip:"middle tip"
	checkbutton chkbtn_ringTip "" width:sml height:sml offset:[12,0] tooltip:"ring tip"
	checkbutton chkbtn_pinkyTip "" width:sml height:sml offset:[12,0] tooltip:"pinky tip"

	checkbutton chkbtn_index2 "" width:sml height:sml across:4 align:#right offset:[8,0] tooltip:"index 2"
	checkbutton chkbtn_middle2 "" width:sml height:sml offset:[12,0] tooltip:"middle 2"
	checkbutton chkbtn_ring2 "" width:sml height:sml offset:[12,0] tooltip:"ring 2"
	checkbutton chkbtn_pinky2 "" width:sml height:sml offset:[12,0] tooltip:"pinky 2"
	
	checkbutton chkbtn_index1 "" width:sml height:sml across:4 align:#right offset:[8,0] tooltip:"index 1"
	checkbutton chkbtn_middle1 "" width:sml height:sml offset:[12,0] tooltip:"middle 1"
	checkbutton chkbtn_ring1 "" width:sml height:sml offset:[12,0] tooltip:"ring 1"
	checkbutton chkbtn_pinky1 "" width:sml height:sml offset:[12,0] tooltip:"pinky 1"

	checkbutton chkbtn_palmFront "" width:lrg height:lrg across:3 align:#right offset:[7,0] tooltip:"palm front"
	checkbutton chkbtn_palmMiddle "" width:lrg height:lrg offset:[11,0] tooltip:"palm middle"
	checkbutton chkbtn_palmBack "" width:lrg height:lrg offset:[12,0] tooltip:"palm back"		

	checkbutton chkbtn_wristFront "" width:lrg height:lrg across:3 align:#right offset:[7,0] tooltip:"wrist front"
	checkbutton chkbtn_wristMiddle "" width:lrg height:lrg offset:[11,0] tooltip:"wrist middle"
	checkbutton chkbtn_wristBack "" width:lrg height:lrg offset:[12,0] tooltip:"wrist back"
	
	checkbutton chkbtn_wristCenter "" width:lrg height:lrg align:#right offset:[-14,0] tooltip:"wrist center"
	
	checkbutton chkbtn_thumbTip "" width:sml height:sml align:#right offset:[-58,-92] tooltip:"thumb tip"
	checkbutton chkbtn_thumb2 "" width:sml height:sml align:#right offset:[-58,0] tooltip:"thumb 2"
	checkbutton chkbtn_thumb1 "" width:sml height:sml align:#right offset:[-58,0] tooltip:"thumb 1"
		
	fn f_uncheckAll =
	(
		chkbtn_wristCenter.checked = false
		chkbtn_wristFront.checked = false
		chkbtn_wristMiddle.checked = false
		chkbtn_wristBack.checked = false
		chkbtn_palmFront.checked = false
		chkbtn_palmMiddle.checked = false
		chkbtn_palmBack.checked = false
		chkbtn_thumb1.checked = false
		chkbtn_thumb2.checked = false
		chkbtn_thumbTip.checked = false
		chkbtn_index1.checked = false
		chkbtn_index2.checked = false
		chkbtn_indexTip.checked = false
		chkbtn_middle1.checked = false
		chkbtn_middle2.checked = false
		chkbtn_middleTip.checked = false
		chkbtn_ring1.checked = false
		chkbtn_ring2.checked = false
		chkbtn_ringTip.checked = false
		chkbtn_pinky1.checked = false
		chkbtn_pinky2.checked = false
		chkbtn_pinkyTip.checked = false
	)
	
	fn f_updateButton state chkbtn index =
	(
		f_uncheckAll();
		if state then
		(
			if (f_changePivot rolBsBipedTools.m_RHand[1].controller index) then
			(
				chkbtn.checked = true
			)
		)
		else
		(
			if (f_getPivotIndex rolBsBipedTools.m_RHand[1].controller) > 0 then
			(
				chkbtn.checked = true
			)
		)
	)

	on rolBSRightHandPivots open do
	(
		case (f_getPivotIndex rolBsBipedTools.m_RHand[1].controller) of
		(
			1: chkbtn_wristCenter.checked = true
			2: chkbtn_wristFront.checked = true
			3: chkbtn_wristMiddle.checked = true
			4: chkbtn_wristBack.checked = true
			5: chkbtn_palmFront.checked = true
			6: chkbtn_palmMiddle.checked = true
			7: chkbtn_palmBack.checked = true
			8: chkbtn_thumb1.checked = true
			9: chkbtn_thumb2.checked = true
			10: chkbtn_thumbTip.checked = true
			11: chkbtn_index1.checked = true
			12: chkbtn_index2.checked = true
			13: chkbtn_indexTip.checked = true
			14: chkbtn_middle1.checked = true
			15: chkbtn_middle2.checked = true
			16: chkbtn_middleTip.checked = true
			17: chkbtn_ring1.checked = true
			18: chkbtn_ring2.checked = true
			19: chkbtn_ringTip.checked = true
			20: chkbtn_pinky1.checked = true
			21: chkbtn_pinky2.checked = true
			22: chkbtn_pinkyTip.checked = true
			default: f_uncheckAll()
		)
	)
	
	on rolBSRightHandPivots close do
	(
		
	)
	
	on chkbtn_wristCenter changed state do (f_updateButton state chkbtn_wristCenter 1)
	on chkbtn_wristFront changed state do (f_updateButton state chkbtn_wristFront 2)
	on chkbtn_wristMiddle changed state do (f_updateButton state chkbtn_wristMiddle 3)
	on chkbtn_wristBack changed state do (f_updateButton state chkbtn_wristBack 4)
	on chkbtn_palmFront changed state do (f_updateButton state chkbtn_palmFront 5)
	on chkbtn_palmMiddle changed state do (f_updateButton state chkbtn_palmMiddle 6)
	on chkbtn_palmBack changed state do (f_updateButton state chkbtn_palmBack 7)
	on chkbtn_thumb1 changed state do (f_updateButton state chkbtn_thumb1 8)
	on chkbtn_thumb2 changed state do (f_updateButton state chkbtn_thumb2 9)
	on chkbtn_thumbTip changed state do (f_updateButton state chkbtn_thumbTip 10)
	on chkbtn_index1 changed state do (f_updateButton state chkbtn_index1 11)
	on chkbtn_index2 changed state do (f_updateButton state chkbtn_index2 12)
	on chkbtn_indexTip changed state do (f_updateButton state chkbtn_indexTip 13)
	on chkbtn_middle1 changed state do (f_updateButton state chkbtn_middle1 14)
	on chkbtn_middle2 changed state do (f_updateButton state chkbtn_middle2 15)
	on chkbtn_middleTip changed state do (f_updateButton state chkbtn_middleTip 16)
	on chkbtn_ring1 changed state do (f_updateButton state chkbtn_ring1 17)
	on chkbtn_ring2 changed state do (f_updateButton state chkbtn_ring2 18)
	on chkbtn_ringTip changed state do (f_updateButton state chkbtn_ringTip 19)
	on chkbtn_pinky1 changed state do (f_updateButton state chkbtn_pinky1 20)
	on chkbtn_pinky2 changed state do (f_updateButton state chkbtn_pinky2 21)
	on chkbtn_pinkyTip changed state do (f_updateButton state chkbtn_pinkyTip 22)
) --// end rollout

rollout rolBSLeftFootPivots "L-Foot" width:90
(
	local lrg = 16

	checkbutton chkbtn_frontLeft "" across:3 width:lrg height:lrg align:#left offset:[0,0] tooltip:"front left"
	checkbutton chkbtn_frontMiddle "" width:lrg height:lrg offset:[0,0] tooltip:"front middle"
	checkbutton chkbtn_frontRight "" width:lrg height:lrg offset:[3,0] tooltip:"front right"
	checkbutton chkbtn_ankle "" width:lrg height:lrg align:#left offset:[13,0] tooltip:"ankle"
	checkbutton chkbtn_backLeft "" across:3 width:lrg height:lrg align:#left offset:[0,0] tooltip:"back left"
	checkbutton chkbtn_backMiddle "" width:lrg height:lrg offset:[0,0] tooltip:"back middle"
	checkbutton chkbtn_backRight "" width:lrg height:lrg offset:[3,0] tooltip:"back right"

	fn f_uncheckAll =
	(
		chkbtn_ankle.checked = false
		chkbtn_backLeft.checked = false
		chkbtn_backMiddle.checked = false
		chkbtn_backRight.checked = false
		chkbtn_frontLeft.checked = false
		chkbtn_frontMiddle.checked = false
		chkbtn_frontRight.checked = false
	)
	
	fn f_updateButton state chkbtn index =
	(
		f_uncheckAll();
		if state then
		(
			if (f_changePivot rolBsBipedTools.m_LFoot[1].controller index) then
			(
				chkbtn.checked = true
			)
		)
		else
		(
			if (f_getPivotIndex rolBsBipedTools.m_LFoot[1].controller) > 0 then
			(
				chkbtn.checked = true
			)
		)
	)

	on rolBSLeftFootPivots open do
	(
		case (f_getPivotIndex rolBsBipedTools.m_LFoot[1].controller) of
		(
			1: chkbtn_ankle.checked = true
			2: chkbtn_backLeft.checked = true
			3: chkbtn_backMiddle.checked = true
			4: chkbtn_backRight.checked = true
			5: chkbtn_frontLeft.checked = true
			6: chkbtn_frontMiddle.checked = true
			7: chkbtn_frontRight.checked = true
			default: f_uncheckAll()
		)
	)
	
	on rolBSLeftFootPivots close do
	(
		
	)
	
	on chkbtn_ankle changed state do (f_updateButton state chkbtn_ankle 1)
	on chkbtn_backLeft changed state do (f_updateButton state chkbtn_backLeft 2)
	on chkbtn_backMiddle changed state do (f_updateButton state chkbtn_backMiddle 3)
	on chkbtn_backRight changed state do (f_updateButton state chkbtn_backRight 4)
	on chkbtn_frontLeft changed state do (f_updateButton state chkbtn_frontLeft 5)
	on chkbtn_frontMiddle changed state do (f_updateButton state chkbtn_frontMiddle 6)
	on chkbtn_frontRight changed state do (f_updateButton state chkbtn_frontRight 7)	
) --// end rollout

rollout rolBSRightFootPivots "R-Foot" width:90
(
	local lrg = 16

	checkbutton chkbtn_frontLeft "" across:3 width:lrg height:lrg align:#left offset:[0,0] tooltip:"front left"
	checkbutton chkbtn_frontMiddle "" width:lrg height:lrg offset:[0,0] tooltip:"front middle"
	checkbutton chkbtn_frontRight "" width:lrg height:lrg offset:[3,0] tooltip:"front right"
	checkbutton chkbtn_ankle "" width:lrg height:lrg align:#left offset:[39,0] tooltip:"ankle"
	checkbutton chkbtn_backLeft "" across:3 width:lrg height:lrg align:#left offset:[0,0] tooltip:"back left"
	checkbutton chkbtn_backMiddle "" width:lrg height:lrg offset:[0,0] tooltip:"back middle"
	checkbutton chkbtn_backRight "" width:lrg height:lrg offset:[3,0] tooltip:"back right"

	fn f_uncheckAll =
	(
		chkbtn_ankle.checked = false
		chkbtn_backLeft.checked = false
		chkbtn_backMiddle.checked = false
		chkbtn_backRight.checked = false
		chkbtn_frontLeft.checked = false
		chkbtn_frontMiddle.checked = false
		chkbtn_frontRight.checked = false
	)
	
	fn f_updateButton state chkbtn index =
	(
		f_uncheckAll();
		if state then
		(
			if (f_changePivot rolBsBipedTools.m_RFoot[1].controller index) then
			(
				chkbtn.checked = true
			)
		)
		else
		(
			if (f_getPivotIndex rolBsBipedTools.m_RFoot[1].controller) > 0 then
			(
				chkbtn.checked = true
			)
		)
	)

	on rolBSRightFootPivots open do
	(
		case (f_getPivotIndex rolBsBipedTools.m_RFoot[1].controller) of
		(
			1: chkbtn_ankle.checked = true
			2: chkbtn_backLeft.checked = true
			3: chkbtn_backMiddle.checked = true
			4: chkbtn_backRight.checked = true
			5: chkbtn_frontLeft.checked = true
			6: chkbtn_frontMiddle.checked = true
			7: chkbtn_frontRight.checked = true
			default: f_uncheckAll()
		)
	)
	
	on rolBSRightFootPivots close do
	(
		
	)
	
	on chkbtn_ankle changed state do (f_updateButton state chkbtn_ankle 1)
	on chkbtn_backLeft changed state do (f_updateButton state chkbtn_backLeft 2)
	on chkbtn_backMiddle changed state do (f_updateButton state chkbtn_backMiddle 3)
	on chkbtn_backRight changed state do (f_updateButton state chkbtn_backRight 4)
	on chkbtn_frontLeft changed state do (f_updateButton state chkbtn_frontLeft 5)
	on chkbtn_frontMiddle changed state do (f_updateButton state chkbtn_frontMiddle 6)
	on chkbtn_frontRight changed state do (f_updateButton state chkbtn_frontRight 7)
) --// end rollout

rollout rolBSFingers "BsBipedTools_Fingers" width:300 height:230
(
	checkbutton chbTips "ÊöÇ‰∏çÊîØÊåÅ4ËäÇÊâãÊåá" pos:[100,5] height:20 highlightColor:rolBsBipedTools.mcScanBiped checked:true

	checkbutton chbRFingers "R Fingers" pos:[40,160] width:100 highlightColor:rolBsBipedTools.mcRightFinger checked:true
	checkbutton chbLFingers "L Fingers" pos:[160,160] width:100 highlightColor:rolBsBipedTools.mcLeftFinger checked:true
	
	--R Index Finger (Êï¥‰ΩìÂè≥Áßª20ÂÉèÁ¥†Â±Ö‰∏≠)
	checkbutton select_rhand1_btn "R Hand"	enabled:true pos:[40,30] width:80 height:30 highlightColor:rolBsBipedTools.mcRight checked:true toolTip:""
	checkbutton select_rfing11_btn ""	enabled:true pos:[100,85] width:20 height:22 highlightColor:rolBsBipedTools.mcRightFinger checked:true toolTip:""
	checkbutton select_rfing12_btn ""	enabled:true pos:[100,107] width:20 height:20 highlightColor:rolBsBipedTools.mcRightFinger checked:true toolTip:""
	checkbutton select_rfing13_btn ""	enabled:true pos:[100,127] width:20 height:17 highlightColor:rolBsBipedTools.mcRightFinger checked:true toolTip:""

	--R Middle Finger
	checkbutton select_rfing21_btn ""	enabled:true pos:[80,85]	width:20 height:23 highlightColor:rolBsBipedTools.mcRightFinger checked:true toolTip:""
	checkbutton select_rfing22_btn ""	enabled:true pos:[80,108]	width:20 height:23 highlightColor:rolBsBipedTools.mcRightFinger checked:true toolTip:""
	checkbutton select_rfing23_btn ""	enabled:true pos:[80,131]	width:20 height:20 highlightColor:rolBsBipedTools.mcRightFinger checked:true ttoolTip:""
	
	--R Ring Finger
	checkbutton select_rfing31_btn ""	enabled:true pos:[60,85]	width:20 height:22 highlightColor:rolBsBipedTools.mcRightFinger checked:true toolTip:""
	checkbutton select_rfing32_btn ""	enabled:true pos:[60,107]	width:20 height:20 highlightColor:rolBsBipedTools.mcRightFinger checked:true toolTip:""
	checkbutton select_rfing33_btn ""	enabled:true pos:[60,127]	width:20 height:17 highlightColor:rolBsBipedTools.mcRightFinger checked:true toolTip:""
	
	--R Pinkie Finger
	checkbutton select_rfing41_btn ""	enabled:true pos:[40,85]	width:20 height:20 highlightColor:rolBsBipedTools.mcRightFinger checked:true toolTip:""
	checkbutton select_rfing42_btn ""	enabled:true pos:[40,105]	width:20 height:17 highlightColor:rolBsBipedTools.mcRightFinger checked:true toolTip:""
	checkbutton select_rfing43_btn ""	enabled:true pos:[40,122]	width:20 height:16 highlightColor:rolBsBipedTools.mcRightFinger checked:true toolTip:""
	
	--R Thumb
	checkbutton select_rthumb1_btn ""	enabled:true pos:[120,69]	width:20 height:30 highlightColor:rolBsBipedTools.mcRightThumb checked:true toolTip:""
	checkbutton select_rthumb2_btn ""	enabled:true pos:[120,99]	width:18 height:19 highlightColor:rolBsBipedTools.mcRightThumb checked:true toolTip:""
	checkbutton select_rthumb3_btn ""	enabled:true pos:[120,118]	width:16 height:18 highlightColor:rolBsBipedTools.mcRightThumb checked:true toolTip:""

	--LEFT HAND (Âè≥ÁßªÂà∞ÂêàÈÄÇ‰ΩçÁΩÆ)
	--L Index Finger
	checkbutton select_lhand1_btn "L Hand"	enabled:true pos:[180,30]	width:80 height:30 highlightColor:rolBsBipedTools.mcLeft checked:true toolTip:""
	checkbutton select_lfing11_btn ""	enabled:true pos:[180,85]	width:20 height:22 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""
	checkbutton select_lfing12_btn ""	enabled:true pos:[180,107]	width:20 height:20 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""
	checkbutton select_lfing13_btn ""	enabled:true pos:[180,127]	width:20 height:17 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""
	
	--L Middle Finger
	checkbutton select_lfing21_btn ""	enabled:true pos:[200,85]	width:20 height:23 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""
	checkbutton select_lfing22_btn ""	enabled:true pos:[200,108]	width:20 height:23 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""
	checkbutton select_lfing23_btn ""	enabled:true pos:[200,131]	width:20 height:20 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""
	
	--L Ring Finger
	checkbutton select_lfing31_btn ""	enabled:true pos:[220,85]	width:20 height:22 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""
	checkbutton select_lfing32_btn ""	enabled:true pos:[220,107]	width:20 height:20 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""
	checkbutton select_lfing33_btn ""	enabled:true pos:[220,127]	width:20 height:17 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""

	--L Pinkie Finger
	checkbutton select_lfing41_btn ""	enabled:true pos:[240,85]	width:20 height:20 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""
	checkbutton select_lfing42_btn ""	enabled:true pos:[240,105]	width:20 height:17 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""
	checkbutton select_lfing43_btn ""	enabled:true pos:[240,122]	width:20 height:16 highlightColor:rolBsBipedTools.mcLeftFinger checked:true toolTip:""

	--L Thumb
	checkbutton select_lthumb1_btn ""	enabled:true pos:[160,69]	width:20 height:30 highlightColor:rolBsBipedTools.mcLeftThumb checked:true toolTip:""
	checkbutton select_lthumb2_btn ""	enabled:true pos:[162,99]	width:18 height:19 highlightColor:rolBsBipedTools.mcLeftThumb checked:true toolTip:""
	checkbutton select_lthumb3_btn ""	enabled:true pos:[164,118]	width:16 height:18 highlightColor:rolBsBipedTools.mcLeftThumb checked:true toolTip:""

	checkbutton btnFingerLineR1 "0" enabled:true pos:[120,44] width:20 height:25 checked:true toolTip:"ÈÄâÊã©ÂçïÊù°ÊâãÊåá"
	checkbutton btnFingerLineR2 "1" enabled:true pos:[100,60] width:20 height:25 checked:true toolTip:"ÈÄâÊã©ÂçïÊù°ÊâãÊåá"
	checkbutton btnFingerLineR3 "2" enabled:true pos:[80,60] width:20 height:25 checked:true toolTip:"ÈÄâÊã©ÂçïÊù°ÊâãÊåá"
	checkbutton btnFingerLineR4 "3" enabled:true pos:[60,60] width:20 height:25 checked:true toolTip:"ÈÄâÊã©ÂçïÊù°ÊâãÊåá"
	checkbutton btnFingerLineR5 "4" enabled:true pos:[40,60] width:20 height:25 checked:true toolTip:"ÈÄâÊã©ÂçïÊù°ÊâãÊåá"
	checkbutton btnFingerLineL1 "0" enabled:true pos:[160,44] width:20 height:25 checked:true toolTip:"ÈÄâÊã©ÂçïÊù°ÊâãÊåá"
	checkbutton btnFingerLineL2 "1" enabled:true pos:[180,60] width:20 height:25 checked:true toolTip:"ÈÄâÊã©ÂçïÊù°ÊâãÊåá"
	checkbutton btnFingerLineL3 "2" enabled:true pos:[200,60] width:20 height:25 checked:true toolTip:"ÈÄâÊã©ÂçïÊù°ÊâãÊåá"
	checkbutton btnFingerLineL4 "3" enabled:true pos:[220,60] width:20 height:25 checked:true toolTip:"ÈÄâÊã©ÂçïÊù°ÊâãÊåá"
	checkbutton btnFingerLineL5 "4" enabled:true pos:[240,60] width:20 height:25 checked:true toolTip:"ÈÄâÊã©ÂçïÊù°ÊâãÊåá"
		
	-- UI Êéß‰ª∂ - Á´ñÁõ¥ÊâãÊåáÂº†ÂºÄÊªëÂùó (‰∏§‰æßÂØπÁß∞Â∏ÉÂ±ÄÔºåÂä†Â§ßÂ∞∫ÂØ∏)
	slider uiRSpread "" range:[1,-0.3,0] width:25 height:120 pos:[10,35] tooltip:"Âè≥ÊâãÊâãÊåáÂº†ÂºÄ\nÂêë‰∏ãÊãñÂä®Âº†ÂºÄ" orient:#vertical
	slider uiLSpread "" range:[1,-0.3,0] width:25 height:120 pos:[270,35] tooltip:"Â∑¶ÊâãÊâãÊåáÂº†ÂºÄ\nÂêë‰∏ãÊãñÂä®Âº†ÂºÄ" orient:#vertical
	
	-- ÊâãÊåáÂºØÊõ≤Êéß‰ª∂ (Â∫ïÈÉ®Â±Ö‰∏≠ÂØπÈΩê)
	label lblRBend "Âè≥ÊâãÂºØÊõ≤:" pos:[60,190] width:60 height:15
	spinner uiRBendStart "" width:50 range:[-45,90,0] scale:1 type:#integer pos:[30,205] tooltip:"Âè≥ÊâãÂºØÊõ≤Ëµ∑ÂßãËßíÂ∫¶"
	spinner uiRBendEnd "" width:50 range:[-45,90,0] scale:1 type:#integer pos:[85,205] tooltip:"Âè≥ÊâãÂºØÊõ≤ÁªìÊùüËßíÂ∫¶"
	
	label lblLBend "Â∑¶ÊâãÂºØÊõ≤:" pos:[195,190] width:60 height:15
	spinner uiLBendStart "" width:50 range:[-45,90,0] scale:1 type:#integer pos:[165,205] tooltip:"Â∑¶ÊâãÂºØÊõ≤Ëµ∑ÂßãËßíÂ∫¶"
	spinner uiLBendEnd "" width:50 range:[-45,90,0] scale:1 type:#integer pos:[220,205] tooltip:"Â∑¶ÊâãÂºØÊõ≤ÁªìÊùüËßíÂ∫¶"
	

	fn GetFinger side index =
	(
		if side == "L" then sideFinger = #lfingers 
		else if side == "R" then sideFinger = #rfingers

		selObj = biped.getNode rolBsBipedTools.m_workingBipRoot sideFinger link:index
		if selObj != undefined then
		(
			if ( selObj.isHidden == false ) or rolBsBipedTools.uiChkSelHiddenObj.state then (
				return #(selObj)
			)
			else (
				return #()
			)
		)
		else
		(
			return undefined
		)
	)

	on select_lhand1_btn changed state do (
		select_lhand1_btn.state = true
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) do ( rolBsBipedTools.SetButtonState false; return ())
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			rolBsBipedTools.Straighten rolBsBipedTools.m_LHand ((eulerangles -90 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(rolBsBipedTools.CompSelect selBackup rolBsBipedTools.m_LHand) catch (
			rolBsBipedTools.m_LHand = rolBsBipedTools.GetLHand()
			select rolBsBipedTools.m_LHand
		)
	)

	on select_lhand1_btn rightclick do 
	(
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) do ( rolBsBipedTools.SetButtonState false; return ())
		rolBsBipedTools.m_RHand = rolBsBipedTools.GetRHand()
		select rolBsBipedTools.m_RHand
	)

	
	on select_rhand1_btn changed state do (
		select_rhand1_btn.state = true
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) do ( rolBsBipedTools.SetButtonState false; return ())
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			rolBsBipedTools.Straighten rolBsBipedTools.m_RHand ((eulerangles 90 0 0) as quat)
			return ()
		)

		selBackup = selection as array

		try(rolBsBipedTools.CompSelect selBackup rolBsBipedTools.m_RHand) catch (
			rolBsBipedTools.m_RHand = rolBsBipedTools.GetRHand()
			select rolBsBipedTools.m_RHand
			
		)
	)

	on select_rhand1_btn rightclick do 
	(
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) do ( rolBsBipedTools.SetButtonState false; return ())
		rolBsBipedTools.m_LHand = rolBsBipedTools.GetLHand()
		select rolBsBipedTools.m_LHand
	)

	on chbTips changed state do
	(
		chbTips.state = true
	)

	on chbRFingers changed state do
	(
		chbRFingers.state = true
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or rolBsBipedTools.m_RHand == undefined ) do (return ())
		chbRFingers.state = true
		rolBsBipedTools.fnSelAllChildrens rolBsBipedTools.m_RHand
		deselect rolBsBipedTools.m_RHand
	)

	on select_rthumb1_btn changed state do (
		select_rthumb1_btn.state = true
		m_RThumb1 = (GetFinger "R" 1)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_RThumb1 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_RThumb1 ((eulerangles 0 0 0) as quat)
			return ()
		)

		try(rolBsBipedTools.CompSelect selBackup m_RThumb1) catch (
			m_RThumb1 = (GetFinger "R" 1)
			select m_RThumb1
		)
	)

	on select_rthumb2_btn changed state do (
		select_rthumb2_btn.state = true
		m_RThumb2 = (GetFinger "R" 2)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_RThumb2 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_RThumb2 ((eulerangles 0 0 0) as quat)
			return ()
		)

		try(rolBsBipedTools.CompSelect selBackup m_RThumb2) catch (
			m_RThumb2 = (GetFinger "R" 2)
			select m_RThumb2
		)
	)

	on select_rthumb3_btn changed state do (
		select_rthumb3_btn.state = true
		m_RThumb3 = (GetFinger "R" 3)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_RThumb3 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_RThumb3 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_RThumb3) catch (
			m_RThumb3 = (GetFinger "R" 3)
			select m_RThumb3
		)
	)

	on select_rfing11_btn changed state do (
		select_rfing11_btn.state = true
		m_RFing11 = (GetFinger "R" 4)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_RFing11 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_RFing11 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_RFing11) catch (
			m_RFing11 = (GetFinger "R" 4)
			select m_RFing11
		)
	)

	on select_rfing12_btn changed state do (
		select_rfing12_btn.state = true
		m_RFing12 = (GetFinger "R" 5)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_RFing12 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_RFing12 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_RFing12) catch (
			m_RFing12 = (GetFinger "R" 5)
			select m_RFing12
		)
	)

	on select_rfing13_btn changed state do (
		select_rfing13_btn.state = true
		m_RFing13 = (GetFinger "R" 6)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_RFing13 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_RFing13 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_RFing13) catch (
			m_RFing13 = (GetFinger "R" 6)
			select m_RFing13
		)
	)

	on select_rfing21_btn changed state do (
		select_rfing21_btn.state = true
		m_RFing21 = (GetFinger "R" 7)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_RFing21 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_RFing21 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_RFing21) catch (
			m_RFing21 = (GetFinger "R" 7)
			select m_RFing21
		)
	)

	on select_rfing22_btn changed state do (
		select_rfing22_btn.state = true
		m_RFing22 = (GetFinger "R" 8)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_RFing22 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_RFing22 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_RFing22) catch (
			m_RFing22 = (GetFinger "R" 8)
			select m_RFing22
		)
	)

	on select_rfing23_btn changed state do (
		select_rfing23_btn.state = true
		m_RFing23 = (GetFinger "R" 9)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_RFing23 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_RFing23 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_RFing23) catch (
			m_RFing23 = (GetFinger "R" 9)
			select m_RFing23
		)
	)

	on select_rfing31_btn changed state do (
		select_rfing31_btn.state = true
		m_RFing31 = (GetFinger "R" 10)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_RFing31 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_RFing31 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_RFing31) catch (
			m_RFing31 = (GetFinger "R" 10)
			select m_RFing31
		)
	)

	on select_rfing32_btn changed state do (
		select_rfing32_btn.state = true
		m_RFing32 = (GetFinger "R" 11)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_RFing32 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_RFing32 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_RFing32) catch (
			m_RFing32 = (GetFinger "R" 11)
			select m_RFing32
		)
	)

	on select_rfing33_btn changed state do (
		select_rfing33_btn.state = true
		m_RFing33 = (GetFinger "R" 12)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_RFing33 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_RFing33 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_RFing33) catch (
			m_RFing33 = (GetFinger "R" 12)
			select m_RFing33
		)
	)

	on select_rfing41_btn changed state do (
		select_rfing41_btn.state = true
		m_RFing41 = (GetFinger "R" 13)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_RFing41 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_RFing41 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_RFing41) catch (
			m_RFing41 = (GetFinger "R" 13)
			select m_RFing41
		)
	)

	on select_rfing42_btn changed state do (
		select_rfing42_btn.state = true
		m_RFing42 = (GetFinger "R" 14)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_RFing42 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_RFing42 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_RFing42) catch (
			m_RFing42 = (GetFinger "R" 14)
			select m_RFing42
		)
	)

	on select_rfing43_btn changed state do (
		select_rfing43_btn.state = true
		m_RFing43 = (GetFinger "R" 15)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_RFing43 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_RFing43 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_RFing43) catch (
			m_RFing43 = (GetFinger "R" 15)
			select m_RFing43
		)
	)

	on chbLFingers changed state do
	(
		chbLFingers.state = true
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or rolBsBipedTools.m_LHand == undefined ) do (return ())
		chbLFingers.state = true
		rolBsBipedTools.fnSelAllChildrens rolBsBipedTools.m_LHand
		deselect rolBsBipedTools.m_LHand
	)

	on select_Lthumb1_btn changed state do (
		select_Lthumb1_btn.state = true
		m_LThumb1 = (GetFinger "L" 1)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_LThumb1 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_LThumb1 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_LThumb1) catch (
			m_LThumb1 = (GetFinger "L" 1)
			select m_LThumb1
		)
	)

	on select_Lthumb2_btn changed state do (
		select_Lthumb2_btn.state = true
		m_LThumb2 = (GetFinger "L" 2)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_LThumb2 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_LThumb2 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_LThumb2) catch (
			m_LThumb2 = (GetFinger "L" 2)
			select m_LThumb2
		)
	)

	on select_Lthumb3_btn changed state do (
		select_Lthumb3_btn.state = true
		m_LThumb3 = (GetFinger "L" 3)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_LThumb3 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_LThumb3 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_LThumb3) catch (
			m_LThumb3 = (GetFinger "L" 3)
			select m_LThumb3
		)
	)

	on select_Lfing11_btn changed state do (
		select_Lfing11_btn.state = true
		m_LFing11 = (GetFinger "L" 4)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_LFing11 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_LFing11 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_LFing11) catch (
			m_LFing11 = (GetFinger "L" 4)
			select m_LFing11
		)
	)

	on select_Lfing12_btn changed state do (
		select_Lfing12_btn.state = true
		m_LFing12 = (GetFinger "L" 5)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_LFing12 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_LFing12 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_LFing12) catch (
			m_LFing12 = (GetFinger "L" 5)
			select m_LFing12
		)
	)

	on select_Lfing13_btn changed state do (
		select_Lfing13_btn.state = true
		m_LFing13 = (GetFinger "L" 6)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_LFing13 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_LFing13 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_LFing13) catch (
			m_LFing13 = (GetFinger "L" 6)
			select m_LFing13
		)
	)

	on select_Lfing21_btn changed state do (
		select_Lfing21_btn.state = true
		m_LFing21 = (GetFinger "L" 7)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_LFing21 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_LFing21 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_LFing21) catch (
			m_LFing21 = (GetFinger "L" 7)
			select m_LFing21
		)
	)

	on select_Lfing22_btn changed state do (
		select_Lfing22_btn.state = true
		m_LFing22 = (GetFinger "L" 8)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_LFing22 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_LFing22 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_LFing22) catch (
			m_LFing22 = (GetFinger "L" 8)
			select m_LFing22
		)
	)

	on select_Lfing23_btn changed state do (
		select_Lfing23_btn.state = true
		m_LFing23 = (GetFinger "L" 9)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_LFing23 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_LFing23 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_LFing23) catch (
			m_LFing23 = (GetFinger "L" 9)
			select m_LFing23
		)
	)

	on select_Lfing31_btn changed state do (
		select_Lfing31_btn.state = true
		m_LFing31 = (GetFinger "L" 10)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_LFing31 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_LFing31 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_LFing31) catch (
			m_LFing31 = (GetFinger "L" 10)
			select m_LFing31
		)
	)

	on select_Lfing32_btn changed state do (
		select_Lfing32_btn.state = true
		m_LFing32 = (GetFinger "L" 11)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_LFing32 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_LFing32 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_LFing32) catch (
			m_LFing32 = (GetFinger "L" 11)
			select m_LFing32
		)
	)

	on select_Lfing33_btn changed state do (
		select_Lfing33_btn.state = true
		m_LFing33 = (GetFinger "L" 12)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_LFing33 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_LFing33 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_LFing33) catch (
			m_LFing33 = (GetFinger "L" 12)
			select m_LFing33
		)
	)

	on select_Lfing41_btn changed state do (
		select_Lfing41_btn.state = true
		m_LFing41 = (GetFinger "L" 13)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_LFing41 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_LFing41 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_LFing41) catch (
			m_LFing41 = (GetFinger "L" 13)
			select m_LFing41
		)
	)

	on select_Lfing42_btn changed state do (
		select_Lfing42_btn.state = true
		m_LFing42 = (GetFinger "L" 14)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_LFing42 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_LFing42 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_LFing42) catch (
			m_LFing42 = (GetFinger "L" 14)
			select m_LFing42
		)
	)

	on select_Lfing43_btn changed state do (
		select_Lfing43_btn.state = true
		m_LFing43 = (GetFinger "L" 15)
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or m_LFing43 == undefined ) do (return ())

		selBackup = selection as array

		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten m_LFing43 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		try(rolBsBipedTools.CompSelect selBackup m_LFing43) catch (
			m_LFing43 = (GetFinger "L" 15)
			select m_LFing43
		)
	)

	on btnFingerLineR1 changed state do (
		btnFingerLineR1.state = true
		local arrFingerLine = #()
		for i = 1 to 3 do (
			tempFinger = (GetFinger "R" i)
			if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or tempFinger == undefined ) do 
			(
				print "ËØ∑ÂÖàÁ°ÆËÆ§ÊâãÊåáÈ™®È™º!"
				return ()
			)
			append arrFingerLine tempFinger[1]
		)
		
		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten arrFingerLine ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		select arrFingerLine
	)
	on btnFingerLineR2 changed state do (
		btnFingerLineR2.state = true
		local arrFingerLine = #()
		for i = 4 to 6 do (
			tempFinger = (GetFinger "R" i)
			if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or tempFinger == undefined ) do 
			(
				print "ËØ∑ÂÖàÁ°ÆËÆ§ÊâãÊåáÈ™®È™º!"
				return ()
			)
			append arrFingerLine tempFinger[1]
		)
		
		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten arrFingerLine ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		select arrFingerLine
	)
	on btnFingerLineR3 changed state do (
		btnFingerLineR3.state = true
		local arrFingerLine = #()
		for i = 7 to 9 do (
			tempFinger = (GetFinger "R" i)
			if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or tempFinger == undefined ) do 
			(
				print "ËØ∑ÂÖàÁ°ÆËÆ§ÊâãÊåáÈ™®È™º!"
				return ()
			)
			append arrFingerLine tempFinger[1]
		)
		
		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten arrFingerLine ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		select arrFingerLine
	)
	on btnFingerLineR4 changed state do (
		btnFingerLineR4.state = true
		local arrFingerLine = #()
		for i = 10 to 12 do (
			tempFinger = (GetFinger "R" i)
			if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or tempFinger == undefined ) do 
			(
				print "ËØ∑ÂÖàÁ°ÆËÆ§ÊâãÊåáÈ™®È™º!"
				return ()
			)
			append arrFingerLine tempFinger[1]
		)
		
		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten arrFingerLine ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		select arrFingerLine
	)
	on btnFingerLineR5 changed state do (
		btnFingerLineR5.state = true
		local arrFingerLine = #()
		for i = 13 to 15 do (
			tempFinger = (GetFinger "R" i)
			if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or tempFinger == undefined ) do 
			(
				print "ËØ∑ÂÖàÁ°ÆËÆ§ÊâãÊåáÈ™®È™º!"
				return ()
			)
			append arrFingerLine tempFinger[1]
		)
		
		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten arrFingerLine ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		select arrFingerLine
	)

	
	on btnFingerLineL1 changed state do (
		btnFingerLineL1.state = true
		local arrFingerLine = #()
		for i = 1 to 3 do (
			tempFinger = (GetFinger "L" i)
			if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or tempFinger == undefined ) do 
			(
				print "ËØ∑ÂÖàÁ°ÆËÆ§ÊâãÊåáÈ™®È™º!"
				return ()
			)
			append arrFingerLine tempFinger[1]
		)
		
		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten arrFingerLine ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		select arrFingerLine
	)
	on btnFingerLineL2 changed state do (
		btnFingerLineL2.state = true
		local arrFingerLine = #()
		for i = 4 to 6 do (
			tempFinger = (GetFinger "L" i)
			if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or tempFinger == undefined ) do 
			(
				print "ËØ∑ÂÖàÁ°ÆËÆ§ÊâãÊåáÈ™®È™º!"
				return ()
			)
			append arrFingerLine tempFinger[1]
		)
		
		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten arrFingerLine ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		select arrFingerLine
	)
	on btnFingerLineL3 changed state do (
		btnFingerLineL3.state = true
		local arrFingerLine = #()
		for i = 7 to 9 do (
			tempFinger = (GetFinger "L" i)
			if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or tempFinger == undefined ) do 
			(
				print "ËØ∑ÂÖàÁ°ÆËÆ§ÊâãÊåáÈ™®È™º!"
				return ()
			)
			append arrFingerLine tempFinger[1]
		)
		
		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten arrFingerLine ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		select arrFingerLine
	)
	on btnFingerLineL4 changed state do (
		btnFingerLineL4.state = true
		local arrFingerLine = #()
		for i = 10 to 12 do (
			tempFinger = (GetFinger "L" i)
			if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or tempFinger == undefined ) do 
			(
				print "ËØ∑ÂÖàÁ°ÆËÆ§ÊâãÊåáÈ™®È™º!"
				return ()
			)
			append arrFingerLine tempFinger[1]
		)
		
		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten arrFingerLine ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		select arrFingerLine
	)
	on btnFingerLineL5 changed state do (
		btnFingerLineL5.state = true
		local arrFingerLine = #()
		for i = 13 to 15 do (
			tempFinger = (GetFinger "L" i)
			if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot) or tempFinger == undefined ) do 
			(
				print "ËØ∑ÂÖàÁ°ÆËÆ§ÊâãÊåáÈ™®È™º!"
				return ()
			)
			append arrFingerLine tempFinger[1]
		)
		
		if keyboard.controlPressed and keyboard.altpressed do (
			rolBsBipedTools.Straighten arrFingerLine ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		select arrFingerLine
	)
	
	-- ÊâãÊåáÂº†ÂºÄÂäüËÉΩ (ÂèÇËÄÉ BipedAssist)
	local mc_spreadMaxAngle = 45.0
	
	-- Á∫øÊÄßÊèíÂÄºÂáΩÊï∞
	function LerpFloat a b bias = (
		return a + (b - a) * bias
	)

	function MakeClosest quat1 quat2 = -- modifies quat2 and also returns quat2
	(
		local dot = quat1.x*quat2.x + quat1.y*quat2.y + quat1.z*quat2.z+quat1.w*quat2.w
		if (dot < 0.0) do (quat2.x = -quat2.x; quat2.y = -quat2.y;quat2.z = -quat2.z; quat2.w = -quat2.w)
		quat2
	)
	
	-- ÊâãÊåáÂº†ÂºÄÂáΩÊï∞ (ÂÆåÂÖ®ÂèÇËÄÉBipedAssistÂÆûÁé∞Ôºå6‰∏™ÂèÇÊï∞)
	function SpreadFingers fingersArr minAngle maxAngle spread bendStart bendEnd =
	(
		if fingersArr.count < 3 do return()
		for fingerIndex = 2 to fingersArr.count do (
			local tFingerBias = ((fingerIndex - 2) as float) / ((fingersArr.count - 2) as float)
			local tWeightedAngle = LerpFloat bendStart bendEnd tFingerBias
			local tSpreadMaxAngle = LerpFloat minAngle maxAngle tFingerBias
			local tSpreadMaxQuat = eulerToQuat (eulerAngles 0 tSpreadMaxAngle tWeightedAngle) order:1
			local tSpreadMinQuat = eulerToQuat (eulerAngles 0 0 tWeightedAngle) order:1
			MakeClosest tSpreadMinQuat tSpreadMaxQuat
			local tRot = slerp tSpreadMinQuat tSpreadMaxQuat spread
			tRot = tRot * fingersArr[fingerIndex][1].parent.transform.rotation
			biped.setTransform fingersArr[fingerIndex][1] #rotation tRot animButtonState
		)
	)
	
	-- ÊâãÊåáÂºØÊõ≤ÂáΩÊï∞ (ÂÆåÂÖ®ÂèÇËÄÉBipedAssistÂÆûÁé∞)
	function BendFingers fingersArr bendStart bendEnd spread = (
		if fingersArr.count < 2 do return()
		for fingerIndex = 2 to fingersArr.count do (
			local tFingerBias = ((fingerIndex - 2) as float) / ((fingersArr.count - 2) as float)
			local tWeightedAngle = LerpFloat bendStart bendEnd tFingerBias
			local tSpreadSliderValue = ((tFingerBias - 0.5) * 2.0) * spread * mc_spreadMaxAngle
			local tBendY = LerpFloat tSpreadSliderValue 0 ((tWeightedAngle as float) / 90.0)
			local tBendX = LerpFloat 0 -tSpreadSliderValue ((tWeightedAngle as float) / 90.0)
			local tRot = eulerToQuat (eulerAngles tWeightedAngle tBendY tBendX) order:6
			tRot = tRot * fingersArr[fingerIndex][1].parent.transform.rotation
			biped.setTransform fingersArr[fingerIndex][1] #rotation tRot animButtonState
			if fingersArr[fingerIndex].count >= 2 do (
				for i = 2 to fingersArr[fingerIndex].count do (
					tRot = eulerToQuat (eulerAngles tWeightedAngle 0 0) order:6
					tRot = tRot * fingersArr[fingerIndex][i].parent.transform.rotation
					biped.setTransform fingersArr[fingerIndex][i] #rotation tRot animButtonState
				)
			)
		)
	)
	
	-- Ëé∑ÂèñÊâãÊåáÊï∞ÁªÑ (ÂÆåÂÖ®ÂèÇËÄÉBipedAssistÂÆûÁé∞ÔºåÊîØÊåÅ‰∏çÂêåÊâãÊåáÁªÑÂêà)
	function GetFingerArray side fingerType = (
		local fingerArr = #()
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) then return fingerArr
		local fingerTypeSym = if side == "R" then #rfingers else #lfingers
		local maxFingers = 5 -- 5Ê†πÊâãÊåá
		local maxJoints = 3  -- ÊØèÊ†πÊâãÊåá3ËäÇ
		for f = 1 to maxFingers do (
			local oneFinger = #()
			for j = 1 to maxJoints do (
				local idx = (f - 1) * maxJoints + j
				local tFinger = biped.getNode rolBsBipedTools.m_workingBipRoot fingerTypeSym link:idx
				if tFinger != undefined do append oneFinger tFinger
			)
			if oneFinger.count > 0 do append fingerArr oneFinger
		)
		return fingerArr
	)

	-- Âè≥ÊâãÂº†ÂºÄ‰∫ã‰ª∂
	on uiRSpread rightClick do (
		uiRSpread.value = 0
		uiRSpread.changed 0
	)
	
	on uiRSpread changed var do (
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) do return()
		local m_RFingers = GetFingerArray "R" "spread"
		if m_RFingers.count > 0 then (
			SpreadFingers m_RFingers (-mc_spreadMaxAngle) mc_spreadMaxAngle var uiRBendStart.value uiRBendEnd.value
		)
	)
	
	-- Â∑¶ÊâãÂº†ÂºÄ‰∫ã‰ª∂
	on uiLSpread rightClick do (
		uiLSpread.value = 0
		uiLSpread.changed 0
	)
	
	on uiLSpread changed var do (
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) do return()
		local m_LFingers = GetFingerArray "L" "spread"
		if m_LFingers.count > 0 then (
			SpreadFingers m_LFingers mc_spreadMaxAngle (-mc_spreadMaxAngle) var uiLBendEnd.value uiLBendStart.value 
		)
	)
	
	-- Âè≥ÊâãÂºØÊõ≤‰∫ã‰ª∂ (È£üÊåá„ÄÅ‰∏≠Êåá„ÄÅÊó†ÂêçÊåá)
	on uiRBendEnd changed var do (
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) do return()
		local m_RFingers = GetFingerArray "R" "bend2"
		if m_RFingers.count > 0 then (
			BendFingers m_RFingers uiRBendStart.value uiRBendEnd.value uiRSpread.value
		)
	)
	
	on uiRBendStart changed var do (
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) do return()
		local m_RFingers = GetFingerArray "R" "bend1"
		if m_RFingers.count > 0 then (
			BendFingers m_RFingers uiRBendStart.value uiRBendEnd.value uiRSpread.value
		)
	)
	
	-- Â∑¶ÊâãÂºØÊõ≤‰∫ã‰ª∂ (‰∏≠Êåá„ÄÅÊó†ÂêçÊåá„ÄÅÂ∞èÊåá)
	on uiLBendStart changed var do (
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) do return()
		local m_LFingers = GetFingerArray "L" "bend1"
		if m_LFingers.count > 0 then (
			BendFingers m_LFingers uiLBendStart.value uiLBendEnd.value (-uiLSpread.value)
		)
	)
	
	on uiLBendEnd changed var do (
		if (rolBsBipedTools.m_workingBipRoot == undefined or (isDeleted rolBsBipedTools.m_workingBipRoot)) do return()
		local m_LFingers = GetFingerArray "L" "bend2"
		if m_LFingers.count > 0 then (
			BendFingers m_LFingers uiLBendStart.value uiLBendEnd.value (-uiLSpread.value)
		)
	)
)

fn fnLoadBsBTConfig =
(
	local oldPrintAllElements  = options.printAllelements
	options.printAllelements = true
	attr = (GetINISetting iniBsBipedTools "BsBipedTools" "BsBTPos") as string  --ÂÖàÊèêÂèñÊñá‰ª∂‰∏≠ÁöÑËÆ∞ÂΩï
	if (attr == "") or (attr == "undefined") then 
	(
		attr = execute "0"
	)
	else 
	(
		attr = execute attr
	)
	options.printAllelements = oldPrintAllElements
	iniBsBTPos = attr
)
fnLoadBsBTConfig()

fn fnSetBsBTConfig =
(
	SetINISetting iniBsBipedTools "BsBipedTools" "BsBTPos" (iniBsBTPos as string)
)

fn fnGetThemeColor =
(
	local curColorThemeFile = colorMan.getFileName()
	local maxuiBgColor = (colorman.getcolor #background) * 255
	
	if (curColorThemeFile != undefined) then
	(
		if (matchpattern curColorThemeFile pattern:"*light*") then
		(
			outThemeColor = "Light"
		)
		else
		(
			case maxuiBgColor of 
			(
				([68,68,68]):
				(
					outThemeColor = "Dark"
				)
				([186,186,186]):
				(
					outThemeColor = "Light"
				)
				default:
				(
					outThemeColor = "Dark"
				)
			)
		)
	)
	else
	(
		case maxuiBgColor of 
		(
			([68,68,68]):
			(
				outThemeColor = "Dark"
			)
			([186,186,186]):
			(
				outThemeColor = "Light"
			)
			default:
			(
				outThemeColor = "Dark"
			)
		)
	)
	return outThemeColor
	----Ëé∑ÂèñÂΩìÂâç‰∏ªÈ¢òÊòØÊ∑±Ëâ≤ËøòÊòØÊµÖËâ≤,Êù•Êõ¥ÊîπÊñáÂ≠óÈ¢úËâ≤ fnGetColorTheme.ms
)

rollout rolBsBipedTools "BsBipedTools" width:180 height:585
(
	local colorTheme = fnGetThemeColor()

	fn fnChangeThemeColor myColor =
	(
		colorTheme = fnGetThemeColor()
		if colorTheme == "Light" then (return myColor) else (return myColor/1.5)
	)

	fn fnBipedComlocalization ctrl =
	(
		if (((sysinfo.GetMaxLanguage())[3]=="CHS") and ((maxVersion())[1] < 20000)) then 
		(
			return ctrl.flip.controller
		)
		else
		(
			return ctrl.turning.controller
		)
	)

	fn fnAddBipedKey =
	(
		for i in selection as array where iskindof i.baseObject Biped_Object do
		(
			if ( classof i.controller == Vertical_Horizontal_Turn ) then
			(
				biped.addNewKey i.controller.vertical.controller slidertime
				biped.addNewKey i.controller.horizontal.controller slidertime
				biped.addNewKey (fnBipedComlocalization i.controller) slidertime
			)
			else 
			(
				try (biped.addNewKey i.controller sliderTime ) catch ()
			)
		)
	)

	fn fnGetAllBipedCom = 
	(
		allBips = #()
		for obj in geometry where not isDeleted obj and classof obj.baseobject == Biped_Object and (classof obj.controller == Vertical_Horizontal_Turn) do
		(
			append allBips obj
		)
		return allBips
	)

	fn fnGetAllSelRootNode = 
	(
		allRootNode = #()
		for obj in selection as array where (classof obj == Biped_object) and ((classof obj.controller == Vertical_Horizontal_Turn) or (classof obj.controller == BipSlave_Control)) do
		(
			if finditem allRootNode obj.controller.rootnode != 0 then 
			(
				Continue
			)
			else 
			(
				appendifUnique allRootNode obj.controller.rootnode
			)
		)
		return allRootNode
	)

	local a_layerNames = #()
	local a_layersActiveState = #()
	local ctrl = undefined
	local numLayers = 0
	local layerIndex = 1
	local postureObjsFile = getDir #plugcfg + "\BsBipedTools_PostureObjs.txt"
	
	-- È¢úÊñáÂ≠óËÑ∏Êï∞ÁªÑ (Â§öÊ†∑ÂåñÁÆÄÊ¥ÅÁâàÔºåÊó†ËÑ∏Ê°Ü)
	local headFaces = #("ÔΩ°‚óï·¥ó‚óïÔΩ°", \
		"^_^", "T_T", "O_O", "o_o", "x_x", "Q_Q", "-_-", ">_<", "<_<", ">_>",
		"v_v", "u_u", "U_U", "o_O", "O_o", "¬¨_¬¨", "TœâT", "OwO", "UwU", "TwT",
		"owo", "uwu", "ToT", "TAT", "XD", "OvO", "oVo", "TvT", "T^T", "T.T",
		"‡≤•_‡≤•", "‡≤•Ôπè‡≤•", "‡≤•‚Äø‡≤•", "‡≤•Áõä‡≤•", "‡≤•‚å£‡≤•", "‡≤•‚Ä∏‡≤•", "‡≤•‡≤•"
	)
		local currentFaceIndex = 1
	
	-- ‰øùÂ≠òËÑ∏ÂûãÁ¥¢ÂºïÂà∞ÈÖçÁΩÆÊñá‰ª∂
	fn fnSaveHeadFace =
	(
		SetINISetting iniBsBipedTools "BsBipedTools" "HeadFaceIndex" (currentFaceIndex as string)
	)
	
	-- ËøòÂéüËÑ∏ÂûãÂà∞ÂàùÂßãÁä∂ÊÄÅ
	fn fnResetHeadFace =
	(
		if (queryBox "Á°ÆÂÆöË¶ÅËøòÂéüÂ§¥ÈÉ®Ë°®ÊÉÖÂà∞ÂàùÂßãÁä∂ÊÄÅÂêóÔºü" title:"ËøòÂéüË°®ÊÉÖÁ°ÆËÆ§") then
		(
			currentFaceIndex = 1
			uiHead.text = headFaces[1]
			fnSaveHeadFace()
			messageBox "Â§¥ÈÉ®Ë°®ÊÉÖÂ∑≤ËøòÂéüÂà∞ÂàùÂßãÁä∂ÊÄÅÔºÅ" title:"BsBipedTools"
		)
	)

	local mc_setKeyColor = fnChangeThemeColor (color 240 180 180)
	local mc_spineColor  = fnChangeThemeColor (color 52 171 187)
	local mcLeft         = fnChangeThemeColor (color 120 120 193)
	local mcRight        = fnChangeThemeColor (color 53 176 53)
	local mcHead         = fnChangeThemeColor (color 160 229 248)
	local mcPevils       = fnChangeThemeColor (color 220 208 148)
	local mcLoopSel      = fnChangeThemeColor (color 200 160 200)
	local mcIK           = fnChangeThemeColor (color 223 225 71)
	local mcFK           = fnChangeThemeColor (color 160 160 160)
	local mcAllBiped     = fnChangeThemeColor (color 200 180 221)
	local mcScanBiped    = fnChangeThemeColor (color 250 200 200)
	local mcMotionPanel  = fnChangeThemeColor (color 223 225 200)
	local mcSelTools     = fnChangeThemeColor (color 20 180 180)
	local mcInPlace      = fnChangeThemeColor (color 192 192 255)
	local mcLeftFinger   = fnChangeThemeColor (color 163 61 180)
	local mcRightFinger  = fnChangeThemeColor (color 176 191 46)
	local mcLeftThumb    = fnChangeThemeColor (color 191 46 46)
	local mcRightThumb   = fnChangeThemeColor (color 241 228 157)

	label lblVersion verBsBipedTools height:15 width:30 align:#left pos:[3,0]
	button btnResetFace "‚óï" offset:[25, -5] height:15 width:15 border:false align:#right pos:[100,0] tooltip:"ËøòÂéüÂ§¥ÈÉ®Ë°®ÊÉÖÂà∞ÂàùÂßãÁä∂ÊÄÅ"
	button btnMini "‚òê" offset:[45, -5] height:15 width:20 border:false align:#right pos:[120,0]
	button uiAbout "?" offset:[-15, -5] height:15 width:20 border:false align:#left pos:[140,0]
	button btnClose "X" offset:[15, -5] height:15 width:20 border:false align:#right pos:[160,0]
	
	dropdownlist ddlAllBipedCom items:#() selection:1 \
	tooltip:"ÈÄâÊã©bipedÈ™®Êû∂" width:70 pos:[10, 20] across:2
	checkButton uiChkBtnScanBiped "All Biped" pos:[85, 20] width:60 checked:true highlightColor:mcScanBiped \
	tooltip:"Â¶ÇÊûúBipedÂèëÁîüÂèòÂåñÔºåËØ∑ÈáçÊñ∞Êâ´Êèè„ÄÇ\r\nÂ¶ÇÊûúÊúâÂ§ö‰∏™ BipedÔºåËØ∑Âú®Â∑¶Ëæπ‰∏ãÊãâÈÄâÊã©„ÄÇ\r\nËøòÂèØÁî®Êù•ÈÄâ‰∏≠ÂΩìÂâçÈ™®Êû∂ÊâÄÊúâBipedÈ™®È™º~"
	checkButton uiToggleMotionPanel "M" pos:[150, 20] width:20 checked:true highlightColor:mcMotionPanel \
	tooltip:"Â∑¶ÈîÆÁ¶ÅÁî®MotionÈù¢Êùø (Â§ßÂ§ßÂáèÂ∞ëÂç°È°ø)\r\nÂè≥ÈîÆÊÅ¢Â§ç (Â¶ÇÊú™ÊÅ¢Â§çËØ∑Âè≥ÂáªÂ§öÊ¨°)\r\nÊ≥®ÊÑèËßÇÂØüÊåâÈíÆÈ¢úËâ≤ (‰ΩÜÈ¢úËâ≤ÈáçÂêØÂ§±Êïà)\r\n(Ê≥®ÊÑè:Êüê‰∫õBipedÂäüËÉΩ‰æùËµñMotionÈù¢ÊùøÂà∑Êñ∞)"
	
	checkButton uiCkbZen "Zen" checked:true width:25 height:23 pos:[10,50] highlightColor:mcMotionPanel \
	tooltip:"Á¶ÖÊ®°ÂºèÂàáÊç¢ÔºàÊúÄÂ§ßÂåñËßÜÁ™óÔºâ"
	checkButton uiCkbHideBip "HB" checked:true width:20 height:23 pos:[40,50] highlightColor:mcMotionPanel \
	tooltip:"Â∑¶ÈîÆÂàáÊç¢ÈöêËóèÊòæÁ§∫BipedÈ™®È™º\r\nÂè≥ÈîÆÁõ¥Êé•ÈöêËóè"

	checkButton uiCkbXray "Xray" checked:true width:20 height:23 pos:[120,50] highlightColor:mcMotionPanel \
	tooltip:"Â∑¶ÈîÆXrayÊ®°ÂºèÂàáÊç¢\r\nÂè≥ÈîÆÁõ¥Êé•ÂºÄÂêØ"
	checkButton uiCkbShowBox "Box" checked:true width:25 height:23 pos:[145,50] highlightColor:mcMotionPanel \
	tooltip:"Â∑¶ÈîÆBoxÊ®°ÂºèÂàáÊç¢\r\nÂè≥ÈîÆÁõ¥Êé•ÂºÄÂêØ"

	checkBox uiChkSelHiddenObj "Select hidden biped" checked:true pos:[-99, -99]
	
	checkButton uiHead "" width: 50 height:33 checked:true highlightColor:mcHead pos:[65, 50]  --Ë°®ÊÉÖ‰ªéSoxÂ∑•ÂÖ∑ÂæóÂà∞ÁÅµÊÑü~~
	checkButton uiNecks "Necks" width: 40 height:23 checked:true highlightColor:mc_spineColor align:#center pos:[70, 85]
	
	checkButton uiRArms "" checked:true highlightColor:mcRight width:25 align:#left pos:[15, 85] across:2
	checkButton uiLArms "" checked:true highlightColor:mcLeft width:25 align:#right pos:[140, 85]
	
	checkButton uiRClavicle "Clavicle" width:55 height:18 checked:true highlightColor:mcRight across:2 pos:[25, 110]
	checkButton uiLClavicle "Clavicle" width:55 height:18 checked:true highlightColor:mcLeft pos:[100, 110]
	
	checkButton uiAllSpine height:64 width:26 checked:true highlightColor:mc_spineColor pos:[60, 130] align:#center
	checkButton uiSpine3 "3" width:30 height:16 checked:true highlightColor:mc_spineColor align:#center pos:[90, 130]
	checkButton uiSpine2 "2" width:30 height:16 checked:true highlightColor:mc_spineColor align:#center pos:[90, 146]
	checkButton uiSpine1 "1" width:30 height:16 checked:true highlightColor:mc_spineColor align:#center pos:[90, 162]
	checkButton uiSpine0 "0" width:30 height:16 checked:true highlightColor:mc_spineColor align:#center pos:[90, 178]
	
	checkButton uiCOM "COM" checked:true width:50 height:30 highlightColor:mcHead pos:[65, 195]
	checkButton uiPelvis "Pelvis" checked:true highlightColor:mcPevils width:60 height:18 pos:[60, 225]
	
	checkButton uiRUpArm "R" width:25  height:30 pos:[20, 131] checked:true highlightColor:mcRight across:2
	checkButton uiLUpArm "L" width:25  height:30 pos:[135, 131] checked:true highlightColor:mcLeft
	checkButton uiRForArm "R" width:25  height:30 pos:[20, 161] checked:true highlightColor:mcRight across:2
	checkButton uiLForArm "L" width:25  height:30 pos:[135, 161] checked:true highlightColor:mcLeft
	checkButton uiRHand "Hand" pos:[10, 191] height:25 checked:true highlightColor:mcRight across:2
	checkButton uiLHand "Hand" pos:[130, 191] height:25 checked:true highlightColor:mcLeft
	
	checkButton uiPropR "Prop" width:35 height:18 checked:true highlightColor:mcSelTools pos:[13, 223]
	checkButton uiPropL "Prop" width:35 height:18 checked:true highlightColor:mcSelTools pos:[133, 223]

	checkButton uiRThigh "R" width:30  height:30 align:#right checked:true highlightColor:mcRight pos:[58, 245] across:2
	checkButton uiLThigh "L" width:30 height:30 align:#left checked:true highlightColor:mcLeft pos:[93, 245]
	checkButton uiRCalf "R" width:30  height:30 checked:true highlightColor:mcRight align:#right  pos:[58, 275] across:2
	checkButton uiLCalf "L" width:30  height:30 checked:true highlightColor:mcLeft align:#left pos:[93, 275]
	checkButton uiRFoot "R Foot" checked:true highlightColor:mcRight align:#right pos:[45, 305] width:40 height:25 across:2
	checkButton uiLFoot "L Foot" checked:true highlightColor:mcLeft align:#left pos:[95, 305] width:40 height:25
	
	checkButton uiRLegs "" checked:true highlightColor:mcRight width:25 align:#left pos:[23, 265] across:2
	checkButton uiLLegs "" checked:true highlightColor:mcLeft width:25 align:#right pos:[132, 265]
	
	checkButton uiRToe "Toe" checked:true highlightColor:mcRight width:30 height:20 align:#left pos:[15, 310] across:2
	checkButton uiLToe "Toe" checked:true highlightColor:mcLeft width:30 height:20 align:#right pos:[135, 310]
	
	checkButton uiAllFoot "" width:50 checked:true highlightColor:mcSelTools align:#center  pos:[65, 335]
	-- checkButton uiAllBip "All Biped" width:100 checked:true highlightColor:mcAllBiped pos:[0, -4] align:#center
	checkButton uiFingers "" width:50 checked:true highlightColor:mcSelTools pos:[10, 335]
	checkButton uiPivot "" width:50 checked:true highlightColor:mcSelTools pos:[120, 335]
	

	groupbox grpKinInfo "" pos:[-10, 358] width:200 height:100
	
	checkbutton uiCbtHorTrack "" pos:[10, 370] width:30 height:25 border:false
	checkbutton uiCbtVerTrack "" pos:[40, 370] width:30 height:25 border:false
	checkbutton uiCbtTurnTrack "" pos:[70, 370] width:30 height:25 border:false
	button uiBtnComLock "" pos:[105, 370] width:30 height:25 border:false 
	checkbutton uiBtnInPlace "" pos:[140,370] width:30 height:25 \
	tooltip:"ÂéüÂú∞Ê®°ÂºèÂéªÂâçÂêé‰ΩçÁßª\r\nIn Place Mode Y\r\nÂè≥ÈîÆÁúüÂéüÂú∞Ê®°Âºè" \
	border:false highlightColor:mcInPlace

	checkButton uiBtnSetAllKey "" pos:[10, 400] across:4 width:25 height:25 border:false \
	tooltip:"Â∑¶ÈîÆÈÄâÊã©KÂ∏ß,\r\nÂè≥ÈîÆBipedÂÖ®Â∏ß." checked:true highlightColor:mcFK
	checkButton uiBtnDeleteKey "" width:25 height:25 tooltip:"Â∑¶ÈîÆÂà†Èô§ÊâÄÈÄâBipedÂΩìÂâçÊªëÊù°Â∏ß\r\nÂè≥ÈîÆÊ∏ÖÈô§BipedÊâÄÊúâÂ∏ß" \
	pos:[37, 400] border:false checked:true highlightColor:mcFK
	checkButton uiBtnLimbPK "" width:25 height:25 tooltip:"Shift + ÂçïÂáª - Â∫îÁî®‰∫éÊâÄÊúâÂ∏ßÔºå\r\nCtrl + ÂçïÂáª - Â∫îÁî®‰∫éÈÄâÂÆöÂ∏ß„ÄÇ\r\nÔºà‰ºöÂç°‰∏Ä‰∏ãÂõ†‰∏∫ÂøÖÈ°ªË¶ÅMotionÈù¢ÊùøÔºâ" \
	pos:[65, 400] border:false checked:true highlightColor:mcFK
	checkButton uiBtnLimbIK "" width:25 height:25 tooltip:"Shift + ÂçïÂáª - Â∫îÁî®‰∫éÊâÄÊúâÂ∏ßÔºå\r\nCtrl + ÂçïÂáª - Â∫îÁî®‰∫éÈÄâÂÆöÂ∏ß„ÄÇ\r\nÔºà‰ºöÂç°‰∏Ä‰∏ãÂõ†‰∏∫ÂøÖÈ°ªË¶ÅMotionÈù¢ÊùøÔºâ" \
	pos:[90, 400] border:false checked:true highlightColor:mcFK
	checkButton uiBtnLimbFK "" width:25 height:25 tooltip:"Shift + ÂçïÂáª - Â∫îÁî®‰∫éÊâÄÊúâÂ∏ßÔºå\r\nCtrl + ÂçïÂáª - Â∫îÁî®‰∫éÈÄâÂÆöÂ∏ß„ÄÇ\r\nÔºà‰ºöÂç°‰∏Ä‰∏ãÂõ†‰∏∫ÂøÖÈ°ªË¶ÅMotionÈù¢ÊùøÔºâ" \
	pos:[115, 400] border:false checked:true highlightColor:mcFK
	checkButton uiBtnTraj "" width:25 height:25
	pos:[145, 400] border:false checked:true highlightColor:mcFK
	
	
	dropdownlist uiDropPlaySpeed pos:[8, 430] items:#("1/4", "1/2", "1", "2", "4") selection:3 tooltip:"Êí≠ÊîæÈÄüÂ∫¶" width:50 
	checkbutton uiPlayBlock "" pos:[60, 430] width:30 height:21 tooltip:"Êí≠ÊîæBlocking(Êó†ËøáÂ∫¶)" border:true
	button uiBtnFrameTick "" pos:[90, 430] width:30 height:21 tooltip:"Êï¥Êï∞Â∏ß/Â∞èÊï∞Â∏ßÂàáÊç¢\r\n‰æø‰∫éÊãñÊªëÊù°ÁªÜË∞ÉÂä®Áîª" border:true
	checkbutton uiFigureMode "" pos:[120,430] width:25 height:21 tooltip:"ÂΩ¢‰ΩìÁºñËæëÊ®°Âºè\r\nFigure Mode" border:true highlightColor:mcInPlace
	button uiWorkbench "" pos:[145,430] width:27 height:21 tooltip:"BipedÊõ≤Á∫øÁºñËæë\r\nWorkbench" border:true
    
	dotNetControl dotnetTabs "System.Windows.Forms.TabControl" pos:[2,460] height:160 width:45

	--copy paste tools
	checkbutton uiCbtCopy "" pos:[50,465] width:30 height:25 visible:false checked:true highlightColor:mcFK tooltip:"Â§çÂà∂Poseture"
	checkbutton uiCbtPaste "" pos:[80,465] width:30 height:25 visible:false checked:true highlightColor:mcFK tooltip:"Á≤òË¥¥Poseture"
	checkbutton uiCbtPasteOpposite "" pos:[110,465] width:30 height:25 visible:false checked:true highlightColor:mcFK tooltip:"ÈïúÂÉèÁ≤òË¥¥Poseture"
	checkbutton uiCbtSelPostureObjs "" pos:[140,465] width:35 height:25 visible:false checked:true highlightColor:mcFK tooltip:"ÈÄâÊã©Â§çÂà∂poseÁöÑBipedÈ™®È™º"
	checkbutton uiCbtMirrorRArm "Âè≥‚ÜíÂ∑¶ËáÇ" pos:[50,495] width:60 height:25 visible:false checked:true highlightColor:mcRight
	checkbutton uiCbtMirrorLArm "Â∑¶‚ÜíÂè≥ËáÇ" pos:[115,495] width:60 height:25 visible:false checked:true highlightColor:mcLeft
	checkbutton uiCbtMirrorRLeg "Âè≥‚ÜíÂ∑¶ËÖø" pos:[50,523] width:60 height:25 visible:false checked:true highlightColor:mcRight
	checkbutton uiCbtMirrorLLeg "Â∑¶‚ÜíÂè≥ËÖø" pos:[115,523] width:60 height:25 visible:false checked:true highlightColor:mcLeft
	checkbutton uiCbtGrabPose "ÈÄüÂ≠òPose" pos:[50,550] width:60 height:25 visible:false checked:true highlightColor:mcFK
	checkbutton uiCbtLoadPose "Âä†ËΩΩPose" pos:[115,550] width:60 height:25 visible:false checked:true highlightColor:mcFK

	--layers tools
	button uiCbtDown "" pos:[50,465] width:20 height:20 visible:false border:false
	button uiCbtUp "" pos:[70,465] width:20 height:20 visible:false border:false
	label uiLblLayerID "0" pos:[95,469] width:20 height:16 visible:false style_sunkenedge:true readonly:true
	label uiLblActive "Ê¥ªÂä®" pos:[133,470] width:40 height:25 visible:false
	checkbox uiChkActive "" pos:[160,465] width:60 height:25 visible:false checked:true
	dropDownList ddlLayers "" pos:[50,489] width:110 visible:false
	checkbutton uiCbtRefreshLayer "R" pos:[160,490] width:15 height:20 visible:false checked:true highlightColor:mcScanBiped tooltip:"Âà∑Êñ∞"
	button uiCbtAddLayer "" pos:[52,514] width:30 height:20 visible:false border:false
	button uiCbtDelLayer "" pos:[82,514] width:30 height:20 visible:false border:false
	button uiCbtDownLayer "" pos:[112,514] width:30 height:20 visible:false border:false
	button uiCbtSnapKeys "" pos:[142,514] width:30 height:20 visible:false border:false tooltip:"Â∑¶ÈîÆÂê∏ÈôÑÂΩìÂâçÂ∏ßÔºåÂè≥ÈîÆÂê∏ÈôÑÂ∏ßÊ†èÊâÄÊúâÂ∏ß"
	checkbutton uiCbtLeftArm "" pos:[52,537] width:30 height:20 visible:false checked:false highlightColor:mcHead border:false
	checkbutton uiCbtRightArm "" pos:[82,537] width:30 height:20 visible:false checked:false highlightColor:mcHead border:false
	checkbutton uiCbtLeftLeg "" pos:[112,537] width:30 height:20 visible:false checked:false highlightColor:mcHead border:false
	checkbutton uiCbtRightLeg "" pos:[142,537] width:30 height:20 visible:false checked:false highlightColor:mcHead border:false
	button uiCbtUpdate "Êõ¥Êñ∞" pos:[50,560] width:65 height:20 visible:false --border:false
	checkbox uiChkIKonly "‰ªÖIK" pos:[130,560] width:100 height:20 visible:false checked:false highlightColor:mcHead tooltip:"Ê≤°ÊâæÂà∞Ëé∑ÂèñÁä∂ÊÄÅÁöÑapi...Âè™ËÉΩupdateËÆæÁΩÆ"

	--loopkey tools
	checkButton uiBtnLoopGet "ËåÉÂõ¥" tooltip:"Ëé∑ÂèñÂΩìÂâçÊó∂Èó¥ËΩ¥\r\nGet current timerange" checked:true width:43 \
	highlightColor:mcAllBiped align:#left pos:[50, 465] height:20 across:3 visible:false
	spinner uiSpnLoopStart tooltip:"Loop Range" type:#integer range:[-9999,9999,0] width:50 align:#left pos:[48, 493] visible:false
	spinner uiSpnLoopEnd tooltip:"Loop Range" type:#integer range:[-9999,9999,30] width:50 align:#left pos:[101, 493] visible:false
	checkButton uiCkbClearUserDef "X" border:true pos:[159, 465] height:70 width:16 checked:true highlightColor:mcAllBiped visible:false \
	tooltip:"Ê∏ÖÈô§ È™®Êû∂‰øùÂ≠òÁöÑÂæ™ÁéØÂ∏ßËá™ÂÆö‰πâÂ±ûÊÄßÂÄº„ÄÇ\r\nÔºàÂØπÊñá‰ª∂Êú¨Ë∫´Êó†‰ªª‰ΩïÂΩ±ÂìçÔºâ "
	checkButton uiBtnGotoMirror "Ë∑≥ËΩ¨ÂØπÁß∞Â∏ß" checked:true highlightColor:mcAllBiped tooltip:"ÊªëÊù°Ë∑≥ËΩ¨Âà∞ÈïúÂÉèÂ∏ß\r\nGoto symmetry key" \
	align:#left pos:[50, 515] height:20 width:103 across:2 visible:false

	checkButton uiBtnLoopSel "ÈÄâÊã©Â∏ß" height:20 width:57 pos:[95, 465] checked:true highlightColor:mcAllBiped align:#left \
	tooltip:"ÈÄâÊã©Âæ™ÁéØÂÜÖÁöÑÊâÄÊúâÂ∏ß\r\nSelect keys in the looping range." visible:false

	-- groupbox grpKeyList "ÂÖ≥ÈîÆÂ∏ß‰π¶Á≠æ" pos:[50, 535] width:140 height:45
	button btnKey1 "Key" width:30 height:20 pos:[50, 540] border:true
	button btnKey2 "Key" width:30 height:20 pos:[82, 540] border:true
	button btnKey3 "Key" width:30 height:20 pos:[114, 540] border:true
	button btnKey4 "Key" width:30 height:20 pos:[146, 540] border:true
	button btnKey5 "Key" width:30 height:20 pos:[50, 560] border:true
	button btnKey6 "Key" width:30 height:20 pos:[82, 560] border:true
	button btnKey7 "Key" width:30 height:20 pos:[114, 560] border:true
	button btnKey8 "Key" width:30 height:20 pos:[146, 560] border:true


	--other tools
	checkButton uiBtn0 "0" pos:[50,465] width:30 height:25 tooltip:"Êõ≤ÊüÑÊâìÁõ¥ Continuity (TCB)\r\nCtrl/Shift ÂèØÊâπÂ§ÑÁêÜ\r\nESCÂèØ‰∏≠Êñ≠" border:true visible:false checked:true highlightColor:mcInPlace
	checkButton uiBtn25 "25" pos:[82,465] width:30 height:25 tooltip:"Êõ≤ÊüÑÈªòËÆ§ Continuity (TCB)\r\nCtrl/Shift ÂèØÊâπÂ§ÑÁêÜ\r\nESCÂèØ‰∏≠Êñ≠" border:true visible:false checked:true highlightColor:mcInPlace
	checkButton uiBtnLoadBip "S" pos:[114, 465] width:30 height:25 tooltip:"" border:true visible:false checked:true highlightColor:mcInPlace
	checkButton uiBtnSaveBip "L" pos:[146, 465] width:30 height:25 tooltip:"" border:true visible:false checked:true highlightColor:mcInPlace

	-- label uiLblTitle "BsBipedTools_v1.0" height:16 width:rolBsBipedTools.width pos:[5, 585]
	timer clock "PlayClock" interval:1 active:false -- Í∞ÄÏû• Îπ†Î•∏ Ïù∏ÌÑ∞Î≤åÎ°ú
--/////////////////////////////////////////////////////////////////////////////////////////////////
    button btnAddScale "Ê∑ªÂä†Áº©Êîæ" pos:[50,495] width:62

    button btnRemoveScale "ÁßªÈô§Áº©Êîæ" pos:[114,495] width:62
	
	local arrLoopTools = #("Âæ™ÁéØ",#(uiBtnLoopGet,uiSpnLoopStart,uiSpnLoopEnd,uiCkbClearUserDef,uiBtnLoopSel,uiBtnGotoMirror,\
		btnKey1,btnKey2,btnKey3,btnKey4,btnKey5,btnKey6,btnKey7,btnKey8))
	local arrOtherTools = #("ÂÖ∂‰ªñ",#(uiBtn0,uiBtn25,uiBtnLoadBip,uiBtnSaveBip,btnAddScale,btnRemoveScale)) 
	local arrLayerTools = #("Â±ÇÂ±Ç",#(uiCbtRefreshLayer,uiCbtDown,uiCbtUp,uiLblLayerID,uiLblActive,uiChkActive,uiCbtAddLayer,\
		uiCbtDelLayer,uiCbtDownLayer,uiCbtSnapKeys,uiCbtLeftArm,uiCbtRightArm,uiCbtLeftLeg,uiCbtRightLeg,uiCbtUpdate,uiChkIKonly,ddlLayers))
	local arrCopyTools = #("Â§çÂà∂",#(uiCbtCopy,uiCbtPaste,uiCbtPasteOpposite,uiCbtSelPostureObjs,uiCbtMirrorLArm,uiCbtMirrorRArm,\
		uiCbtMirrorLLeg,uiCbtMirrorRLeg,uiCbtGrabPose,uiCbtLoadPose))
	local arrAllToolsTab = #(arrCopyTools,arrLayerTools,arrLoopTools,arrOtherTools)

	local m_goto1; local m_goto2; local m_goto3; local m_goto4; local m_goto5; local m_goto6; local m_goto7; local m_goto8

	fn fnChangeToolsVisble id =
	(
		for i = 1 to arrAllToolsTab.count do 
		(
			if i == id then
			(
				for j in arrAllToolsTab[i][2] do j.visible = true
			)
			else (for j in arrAllToolsTab[i][2] do j.visible = false)
		)
	)

	-- fn fnDotnetBitmap fName =
	-- (
	-- 	if doesFileExist fName then
	-- 	(
	-- 		local img = (dotnetclass "System.Drawing.Image").fromfile fName 
	-- 		local retBmp = dotnetObject "System.Drawing.Bitmap" (img.Width) (img.height)
	-- 		local g = (dotnetclass "system.drawing.graphics").fromImage retBmp
	-- 		g.drawimage img 0 0 	
	-- 		img.Dispose();
	-- 		retBmp
	-- 	)
	-- 	else return undefined
	-- )

	fn fnInitDotTabs =
	(
		-- imgTab1 = fnDotnetBitmap @"D:\Download\paste (2).png"
		-- imgTab2 = fnDotnetBitmap @"D:\Download\ÂõæÂ±Ç (4).png"
		-- imgTab3 = fnDotnetBitmap @"D:\Download\ÂõæÂ±Ç (4).png"
		-- imgTab4 = fnDotnetBitmap @"D:\Download\ÂõæÂ±Ç (4).png"
		-- -- imgTab1 = dotNetObject "System.Drawing.Bitmap" imgPath
		-- imageList = dotNetObject "System.Windows.Forms.ImageList"

		-- imageList.ImageSize = dotNetObject "System.Drawing.Size" 20 20
		-- imageList.images.add(imgTab1)
		-- imageList.images.add(imgTab2)
		-- imageList.images.add(imgTab3)
		-- imageList.images.add(imgTab4)

		dotnetTabs.sizeMode  = dotnetTabs.sizeMode.Fixed
		dotnetTabs.itemSize  = dotNetObject "System.Drawing.Size" 29 40
		dotnetTabs.dock      = dotnetTabs.dock.Fill
		dotnetTabs.Drawmode  = dotnetTabs.Drawmode.OwnerDrawFixed
		dotnetTabs.alignment = (dotnetclass "system.Windows.Forms.Tabalignment").left

		for aTab = 1 to arrAllToolsTab.count do
		(
			dotnetTabs.TabPages.add arrAllToolsTab[aTab][1]
			-- dotnetTabs.TabPages.item[aTab - 1].ImageIndex = aTab - 1
			-- dotnetTabs.TabPages.item[aTab - 1].text = ""
			-- print  aTab[1]
		)
		-- dotnetTabs.imagelist = imageList
	)

	on dotnetTabs Selected itm do
	(
		arrID = (itm.TabPageIndex + 1)
		if LastSubRollout != arrID do --do not update if the same tab clicked twice
		(
			fnChangeToolsVisble arrID
		) 
	)

	fn fnApplyIcons =
	(
		uiBtnSetAllKey.images      = #("bip_ikkey_i.bmp","bip_ikkey_i.bmp",8,1,1,1,1,true,true)
		uiBtnDeleteKey.images      = #("bip_keyframe_i.bmp","bip_keyframe_i.bmp",46,3,3,3,3,true,true)
		uiBtnLimbPK.images         = #("bip_ikkey_i.bmp","bip_ikkey_i.bmp",8,3,3,3,3,true,true)
		uiBtnLimbIK.images         = #("bip_ikkey_i.bmp","bip_ikkey_i.bmp",8,5,5,5,5,true,true)
		uiBtnLimbFK.images         = #("bip_ikkey_i.bmp","bip_ikkey_i.bmp",8,7,7,7,7,true,true)
		uiPlayBlock.images         = #("bip_mfltrans_i.bmp","bip_mfltrans_i.bmp",26,21,21,21,21,true,true)
		uiToggleMotionPanel.images = #("bip_pivselbig_i.bmp","bip_pivselbig_i.bmp",6,6,6,6,6,true,true)
		uiCkbShowBox.images        = #("UVWUnwrapView_16i.bmp","UVWUnwrapView_16a.bmp",28,9,9,9,9,true,false)
		uiCkbXray.images           = #("bip_modes_i.bmp","bip_modes_i.bmp",8,2,2,2,2,true,true)
		uiCkbHideBip.images        = #("bip_tracksel_i.bmp","bip_tracksel_i.bmp",10,7,7,7,7,true,true)
		uiCkbZen.images            = #("FileLinkActionItems_16i.bmp","FileLinkActionItems_16i.bmp",9,5,5,5,5,true,true)
		uiBtnFrameTick.images      = #("AutoGrid_16i.bmp","AutoGrid_16i.bmp",2,2,2,2,2,true,true)
		uiBtnTraj.images           = #("bip_keyframe_i.bmp","bip_keyframe_i.bmp",46,29,29,29,29,true,true)
		uiRArms.images             = #("AddPreset_16i.bmp","AddPreset_16i.bmp",1,1,1,1,1,true,true)
		uiLArms.images             = #("AddPreset_16i.bmp","AddPreset_16i.bmp",1,1,1,1,1,true,true)
		uiRLegs.images             = #("AddPreset_16i.bmp","AddPreset_16i.bmp",1,1,1,1,1,true,true)
		uiLLegs.images             = #("AddPreset_16i.bmp","AddPreset_16i.bmp",1,1,1,1,1,true,true)
		uiAllFoot.images           = #("bip_modes_i.bmp","bip_modes_i.bmp",8,4,3,4,3,true,true)
		uiBtnInPlace.images        = #("bip_general_i.bmp","bip_general_i.bmp",30,27,27,27,27,true,true)
		uiBtnSaveBip.images        = #("bip_general_i.bmp","bip_general_i.bmp",30,7,7,7,7,true,true)
		uiBtnLoadBip.images        = #("bip_general_i.bmp","bip_general_i.bmp",30,5,5,5,5,true,true)
		uiFigureMode.images        = #("bip_modes_i.bmp","bip_modes_i.bmp",8,1,1,1,1,true,true)
		uiWorkbench.images         = #("bip_workbench_i.bmp","bip_workbench_i.bmp",10,7,7,7,7,true,true)
		uiCbtCopy.images           = #("bip_keyframe_i.bmp","bip_keyframe_i.bmp",46,9,9,9,9,true,true)
		uiCbtSelPostureObjs.images = #("bip_mflshare_i.bmp","bip_mflshare_i.bmp",2,2,2,2,2,true,true)
		uiCbtPaste.images          = #("bip_keyframe_i.bmp","bip_keyframe_i.bmp",46,17,17,17,17,true,true)
		uiCbtPasteOpposite.images  = #("bip_keyframe_i.bmp","bip_keyframe_i.bmp",46,19,19,19,19,true,true)
		uiCbtUp.images             = #("bip_layer_i.bmp","bip_layer_i.bmp",24,1,1,1,1,true,true)
		uiCbtDown.images           = #("bip_layer_i.bmp","bip_layer_i.bmp",24,3,3,3,3,true,true)
		uiCbtAddLayer.images       = #("bip_layer_i.bmp","bip_layer_i.bmp",24,5,5,5,5,true,true)
		uiCbtDelLayer.images       = #("bip_layer_i.bmp","bip_layer_i.bmp",24,7,7,7,7,true,true)
		uiCbtDownLayer.images      = #("bip_layer_i.bmp","bip_layer_i.bmp",24,13,13,13,13,true,true)
		uiCbtSnapKeys.images       = #("bip_layer_i.bmp","bip_layer_i.bmp",24,15,15,15,15,true,true)
		uiCbtLeftArm.images        = #("bip_layer_i.bmp","bip_layer_i.bmp",24,17,17,17,17,true,true)
		uiCbtRightArm.images       = #("bip_layer_i.bmp","bip_layer_i.bmp",24,19,19,19,19,true,true)
		uiCbtLeftLeg.images        = #("bip_layer_i.bmp","bip_layer_i.bmp",24,21,21,21,21,true,true)
		uiCbtRightLeg.images       = #("bip_layer_i.bmp","bip_layer_i.bmp",24,23,23,23,23,true,true)
		uiFingers.images           = #("curvecontrol_defstat_i.bmp","curvecontrol_defstat_i.bmp",13,5,5,5,5,true,true)
		uiPivot.images             = #("bip_mflshare_i.bmp","bip_mflshare_i.bmp",2,2,2,2,2,true,true)
		uiCbtHorTrack.images       = #("bip_tracksel_i.bmp","bip_tracksel_i.bmp",10,1,1,1,1,true,true)
		uiCbtVerTrack.images       = #("bip_tracksel_i.bmp","bip_tracksel_i.bmp",10,3,3,3,3,true,true)
		uiCbtTurnTrack.images      = #("bip_tracksel_i.bmp","bip_tracksel_i.bmp",10,5,5,5,5,true,true)
		uiBtnComLock.images        = #("LockButtonExt_i.bmp","LockButtonExt_i.bmp",2,1,1,1,1,true,true)
	)

	fn fnDeleteUserProp nodeBipRoot prop = if getUserProp nodeBipRoot prop != undefined do
	(
		buff = (getUserPropBuffer nodeBipRoot) as stringStream 
		newb = stringStream ""
		while not eof buff do
		(
			str = readLine buff
			if str != "" and not matchpattern str pattern:("*" + prop + "*=*") do format "%\n" str to:newb
		)
		setUserPropBuffer nodeBipRoot (replace_LF_with_CRLF (newb as string))
		return ok
	)

    local m_workingBipRoot -- ÌòÑÏû¨ ÏûëÏóÖÏ§ëÏù∏ Î∞îÏù¥Ìå®ÎìúÏùò Î£®Ìä∏ ÎÖ∏Îìú
    
	-- ÏãúÏù∏ÏÑ±ÏùÑ ÏúÑÌï¥ ÏòàÏô∏Ï†ÅÏúºÎ°ú m_ Îí§Ïóê ÎåÄÎ¨∏Ïûê ÏÇ¨Ïö©
	-- Î™®Îì† Î∂ÄÏúÑ Î≥ÄÏàòÎì§ÏùÄ Î∞∞Ïó¥
	local m_Head
	local m_RArms
	local m_Necks
	local m_LArms
	local m_RClavicle
	local m_LClavicle
	local m_RUpArm
	local m_AllSpine
	local m_Spine2
	local m_Spine1
	local m_Spine0
	local m_LUpArm
	local m_RForArm
	local m_LForArm
	local m_RHand
	local m_COM
	local m_LHand
	local m_Pelvis
	local m_RThigh
	local m_LThigh
	local m_RCalf
	local m_LCalf
	local m_RFoot
	local m_LFoot
	local m_RToe
	local m_LToe
	local m_RLegs
	local m_AllFoot
	local m_LLegs
	local m_AllBip
	local m_LProp
	local m_RProp
    
    local m_PBKeyTimeArray      -- Î∏îÎü≠ÌÇπ Ïï†ÎãàÎ©îÏù¥ÏÖòÏö© ÌÇ§ ÌÉÄÏûÑ Î∞∞Ïó¥ Î°úÏª¨ Î≥ÄÏàò (Frame)
    local m_PBKeyMiliSecArray  -- Î∏îÎü≠ÌÇπ Ïï†ÎãàÎ©îÏù¥ÏÖòÏö© ÌÇ§ ÌÉÄÏûÑ Î∞∞Ïó¥ Î°úÏª¨ Î≥ÄÏàò (Î∞ÄÎ¶¨ÏÑ∏Ïª®Îìú)
    local m_PBStartTime     -- Î∏îÎü≠ÌÇπ Ïï†ÎãàÎ©îÏù¥ÏÖò Î∞òÎ≥µ ÏãúÏûëÏãúÍ∞Ñ ÎπÑÍµêÏö© Í∏∞Î°ù
    local m_PBPointer       -- Ïñ¥ÎîîÍπåÏßÄ Ïû¨ÏÉùÏ§ëÏù∏ÏßÄ Í∏∞Î°ùÌïòÎäî Ìè¨Ïù∏ÌÑ∞
    local m_PBPlaySpeed     -- Ïû¨ÏÉù ÏÜçÎèÑ Í∞ÄÏÜç Í∞êÏÜçÏö©, uiDropPlaySpeed ÏôÄ Ïó∞ÎèôÎê®
	
	struct BipType
	(
		limbName,
		linkIndex
    )
    
    function SetPBPlaySpeed = (
        case timeConfiguration.playbackSpeed of (
        1: (m_PBPlaySpeed = 4.0) -- 1/4 ÏÜçÎèÑÎùºÏÑú 4Î∞∞ Îçî ÌÅ∞ ÏãúÍ∞Ñ Í∞íÏùÑ Ï†ÅÏö©Ìï¥ÏïºÌï®
        2: (m_PBPlaySpeed = 2.0)
        3: (m_PBPlaySpeed = 1.0)
        4: (m_PBPlaySpeed = 0.5)
        5: (m_PBPlaySpeed = 0.25) -- 4Î∞∞ ÏÜçÎèÑÎùºÏÑú 0.25Î∞∞ ÏûëÏùÄ ÏãúÍ∞ÑÍ∞íÏùÑ Ï†ÅÏö©Ìï¥ÏïºÌï®
        )
    )

	-- Î∞îÏù¥Ìå®Îìú COMÏù∏ÏßÄ Í≤ÄÏÇ¨
	fn IfBipRoot obj = (
		if ((classof obj.baseobject) == Biped_Object and ((classof obj.controller == Vertical_Horizontal_Turn) or (classof obj.controller == BipSlave_Control))) do (
			if (obj.controller.rootNode == obj) do (return true)
		)
		return false
	)

	fn SaveRangeLoop = (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do return ()
		setUserProp m_workingBipRoot "BsBT_RangeLoopStart" uiSpnLoopStart.value
		setUserProp m_workingBipRoot "BsBT_RangeLoopEnd" uiSpnLoopEnd.value
	)

	fn LoadRangeLoop = (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do return ()
		try (
			uiSpnLoopStart.value = getUserProp m_workingBipRoot "BsBT_RangeLoopStart"
			uiSpnLoopEnd.value = getUserProp m_workingBipRoot "BsBT_RangeLoopEnd"
		) catch ()
	)

	function LoadGoto = (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do return ()
		try (
			m_goto1 = getUserProp m_workingBipRoot "BsBT_Goto1"
			if (m_goto1 == "undefined") do (m_goto1 = undefined)
			m_goto2 = getUserProp m_workingBipRoot "BsBT_Goto2"
			if (m_goto2 == "undefined") do (m_goto2 = undefined)
			m_goto3 = getUserProp m_workingBipRoot "BsBT_Goto3"
			if (m_goto3 == "undefined") do (m_goto3 = undefined)
			m_goto4 = getUserProp m_workingBipRoot "BsBT_Goto4"
			if (m_goto4 == "undefined") do (m_goto4 = undefined)
			m_goto5 = getUserProp m_workingBipRoot "BsBT_Goto5"
			if (m_goto5 == "undefined") do (m_goto5 = undefined)
			m_goto6 = getUserProp m_workingBipRoot "BsBT_Goto6"
			if (m_goto6 == "undefined") do (m_goto6 = undefined)
			m_goto7 = getUserProp m_workingBipRoot "BsBT_Goto7"
			if (m_goto7 == "undefined") do (m_goto7 = undefined)
			m_goto8 = getUserProp m_workingBipRoot "BsBT_Goto8"
			if (m_goto8 == "undefined") do (m_goto8 = undefined)
		) catch ()
	)

    function SaveGoto ui val index = (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do return ()
		local pString = "BsBT_Goto" + (index as string)
		try (
			setUserProp m_workingBipRoot pString val
		) catch ()
	)

	function SetGotoBtnTextSub ui val = (
		local tString
		if (val == undefined) then (tString = "Key") else (tString = (val as string))
		ui.text = tString
		ui.tooltip = tString
	)

	function SetGotoBtnText = (
		SetGotoBtnTextSub btnKey1 m_goto1
		SetGotoBtnTextSub btnKey2 m_goto2
		SetGotoBtnTextSub btnKey3 m_goto3
		SetGotoBtnTextSub btnKey4 m_goto4
		SetGotoBtnTextSub btnKey5 m_goto5
		SetGotoBtnTextSub btnKey6 m_goto6
		SetGotoBtnTextSub btnKey7 m_goto7
		SetGotoBtnTextSub btnKey8 m_goto8
	)

	-- m_goto1 Îì±Ïùò Î≥ÄÏàòÎ•º Ï∞∏Ï°∞ ÌòïÏãùÏúºÎ°ú &val Îß§Í∞úÎ≥ÄÏàòÏóê Ï†ÑÎã¨
	function GotoFrame ui &val index setKey:false = (
		if (setKey) then (
			if (ui.text == "Key") then 
			(
				val = int sliderTime
				SetGotoBtnText()
				SaveGoto ui val index
			)
			else
			(
				if (queryBox "ÂΩìÂâçÂ∑≤ËÆæÂÆöË∑≥ËΩ¨Â∏ß,ÊòØÂê¶Ê∏ÖÈô§Ôºü                   " beep:false) then
				(
					val = undefined
					SetGotoBtnText()
					SaveGoto ui val index
				)
			)
			return ()
		)
		else 
		(
			if (ui.text == "Key") then 
			(
				val = int sliderTime
				SetGotoBtnText()
				SaveGoto ui val index
			)
			else
			(
				if (val != undefined) do (
					try (
						sliderTime = val
					) catch ()
				)
			)
		)
	)
	
		-- Î¶¨ÌÑ¥ Ïä§Ìä∏Îü≠Ï≥êÏùò Î©§Î≤Ñ : limbName, linkIndex
	function GetBipedType obj = (
		if ( obj == undefined ) do return undefined
		if ( (classof obj.baseobject) != Biped_Object ) do return (bipType limbName:#nonBiped linkIndex:0)
		
		-- biped.maxNumLinks $ Ïù¥ Î∞©Î≤ïÏúºÎ°ú Î∞îÏù¥Ìå®ÎìúÏùò ÏµúÎåÄ ÎßÅÌÅ¨ ÏàòÎ•º ÏïåÏïÑÎÇº Ïàò ÏûàÎã§. Î≥¥ÌÜµ 25Ïù¥ÏßÄÎßå ÎÑâÎÑâÌïòÍ≤å 30
		loopCount = 30
		types = #(
			#larm,
			#rarm,
			#lfingers,
			#rfingers,
			#lleg,
			#rleg,
			#ltoes,
			#rtoes,
			#spine,
			#tail,
			#head,
			#pelvis,
			#vertical,
			#horizontal,
			#turn,
			#footprints,
			#neck,
			#pony1,
			#pony2,
			#prop1,
			#prop2,
			#prop3,
			#lfArmTwist,
			#rfArmTwist,
			#lUparmTwist,
			#rUparmTwist,
			#lThighTwist,
			#rThighTwist,
			#lCalfTwist,
			#rCalfTwist,
			#lHorseTwist,
			#rHorseTwist			
		)
		
		for o in types do (
			for p = 1 to loopCount do (
				if ( try ( obj == biped.getNode obj o link:p ) catch false ) do (
					returnType = (bipType limbName:o linkIndex:p)
					return returnType
				)
			)
		)
		
		-- Îß•Ïä§ Ïä§ÌÅ¨Î¶ΩÌä∏ÏóêÏÑú Xtra Î≥∏ÏùÑ Ï†ÑÌòÄ ÏßÄÏõêÌïòÏßÄ ÏïäÏïÑÏÑú Ïñ¥Ï©î Ïàò ÏóÜÏù¥ Î∞îÏù¥Ìå®Îìú ÌÅ¥ÎûòÏä§Ïù∏Îç∞ Ï†ïÏ≤¥Î•º ÏïåÏïÑÎÇ¥ÏßÄ Î™ªÌïúÍ±¥ Î™®Îëê XtraÎ°ú Ï†ïÏùò
		-- https://forums.cgsociety.org/t/biped-xtra-maxscript-commands/1570351/5 Ïà®Í≤®ÏßÑ Î∞îÏù¥Ìå®Îìú Xtra Ìï®ÏàòÎì§ÏùÑ Ï¢Ä ÏÇ¥Ìé¥Î¥êÏïºÌï†ÎìØ.
		return (bipType limbName:#xtra linkIndex:0)
	)
	
	-- ÌòÑÏû¨ Ïò§Î∏åÏ†ùÌä∏Í∞Ä Ïï†ÎãàÎ©îÏù¥ÏÖò ÌÇ§ ÏßÄÏ†ïÏù¥ Í∞ÄÎä•Ìïú Î∞îÏù¥Ìå®ÎìúÏù∏ÏßÄÎ•º Í≤ÄÏÇ¨ true ÏôÄ false Î¶¨ÌÑ¥
	function IfKeyableBip obj =
	(
		if ( classof obj.baseobject != Biped_object ) do return false
		
		tType = GetBipedType obj
		
		returnBool = case tType.limbName of
		(
			#footprints: false
			#lfArmTwist: false
			#rfArmTwist: false
			#lUparmTwist: false
			#rUparmTwist: false
			#lThighTwist: false
			#rThighTwist: false
			#lCalfTwist: false
			#rCalfTwist: false
			#lHorseTwist: false
			#rHorseTwist: false
			default: true
		)
		return returnBool
	)
	
	-- Î∞îÏù¥Ìå®Îìú Î∂ÄÏúÑÎì§ Ï§ë Limb, COM, NoKey, Etc Î•º Íµ¨Î∂ÑÌïòÏó¨ Î¶¨ÌÑ¥ (Ïï†ÎãàÎ©îÏù¥ÏÖò ÌÇ§ Î≥µÏ†ú Î∞©ÏãùÏù¥ Îã§Î¶Ñ)
	function GetBipKeyType obj = (
		if ( classof obj.baseobject != Biped_object ) do return false
		
		tType = GetBipedType obj

		if tType.limbName == #vertical OR\
			tType.limbName == #horizontal OR\
			tType.limbName == #turn do (
			return "COM"
		)

		if tType.limbName == #larm OR\
			tType.limbName == #rarm OR\
			tType.limbName == #lleg OR\
			tType.limbName == #rleg OR\
			tType.limbName == #ltoes OR\
			tType.limbName == #rtoes do (
				return "Limb"
		)

		if tType.limbName == #lfArmTwist OR\
			tType.limbName == #rfArmTwist OR\
			tType.limbName == #lUparmTwist OR\
			tType.limbName == #rUparmTwist OR\
			tType.limbName == #lThighTwist OR\
			tType.limbName == #rThighTwist OR\
			tType.limbName == #lCalfTwist OR\
			tType.limbName == #rCalfTwist OR\
			tType.limbName == #lHorseTwist OR\
			tType.limbName == #rHorseTwist OR\
			tType.limbName == #footprints do (
				return "NoKey"
		)
		
		return "Etc"
	)

	-- Î∞îÏù¥Ìå®Îìú Limb Ï†ÑÏö© Í∏∞Îä•ÏùÑ ÏúÑÌï¥ Limb Ïù∏ÏßÄ Ï≤¥ÌÅ¨ÌïòÎäî Ìï®Ïàò
	function IfLimb obj = (
		if ( classof obj.baseobject != Biped_object ) do return false
		tType = GetBipedType obj
		if tType.limbName == #larm OR\
			tType.limbName == #rarm OR\
			tType.limbName == #lleg OR\
			tType.limbName == #rleg OR\
			tType.limbName == #ltoes OR\
			tType.limbName == #rtoes do (
				return true
		)
		return false
	)
	
    fn DeselectAllKeys obj = (
		-- Ï≤òÏùåÏóî Î≥µÏû°Ìïú Î∞©Î≤ïÏúºÎ°ú ÏùºÏùºÏù¥ ÌÇ§ ÌïòÎÇòÏî© Î£®ÌîÑ ÎèåÏïÑÍ∞ÄÎ©∞ ÏÑ†ÌÉù Ìï¥Ï†úÌñàÎäîÎç∞, Î≠âÎö±Í∑∏Î†§ÏÑú controller Î°ú ÌïòÎãà Ïûò ÎêòÎäîÎìØ
		deselectKeys obj.controller
	)
	
	-- Ïù¥ Ìï®ÏàòÎäî ÏÇ≠Ï†ú Ï†Ñ Deselect Îäî Í≥†Î†§ÌïòÏßÄ ÏïäÏùå. (Í∏∞Ï°¥Ïóê Deselect ÎêòÏñ¥ÏÑú ÏßÑÏûÖÌïú Í≤ÉÏùÑ Ï†ÑÏ†úÎ°ú Ìï®)
	fn TrimKeys controller frameStart frameEnd ifBip = (
		local firstKeyTime
		local lastKeyTime
		if (ifBip) then (
			local keyCount = numKeys controller
			if keyCount < 1 do return()
			firstKeyTime = (getKey controller 1).time
			lastKeyTime = (getKey controller keyCount).time
		)
		else (
			firstKeyTime = -99999
			lastKeyTime = 99999
		)

		if (firstKeyTime < frameStart) do (
			-- Î≥¥Ï°¥ Íµ¨Í∞ÑÎ≥¥Îã§ ÏïûÏ™ΩÏóê ÌÇ§Í∞Ä ÏûàÎäî Í≤ΩÏö∞
			selectKeys controller (interval firstKeyTime (frameStart - 1))
		)
		if (lastKeyTime > frameEnd) do (
			-- Î≥¥Ï°¥ Íµ¨Í∞ÑÎ≥¥Îã§ Îí§Ï™ΩÏóê ÌÇ§Í∞Ä ÏûàÎäî Í≤ΩÏö∞
			selectKeys controller (interval lastKeyTime (frameEnd + 1))
		)

		if (ifBip) then (
			biped.deleteKeys controller #selection
		)
		else (
			deleteKeys controller #selection
		)
	)

    -- obj Ïùò Î™®Îì† ÏûêÏãùÎì§ÏùÑ Î∞∞Ïó¥Î°ú Î¶¨ÌÑ¥. Î∞∞Ïó¥ ÏàúÏÑúÎäî Í≥ÑÏ∏µÍµ¨Ï°∞ ÏàúÏÑúÎåÄÎ°ú
	function fnGetAllChildren obj = (
		if ( obj == undefined ) do return undefined
		
		local tAllChildren = #()
		if ( obj.children.count != 0 ) do (
			for o in obj.children where not isDeleted o and (classof o.baseobject == Biped_Object or (classof o.controller == Vertical_Horizontal_Turn)) do (
				append tAllChildren o
				if ( o.children.count != 0 ) do (
					tAllChildren = tAllChildren +  (fnGetAllChildren o)		-- recursive
				)
			)
		)
		return tAllChildren
	)

	fn fnSelAllChildrens arrObj =
	(
		clearselection()
		for o in arrObj where isvalidnode o do
		(
			selectmore o
			selectmore (fnGetAllChildren o)
		)
	)
	
    fn SetComBtnText state = (
        if state then (
            uiCOM.text = m_workingBipRoot.name
        )
        else (
            uiCOM.text = "COM"
        )
    )

    fn SetButtonState state = (
        uiHead.state = state
        uiRArms.state = state
        uiNecks.state = state
        uiLArms.state = state
        uiRClavicle.state = state
        uiLClavicle.state = state
        uiRUpArm.state = state
		uiAllSpine.state = state
		uiSpine3.state = state
		uiSpine2.state = state
		uiSpine1.state = state
		uiSpine0.state = state
        uiLUpArm.state = state
        uiRForArm.state = state
        uiLForArm.state = state
        uiRHand.state = state
        uiCOM.state = state
        if state == false do uiCOM.text = "COM"
        uiLHand.state = state
        uiPelvis.state = state
        uiRThigh.state = state
        uiLThigh.state = state
        uiRCalf.state = state
        uiLCalf.state = state
        uiRFoot.state = state
		uiLFoot.state = state
		uiRToe.state = state
		uiLToe.state = state
        uiRLegs.state = state
        uiAllFoot.state = state
        uiLLegs.state   = state
		-- uiAllBip.state = state
		uiPlayBlock.state = state
		uiFingers.state   = state
		uiPropR.state      = state
		uiPivot.state     = state
		uiPropL.state     = state
		uiCkbHideBip.state = state
		uiCkbXray.state = state
		uiCkbShowBox.state = state
		uiCkbZen.state = state
		uiCbtMirrorLLeg.state = state
		uiCbtMirrorRLeg.state = state
		uiCbtMirrorLArm.state = state
		uiCbtMirrorRArm.state = state
    )

	-- Ïî¨ ÎÇ¥ Î∞îÏù¥Ìå®Îìú Ïò§Î∏åÏ†ùÌä∏Î•º Î™®Îëê Ï°∞ÏÇ¨ÌïòÏó¨ Î∞îÏù¥Ìå®ÎìúÍ∞Ä ÌïòÎÇòÎßå ÏûàÏúºÎ©¥ Í∑∏ Î∞îÏù¥Ìå®ÎìúÎ•º m_workingBipRootÏóê ÏÑ∏ÌåÖ.
	-- ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Ïò§Î∏åÏ†ùÌä∏Í∞Ä Î∞îÏù¥Ìå®ÎìúÎ©¥ Í∑∏Í≤ÉÏùÑ ÏÑ∏ÌåÖ
	-- ÏÑ†ÌÉùÏù¥ ÏÑ±Í≥µÌïòÎ©¥ true, Ïã§Ìå®ÌïòÎ©¥ false Î¶¨ÌÑ¥
	function AutoGetBipRoot = 
	(
		if rolBsBipedTools.ddlAllBipedCom.selection != 0 then 
		(
			bipedCom = arrAllBipedCom[rolBsBipedTools.ddlAllBipedCom.selection]
			if not isDeleted bipedCom and isvalidnode bipedCom then 
			(
				if ( try(classof bipedCom.baseobject == Biped_object) catch false ) do (
					try
					(
						m_workingBipRoot = bipedCom.controller.rootnode
						SetComBtnText true
						return true
					)
					catch()
				)
			)
		)
		for o in objects where not isDeleted o and isvalidnode o do (
			try(
				if (classof o.baseobject == Biped_object) do (
					m_workingBipRoot = o.controller.rootnode
					SetComBtnText true
					if not isDeleted m_workingBipRoot then return true
				)
			)catch()
		)
		m_workingBipRoot = undefined -- Ïî¨ÏùÑ ÏÉàÎ°ú Ïò§ÌîàÌïúÎã§Í±∞ÎÇò ÌïòÎ©¥ ÏÇ≠Ï†úÎêú Ïò§Î∏åÏ†ùÌä∏Î•º Í∏∞ÏñµÌïòÍ≥† ÏûàÏùÑ Ïàò ÏûàÏñ¥ÏÑú (undefined ÏïÑÎãò) Î∞òÎìúÏãú undefined Î°ú Ï¥àÍ∏∞ÌôîÌï¥Ï§òÏïºÌï®.
		SetComBtnText false
		SetButtonState false
		return false
	)

	fn fnGetDisplayNames =
	(
		local a_displayNames = deepCopy a_layerNames
		for i = 1 to a_displayNames.count-1 do
		(
			if (biped.getLayerActive ctrl i) then
			(
				a_displayNames[i+1] = a_layerNames[i+1]
			)
			else
			(
				a_displayNames[i+1] = "* " + a_layerNames[i+1]
			)	
		)
		
		a_displayNames
	)

	fn fnSyncBipedPanel =
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
		numLayers = biped.numLayers m_workingBipRoot.controller
		layerIndex = biped.getCurrentLayer m_workingBipRoot.controller
	)

	fn fnIsValidBiped =
	(
		if m_workingBipRoot != undefined AND NOT isDeleted m_workingBipRoot then
		(
			return true
		)
		return false
	)
	
	mapped fn fnProcessTCB obj val =
	(
		if fnIsValidBiped() then
		(
			try
			(
				if obj == m_workingBipRoot then
				(
					(biped.getKey obj.controller[1].controller (getkeyindex obj.controller[1].controller slidertime)).continuity = val
					(biped.getKey obj.controller[2].controller (getkeyindex obj.controller[2].controller slidertime)).continuity = val
					(biped.getKey obj.controller[3].controller (getkeyindex obj.controller[3].controller slidertime)).continuity = val
				)
				else
				(
					(biped.getKey obj.controller (getkeyindex obj.controller slidertime)).continuity = val
				)
			)catch()
		)
	)

	fn fnEvaluateTCB val =
	(
		if fnIsValidBiped() then
		(
			if selection.count > 0 do
			(
				if keyboard.shiftPressed OR keyboard.controlPressed then
				(
					slidertime = 0
					for t = animationRange.start to animationRange.end while not keyboard.escPressed do
					(
						at time t (rolBsBipedTools.fnProcessTCB (selection as array) val)
						slidertime += 1
					)
					messagebox "ÊâÄÈÄâÁâ©‰ΩìÁöÑ TCB ÂÄºÊâπÈáèÂ§ÑÁêÜÂÆåÊØï„ÄÇ" title:"BsBipedTools"
				)
				else
				(
					rolBsBipedTools.fnProcessTCB (selection as array) val
				)
			)
		)
	)

	fn fnBSUpdateLayers =
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
		if fnIsValidBiped() then
		(
			ctrl = m_workingBipRoot.controller
			if m_LHand[1] != undefined then uiCbtLeftArm.checked = biped.getLimbRetargetState m_LHand[1]
			if m_RHand[1] != undefined then uiCbtRightArm.checked = biped.getLimbRetargetState m_RHand[1]
			if m_LFoot[1] != undefined then uiCbtLeftLeg.checked = biped.getLimbRetargetState m_LFoot[1]
			if m_RFoot[1] != undefined then uiCbtRightLeg.checked = biped.getLimbRetargetState m_RFoot[1]
			a_layerNames = #(("# "+(biped.getLayerName ctrl 0)+" #"))
			numLayers = biped.numLayers ctrl
			if numLayers > 0 then
			(
				layerIndex = biped.getCurrentLayer ctrl
				uiLblLayerID.text = layerIndex as string
				for i = 1 to numLayers do
				(
					append a_layerNames (biped.getLayerName ctrl i)
				)
				if numLayers > 1 then
				(
					uiCbtLeftArm.enabled  = false
					uiCbtRightArm.enabled = false
					uiCbtLeftLeg.enabled  = false
					uiCbtRightLeg.enabled = false
					uiCbtLeftArm.images   = #("bip_layer_i.bmp","bip_layer_i.bmp",24,18,18,18,18,true,true)
					uiCbtRightArm.images  = #("bip_layer_i.bmp","bip_layer_i.bmp",24,20,20,20,20,true,true)
					uiCbtLeftLeg.images   = #("bip_layer_i.bmp","bip_layer_i.bmp",24,22,22,22,22,true,true)
					uiCbtRightLeg.images  = #("bip_layer_i.bmp","bip_layer_i.bmp",24,24,24,24,24,true,true)
				)
				else
				(
					uiCbtLeftArm.enabled  = true
					uiCbtRightArm.enabled = true
					uiCbtLeftLeg.enabled  = true
					uiCbtRightLeg.enabled = true
					uiCbtLeftArm.images   = #("bip_layer_i.bmp","bip_layer_i.bmp",24,17,17,17,17,true,true)
					uiCbtRightArm.images  = #("bip_layer_i.bmp","bip_layer_i.bmp",24,19,19,19,19,true,true)
					uiCbtLeftLeg.images   = #("bip_layer_i.bmp","bip_layer_i.bmp",24,21,21,21,21,true,true)
					uiCbtRightLeg.images  = #("bip_layer_i.bmp","bip_layer_i.bmp",24,23,23,23,23,true,true)
				)
			)
			else
			(
				layerIndex = 0
				uiLblLayerID.text = "0"
				uiChkActive.enabled = false
			)

			if layerIndex > 0 then
			(
				uiChkActive.enabled = true
				uiChkActive.checked = (biped.getLayerActive ctrl layerIndex)
				uiCbtDelLayer.enabled = true
				uiCbtDownLayer.enabled = true
				uiCbtSnapKeys.enabled = true
				uiCbtDelLayer.images  = #("bip_layer_i.bmp","bip_layer_i.bmp",24,7,7,7,7,true,true)
				uiCbtDownLayer.images = #("bip_layer_i.bmp","bip_layer_i.bmp",24,13,13,13,13,true,true)
				uiCbtSnapKeys.images  = #("bip_layer_i.bmp","bip_layer_i.bmp",24,15,15,15,15,true,true)
			)
			else
			(
				uiChkActive.enabled = false
				uiCbtDelLayer.enabled = false
				uiCbtDownLayer.enabled = false
				uiCbtSnapKeys.enabled = false
				uiCbtDelLayer.images  = #("bip_layer_i.bmp","bip_layer_i.bmp",24,8,8,8,8,true,true)
				uiCbtDownLayer.images = #("bip_layer_i.bmp","bip_layer_i.bmp",24,14,14,14,14,true,true)
				uiCbtSnapKeys.images  = #("bip_layer_i.bmp","bip_layer_i.bmp",24,16,16,16,16,true,true)
			)
			
			ddlLayers.items = fnGetDisplayNames()
			ddlLayers.selection = layerIndex + 1
		)
		else
		(
			layerIndex = 0
			numLayers = 0
			uiLblLayerID.text = ""
			ddlLayers.items = #("")
			ddlLayers.selection = 1
			uiChkActive.enabled = false
		)
		
		if layerIndex == numLayers then
		(
			uiCbtUp.enabled = false
			uiCbtUp.images = #("bip_layer_i.bmp","bip_layer_i.bmp",24,2,2,2,2,true,true)
		)
		else 
		(
			uiCbtUp.enabled = true
			uiCbtUp.images = #("bip_layer_i.bmp","bip_layer_i.bmp",24,1,1,1,1,true,true)
		)
		if layerIndex == 0 then
		(
			uiCbtDown.enabled = false
			uiCbtDown.images = #("bip_layer_i.bmp","bip_layer_i.bmp",24,4,4,4,4,true,true)
		)
		else
		(
			uiCbtDown.enabled = true
			uiCbtDown.images = #("bip_layer_i.bmp","bip_layer_i.bmp",24,3,3,3,3,true,true)
		)
		redrawViews()
	)

	fn fnLockComTrack com =
	(
		with redraw off 
		(
			-- max motion mode
			theactionman = actionMan.executeAction
			tableId = 972555510
			-- max select
			theactionman tableId "40185"
			numTrackSel = com.controller.trackSelection
			if numTrackSel != 7 then (com.controller.trackSelection = 7)
			else if numTrackSel == 7 then (com.controller.trackSelection = 0)
			-- max move
		)
	)

	fn fnGetComTrackSelection com =
	(
		case com.controller.trackSelection of
		(
			1:(return [1,0,0])
			2:(return [0,1,0])
			3:(return [0,0,1])
			4:(return [1,1,0])
			5:(return [1,0,1])
			6:(return [0,1,1])
			7:(return [1,1,1])
			default:(return [0,0,0])
		)
	)

	-- fn fnSetComTrackSelection com =
	-- (
	-- 	numTrackSel = 0
	-- 	typeTrackSel = [0,0,0]
	-- 	typeTrackSel[1] = if rolBsBipedTools.uiCbtHorTrack.state then 1 else 0
	-- 	typeTrackSel[2] = if rolBsBipedTools.uiCbtVerTrack.state then 1 else 0
	-- 	typeTrackSel[3] = if rolBsBipedTools.uiCbtTurnTrack.state then 1 else 0
	-- 	case typeTrackSel of 
	-- 	(
	-- 		([1,0,0]):(numTrackSel = 1)
	-- 		([0,1,0]):(numTrackSel = 2)
	-- 		([0,0,1]):(numTrackSel = 3)
	-- 		([1,1,0]):(numTrackSel = 4)
	-- 		([1,0,1]):(numTrackSel = 5)
	-- 		([0,1,1]):(numTrackSel = 6)
	-- 		([1,1,1]):(numTrackSel = 7)
	-- 		default:(numTrackSel = 0)
	-- 	)
	-- 	if numTrackSel >= 5 and numTrackSel <= 7 then (fnLockComTrack com)
	-- 	com.controller.trackSelection = numTrackSel
	-- )

	fn fnRefreshTrackSelection com =
	(
		if fnIsValidBiped() then
		(
			typeTrackSel = rolBsBipedTools.fnGetComTrackSelection com
			if selection.count == 0 then typeTrackSel = [0,0,0]
			rolBsBipedTools.uiCbtHorTrack.state  = if typeTrackSel[1] == 1 then true else false
			rolBsBipedTools.uiCbtVerTrack.state  = if typeTrackSel[2] == 1 then true else false
			rolBsBipedTools.uiCbtTurnTrack.state = if typeTrackSel[3] == 1 then true else false
		)
	)

	-- Î∞∞Ïó¥ ÎπºÍ∏∞
	function ArraySubtract arrFrom arrSub = (
		if arrSub.count == 0 do (return arrFrom)
		
		for o in arrSub do (
			foundNum = findItem arrFrom o
			if foundNum != 0 do (
				deleteItem arrFrom foundNum
			)
		)
		return arrFrom
	)
	
	-- Í∏∞Ï°¥ selection Î∞±ÏóÖÍ≥º Ïù¥Î≤àÏóê ÏÑ†ÌÉùÌï† selArr ÏùÑ ÏûÖÎ†•Î∞õÏïÑ Ï†ÅÏ†àÌïòÍ≤å ÏÑ†ÌÉùÌïúÎã§. Î∂ÄÏàòÏ†ÅÏúºÎ°ú Î™®ÏÖòÌå®ÎÑêÎ°úÏùò Î≥ÄÍ≤ΩÎèÑ Í∞ôÏù¥ ÏàòÌñâ
    -- selBackup ÏùÑ ÏÇ¨Ïö©Ìï†ÏßÄÎäî ÎØ∏Ï†ï
    -- selBackup ÏùÄ selection as array
	function CompSelect selBackup selArr = (
		-- Îã®Ï∂ïÌÇ§ Ï°∞Ìï©Ïù¥ ÏïÑÎ¨¥Í≤ÉÎèÑ ÎàåÎü¨Ï†∏ÏûàÏßÄ ÏïäÏúºÎ©¥ Îπ†Î•¥Í≤å Í∑∏ÎÉ• ÏÑ†ÌÉù ÌõÑ Î¶¨ÌÑ¥
		if (keyboard.controlPressed == false) and (keyboard.altPressed == false) and (keyboard.shiftPressed == false) do (
			undo on (
				select selArr
			)
			return()
		)

		if keyboard.shiftPressed do 
		(
			fnSelAllChildrens selArr
			return()
		)

		if keyboard.controlPressed and not keyboard.altPressed do (
			selArr += selBackup
		)
		
		if keyboard.altPressed and not keyboard.controlPressed do (
			selArr = ArraySubtract selBackup selArr
		)
		
		undo on (
			if selArr.count == 0 then (
				clearSelection()
			)
			else (
				--setCommandPanelTaskMode mode:#motion
				select selArr
			)
		)
	)

	-- Î∞îÏù¥Ìå®Îìú Î∞∞Ïó¥Ïù¥ Ï†ïÏÉÅÏ†ÅÏù∏ÏßÄ Ï≤¥ÌÅ¨ÌïòÏó¨ Î¶¨ÌÑ¥
	fn IfExistBips bipArr = (
		if (bipArr == undefined) do return false
		if (bipArr.count == 0) do return false
		for obj in bipArr do (
			-- ÏÇ≠Ï†úÎêú Ïò§Î∏åÏ†ùÌä∏Ïóê ÎåÄÌï¥ Ï≤òÎ¶¨ÌïòÎ†§Í≥† ÌïòÎ©¥ ÏóêÎü¨Í∞Ä ÎÇòÎØÄÎ°ú try Ï≤òÎ¶¨
			try (
				if (obj == undefined) do return false
				if ((classof obj.baseobject) != Biped_Object) do return false
			) catch (return false)
		)
		return true
	)

	-- Ïù¥Ìïò Î∞îÏù¥Ìå®Îìú Î∂ÄÏúÑÎì§ÏùÑ ÏñªÏñ¥Ïò§Îäî Ìï®ÏàòÎì§ÏùÄ m_workingBipRootÎ•º ÎåÄÏÉÅÏúºÎ°ú ÏûëÎèô
	fn GetHead = (
		selObj = biped.getNode m_workingBipRoot #head
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetRArms = (
		tArr = #()
		for i = 1 to 4 do (
			selObj = biped.getNode m_workingBipRoot #rarm link:i
			if selObj != undefined do -- Î∞îÏù¥Ìå®Îìú Ïä§Ìä∏Îü≠Ï≤ò ÏÑ§Ï†ïÏóê Îî∞Îùº ÌåîÏù¥ ÏóÜÎäî Îì± ÏòàÏô∏Í∞Ä ÏûàÏùÑ Ïàò ÏûàÏùå
			(
				if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state do (
					append tArr selObj
				)
			)
		)
		return tArr
	)
	fn GetNecks = (
		tArr = #()
		testBool = true
		tIndex = 1
		while testBool do (
			selObj = biped.getNode m_workingBipRoot #neck link:tIndex
			if ( selObj == undefined ) then (
				testBool = false
			)
			else (
				if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state do (
					append tArr selObj
				)
			)
			tIndex += 1
		)
		return tArr
	)
	fn GetLArms = (
		tArr = #()
		for i = 1 to 4 do (
			selObj = biped.getNode m_workingBipRoot #larm link:i
			if selObj != undefined do -- Î∞îÏù¥Ìå®Îìú Ïä§Ìä∏Îü≠Ï≤ò ÏÑ§Ï†ïÏóê Îî∞Îùº ÌåîÏù¥ ÏóÜÎäî Îì± ÏòàÏô∏Í∞Ä ÏûàÏùÑ Ïàò ÏûàÏùå
			(
				if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state do (
					append tArr selObj
				)
			)
		)
		return tArr
	)
	fn GetRClavicle = (
		selObj = biped.getNode m_workingBipRoot #rarm link:1
		if selObj == undefined do -- Î∞îÏù¥Ìå®Îìú Ïä§Ìä∏Îü≠Ï≤ò ÏÑ§Ï†ïÏóê Îî∞Îùº ÌåîÏù¥ ÏóÜÎäî Îì± ÏòàÏô∏Í∞Ä ÏûàÏùÑ Ïàò ÏûàÏùå
		(
			return #()
		)
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetLClavicle = (
		selObj = biped.getNode m_workingBipRoot #larm link:1
		if selObj == undefined do -- Î∞îÏù¥Ìå®Îìú Ïä§Ìä∏Îü≠Ï≤ò ÏÑ§Ï†ïÏóê Îî∞Îùº ÌåîÏù¥ ÏóÜÎäî Îì± ÏòàÏô∏Í∞Ä ÏûàÏùÑ Ïàò ÏûàÏùå
		(
			return #()
		)
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetRUpArm = (
		selObj = biped.getNode m_workingBipRoot #rarm link:2
		if selObj == undefined do -- Î∞îÏù¥Ìå®Îìú Ïä§Ìä∏Îü≠Ï≤ò ÏÑ§Ï†ïÏóê Îî∞Îùº ÌåîÏù¥ ÏóÜÎäî Îì± ÏòàÏô∏Í∞Ä ÏûàÏùÑ Ïàò ÏûàÏùå
		(
			return #()
		)
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetAllSpine = (
		tArr = #()
		testBool = true
		tIndex = 1
		while testBool do (
			selObj = biped.getNode m_workingBipRoot #spine link:tIndex
			if ( selObj == undefined ) then (
				testBool = false
			)
			else (
				if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state do (
					append tArr selObj
				)
			)
			tIndex += 1
		)
		return tArr
	)
	fn GetSpine index = (
		selObj = biped.getNode m_workingBipRoot #spine link:(index + 1)
		if selObj == undefined do return #()
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetLUpArm = (
		selObj = biped.getNode m_workingBipRoot #larm link:2
		if selObj == undefined do -- Î∞îÏù¥Ìå®Îìú Ïä§Ìä∏Îü≠Ï≤ò ÏÑ§Ï†ïÏóê Îî∞Îùº ÌåîÏù¥ ÏóÜÎäî Îì± ÏòàÏô∏Í∞Ä ÏûàÏùÑ Ïàò ÏûàÏùå
		(
			return #()
		)
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetRForArm = (
		selObj = biped.getNode m_workingBipRoot #rarm link:3
		if selObj == undefined do -- Î∞îÏù¥Ìå®Îìú Ïä§Ìä∏Îü≠Ï≤ò ÏÑ§Ï†ïÏóê Îî∞Îùº ÌåîÏù¥ ÏóÜÎäî Îì± ÏòàÏô∏Í∞Ä ÏûàÏùÑ Ïàò ÏûàÏùå
		(
			return #()
		)
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetLForArm = (
		selObj = biped.getNode m_workingBipRoot #larm link:3
		if selObj == undefined do -- Î∞îÏù¥Ìå®Îìú Ïä§Ìä∏Îü≠Ï≤ò ÏÑ§Ï†ïÏóê Îî∞Îùº ÌåîÏù¥ ÏóÜÎäî Îì± ÏòàÏô∏Í∞Ä ÏûàÏùÑ Ïàò ÏûàÏùå
		(
			return #()
		)
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetRHand = (
		selObj = biped.getNode m_workingBipRoot #rarm link:4
		if selObj == undefined do -- Î∞îÏù¥Ìå®Îìú Ïä§Ìä∏Îü≠Ï≤ò ÏÑ§Ï†ïÏóê Îî∞Îùº ÌåîÏù¥ ÏóÜÎäî Îì± ÏòàÏô∏Í∞Ä ÏûàÏùÑ Ïàò ÏûàÏùå
		(
			return #()
		)
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	--fn GetCOM = ()
	fn GetLHand = (
		selObj = biped.getNode m_workingBipRoot #larm link:4
		if selObj == undefined do -- Î∞îÏù¥Ìå®Îìú Ïä§Ìä∏Îü≠Ï≤ò ÏÑ§Ï†ïÏóê Îî∞Îùº ÌåîÏù¥ ÏóÜÎäî Îì± ÏòàÏô∏Í∞Ä ÏûàÏùÑ Ïàò ÏûàÏùå
		(
			return #()
		)
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetPelvis = (
		selObj = biped.getNode m_workingBipRoot #pelvis
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetRThigh = (
		selObj = biped.getNode m_workingBipRoot #rleg link:1
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetLThigh = (
		selObj = biped.getNode m_workingBipRoot #lleg link:1
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetRCalf = (
		selObj = biped.getNode m_workingBipRoot #rleg link:2
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetLCalf = (
		selObj = biped.getNode m_workingBipRoot #lleg link:2
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetRFoot = (
		local footIndex = 4 -- HorseLinkÍ∞Ä ÏûàÎäî Í≤ΩÏö∞
		if (biped.getNode m_workingBipRoot #rleg link:4) == undefined do (
			footIndex = 3
		)
		selObj = biped.getNode m_workingBipRoot #rleg link:footIndex
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetLFoot = (
		local footIndex = 4 -- HorseLinkÍ∞Ä ÏûàÎäî Í≤ΩÏö∞
		if (biped.getNode m_workingBipRoot #lleg link:4) == undefined do (
			footIndex = 3
		)
		selObj = biped.getNode m_workingBipRoot #lleg link:footIndex
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetRToe = (
		selObj = biped.getNode m_workingBipRoot #rtoes link:1
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetLToe = (
		selObj = biped.getNode m_workingBipRoot #ltoes link:1
		if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
			return #(selObj)
		)
		else (
			return #()
		)
	)
	fn GetRLegs = (
		tArr = #()
		for i = 1 to 4 do (
			selObj = biped.getNode m_workingBipRoot #rleg link:i
			if selObj != undefined do (		-- HorseLink Í∞Ä ÏûàÍ∏∞ÎèÑ ÌïòÍ≥† ÏóÜÍ∏∞ÎèÑ Ìï† Ïàò ÏûàÏùå
				if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state do (
					append tArr selObj
				)
			)
		)
		append tArr (biped.getNode m_workingBipRoot #rtoes link:1)
		return tArr
	)
	fn GetAllFoot = (
		tArr = #()
		selObj = GetLFoot()
		if ( selObj[1].isHidden == false ) or uiChkSelHiddenObj.state do ( append tArr selObj[1] )
		selObj = GetRFoot()
		if ( selObj[1].isHidden == false ) or uiChkSelHiddenObj.state do ( append tArr selObj[1] )
		return tArr
	)
	fn GetLLegs = (
		tArr = #()
		for i = 1 to 4 do (
			selObj = biped.getNode m_workingBipRoot #lleg link:i
			if selObj != undefined do (		-- HorseLink Í∞Ä ÏûàÍ∏∞ÎèÑ ÌïòÍ≥† ÏóÜÍ∏∞ÎèÑ Ìï† Ïàò ÏûàÏùå
				if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state do (
					append tArr selObj
				)
			)
		)
		append tArr (biped.getNode m_workingBipRoot #ltoes link:1)
		return tArr
	)
	fn GetAllBip = (
		local retBips = #()
		for o in objects do (
			if ( classof o.baseobject == Biped_object ) and \
			((classof o.controller == Vertical_Horizontal_Turn) or (classof o.controller == BipSlave_Control)) do
			(
				-- Í∞ôÏùÄBip001Ïùò ÏûêÏãùÏù¥Î©¥
				if ( o.controller.rootNode == m_workingBipRoot AND (classof o.controller) != Footsteps) do
				(
					append retBips o
				)
			)
		)
		return retBips
	)

	fn GetLProp =
	(
		selObj = biped.getNode m_workingBipRoot #prop2 link:1
		if selObj != undefined then
		(
			if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
				return #(selObj)
			)
			else (
				return #()
			)
		)
		else
		(
			return #()
		)
	)
	
	fn GetRProp =
	(
		selObj = biped.getNode m_workingBipRoot #prop1 link:1
		if selObj != undefined then
		(
			if ( selObj.isHidden == false ) or uiChkSelHiddenObj.state then (
				return #(selObj)
			)
			else (
				return #()
			)
		)
		else
		(
			return #()
		)
	)

	-- Go to Mirror frame Î≤ÑÌäºÏù¥ ÏûëÎèôÌïòÍ∏∞ ÏúÑÌïú Ï°∞Í±¥ Í≤ÄÏÇ¨ ÌõÑ Î≤ÑÌäº enable ÏÑ∏ÌåÖ
	-- Î£®Ìïë Íµ¨Í∞Ñ ÌîÑÎ†àÏûÑÏù¥ ÏßùÏàòÏó¨ÏïºÌïòÍ≥† ÏùºÏ†ï Ïàò Ïù¥ÏÉÅÏù¥Ïó¨ÏïºÌï®
	fn SetGotoMirrorEnable = (
		--uiBtnGotoMirror
		local fCount = uiSpnLoopEnd.value - uiSpnLoopStart.value
		if (fCount < 2) do (
			uiBtnGotoMirror.enabled = false
			return ()
		)

		local fCountHalf = fCount / 2.0
		-- ÌôÄÏàòÏù∏ÏßÄ?
		if float (int fCountHalf) != fCountHalf do (
			uiBtnGotoMirror.enabled = false
			return ()
		)
		uiBtnGotoMirror.enabled = true
	)
    
	-- ÏûëÏóÖÏö© Î∞îÏù¥Ìå®Îìú Î£®Ìä∏ ÎÖ∏ÎìúÎùºÎçòÍ∞Ä, ÏÑ†ÌÉùÏö© Î∞∞Ïó¥ Î≥ÄÏàò Îì±ÏùÑ ÎØ∏Î¶¨ ÏÑ∏ÌåÖ
	function InitLocalVars = (
		try(arrAllBipedCom = rolBsBipedTools.fnGetAllBipedCom())catch()
		-- print arrAllBipedCom
		rolBsBipedTools.ddlAllBipedCom.items = for i in arrAllBipedCom where not isDeleted i and i.name != undefined collect i.name
		for i in (selection as array) where (selection.count != 0 and (isValidNode i) and (iskindof i.baseobject Biped_Object) and \
		((classof i.controller == Vertical_Horizontal_Turn) or (classof i.controller == BipSlave_Control)) ) do 
		(
			selBipedId = finditem arrAllBipedCom i.controller.rootnode
			rolBsBipedTools.ddlAllBipedCom.selection = selBipedId
			exit
		)
		--uiBtnLoopDupe.enabled = false -- Í∞úÎ∞úÏ§ëÏù∏ Í∏∞Îä• Î¥âÏù∏
		AutoGetBipRoot()
        if m_workingBipRoot == undefined then (
            SetButtonState false
            return ()
        )
        else (
            SetButtonState true
		)
		uiChkBtnScanBiped.text = "Scanning..."
		
		-- Î™®Îì† Î∂ÄÏúÑ Î≥ÄÏàòÎì§ÏùÄ Î∞∞Ïó¥
		m_Head = GetHead()
		m_RArms = GetRArms()
		if (m_RArms.count == 0) then (uiRArms.enabled = false; uiRArms.state = false) else (uiRArms.enabled = true; uiRArms.state = true)
		m_Necks = GetNecks()
		m_LArms = GetLArms()
		if (m_LArms.count == 0) then (uiLArms.enabled = false; uiLArms.state = false) else (uiLArms.enabled = true; uiLArms.state = true)
		m_RClavicle = GetRClavicle()
		if (m_RClavicle.count == 0) then (uiRClavicle.enabled = false; uiRClavicle.state = false) else (uiRClavicle.enabled = true; uiRClavicle.state = true)
		m_LClavicle = GetLClavicle()
		if (m_LClavicle.count == 0) then (uiLClavicle.enabled = false; uiLClavicle.state = false) else (uiLClavicle.enabled = true; uiLClavicle.state = true)
		m_RUpArm = GetRUpArm()
		if (m_RUpArm.count == 0) then (uiRUpArm.enabled = false; uiRUpArm.state = false) else (uiRUpArm.enabled = true; uiRUpArm.state = true)
		m_AllSpine = GetAllSpine()
		m_Spine3 = GetSpine 3
		if (m_Spine3.count == 0) then (uiSpine3.enabled = false; uiSpine3.state = false) else (uiSpine3.enabled = true; uiSpine3.state = true)
		m_Spine2 = GetSpine 2
		if (m_Spine2.count == 0) then (uiSpine2.enabled = false; uiSpine2.state = false) else (uiSpine2.enabled = true; uiSpine2.state = true)
		m_Spine1 = GetSpine 1
		if (m_Spine1.count == 0) then (uiSpine1.enabled = false; uiSpine1.state = false) else (uiSpine1.enabled = true; uiSpine1.state = true)
		m_Spine0 = GetSpine 0
		if (m_Spine0.count == 0) then (uiSpine0.enabled = false; uiSpine0.state = false) else (uiSpine0.enabled = true; uiSpine0.state = true)
		m_LUpArm = GetLUpArm()
		if (m_LUpArm.count == 0) then (uiLUpArm.enabled = false; uiLUpArm.state = false) else (uiLUpArm.enabled = true; uiLUpArm.state = true)
		m_RForArm = GetRForArm()
		if (m_RForArm.count == 0) then (uiRForArm.enabled = false; uiRForArm.state = false) else (uiRForArm.enabled = true; uiRForArm.state = true)
		m_LForArm = GetLForArm()
		if (m_LForArm.count == 0) then (uiLForArm.enabled = false; uiLForArm.state = false) else (uiLForArm.enabled = true; uiLForArm.state = true)
		m_RHand = GetRHand()
		if (m_RHand.count == 0) then (uiRHand.enabled = false; uiRHand.state = false) else (uiRHand.enabled = true; uiRHand.state = true)
		--m_COM = GetCOM()
		m_LHand = GetLHand()
		if (m_LHand.count == 0) then (uiLHand.enabled = false; uiLHand.state = false) else (uiLHand.enabled = true; uiLHand.state = true)
		m_Pelvis = GetPelvis()
		m_RThigh = GetRThigh()
		m_LThigh = GetLThigh()
		m_RCalf = GetRCalf()
		m_LCalf = GetLCalf()
		m_RFoot = GetRFoot()
		m_LFoot = GetLFoot()
		m_RToe = GetRToe()
		m_LToe = GetLToe()
		m_RLegs = GetRLegs()
		m_AllFoot = GetAllFoot()
		m_LLegs = GetLLegs()
		m_AllBip = GetAllBip()
		m_LProp = GetLProp()
		m_RProp = GetRProp()

		uiChkBtnScanBiped.text = "All Biped"

		LoadRangeLoop()
		-- LoadRangeA()
		-- LoadRangeB()
		LoadGoto()
		SetGotoBtnText()

		uiDropPlaySpeed.selection = timeConfiguration.playbackSpeed

        SetGotoMirrorEnable ()
        
        uiPlayBlock.state = false
		clock.active = false
		m_PBKeyTimeArray = #()
		m_PBKeyMiliSecArray = #()
        SetPBPlaySpeed()
		if selection.count == 1 then 
		(
			try
			(
				uiFigureMode.state = $.controller.rootnode.controller.figureMode
				uiBtnInPlace.state = false
				if $.controller.rootnode.controller.inPlaceYMode == true then
				(
					uiBtnInPlace.images = #("bip_general_i.bmp","bip_general_i.bmp",30,27,27,27,27,true,true)
					uiBtnInPlace.state = true
				)
				else if $.controller.rootnode.controller.inPlaceMode == true then
				(
					uiBtnInPlace.images = #("bip_general_i.bmp","bip_general_i.bmp",30,23,23,23,23,true,true)
					uiBtnInPlace.state = true
				)
			)
			catch
			(
				uiFigureMode.state = false
				uiBtnInPlace.state = false
			)
		)
		else 
		(
			uiFigureMode.state = false
			uiBtnInPlace.state = false
		)
		fnRefreshTrackSelection m_workingBipRoot
		fnSyncBipedPanel()
		fnBSUpdateLayers()
	)

	-- Î≥¥Ï†ïÏπò ÌöåÏ†ÑÍ∞íÏùÑ ÏûÖÎ†•Î∞õÍ≥† ÎòëÎ∞îÎ°ú Ìé¥Ï£ºÎäî Í∏∞Îä•ÏùÑ ÌïúÎã§. bipsÎäî Î∞∞Ïó¥. Î≥¥Ï†ïÏπò ÌöåÏ†ÑÍ∞íÏùÄ Toe Îì±ÏóêÏÑú 90ÎèÑ Ï∂îÍ∞Ä ÌöåÏ†ÑÏù¥ ÌïÑÏöîÌï®
	function Straighten bips offsetRotation = (
		for bip in bips do (
			if (bip != undefined AND (isDeleted bip) == false) do (
				biped.setTransform bip #rotation (offsetRotation * bip.parent.transform.rotation) animButtonState
			)
		)
	)

	-- Straighten Ìï®ÏàòÏôÄ Í∞ôÏùÄ Í∏∞Îä•Ïù¥ÏßÄÎßå Î∂ÄÎ™® ÎåÄÏã†Ïóê Îã§Î•∏ ÌîÑÎ°ùÏãú Ïò§Î∏åÏ†ùÌä∏Î•º Í∏∞Ï§ÄÏúºÎ°ú ÌïúÎã§.
	-- Î∞îÏù¥Ìå®ÎìúÏùò Triangle Pelvis ÏòµÏÖòÎïåÎ¨∏Ïóê ÌóàÎ≤ÖÏßÄ Î∂ÄÎ™®Í∞Ä Ï≤ôÏ∂îÏù∏ Í≤ΩÏö∞Í∞Ä Ï¢ÖÏ¢Ö ÏûàÏñ¥ÏÑú Í∞ïÏ†úÎ°ú PelvisÎ•º ÏßÄÏ†ï
	function StraightenByProxy bips proxy offsetRotation = (
		for bip in bips do (
			if (bip != undefined AND (isDeleted bip) == false) do (
				biped.setTransform bip #rotation (offsetRotation * proxy.transform.rotation) animButtonState
			)
		)
	)

	fn fnMsgMissingBiped =
	(
		messageBox "ÈîôËØØÔºöÂú∫ÊôØ‰∏≠Áº∫Â∞ëÂÖàÂâçÈÄâÊã©ÁöÑ BipedÔºÅÂ∑≤ÈáçÂêØÂ∑•ÂÖ∑ÔºÅ                                                " title:"BsBipedTools"
		setIniSetting iniBsBipedTools "BipedPanel" "CurrentBip" "1"
		try (destroydialog rolBsBipedTools) catch()
		if (iniBsBTPos != 0) then 
		(Createdialog rolBsBipedTools pos:iniBsBTPos style:#() fgcolor:(if fnGetThemeColor() == "Light" then (color 28 89 177) else (color 165 222 228)))
		else (Createdialog rolBsBipedTools style:#() fgcolor:(if fnGetThemeColor() == "Light" then (color 28 89 177) else (color 165 222 228)))
	)

	fn fnMirrorPosture a_bipObjs =
	(
		if isValidNode m_workingBipRoot AND NOT isDeleted m_workingBipRoot then
		(
			try
			(
				local bRootCtrl = m_workingBipRoot.controller
				biped.createCopyCollection bRootCtrl "MirrorTemp"
				local colIndex = biped.numCopyCollections bRootCtrl
				local copyCol = biped.getCopyCollection bRootCtrl colIndex
				biped.copyBipPosture bRootCtrl copyCol a_bipObjs #snapAuto
				local mirroreBH_pose = getCopy copyCol #posture 1
				with Animate on
				(
					undo "MirrorPosture" on
					(
						biped.pasteBipPosture bRootCtrl mirroreBH_pose true #pstdefault true true true false
					)
				)
				biped.deleteCopyCollection bRootCtrl colIndex
			)
			catch(messageBox "ÈîôËØØÔºöÈïúÂÉèÂ§±Ë¥•ÔºåËØ∑ÈáçÊñ∞Â∞ùËØï„ÄÇ                       " title:"BsBipedTools")
		)
	)
	
	fn fnStorePostureObjs a_objs =
	(
		local txtFile = openFile postureObjsFile mode:"w"
		for obj in a_objs do
		(
			format "%\n" obj.name to:txtFile
		)
		close txtFile
	)
	
	fn fnRetrievePostureObjs =
	(
		if doesFileExist postureObjsFile do
		(
			local a_objs = #()
			local txtFile = openFile postureObjsFile mode:"r"
			while NOT eof txtFile do
			(
				append a_objs (getNodeByName (readLine txtFile))
			)
			close txtFile
			a_objs
		)
	)
	
	fn fnFilterBipedParts a_selObjs =
	(
		local a_bipedParts = #()
		
		for obj in a_selObjs do
		(
			if classof obj.baseObject == Biped_Object do
			(
				append a_bipedParts obj
			)
		)
		a_bipedParts
	)

	on uiCbtCopy changed state do
	(
		uiCbtCopy.state = true
		try
		(
			if selection.count > 0 then
			(
				local a_objs = selection as array
				--// Make sure only Biped parts are selected for copying by filtering out non-Biped parts
				a_objs = fnFilterBipedParts a_objs
				if a_objs.count > 0 then
				(
					fnStorePostureObjs a_objs
					if isValidNode m_workingBipRoot AND NOT isDeleted m_workingBipRoot then
					(
						local bRootCtrl = m_workingBipRoot.controller
						biped.createCopyCollection bRootCtrl "CopyPosture"
						local colIndex = biped.numCopyCollections bRootCtrl
						local copyCol = biped.getCopyCollection bRootCtrl colIndex
						biped.copyBipPosture bRootCtrl copyCol a_objs #snapAuto
						biped.saveCopyPasteFile bRootCtrl (getDir #plugcfg + "\BsBipedTools_PoseGrabbed.cpy")
						biped.deleteCopyCollection bRootCtrl colIndex
					)
				)
				else
				(
					messageBox "ÈîôËØØÔºöÊ≤°ÊúâÈÄâÊã© Biped ÂØπË±°„ÄÇ                       " title:"BsBipedTools"
				)
			)
			else
			(
				messageBox "ÈîôËØØÔºöËØ∑ÈÄâÊã©‰∏Ä‰∫õË¶ÅÂ§çÂà∂ÁöÑ Biped ÂØπË±°„ÄÇ                            " title:"BsBipedTools"
			)
		)
		catch(messageBox "ÈîôËØØÔºöËØ∑ÈáçÊñ∞Â∞ùËØïÂ§çÂà∂Á≤òË¥¥Pose„ÄÇ                       " title:"BsBipedTools")
	)
	
	on uiCbtPaste changed state do
	(
		uiCbtPaste.state = true
		try
		(
			local postureFile = getDir #plugcfg + "\BsBipedTools_PoseGrabbed.cpy"
			if doesFileExist postureFile then
			(
				if isValidNode m_workingBipRoot AND NOT isDeleted m_workingBipRoot then
				(
					local bRootCtrl = m_workingBipRoot.controller
					biped.loadCopyPasteFile bRootCtrl postureFile
					local colIndex = biped.numCopyCollections bRootCtrl
					local copyCol = biped.getCopyCollection bRootCtrl colIndex
					local copyBH_posture = getCopy copyCol #posture 1
					if copyBH_posture != false then
					(
						with Animate on
						(
							undo "PastePosture" on
							(
								biped.pasteBipPosture bRootCtrl copyBH_posture false #pstdefault true true true false
							)
						)
					)
					else
					(
						messagebox "ÈîôËØØÔºöÁ°Æ‰øù Copy/Paste Posture ‰∏çÂåÖÂê´Âêç‰∏∫"CopyPosture"ÁöÑÈõÜÂêà„ÄÇ                            " title:"BsBipedTools"
					)
					local colIndex = biped.numCopyCollections bRootCtrl
					biped.deleteCopyCollection bRootCtrl colIndex
				)
			)
			else
			(
				messageBox "ÈîôËØØÔºöËØ∑ÂÖàÂ§çÂà∂‰∏Ä‰∏™ Pose„ÄÇ                          " title:"BsBipedTools"
			)
		)
		catch (messageBox "ÈîôËØØÔºöËØ∑ÈáçÊñ∞Â∞ùËØïÂ§çÂà∂Á≤òË¥¥Pose„ÄÇ                       " title:"BsBipedTools")
	)

	on uiCbtPasteOpposite changed state do
	(
		uiCbtPasteOpposite.state = true
		try
		(
			local postureFile = getDir #plugcfg + "\BsBipedTools_PoseGrabbed.cpy"
			if doesFileExist postureFile then
			(
				if isValidNode m_workingBipRoot AND NOT isDeleted m_workingBipRoot then
				(
					local bRootCtrl = m_workingBipRoot.controller
					biped.loadCopyPasteFile bRootCtrl postureFile
					local colIndex = biped.numCopyCollections bRootCtrl
					local copyCol = biped.getCopyCollection bRootCtrl colIndex
					local copyBH_posture = getCopy copyCol #posture 1
					if copyBH_posture != false then
					(
						with Animate on
						(
							undo "PastePosture" on
							(
								biped.pasteBipPosture bRootCtrl copyBH_posture true #pstdefault true true true false
							)
						)
					)
					else
					(
						messagebox "ÈîôËØØÔºöÁ°Æ‰øù Copy/Paste Posture ‰∏çÂåÖÂê´Âêç‰∏∫"CopyPosture"ÁöÑÈõÜÂêà„ÄÇ                            " title:"BsBipedTools"
					)
					local colIndex = biped.numCopyCollections bRootCtrl
					biped.deleteCopyCollection bRootCtrl colIndex
				)
			)
			else
			(
				messageBox "ÈîôËØØÔºöËØ∑ÂÖàÂ§çÂà∂‰∏Ä‰∏™ Pose„ÄÇ                          " title:"BsBipedTools"
			)
		)
		catch (messageBox "ÈîôËØØÔºöËØ∑ÈáçÊñ∞Â∞ùËØïÂ§çÂà∂Á≤òË¥¥Pose„ÄÇ                       " title:"BsBipedTools")
	)
	
	on uiCbtSelPostureObjs changed state do
	(
		uiCbtSelPostureObjs.state = true
		try
			(
				local a_objs = fnRetrievePostureObjs()
				if a_objs != undefined then
				(
					try
					(
						select a_objs
					)catch(messageBox "ÈîôËØØ: Êó†Ê≥ïÈÄâÊã©Áî®‰∫éÂ§çÂà∂ÂßøÂäøÁöÑBipedÈ™®È™º„ÄÇ                                " title:"BsBipedTools")
				)
			)catch()
	)
	
	on uiCbtMirrorLArm changed state do
	(
		uiCbtMirrorLArm.state = true
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		-- local arrMirror = makeUniqueArray (m_LArms + m_LHand)
		fnMirrorPosture m_LArms
	)
	
	on uiCbtMirrorRArm changed state do
	(
		uiCbtMirrorRArm.state = true
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		-- local arrMirror = makeUniqueArray (m_RArms + m_RHand)
		fnMirrorPosture m_RArms
	)
	
	on uiCbtMirrorLLeg changed state do
	(
		uiCbtMirrorLLeg.state = true
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		fnMirrorPosture m_LLegs
	)
	
	on uiCbtMirrorRLeg changed state do
	(
		uiCbtMirrorRLeg.state = true
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		fnMirrorPosture m_RLegs
	)

	on uiChkBtnScanBiped changed state do (
		uiChkBtnScanBiped.state = true
		InitLocalVars() -- Â∑•‰ΩúÁî® ÂèåË∂≥‰∫∫ÂΩ¢ Ê†πËäÇÁÇπÁ≠âÔºåÈÄâÊã©Áî®Êï∞ÁªÑÂèòÈáèÁ≠âÈ¢ÑËÆæ
		if (m_workingBipRoot != undefined) do (select m_AllBip)
	)

	on uiBtnSetAllKey changed state do with undo on
	(
		uiBtnSetAllKey.state = true
		for i in selection as array where iskindof i.baseObject Biped_Object do
		(
			if ( classof i.controller == Vertical_Horizontal_Turn ) then
			(
				biped.addNewKey i.controller.vertical.controller slidertime
				biped.addNewKey i.controller.horizontal.controller slidertime
				biped.addNewKey (fnBipedComlocalization i.controller) slidertime
			)
			else 
			(
				try (biped.addNewKey i.controller sliderTime ) catch ()
			)
		)
	)
	
	on uiBtnSetAllKey rightclick do (
		uiBtnSetAllKey.state = true
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		if (m_workingBipRoot.transform.controller.figureMode) do (
			messageBox "‰∏çËÉΩÂú®‰ΩìÂΩ¢Ê®°Âºè‰∏≠Ê∑ªÂä†ÂÖ≥ÈîÆÂ∏ß„ÄÇ                              " title:"BsBipedTools"
			return ()
		)

		selBackup = selection as array

		-- È¢ÑÂ≠òÊï∞ÁªÑÊúâÈóÆÈ¢òÂàôÈáçÊñ∞ÂàùÂßãÂåñÊï∞ÁªÑ
		if (IfExistBips m_AllBip) == false do (
			m_AllBip = GetAllBip()
		)
		if (IfExistBips m_AllBip) == false do return () -- ËøòÊòØÊúâÈóÆÈ¢òÂàôÁõ¥Êé•ËøîÂõû
		
		undo on
		(
			for o in m_AllBip do
			(
				if ( o == m_workingBipRoot ) then
				(
					biped.addNewKey o.controller.vertical.controller slidertime
					biped.addNewKey o.controller.horizontal.controller slidertime
					biped.addNewKey (fnBipedComlocalization o.controller) slidertime
				)
				else
				(
					try ( biped.addNewKey o.controller slidertime ) catch ()		-- Footstep ÂØπË±°ÂØºËá¥ try Â§ÑÁêÜ
				)
			) -- for end
		) -- undo end	
		clearSelection()
		select selBackup
	)

	on uiBtnLimbPK changed state do (
		uiBtnLimbPK.state = on -- ‰ªª‰ΩïÁä∂ÊÄÅ‰∏ãÊåâÈíÆÁä∂ÊÄÅÈÉΩ‰øùÊåÅÊåâ‰∏ã
		local tempPanel = getCommandPanelTaskMode()
		setCommandPanelTaskMode mode:#motion -- biped.setSlidingKey Á≠âÂäüËÉΩÂè™Âú® Motion Èù¢ÊùøÊ≠£Â∏∏Â∑•‰ΩúÔºåÂÖ∂‰ªñÂú∞Êñπ‰ºöÂØºËá¥ÈîôËØØÂßøÂäøË¶ÜÁõñ
		local timeBefore = sliderTime
		disableSceneRedraw()
		undo on (
			for obj in selection do (
				if (IfLimb obj) do (
					if (keyboard.shiftPressed OR keyboard.controlPressed) then (
						local keys = obj.controller.keys
						local animRangeBackup = animationRange -- ÊöÇÊó∂ÂèØ‰ª•‰øÆÊîπÂ§ñÈÉ®ÁöÑÂÖ≥ÈîÆÂ∏ßÔºåËÆ∞ÂΩïÂΩìÂâçÁöÑÂä®ÁîªÂå∫Èó¥
						animationRange = Interval keys[1].time keys[keys.count].time
						for i = 1 to keys.count do (
							if keyboard.shiftPressed do (
								-- Shift Êåâ‰∏ãÂàô‰∏çËÄÉËôëÂÖ≥ÈîÆÂ∏ßÈÄâÊã©ÔºåÂÖ®ÈÉ®‰øÆÊîπ
								sliderTime = keys[i].time -- ‰ΩøÁî® at time ÊñπÂºè‰ºöÂØºËá¥ sliderTime ÁöÑÂßøÂäøÁîüÊàêÂÖ≥ÈîÆÂ∏ßÔºåÊâÄ‰ª•Áõ¥Êé•ÊîπÂèò sliderTime ËøõË°å
								biped.SetPlantedKey obj
							)
							if keyboard.controlPressed do (
								-- Ctrl Êåâ‰∏ãÂàôÂè™‰øÆÊîπÈÄâ‰∏≠ÁöÑÂÖ≥ÈîÆÂ∏ß
								if keys[i].selected == true do (
									sliderTime = keys[i].time -- ‰ΩøÁî® at time ÊñπÂºè‰ºöÂØºËá¥ sliderTime ÁöÑÂßøÂäøÁîüÊàêÂÖ≥ÈîÆÂ∏ßÔºåÊâÄ‰ª•Áõ¥Êé•ÊîπÂèò sliderTime ËøõË°å
									biped.SetPlantedKey obj
								)
							)
						)
						animationRange = animRangeBackup -- ÊÅ¢Â§çÂéüÊù•ÁöÑÂä®ÁîªÂå∫Èó¥
					)
					else (
						biped.SetPlantedKey obj
					)
				)
			) -- for
		) -- Undo
		if tempPanel != #motion do setCommandPanelTaskMode mode:tempPanel
		enableSceneRedraw()
		sliderTime = timeBefore
	)

	on uiBtnLimbIK changed state do (
		uiBtnLimbIK.state = on -- ‰ªª‰ΩïÁä∂ÊÄÅ‰∏ãÊåâÈíÆÁä∂ÊÄÅÈÉΩ‰øùÊåÅÊåâ‰∏ã
		local tempPanel = getCommandPanelTaskMode()
		setCommandPanelTaskMode mode:#motion -- biped.setSlidingKey Á≠âÂäüËÉΩÂè™Âú® Motion Èù¢ÊùøÊ≠£Â∏∏Â∑•‰ΩúÔºåÂÖ∂‰ªñÂú∞Êñπ‰ºöÂØºËá¥ÈîôËØØÂßøÂäøË¶ÜÁõñ
		local timeBefore = sliderTime
		disableSceneRedraw()
		undo on (
			for obj in selection do (
				if (IfLimb obj) do (
					if (keyboard.shiftPressed OR keyboard.controlPressed) then (
						local keys = obj.controller.keys
						local animRangeBackup = animationRange -- ÊöÇÊó∂ÂèØ‰ª•‰øÆÊîπÂ§ñÈÉ®ÁöÑÂÖ≥ÈîÆÂ∏ßÔºåËÆ∞ÂΩïÂΩìÂâçÁöÑÂä®ÁîªÂå∫Èó¥
						animationRange = Interval keys[1].time keys[keys.count].time
						for i = 1 to keys.count do (
							if keyboard.shiftPressed do (
								-- Shift Êåâ‰∏ãÂàô‰∏çËÄÉËôëÂÖ≥ÈîÆÂ∏ßÈÄâÊã©ÔºåÂÖ®ÈÉ®‰øÆÊîπ
								sliderTime = keys[i].time -- ‰ΩøÁî® at time ÊñπÂºè‰ºöÂØºËá¥ sliderTime ÁöÑÂßøÂäøÁîüÊàêÂÖ≥ÈîÆÂ∏ßÔºåÊâÄ‰ª•Áõ¥Êé•ÊîπÂèò sliderTime ËøõË°å
								biped.setSlidingKey obj
							)
							if keyboard.controlPressed do (
								-- Ctrl Êåâ‰∏ãÂàôÂè™‰øÆÊîπÈÄâ‰∏≠ÁöÑÂÖ≥ÈîÆÂ∏ß
								if keys[i].selected == true do (
									sliderTime = keys[i].time -- ‰ΩøÁî® at time ÊñπÂºè‰ºöÂØºËá¥ sliderTime ÁöÑÂßøÂäøÁîüÊàêÂÖ≥ÈîÆÂ∏ßÔºåÊâÄ‰ª•Áõ¥Êé•ÊîπÂèò sliderTime ËøõË°å
									biped.setSlidingKey obj
								)
							)
						)
						animationRange = animRangeBackup -- ÊÅ¢Â§çÂéüÊù•ÁöÑÂä®ÁîªÂå∫Èó¥
					)
					else (
						biped.setSlidingKey obj
					)
				)
			) -- for
		) -- Undo
		if tempPanel != #motion do setCommandPanelTaskMode mode:tempPanel
		enableSceneRedraw()
		sliderTime = timeBefore
	)

	on uiBtnLimbFK changed state do (
		uiBtnLimbFK.state = on -- ‰ªª‰ΩïÁä∂ÊÄÅ‰∏ãÊåâÈíÆÁä∂ÊÄÅÈÉΩ‰øùÊåÅÊåâ‰∏ã
		local tempPanel = getCommandPanelTaskMode()
		setCommandPanelTaskMode mode:#motion -- biped.setSlidingKey Á≠âÂäüËÉΩÂè™Âú® Motion Èù¢ÊùøÊ≠£Â∏∏Â∑•‰ΩúÔºåÂÖ∂‰ªñÂú∞Êñπ‰ºöÂØºËá¥ÈîôËØØÂßøÂäøË¶ÜÁõñ
		local timeBefore = sliderTime
		disableSceneRedraw()
		undo on (
			for obj in selection do (
				if (IfLimb obj) do (
					if (keyboard.shiftPressed OR keyboard.controlPressed) then (
						local keys = obj.controller.keys
						local animRangeBackup = animationRange -- Ïû†Ïãú Î∞îÍπ•Ïóê ÏûàÎäî ÌÇ§Îì§ÎèÑ ÏàòÏ†ïÌï† Ïàò ÏûàÎèÑÎ°ù ÌòÑÏû¨Ïùò Ïï†ÎãàÎ©îÏù¥ÏÖò Íµ¨Í∞ÑÏùÑ Í∏∞ÏñµÌïúÎã§.
						animationRange = Interval keys[1].time keys[keys.count].time
						for i = 1 to keys.count do (
							if keyboard.shiftPressed do (
								-- ShiftÍ∞Ä ÎàåÎ†§ÏûàÏúºÎ©¥ ÌÇ§ ÏÑ†ÌÉùÍ≥º ÏÉÅÍ¥Ä ÏóÜÏù¥ Î™®Îëê Î≥ÄÍ≤Ω
								sliderTime = keys[i].time -- at time Î∞©ÏãùÏúºÎ°ú ÌïòÎ©¥ sliderTimeÏùò ÏûêÏÑ∏Î°ú ÌÇ§Í∞Ä ÏÉùÏÑ±ÎêòÎäî Î¨∏Ï†úÍ∞Ä ÏûàÏñ¥ÏÑú Ïã§Ï†ú sliderTimeÏùÑ Î≥ÄÍ≤ΩÏãúÏºúÏÑú ÏßÑÌñâ
								biped.setFreeKey obj
							)
							if keyboard.controlPressed do (
								-- CtrlÏù¥ ÎàåÎ†§ÏûàÏúºÎ©¥ ÏÑ†ÌÉùÎêú ÌÇ§Îì¶Îßå Î≥ÄÍ≤Ω
								if keys[i].selected == true do (
									sliderTime = keys[i].time -- at time Î∞©ÏãùÏúºÎ°ú ÌïòÎ©¥ sliderTimeÏùò ÏûêÏÑ∏Î°ú ÌÇ§Í∞Ä ÏÉùÏÑ±ÎêòÎäî Î¨∏Ï†úÍ∞Ä ÏûàÏñ¥ÏÑú Ïã§Ï†ú sliderTimeÏùÑ Î≥ÄÍ≤ΩÏãúÏºúÏÑú ÏßÑÌñâ
									biped.setFreeKey obj
								)
							)
						)
						animationRange = animRangeBackup -- Îã§Ïãú ÏõêÎûòÎåÄÎ°úÏùò Ïï†ÎãàÎ©îÏù¥ÏÖò Íµ¨Í∞ÑÏúºÎ°ú Î≥µÍµ¨
					)
					else (
						biped.setFreeKey obj
					)
				)
			) -- for
		) -- Undo
		if tempPanel != #motion do setCommandPanelTaskMode mode:tempPanel
		enableSceneRedraw()
		sliderTime = timeBefore
	)

	on uiHead changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiHead.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			Straighten m_Head ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array
		
		try(CompSelect selBackup m_Head) catch (
			m_Head = GetHead()
			select m_Head
		)
	)

	on uiHead rightclick do 
	(
		-- ÂàáÊç¢È¢úÊñáÂ≠óËÑ∏
		currentFaceIndex += 1
		if currentFaceIndex > headFaces.count then currentFaceIndex = 1
		uiHead.caption = headFaces[currentFaceIndex]
		uiHead.state = on
		-- ‰øùÂ≠òÂà∞ÈÖçÁΩÆÊñá‰ª∂
		SetINISetting iniBsBipedTools "BsBipedTools" "HeadFaceIndex" (currentFaceIndex as string)
	)

	on btnResetFace pressed do 
	(
		-- ËøòÂéüËÑ∏ÂûãÂà∞ÂàùÂßãÁä∂ÊÄÅ
		if (queryBox "Á°ÆÂÆöË¶ÅËøòÂéüÂ§¥ÈÉ®Ë°®ÊÉÖÂà∞ÂàùÂßãÁä∂ÊÄÅÂêóÔºü" title:"ËøòÂéüË°®ÊÉÖÁ°ÆËÆ§") then
		(
			currentFaceIndex = 1
			uiHead.caption = headFaces[currentFaceIndex]
			uiHead.state = on
			SetINISetting iniBsBipedTools "BsBipedTools" "HeadFaceIndex" (currentFaceIndex as string)
			messageBox "Â§¥ÈÉ®Ë°®ÊÉÖÂ∑≤ËøòÂéüÂà∞ÂàùÂßãÁä∂ÊÄÅÔºÅ" title:"BsBipedTools"
		)
	)

	on uiNecks changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiNecks.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			Straighten m_Necks ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_Necks) catch (
			m_Necks = GetNecks()
			select m_Necks
			
		)
	)
	
	on uiRArms changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRArms.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		selBackup = selection as array

		try(CompSelect selBackup m_RArms) catch (
			m_RArms = GetRArms()
			select m_RArms
			
		)
	)

	on uiRArms rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRArms.state = on
		m_LArms = GetLArms()
		select m_LArms
	) 
	
	on uiLArms changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLArms.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		selBackup = selection as array

		try(CompSelect selBackup m_LArms) catch (
			m_LArms = GetLArms()
			select m_LArms
			
		)
	)

	on uiLArms rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLArms.state = on
		m_RArms = GetRArms()
		select m_RArms
	) 
	
	on uiRClavicle changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRClavicle.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			StraightenByProxy m_RClavicle m_AllSpine[m_AllSpine.count] ((eulerangles 0 90 -180) as quat)
			return ()
		)

		selBackup = selection as array

		try(CompSelect selBackup m_RClavicle) catch (
			m_RClavicle = GetRClavicle()
			select m_RClavicle
			
		)
	)

	on uiRClavicle rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRClavicle.state = on
		m_LClavicle = GetLClavicle()
		select m_LClavicle
	) 

	on uiLClavicle changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLClavicle.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			StraightenByProxy m_LClavicle m_AllSpine[m_AllSpine.count] ((eulerangles 0 -90 -180) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_LClavicle) catch (
			m_LClavicle = GetLClavicle()
			select m_LClavicle
			
		)
	)

	on uiLClavicle rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLClavicle.state = on
		m_RClavicle = GetRClavicle()
		select m_RClavicle
	)
	
	on uiRUpArm changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRUpArm.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			Straighten m_RUpArm ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_RUpArm) catch (
			m_RUpArm = GetRUpArm()
			select m_RUpArm
			
		)
	)

	on uiRUpArm rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRUpArm.state = on
		m_LUpArm = GetLUpArm()
		select m_LUpArm
	)

	on uiAllSpine changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiAllSpine.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			Straighten m_AllSpine ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_AllSpine) catch (
			m_AllSpine = GetAllSpine()
			select m_AllSpine
			
		)
	)

	on uiSpine3 changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiSpine3.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			Straighten m_Spine3 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		-- Í∏∞Ï°¥ selection Î∞±ÏóÖÍ≥º Ïù¥Î≤àÏóê ÏÑ†ÌÉùÌï† selArr ÏùÑ ÏûÖÎ†•Î∞õÏïÑ ÌÇ§Î≥¥Îìú Ï°∞Ìï©ÏúºÎ°ú Ï†ÅÏ†àÌïòÍ≤å ÏÑ†ÌÉùÌïúÎã§. Î∂ÄÏàòÏ†ÅÏúºÎ°ú Î™®ÏÖòÌå®ÎÑêÎ°úÏùò Î≥ÄÍ≤ΩÎèÑ Í∞ôÏù¥ ÏàòÌñâ
		try(CompSelect selBackup m_Spine3) catch (
			m_Spine3 = GetSpine 3
			select m_Spine3
		)
	)

	on uiSpine2 changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiSpine2.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			Straighten m_Spine2 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_Spine2) catch (
			m_Spine2 = GetSpine 2
			select m_Spine2
			
		)
	)

	on uiSpine1 changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiSpine1.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			Straighten m_Spine1 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_Spine1) catch (
			m_Spine1 = GetSpine 1
			select m_Spine1
			
		)
	)

	on uiSpine0 changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiSpine0.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			Straighten m_Spine0 ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_Spine0) catch (
			m_Spine0 = GetSpine 0
			select m_Spine0
			
		)
	)

	on uiLUpArm changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLUpArm.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			Straighten m_LUpArm ((eulerangles 0 0 0) as quat)
			return ()
		)

		selBackup = selection as array

		try(CompSelect selBackup m_LUpArm) catch (
			m_LUpArm = GetLUpArm()
			select m_LUpArm
			
		)
	)

	on uiLUpArm rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLUpArm.state = on
		m_RUpArm = GetRUpArm()
		select m_RUpArm
	)
	
	on uiRForArm changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRForArm.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			Straighten m_RForArm ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_RForArm) catch (
			m_RForArm = GetRForArm()
			select m_RForArm
			
		)
	)

	on uiRForArm rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRForArm.state = on
		m_LForArm = GetLForArm()
		select m_LForArm
	)

	on uiLForArm changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLForArm.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			Straighten m_LForArm ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_LForArm) catch (
			m_LForArm = GetLForArm()
			select m_LForArm
			
		)
	)

	on uiLForArm rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLForArm.state = on
		m_RForArm = GetRForArm()
		select m_RForArm
	)
	
	on uiRHand changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRHand.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			Straighten m_RHand ((eulerangles 90 0 0) as quat)
			return ()
		)

		selBackup = selection as array

		try(CompSelect selBackup m_RHand) catch (
			m_RHand = GetRHand()
			select m_RHand
			
		)
	)

	on uiRHand rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRHand.state = on
		m_LHand = GetLHand()
		select m_LHand
	)

	on uiCOM changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiCOM.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		selBackup = selection as array
        
        -- ÏÉàÎ°úÏö¥ Ïî¨ÏùÑ Ïó¥Î©¥ m_workingBipRootÏù¥ undefinedÎäî ÏïÑÎãàÏßÄÎßå ÏóêÎü¨ Î∞úÏÉùÌï®
        try (
            if ( m_workingBipRoot.isHidden == false ) or uiChkSelHiddenObj.state then (
                CompSelect selBackup #(m_workingBipRoot)
            )
            else (
                clearselection()
            )
        )
        catch (
            if (AutoGetBipRoot() == false) do ( SetButtonState false; return ())
            if ( m_workingBipRoot.isHidden == false ) or uiChkSelHiddenObj.state then (
                CompSelect selBackup #(m_workingBipRoot)
            )
            else (
                clearselection()
            )
        )
		
	)
	
	on uiLHand changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLHand.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			Straighten m_LHand ((eulerangles -90 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_LHand) catch (
			m_LHand = GetLHand()
			select m_LHand
		)
	)

	on uiLHand rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLHand.state = on
		m_RHand = GetRHand()
		select m_RHand
	)
	
	on uiPelvis changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiPelvis.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			Straighten m_Pelvis ((eulerangles -90 -90 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_Pelvis) catch (
			m_Pelvis = GetPelvis()
			select m_Pelvis
			
		)
	)
	
	on uiRThigh changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRThigh.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			StraightenByProxy m_RThigh m_Pelvis[1] ((eulerangles 0 180 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_RThigh) catch (
			m_RThigh = GetRThigh()
			select m_RThigh
			
		)
	)

	on uiRThigh rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRThigh.state = on
		m_LThigh = GetLThigh()
		select m_LThigh
	)

	on uiLThigh changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLThigh.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			StraightenByProxy m_LThigh m_Pelvis[1] ((eulerangles 0 -180 0) as quat)
			return ()
		)
		
		selBackup = selection as array
		
		try(CompSelect selBackup m_LThigh) catch (
			m_LThigh = GetLThigh()
			select m_LThigh
			
		)
	)

	on uiLThigh rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLThigh.state = on
		m_RThigh = GetRThigh()
		select m_RThigh
	)
	
	on uiRCalf changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRCalf.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			Straighten m_RCalf ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_RCalf) catch (
			m_RCalf = GetRCalf()
			select m_RCalf
			
		)
	)

	on uiRCalf rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRCalf.state = on
		m_LCalf = GetLCalf()
		select m_LCalf
	)

	on uiLCalf changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLCalf.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			Straighten m_LCalf ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_LCalf) catch (
			m_LCalf = GetLCalf()
			select m_LCalf
			
		)
	)

	on uiLCalf rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLCalf.state = on
		m_RCalf = GetRCalf()
		select m_RCalf
	)
	
	on uiRFoot changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRFoot.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			Straighten m_RFoot ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_RFoot) catch (
			m_RFoot = GetRFoot()
			select m_RFoot
			
		)
	)

	on uiRFoot rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRFoot.state = on
		m_LFoot = GetLFoot()
		select m_LFoot
	)
	
	on uiLFoot changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLFoot.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		
		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			Straighten m_LFoot ((eulerangles 0 0 0) as quat)
			return ()
		)
		
		selBackup = selection as array

		try(CompSelect selBackup m_LFoot) catch (
			m_LFoot = GetLFoot()
			select m_LFoot
			
		)
	)

	on uiLFoot rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLFoot.state = on
		m_RFoot = GetRFoot()
		select m_RFoot
	)

	on uiRToe changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRToe.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù

		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			Straighten m_RToe ((eulerangles 0 0 90) as quat)
			return ()
		)

		selBackup = selection as array
		
		try(CompSelect selBackup m_RToe) catch (
			m_RToe = GetRToe()
			select m_RToe
			
		)
	)

	on uiRToe rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRToe.state = on
		m_LToe = GetLToe()
		select m_LToe
	)

	on uiLToe changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLToe.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù

		if keyboard.controlPressed and keyboard.altpressed do (
			-- Shift Î•º ÎàÑÎ•¥Î©¥ ÎòëÎ∞îÎ°ú Ìé¥Îäî Í∏∞Îä•
			Straighten m_LToe ((eulerangles 0 0 90) as quat)
			return ()
		)

		selBackup = selection as array

		try(CompSelect selBackup m_LToe) catch (
			m_LToe = GetLToe()
			select m_LToe
			
		)
	)

	on uiLToe rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLToe.state = on
		m_RToe = GetRToe()
		select m_RToe
	)
	
	on uiRLegs changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRLegs.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		selBackup = selection as array

		try(CompSelect selBackup m_RLegs) catch (
			m_RLegs = GetRLegs()
			select m_RLegs
			
		)
	)

	on uiRLegs rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiRLegs.state = on
		m_LLegs = GetLLegs()
		select m_LLegs
	)
	
	on uiAllFoot changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiAllFoot.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		selBackup = selection as array

		try(CompSelect selBackup m_AllFoot) catch (
			m_AllFoot = GetAllFoot()
			select m_AllFoot
		)
	)
	
	on uiLLegs changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLLegs.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù
		selBackup = selection as array

		try(CompSelect selBackup m_LLegs) catch (
			m_LLegs = GetLLegs()
			select m_LLegs
			
		)
	)

	on uiLLegs rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiLLegs.state = on
		m_RLegs = GetRLegs()
		select m_RLegs
	)

	on uiPropL changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiPropL.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù

		selBackup = selection as array

		try(CompSelect selBackup m_LProp) catch (
			m_LProp = GetLProp()
			select m_LProp
		)
	)

	on uiPropL rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiPropL.state = on
		m_RProp = GetRProp()
		select m_RProp
	)

	on uiPropR changed state do (
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiPropR.state = on -- Ïñ¥Îñ§ ÏÉÅÌÉúÏóêÏÑúÎèÑ Î≤ÑÌäº Ïä§ÌÖåÏù¥Ìä∏Îäî ÎàåÎ†§ÏûàÎèÑÎ°ù

		selBackup = selection as array

		try(CompSelect selBackup m_RProp) catch (
			m_RProp = GetRProp()
			select m_RProp
		)
	)

	on uiPropR rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiPropR.state = on
		m_LProp = GetLProp()
		select m_RProp
	)
	
	on uiSpnLoopStart changed var do (
		SaveRangeLoop()
		SetGotoMirrorEnable() -- Go to Mirror frame Î≤ÑÌäº ÌôúÏÑ±/ÎπÑÌôúÏÑ± ÏÑ§Ï†ï
	)
	on uiSpnLoopEnd changed var do (
		SaveRangeLoop()
		SetGotoMirrorEnable() -- Go to Mirror frame Î≤ÑÌäº ÌôúÏÑ±/ÎπÑÌôúÏÑ± ÏÑ§Ï†ï
	)

	on uiBtnGotoMirror changed state do (
		uiBtnGotoMirror.state = on
		local now = int sliderTime
		if (now < uiSpnLoopStart.value) OR (now > uiSpnLoopEnd.value) do return ()

		if now == uiSpnLoopEnd.value do (now = uiSpnLoopStart.value) -- Î£®ÌîÑ ÎÅù ÌîÑÎ†àÏûÑÏóêÏÑú Î≤ÑÌäºÏù¥ ÎàåÎü¨Ï°åÏúºÎ©¥ Ï≤´ ÌîÑÎ†àÏûÑÏúºÎ°ú Í∞ÑÏ£ºÌï®
		local fCount = uiSpnLoopEnd.value - uiSpnLoopStart.value
		fCount *= 0.5
		local targetFrame = (int sliderTime) + fCount
		if targetFrame == uiSpnLoopEnd.value do (
			sliderTime = uiSpnLoopStart.value
			return ()
		)
		if targetFrame > uiSpnLoopEnd.value then (
			sliderTime = uiSpnLoopStart.value + (targetFrame - uiSpnLoopEnd.value)
			return ()
		)
		else (
			sliderTime = targetFrame
			return ()
		)
	)

	-- IK Blend, Body/Object Îì±Ïùò ÌÇ§Í∞íÏùÑ Ï°∞ÏÇ¨Ìï¥ÏÑú Planted, Sliding, Free ÏÖã Ï§ë ÌïòÎÇòÏùò ÌÉÄÏûÖÏùÑ Î¶¨ÌÑ¥ÌïúÎã§.
	fn GetLimbKeyType key = (
		-- ikSpace 0 = Body, 1 = Object
		if key.ikBlend == 1 AND key.ikSpace == 1 AND key.ikJoinedPivot == true do return "Planted"
		if key.ikBlend == 1 AND key.ikSpace == 1 AND key.ikJoinedPivot == false  do return "Sliding"
		return "Free"
	)

	on uiBtnLoopSel changed state do (
		uiBtnLoopSel.state = true

		for obj in selection do (
			DeselectAllKeys obj
			-- ÏÑ†ÌÉùÏãú Ïª®Ìä∏Î°§Îü¨Îäî ÏÑ∏Î∂Ä Ïª®Ìä∏Î°§Îü¨ Î™ÖÏãú ÏóÜÏñ¥ÎèÑ ÎåÄÏ∂© Ïûò ÏÑ†ÌÉùÌï¥Ï§å
			selectKeys obj.controller (interval uiSpnLoopStart.value uiSpnLoopEnd.value)
		)
	)
	
	on uiBtnLoopGet changed state do (
		uiBtnLoopGet.state = true
		undo on (
			uiSpnLoopStart.value = animationRange.start as integer / TicksPerFrame
			uiSpnLoopEnd.value = animationRange.end as integer / TicksPerFrame
			SaveRangeLoop()
		)
	)

	on uiDropPlaySpeed selected sel do (
        timeConfiguration.playbackSpeed = sel
        SetPBPlaySpeed()
    )

    -- ÌîÑÎ†àÏûÑÏùÑ Ìã±ÏúºÎ°ú, Ìã±ÏùÑ Î∞ÄÎ¶¨ÏÑ∏Ïª®ÎìúÎ°ú (integer Î¶¨ÌÑ¥)
    function FramToMilisecond frame = (
		-- animationRange.startÎ•º ÎπºÏ£ºÏßÄ ÏïäÏúºÎ©¥ 0ÌîÑÎ†àÏûÑÏù¥ ÏïÑÎãå Í≥≥ÏóêÏÑú ÏãúÏûëÌï† Îïå ÎîúÎ†àÏù¥ Î∞úÏÉùÌï®
		return ((((frame - animationRange.start) as integer) * (10.0 / 48.0) * m_PBPlaySpeed) as integer)
    )

    function AppendKeyTimeArray m_PBKeyMiliSecArray keys = (
        if keys.count == 0 do return()
        for i = 1 to keys.count do (
            if (keys[i].time >= animationRange.start) AND (keys[i].time <= animationRange.end) do (
                appendifUnique m_PBKeyMiliSecArray (FramToMilisecond keys[i].time)
                appendifUnique m_PBKeyTimeArray keys[i].time
            )
        )
        -- Ïï†ÎãàÎ©îÏù¥ÏÖò Î†àÏù∏ÏßÄÏùò ÏãúÏûëÍ≥º ÎÅùÏùÄ Î¨¥Ï°∞Í±¥ Ìè¨Ìï®ÏãúÌÇ¥
        appendifUnique m_PBKeyMiliSecArray (FramToMilisecond animationRange.start)
        appendifUnique m_PBKeyTimeArray animationRange.start
        appendifUnique m_PBKeyMiliSecArray (FramToMilisecond animationRange.end)
        appendifUnique m_PBKeyTimeArray animationRange.end
	)
	
	function StopBlocking = (
        clock.active = false
        uiPlayBlock.state = false
        uiPlayBlock.text = "Ë∑≥Â∏ßÊí≠"
	)
    
    function PlayBlocking = (
		m_PBKeyTimeArray = #() -- Î∏îÎü≠ÌÇπ Ïï†ÎãàÎ©îÏù¥ÏÖòÏö© ÌÇ§ ÌÉÄÏûÑ Î∞∞Ïó¥ Î°úÏª¨ Î≥ÄÏàò (Frame)
        m_PBKeyMiliSecArray = #() -- Î∏îÎü≠ÌÇπ Ïï†ÎãàÎ©îÏù¥ÏÖòÏö© ÌÇ§ ÌÉÄÏûÑ Î∞∞Ïó¥ Î°úÏª¨ Î≥ÄÏàò (Î∞ÄÎ¶¨ÏÑ∏Ïª®Îìú)
        local nowTime = timeStamp()
        for obj in selection do (
            if (classof obj.baseObject) == Biped_Object do (
                if (IfBipRoot obj) then (
					turnCtrlObj = (fnBipedComlocalization obj.transform.controller)
                    AppendKeyTimeArray m_PBKeyMiliSecArray obj.transform.controller.horizontal.controller.keys
                    AppendKeyTimeArray m_PBKeyMiliSecArray obj.transform.controller.vertical.controller.keys
                    AppendKeyTimeArray m_PBKeyMiliSecArray turnCtrlObj.keys
                )
                else (
                    AppendKeyTimeArray m_PBKeyMiliSecArray obj.transform.controller.keys
                )
            )
		)
		if m_PBKeyMiliSecArray.count == 0 do (
			StopBlocking()
			return() -- ÏùºÎ∞ò Ïò§Î∏åÏ†ùÌä∏Î•º ÏÑ†ÌÉùÌïòÎ©¥ Î∞∞Ïó¥Ïù¥ ÎπÑÏñ¥ÏûàÏùå
		)
		
		if (isAnimPlaying()) do (
			stopAnimation()
		)		
		
        sort m_PBKeyTimeArray
        sort m_PBKeyMiliSecArray
        m_PBPointer = 1
        while (m_PBKeyTimeArray[m_PBPointer] < sliderTime) do (
            m_PBPointer += 1
        )

        m_PBStartTime = timeStamp() - (FramToMilisecond sliderTime)
		sliderTime = m_PBKeyTimeArray[m_PBPointer] -- ÏùºÎã® Ïä¨ÎùºÏù¥Îçî ÌÉÄÏûÑÏùÑ ÎèôÍ∏∞Ìôî (ÏïàÌïòÎ©¥ Í∞ïÏ†úÎ°ú Ïä§ÌÜ±Îê®)
		clock.active = true
		uiPlayBlock.text = "Stop"
    )
	
	function ReplayBlocking = (
		m_PBPointer = 1
        m_PBStartTime = timeStamp()
        sliderTime = m_PBKeyTimeArray[m_PBPointer]
	)

	on uiPlayBlock changed state do (
        if (selection.count == 0) do (
            StopBlocking()
            return()
        )
		if state then (
            PlayBlocking()
        )
        else (
            StopBlocking()
        )
    )
    
    -- Play BlockingÏö© Ìã± Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
    on clock tick do (
        if (m_PBPointer > m_PBKeyMiliSecArray.count) do return()
		local now = timeStamp()
		local pointer
		if (m_PBKeyMiliSecArray.count == m_PBPointer) then (
			ReplayBlocking()
			pointer = 1
		)
		else (
			pointer = m_PBStartTime + m_PBKeyMiliSecArray[m_PBPointer + 1] -- Îã§Ïùå ÌÇ§ÌîÑÎ†àÏûÑÍ≥º ÌòÑÏû¨ ÏãúÍ∞ÑÏùÑ ÎπÑÍµê
		)
        
        -- ÌòÑÏû¨ ÏãúÍ∞ÑÏù¥ Îã§Ïùå ÌîÑÎ†àÏûÑÏùÑ ÎÑòÏñ¥ÏÑúÎ©¥ Ìè¨Ïù∏ÌÑ∞ Ï¶ùÍ∞Ä, Ïä¨ÎùºÏù¥Îçî Î≥ÄÍ≤Ω
        if ( now > pointer ) do (
            m_PBPointer += 1
            sliderTime = m_PBKeyTimeArray[m_PBPointer]
        )
        
        -- Ìè¨Ïù∏ÌÑ∞Í∞Ä ÎßàÏßÄÎßâ ÌîÑÎ†àÏûÑÏùÑ Í∞ÄÎ¶¨ÌÇ§Î©¥ Ï≤òÏùåÏúºÎ°ú ÎêòÎèåÎ¶¨Í≥† ÏãúÏûëÏãúÍ∞Ñ Î¶¨ÏÖã
        if (m_PBPointer >= m_PBKeyMiliSecArray.count) do (
            ReplayBlocking()
        )

        if keyboard.escPressed do (
            StopBlocking()
		)
		
		-- Ïô∏Î∂Ä ÏöîÏù∏Ïóê ÏùòÌï¥ Í∞ïÏ†úÎ°ú Ïä¨ÎùºÏù¥Îçî ÏãúÍ∞ÑÏù¥ Î≥ÄÍ≤ΩÎêòÎ©¥ ÏÇ¨Ïö©ÏûêÏóê ÏùòÌïú ÌîåÎ†àÏù¥ Ï∑®ÏÜåÎ°ú Í∞ÑÏ£º
		if (sliderTime != m_PBKeyTimeArray[m_PBPointer]) do (
			StopBlocking()
		)
    )

	on uiAbout pressed do (
		-- shellLaunch "http://cafe.naver.com/pinksox/6131" ""
		-- rolBsAboutPanel.Show()
		try(destroyDialog rolBsBipToolsHelp)catch()
		Createdialog rolBsBipToolsHelp style:#(#style_titlebar, #style_sysmenu, #style_toolwindow)
	)
	
	on rolBsBipedTools open do (
		
		if NOT (doesFileExist postureObjsFile) do
		(
			local txtFile = openFile postureObjsFile mode:"w"
			close txtFile
		)

		fnLoadBsBTConfig()
		-- Âä†ËΩΩ‰øùÂ≠òÁöÑËÑ∏Âûã
		local savedIndex = (GetINISetting iniBsBipedTools "BsBipedTools" "HeadFaceIndex") as integer
		if savedIndex != undefined and savedIndex > 0 and savedIndex <= headFaces.count then
		(
			currentFaceIndex = savedIndex
		)
		else
		(
			currentFaceIndex = 1
		)
		-- ËÆæÁΩÆË°®ÊÉÖÔºàÂú®UIÂàõÂª∫ÂêéÔºâ
		uiHead.caption = headFaces[currentFaceIndex]
		fnApplyIcons()
        InitLocalVars() -- ÏûëÏóÖÏö© Î∞îÏù¥Ìå®Îìú Î£®Ìä∏ ÎÖ∏ÎìúÎùºÎçòÍ∞Ä, ÏÑ†ÌÉùÏö© Î∞∞Ïó¥ Î≥ÄÏàò Îì±ÏùÑ ÎØ∏Î¶¨ ÏÑ∏ÌåÖ
        
		fnInitDotTabs()
		fnChangeToolsVisble (dotnetTabs.SelectedIndex + 1)
		if fnIsValidBiped() then 
		(
			ctrl = m_workingBipRoot.controller
			if m_LHand[1] != undefined then uiCbtLeftArm.checked = biped.getLimbRetargetState m_LHand[1]
			if m_RHand[1] != undefined then uiCbtRightArm.checked = biped.getLimbRetargetState m_RHand[1]
			if m_LFoot[1] != undefined then uiCbtLeftLeg.checked = biped.getLimbRetargetState m_LFoot[1]
			if m_RFoot[1] != undefined then uiCbtRightLeg.checked = biped.getLimbRetargetState m_RFoot[1]
		)

        callbacks.addScript #filePostOpen "rolBsBipedTools.InitLocalVars ()" id:#BsBTCallbackOpen
		callbacks.addScript #systemPostNew "rolBsBipedTools.InitLocalVars ()" id:#BsBTCallbackNew
		callbacks.addScript #systemPostReset "rolBsBipedTools.InitLocalVars ()" id:#BsBTCallbackReset
		callbacks.addScript #selectionSetChanged "rolBsBipedTools.InitLocalVars ()" id:#BsBTSelChange
		callbacks.addScript #sceneUndo "rolBsBipedTools.InitLocalVars()" id:#BsBTUpdateLayers
		
		fnSetBsBTConfig()

	)
	
	on rolBsBipedTools close do (
        callbacks.removeScripts id:#BsBTCallbackOpen
		callbacks.removeScripts id:#BsBTCallbackNew
		callbacks.removeScripts id:#BsBTCallbackReset
		callbacks.removeScripts id:#BsBTSelChange
		callbacks.removeScripts id:#BsBTUpdateLayers
		fnSetBsBTConfig()
	)

	on rolBsBipedTools mbuttondown pos do 
	(
		try (destroydialog rolBsBipedTools) catch ()
	)
	
	on rolBsBipedTools lbuttondown posMou do
	(
		setSysCur #move
		posBsBipedTools = posMou
		dragBsBipedTools = on
	)
	
	on rolBsBipedTools lbuttonup posMou do
	(
		dragBsBipedTools = off
		iniBsBTPos = (GetDialogPos rolBsBipedTools)
		fnSetBsBTConfig()
	)
	
	on rolBsBipedTools mouseMove pos do
	(
		if dragBsBipedTools == on then
		(
			SetDialogPos rolBsBipedTools (mouse.screenpos - posBsBipedTools)
		)
	)

	on btnClose pressed do 
	(
		try (destroydialog rolBsBipedTools) catch ()
	)

	on btnMini pressed do 
	(
		if rolBsBipedTools.height == 458 then rolBsBipedTools.height = 585
		else rolBsBipedTools.height = 458
	)

	on ddlAllBipedCom selected sel do
	(
		try
		(
			select arrAllBipedCom[sel]
			InitLocalVars()
		)
		catch()
	)

	on uiBtnDeleteKey rightclick do
	(
		uiBtnDeleteKey.state = on 
		allBipedRootNode = fnGetAllSelRootNode()
		-- print allBipedRootNode
		for i in allBipedRootNode where isvalidnode i do 
		(
			if (queryBox ("ÊòØÂê¶Ê∏ÖÈô§ " + i.name + " È™®Êû∂ÁöÑÊâÄÊúâÂ∏ß?                        ") title:"BsBipedTools") do
			(
				biped.clearAllAnimation i.controller
			)
		)
	)

	on uiBtnDeleteKey changed state do
	(
		uiBtnDeleteKey.state = on
		undo on (	
			for b in selection as array where iskindof b.baseObject Biped_Object do
			(
				deselectKeys b.controller
				selectKeys b.controller sliderTime
				if ( classof b.controller == Vertical_Horizontal_Turn ) then
				(
					local arrComSelType = fnGetComTrackSelection b
					ctrlTurn = (fnBipedComlocalization b.controller)
					if arrComSelType[1] == 1 then
					(
						deleteKeys b.controller.horizontal.controller.keys #selection
					)
					if arrComSelType[2] == 1 then
					(
						deleteKeys b.controller.vertical.controller.keys #selection
					)
					if arrComSelType[3] == 1 then
					(
						deleteKeys ctrlTurn.keys #selection
					)
				)
				else
				(
					deleteKeys b.controller.keys #selection
				)
			)
		)
	)

	on uiToggleMotionPanel changed state do
	(
		uiToggleMotionPanel.state = on 
		try
		(
			suspendEditing which:#motion
			uiToggleMotionPanel.highlightColor = green
		)
		catch()
		-- messagebox "Â∑≤Á¶ÅÁî®MotionÈù¢Êùø,ËÉΩÂ§ßÂ§ßÈôç‰ΩéÈÄâÊã©Âç°È°ø,\r\n\r\nÂ¶ÇÈúÄÊÅ¢Â§çËØ∑Âè≥Âáª,Á¶ÅÁî®‰∫ÜÂá†Ê¨°Âè≥ÂáªÂá†Ê¨°ÊÅ¢Â§ç!                         " title:"BsBipedTools"
	)

	on uiToggleMotionPanel rightclick do
	(
		uiToggleMotionPanel.state = on 
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
		try
		(
			resumeEditing which:#motion
			uiToggleMotionPanel.highlightColor = mcMotionPanel
		)
		catch()
		-- messagebox "Â∑≤ÊÅ¢Â§çMotionÈù¢Êùø,\r\n\r\nÂ¶ÇÈúÄÁ¶ÅÁî®ËØ∑Â∑¶Âáª!                        " title:"BsBipedTools"
	)

	on uiCkbZen changed state do
	( 
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiCkbZen.state = on
		stateExpertMode = cui.getexpertmode()
		if stateExpertMode then 
		(
			cui.expertModeOff()
		)
		else
		(
			cui.expertModeOn()
		)
	)

	on uiCkbShowBox changed state do
	( 
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiCkbShowBox.state = on
		try(
			for o in m_AllBip where (o.isHidden == false) and (not isDeleted o) do 
			(
				if o.boxmode == off then o.boxmode = on 
				else o.boxmode = off
			)
		)
		catch(messageBox "È™®È™ºÂèØËÉΩÊúâÂèòÂä®ÔºåËØ∑ÂÖàÁÇπÂáª All Biped Âà∑Êñ∞È™®È™º!         " title:"BsBipedTools")
	)

	on uiCkbShowBox rightclick do
	( 
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiCkbShowBox.state = on
		try(
			for o in m_AllBip where (o.isHidden == false) and (not isDeleted o) do 
			(
				o.boxmode = on
			)
		)
		catch(messageBox "È™®È™ºÂèØËÉΩÊúâÂèòÂä®ÔºåËØ∑ÂÖàÁÇπÂáª All Biped Âà∑Êñ∞È™®È™º!         " title:"BsBipedTools")
	)

	on uiCkbXray changed state do
	( 
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiCkbXray.state = on
		try(
			for o in m_AllBip where (o.isHidden == false) and (not isDeleted o) do 
			(
				if o.xray == off then o.xray = on 
				else o.xray = off
			)
		)
		catch(messageBox "È™®È™ºÂèØËÉΩÊúâÂèòÂä®ÔºåËØ∑ÂÖàÁÇπÂáª All Biped Âà∑Êñ∞È™®È™º!         " title:"BsBipedTools")
	)

	on uiCkbXray rightclick do
	( 
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiCkbXray.state = on
		try(
			for o in m_AllBip where (o.isHidden == false) and (not isDeleted o) do 
			(
				o.xray = on
			)
		)
		catch(messageBox "È™®È™ºÂèØËÉΩÊúâÂèòÂä®ÔºåËØ∑ÂÖàÁÇπÂáª All Biped Âà∑Êñ∞È™®È™º!         " title:"BsBipedTools")
	)
	
	on uiCkbHideBip changed state do
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiCkbHideBip.state = on 
		try(
			for o in m_AllBip where (not isDeleted o) do 
			(
				if o.isHidden == off then o.isHidden = on 
				else o.isHidden = off
			)
			-- m_workingBipRoot.controller.displayFootsteps = false
			hide $*Footsteps
		)
		catch(messageBox "È™®È™ºÂèØËÉΩÊúâÂèòÂä®ÔºåËØ∑ÂÖàÁÇπÂáª All Biped Âà∑Êñ∞È™®È™º!         " title:"BsBipedTools")
	)

	on uiCkbHideBip rightclick do
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiCkbHideBip.state = on 
		try(
			for o in m_AllBip where (not isDeleted o) do 
			(
				o.isHidden = on
			)
			-- m_workingBipRoot.controller.displayFootsteps = false
			hide $*Footsteps
		)
		catch(messageBox "È™®È™ºÂèØËÉΩÊúâÂèòÂä®ÔºåËØ∑ÂÖàÁÇπÂáª All Biped Âà∑Êñ∞È™®È™º!         " title:"BsBipedTools")
	)

	on uiBtnFrameTick pressed do 
	(
		if timeDisplayMode != #frameTicks then 
		(
			timeDisplayMode = #frameTicks
		)
		else 
		(
			timeDisplayMode = #frames
		)
		disableSceneRedraw()
		trackbar.visible = false
		trackbar.visible = true
		enableSceneRedraw()
	)

	on uiBtnTraj changed state do 
	(
		uiBtnTraj.state = on 
		try
		(
			allBipedRootNode = fnGetAllSelRootNode()
			for i in allBipedRootNode where isvalidnode i do 
			(
				if i.controller.displaytrajectories then
				(
					i.controller.displaytrajectories = false
				)
				else
				(
					setCommandPanelTaskMode #motion
					i.controller.displaytrajectories = true
				)
			)
		)catch()
	)

	on uiCkbClearUserDef changed state do 
	(
		uiCkbClearUserDef.state = on
		allBipedRootNode = fnGetAllSelRootNode()
		print allBipedRootNode
		for i in allBipedRootNode where isvalidnode i do 
		(
			if (queryBox ("ÊòØÂê¶Ê∏ÖÈô§ " + i.name + " È™®Êû∂‰øùÂ≠òÁöÑÂæ™ÁéØÂ∏ßËá™ÂÆö‰πâÂ±ûÊÄßÂÄº?\r\n\r\nÔºàÂØπÊñá‰ª∂Êú¨Ë∫´Êó†‰ªª‰ΩïÂΩ±ÂìçÔºâ                                               ")) do
			(
				try 
				(
					fnDeleteUserProp i "BsBT_RangeLoopStart"
					fnDeleteUserProp i "BsBT_RangeLoopEnd"
					fnDeleteUserProp i "BsBT_Goto1"
					fnDeleteUserProp i "BsBT_Goto2"
					fnDeleteUserProp i "BsBT_Goto3"
					fnDeleteUserProp i "BsBT_Goto4"
					fnDeleteUserProp i "BsBT_Goto5"
					fnDeleteUserProp i "BsBT_Goto6"
					fnDeleteUserProp i "BsBT_Goto7"
					fnDeleteUserProp i "BsBT_Goto8"
					btnKey1.text = btnKey2.text = btnKey3.text = btnKey4.text = btnKey5.text = btnKey6.text = btnKey7.text = btnKey8.text = "Key"
					m_goto1 = m_goto2 = m_goto3 = m_goto4 = m_goto5 = m_goto6 = m_goto7 = m_goto8 = undefined
				)
				catch()
			)
		)
	)

	on uiWorkbench pressed do 
	(
		BipWorkBench.Open()
	)

	on uiFigureMode changed state do
	(
		arrBipCom = fnGetAllSelRootNode()
		for i in arrBipCom where arrBipCom.count != 0 do
		(
			if biped.getCurrentLayer i.controller == 0 then i.controller.figureMode = state
			else 
			(
				uiFigureMode.state = false
				messageBox "ÂΩìÂâç‰∏çÂ§Ñ‰∫é Original LayerÔºåÊó†Ê≥ïÊâìÂºÄÂΩ¢‰ΩìÊ®°ÂºèÔºÅ                                " title:"BsBipedTools"
			)
		)
	)

	on uiBtnInPlace changed state do
	(
		uiBtnInPlace.images = #("bip_general_i.bmp","bip_general_i.bmp",30,27,27,27,27,true,true)
		arrBipCom = fnGetAllSelRootNode()
		for i in arrBipCom where isvalidnode i do
		(
			if i.controller.figureMode == false then i.controller.inPlaceYMode  = state
			else 
			(
				uiBtnInPlace.state = false
				messagebox (i.name + "  ‰∏çËÉΩÂú®‰ΩìÂΩ¢Ê®°Âºè‰∏≠ÊâìÂºÄÂéüÂú∞Ê®°Âºè„ÄÇ                              ")  title:"BsBipedTools"
			)
		)
	)
	on uiBtnInPlace rightclick do
	(
		uiBtnInPlace.images = #("bip_general_i.bmp","bip_general_i.bmp",30,23,23,23,23,true,true)
		uiBtnInPlace.state  = not uiBtnInPlace.state
		arrBipCom = fnGetAllSelRootNode()
		for i in arrBipCom where isvalidnode i do
		(
			if i.controller.figureMode == false then i.controller.inPlaceMode  = uiBtnInPlace.state
			else 
			(
				uiBtnInPlace.state = false
				messagebox (i.name + "  ‰∏çËÉΩÂú®‰ΩìÂΩ¢Ê®°Âºè‰∏≠ÊâìÂºÄÂéüÂú∞Ê®°Âºè„ÄÇ                              ")  title:"BsBipedTools"
			)
		)
	)

	on uiCbtDown pressed do
	(
		if fnIsValidBiped() then
		(
			fnSyncBipedPanel()
			layerIndex = layerIndex - 1
			if layerIndex >= 0 then
			(
				biped.setCurrentLayer ctrl layerIndex
				uiCbtUp.enabled = true
				uiCbtUp.images = #("bip_layer_i.bmp","bip_layer_i.bmp",24,1,1,1,1,true,true)
				if layerIndex == 0 then
				(
					uiCbtDown.enabled = false
					uiCbtDown.images = #("bip_layer_i.bmp","bip_layer_i.bmp",24,4,4,4,4,true,true)
				)
			)
			else
			(
				layerIndex = 0
			)
		)	
		fnBSUpdateLayers()
	)

	on uiCbtUp pressed do
	(
		if fnIsValidBiped() then
		(
			fnSyncBipedPanel()
			layerIndex = layerIndex + 1
			if layerIndex <= numLayers then
			(
				biped.setCurrentLayer ctrl layerIndex
				uiCbtDown.enabled = true
				uiCbtDown.images = #("bip_layer_i.bmp","bip_layer_i.bmp",24,3,3,3,3,true,true)
				if layerIndex == numLayers then
				(
					uiCbtUp.enabled = false
					uiCbtUp.images = #("bip_layer_i.bmp","bip_layer_i.bmp",24,2,2,2,2,true,true)
				)
			)
			else
			(
				layerIndex = numLayers
				uiCbtUp.enabled = false
				uiCbtUp.images = #("bip_layer_i.bmp","bip_layer_i.bmp",24,2,2,2,2,true,true)
			)
		)
		fnBSUpdateLayers()
	)

	on uiChkActive changed state do
	(
		if fnIsValidBiped() then
		(
			fnSyncBipedPanel()
			if state then
			(
				biped.setLayerActive ctrl layerIndex true
			)
			else
			(
				biped.setLayerActive ctrl layerIndex false
			)
		)
		fnBSUpdateLayers()
	)

	on ddlLayers selected val do
	(
		if fnIsValidBiped() then
		(
			fnSyncBipedPanel()
			local index = val - 1
			if index <= numLayers then
			(
				biped.setCurrentLayer ctrl index
			)
		)
		fnBSUpdateLayers()
	)

	on uiCbtRefreshLayer changed state do
	(
		uiCbtRefreshLayer.state = true
		if fnIsValidBiped() then
		(
			fnBSUpdateLayers()
		)
	)

	on uiCbtLeftArm changed state do
	(
		if fnIsValidBiped() then 
		(
			if m_LHand[1] != undefined then (with undo on (biped.setLimbRetargetState m_LHand[1] state))
		)
	)
	
	on uiCbtRightArm changed state do
	(
		if fnIsValidBiped() then 
		(
			if m_RHand[1] != undefined then (with undo on (biped.setLimbRetargetState m_RHand[1] state))
		)
	)
	
	on uiCbtLeftLeg changed state do
	(
		if fnIsValidBiped() then 
		(
			if m_LFoot[1] != undefined then (with undo on (biped.setLimbRetargetState m_LFoot[1] state))
		)
	)
	
	on uiCbtRightLeg changed state do
	(
		if fnIsValidBiped() then 
		(
			if m_RFoot[1] != undefined then (with undo on (biped.setLimbRetargetState m_RFoot[1] state))
		)
	)
		
	on uiCbtUpdate pressed do
	(
		if fnIsValidBiped() then
		(
			with undo on (biped.retargetToBaseLayer ctrl uiChkIKonly.state)
			redrawViews()
		)
	)

	on uiCbtGrabPose changed state do
	(
		uiCbtGrabPose.state = true
		if isValidNode m_workingBipRoot AND NOT isDeleted m_workingBipRoot then
		(
			local bRootCtrl = m_workingBipRoot.controller
			biped.createCopyCollection bRootCtrl "PoseGrabber"
			local colIndex = biped.numCopyCollections bRootCtrl
			local copyCol = biped.getCopyCollection bRootCtrl colIndex
			biped.copyBipPose bRootCtrl copyCol #snapAuto
			local grabbeBH_pose = getCopy copyCol #pose 1
			biped.saveCopyPasteFile bRootCtrl (getDir #plugcfg + "\BsBipedTools_PoseGrabbed.cpy")
			biped.deleteCopyCollection bRootCtrl colIndex
		)
		else
		(
			fnMsgMissingBiped()			
		)	
	)
	
	on uiCbtLoadPose changed state do
	(
		uiCbtLoadPose.state = true
		if isValidNode m_workingBipRoot AND NOT isDeleted m_workingBipRoot then
		(
			local poseFile = getDir #plugcfg + "\BsBipedTools_PoseGrabbed.cpy"
			if doesFileExist poseFile then
			(
				local bRootCtrl = m_workingBipRoot.controller
				biped.loadCopyPasteFile bRootCtrl poseFile
				local colIndex = biped.numCopyCollections bRootCtrl
				local copyCol = biped.getCopyCollection bRootCtrl colIndex
				local grabbeBH_pose = getCopy copyCol #pose 1
				with Animate on
				(
					--// Requires two paste operations to work properly (Biped oddness)
					biped.pasteBipPose bRootCtrl grabbeBH_pose false #pstdefault true true true false
					biped.pasteBipPose bRootCtrl grabbeBH_pose false #pstdefault true true true false
				)
				local colIndex = biped.numCopyCollections bRootCtrl
				biped.deleteCopyCollection bRootCtrl colIndex
			)
			else
			(
				messageBox "ÈîôËØØ: ‰∏¥Êó∂ Pose Êñá‰ª∂‰∏çÂ≠òÂú®ÔºåËØ∑ÂÖàÊöÇÂ≠òPoseÔºÅ                              " title:"BsBipedTools"
			)
		)
		else
		(
			fnMsgMissingBiped()			
		)	
	)

	on uiPivot changed state do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiPivot.state = true

		try(destroyDialog rolBSLeftHandPivots)catch()
		try(destroyDialog rolBSRightHandPivots)catch()
		try(destroyDialog rolBSLeftFootPivots)catch()
		try(destroyDialog rolBSRightFootPivots)catch()

		case of 
		(
			(selection[1] == m_LHand[1]):(Createdialog rolBSLeftHandPivots pos:(mouse.screenPos + [40,-50]) parent:rolBsBipedTools.hwnd fgcolor:(if fnGetThemeColor() == "Light" then (color 28 89 177) else (color 165 222 228)) style:#(#style_titlebar, #style_sysmenu, #style_toolwindow))
			(selection[1] == m_RHand[1]):(Createdialog rolBSRightHandPivots pos:(mouse.screenPos + [40,-50]) parent:rolBsBipedTools.hwnd fgcolor:(if fnGetThemeColor() == "Light" then (color 28 89 177) else (color 165 222 228)) style:#(#style_titlebar, #style_sysmenu, #style_toolwindow))
			(selection[1] == m_LFoot[1]):(Createdialog rolBSLeftFootPivots pos:(mouse.screenPos + [40,-50]) parent:rolBsBipedTools.hwnd fgcolor:(if fnGetThemeColor() == "Light" then (color 28 89 177) else (color 165 222 228)) style:#(#style_titlebar, #style_sysmenu, #style_toolwindow))
			(selection[1] == m_RFoot[1]):(Createdialog rolBSRightFootPivots pos:(mouse.screenPos + [40,-50]) parent:rolBsBipedTools.hwnd fgcolor:(if fnGetThemeColor() == "Light" then (color 28 89 177) else (color 165 222 228)) style:#(#style_titlebar, #style_sysmenu, #style_toolwindow))
			default:(messageBox "ËØ∑ÂÖàÈÄâÊã©ÊâãÊàñËÑö‰ªªÊÑè‰∏ÄÊ†πÈ™®È™ºÔºåÂπ∂‰∏îËÆæÁΩÆÊªëÂä®Â∏ßÊàñÂõ∫ÂÆöÂ∏ß!                            " title:"BsBipedTools")
		)
	)

	on uiFingers changed state do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ( SetButtonState false; return ())
		uiFingers.state = true

		try(destroyDialog rolBSFingers)catch()

		Createdialog rolBSFingers pos:(mouse.screenPos - [310,100]) parent:rolBsBipedTools.hwnd style:#(#style_titlebar, #style_sysmenu, #style_toolwindow)
	)

	on uiBtnLoadBip changed state do
	(
		uiBtnLoadBip.state = true
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ((messageBox "ËØ∑ÂÖàÁ°ÆËÆ§Â≠òÂú®BipedÈ™®È™º!                            " title:"BsBipedTools");return ())
		biped.loadBipFileDlg m_workingBipRoot.controller
	)

	on uiBtnSaveBip changed state do
	(
		uiBtnSaveBip.state = true
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do ((messageBox "ËØ∑ÂÖàÁ°ÆËÆ§Â≠òÂú®BipedÈ™®È™º!                            " title:"BsBipedTools");return ())
		biped.saveBipFileDlg m_workingBipRoot.controller
	)

	on uiCbtAddLayer pressed do
	(
		with undo on
		(
			if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
			fnBSUpdateLayers()
			ctrlCom = m_workingBipRoot.controller
			numCurLayer = biped.getCurrentLayer ctrlCom
			countAllLayers = biped.numLayers ctrlCom
			numNewLayerIndex = numCurLayer + 1
			numNewLayerName = (countAllLayers + 1) as string
			biped.createLayer ctrlCom numNewLayerIndex ("Layer " + numNewLayerName )
		)
		fnBSUpdateLayers()
	)

	on uiCbtDelLayer pressed do
	(
		with undo on
		(
			if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
			fnBSUpdateLayers()
			ctrlCom = m_workingBipRoot.controller
			numCurLayer = biped.getCurrentLayer ctrlCom
			biped.deleteLayer ctrlCom numCurLayer
		)
		fnBSUpdateLayers()
	)

	on uiCbtDownLayer pressed do
	(
		with undo on
		(
			if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
			fnBSUpdateLayers()
			ctrlCom = m_workingBipRoot.controller
			numCurLayer = biped.getCurrentLayer ctrlCom
			biped.collapseAtLayer ctrlCom (numCurLayer - 1)
		)
		fnBSUpdateLayers()
	)

	on uiCbtSnapKeys pressed do
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
		fnBSUpdateLayers()
		ctrlCom = m_workingBipRoot.controller
		for obj in selection as array where not isDeleted obj and classof obj.baseobject == Biped_Object do 
		(
			if (classof obj.controller == Vertical_Horizontal_Turn) then
			(
				numCurLayer = biped.getCurrentLayer ctrlCom
				biped.setCurrentLayer ctrlCom (numCurLayer - 1)
				tranPos = biped.getTransform obj #pos
				tranRot = biped.getTransform obj #rotation
				biped.setCurrentLayer ctrlCom numCurLayer
				biped.setTransform obj #pos tranPos true
				biped.setTransform obj #rotation tranRot true
			)
			else
			(
				biped.setSnapKey obj
			)
		)
	)

	on uiCbtSnapKeys rightclick do 
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
		fnBSUpdateLayers()
		ctrlCom = m_workingBipRoot.controller
		numCurLayer = biped.getCurrentLayer ctrlCom
		for obj in selection as array where not isDeleted obj and classof obj.baseobject == Biped_Object do 
		(
			local arrAllBipedKeys = #()
			biped.setCurrentLayer ctrlCom (numCurLayer - 1)
			if (classof obj.controller == Vertical_Horizontal_Turn) then
			(
				arrKeyVer = for i in obj.controller.vertical.controller.keys collect i.time
				arrKeyHor = for i in obj.controller.horizontal.controller.keys collect i.time
				arrKeyTurn = for i in (fnBipedComlocalization obj.controller).keys collect i.time
				arrAllBipedKeys = arrKeyVer + arrKeyHor + arrKeyTurn
				arrAllBipedKeys = makeUniqueArray arrAllBipedKeys
				sort arrAllBipedKeys
				for t in arrAllBipedKeys where arrAllBipedKeys.count != 0 do 
				(
					-- at time t with animate on 
					slidertime = t
					with animate on
					(
						biped.createCopyCollection obj.controller "tempBipedComKeys"
						copycol= biped.getcopycollection obj.controller (biped.numCopyCollections obj.controller)
						icpmxbipcopy = biped.copybippose obj.controller copycol #snapview
						biped.setCurrentLayer ctrlCom numCurLayer
						biped.pastebippose obj.controller icpmxbipcopy false #pstdefault false true false false
						biped.deleteCopyCollection obj.controller (biped.numCopyCollections obj.controller)
					)
				)
			)
			else 
			(
				arrAllBipedKeys = for i in obj.controller.keys collect i.time
				biped.setCurrentLayer ctrlCom numCurLayer
				for t in arrAllBipedKeys where arrAllBipedKeys.count != 0 do 
				(
					at time t with animate on 
					(
						try (biped.addNewKey obj.controller t) catch ()
					)
				)
			)
		)
	)
	on uiCbtHorTrack changed state do 
	(
		-- fnSetComTrackSelection m_workingBipRoot
		uiCbtHorTrack.state = true
		uiCbtVerTrack.state = uiCbtTurnTrack.state = false
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
		m_workingBipRoot.controller.trackSelection = 1
		select m_workingBipRoot
	)
	on uiCbtVerTrack changed state do 
	(
		-- fnSetComTrackSelection m_workingBipRoot
		uiCbtVerTrack.state = true
		uiCbtHorTrack.state = uiCbtTurnTrack.state = false
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
		m_workingBipRoot.controller.trackSelection = 2
		select m_workingBipRoot
	)
	on uiCbtTurnTrack changed state do 
	(
		-- fnSetComTrackSelection m_workingBipRoot
		-- if not state then fnLockComTrack m_workingBipRoot
		uiCbtTurnTrack.state = true
		uiCbtVerTrack.state = uiCbtHorTrack.state = false
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
		m_workingBipRoot.controller.trackSelection = 3
		select m_workingBipRoot
	)

	on uiBtnComLock pressed do  -- ÈùûÁä∂ÊÄÅÊòæÁ§∫,Âè™ÊòØÂàáÊç¢ÊåâÈíÆ,Âõ†‰∏∫Ê≤°ÊâæÂà∞API,Âπ≤ËÑÜÂÖ®ÈîÅÂàáÊç¢
	(
		if (m_workingBipRoot == undefined or (isDeleted m_workingBipRoot)) do (return ())
		fnLockComTrack m_workingBipRoot
		fnRefreshTrackSelection m_workingBipRoot
	)

	on uiBtn0 changed state do
	(
		uiBtn0.state = true
		fnEvaluateTCB 0.0
	)
	on uiBtn25 changed state do
	(
		uiBtn25.state = true
		fnEvaluateTCB 25.0
	)

	on btnKey1 pressed do (GotoFrame btnKey1 &m_goto1 1)
	on btnKey2 pressed do (GotoFrame btnKey2 &m_goto2 2)
	on btnKey3 pressed do (GotoFrame btnKey3 &m_goto3 3)
	on btnKey4 pressed do (GotoFrame btnKey4 &m_goto4 4)
	on btnKey5 pressed do (GotoFrame btnKey5 &m_goto5 5)
	on btnKey6 pressed do (GotoFrame btnKey6 &m_goto6 6)
	on btnKey7 pressed do (GotoFrame btnKey7 &m_goto7 7)
	on btnKey8 pressed do (GotoFrame btnKey8 &m_goto8 8)

	on btnKey1 rightclick do (GotoFrame btnKey1 &m_goto1 1 setKey:true)
	on btnKey2 rightclick do (GotoFrame btnKey2 &m_goto2 2 setKey:true)
	on btnKey3 rightclick do (GotoFrame btnKey3 &m_goto3 3 setKey:true)
	on btnKey4 rightclick do (GotoFrame btnKey4 &m_goto4 4 setKey:true)
	on btnKey5 rightclick do (GotoFrame btnKey5 &m_goto5 5 setKey:true)
	on btnKey6 rightclick do (GotoFrame btnKey6 &m_goto6 6 setKey:true)
	on btnKey7 rightclick do (GotoFrame btnKey7 &m_goto7 7 setKey:true)
	on btnKey8 rightclick do (GotoFrame btnKey8 &m_goto8 8 setKey:true)
	
--///////////////////////////////////////////////////////////	
on btnAddScale pressed do
    (
        if (selection.count != 0) then
        (
            --.transform.controller.Biped_SubAnim.controller.BipScaleList.controller.Available.controller = ScaleXYZ ()
            for i in selection do
            (
                if (classOf i ==Biped_Object) and (i.transform.controller[1].name != "Vertical") do --Ë¥®ÂøÉ‰∏ç‰ΩúÁº©Êîæ
                (
                    undo "bipedscale" on
                    (try
                        (
                        bip_ed = i.transform.controller.rootnode
                        bip_ed.transform.controller.enableSubAnims = true
                        i.transform.controller[1][1][1].controller = ScaleXYZ ()
                        )catch()
                    )
                )
            )
        )
        else
        (
            messagebox "ËØ∑ÈÄâÊã©‰∏ÄÊ†πÊàñÂ§öÊ†π Biped È™®È™º!\n\r" beep:true title:"ÈÄâÊã©ÊúâËØØÔºÅ"
        )
    )

    on btnRemoveScale pressed do
    (
        if (selection.count != 0) then
        (
            for i in selection do
            (
                if (classOf i ==Biped_Object) and (i.transform.controller[1].name != "Vertical") do --Ë¥®ÂøÉ‰∏ç‰ΩúÁº©Êîæ
                (
                    undo "bipedscale_key" on --Âà†Èô§Áº©ÊîæÂ∏ß Ôºå
                    (
                        --deletekeys i.transform.controller[1][1][1].controller.keys #allKeys
                        lstctr = i.transform.controller[1][1]
                        try (lstctr.delete 1)catch()
                    )
                )
            )
        )
        else
        (
            messagebox "ËØ∑ÈÄâÊã©‰∏ÄÊ†πÊàñÂ§öÊ†π Biped È™®È™º!\n\r" beep:true title:"ÈÄâÊã©ÊúâËØØÔºÅ"
        )
    )

	
	
--////////////////////////////////////////////////////////		
	
	
)
if (iniBsBTPos != 0) then 
(Createdialog rolBsBipedTools pos:iniBsBTPos style:#() fgcolor:(if fnGetThemeColor() == "Light" then (color 28 89 177) else (color 165 222 228)))
else (Createdialog rolBsBipedTools style:#() fgcolor:(if fnGetThemeColor() == "Light" then (color 28 89 177) else (color 165 222 228)))
clearListener()