--åˆ¶ä½œè€…ï¼šæç›¸å…ƒ
--ä¿®æ”¹: Bullet.S

-- æ£€æŸ¥ä¿®æ”¹å™¨æ˜¯å¦å·²åŠ è½½
try (
	-- å°è¯•è·å–ä¿®æ”¹å™¨çš„classID
	local modClassID = execute "BsRootMotionModifier.classID"
	if modClassID == undefined do throw "Modifier not loaded"
) catch (
	messageBox "è¯·å…ˆåŠ è½½æ ¹è¿åŠ¨æ§åˆ¶å™¨è„šæœ¬ï¼\n\n1. å…³é—­å½“å‰æ–‡ä»¶\n2. è¿è¡Œè„šæœ¬: BsRootMotionToolsï¼ˆæ ¹è¿åŠ¨å·¥å…·ï¼‰\n3. é‡æ–°æ‰“å¼€Maxæ–‡ä»¶ï¼ˆå¦‚æœè¿˜å¼¹çª—ä¸ç”¨ç®¡ï¼Œå†å¼€ä¸€æ¬¡è„šæœ¬å°±å¥½ï¼‰                                                                  " title:"é”™è¯¯" beep:true
	exit
)

-- å®šä¹‰æ ¹è¿åŠ¨ä¿®æ”¹å™¨
plugin modifier BsRootMotionModifier
	name:"Bs_RootMotion_Ctrl"
	classID:#(0x7b72aada, 0x1462108b)
	version:1
	category:"BsKeyTools"
	extends:EmptyModifier
(
	-- å‚æ•°å®šä¹‰
	parameters main rollout:BsRMRollout (
		-- ä½¿ç”¨handleæ–¹å¼å­˜å‚¨å¯¹è±¡å¼•ç”¨ï¼Œé¿å…å¾ªç¯ä¾èµ–
		PelvisObjHandle type:#integer subAnim:false
		RootObjHandle type:#integer subAnim:false
		OriginalRootHandle type:#integer subAnim:false

		-- æ§åˆ¶å‚æ•°ï¼Œè¿™äº›ä¼šæ˜¾ç¤ºåœ¨æ›²çº¿ç¼–è¾‘å™¨ä¸­
		ManualX type:#float ui:spnManualX default:0
		ManualY type:#float ui:spnManualY default:0
		ManualZ type:#float ui:spnManualZ default:0
		TrackX type:#float ui:sliderTrackX default:0
		TrackX_Offset type:#float ui:spnTrackX_Offset default:0
		TrackY type:#float ui:sliderTrackY default:0
		TrackY_Offset type:#float ui:spnTrackY_Offset default:0
		TrackZ type:#float ui:sliderTrackZ default:0
		TrackZ_Offset type:#float ui:spnTrackZ_Offset default:0
		ManualYaw type:#float ui:spnManualYaw default:0
		TrackYaw type:#float ui:sliderTrackYaw default:0
		TrackYaw_Offset type:#float ui:spnTrackYaw_Offset default:90
	)

	-- UIå®šä¹‰
	rollout BsRMRollout "Bs_RootMotion_Ctrl" width:160 height:680 (
		local animStateBackup

		label labelPelvisObj "è´¨å¿ƒ: " align:#left pos:[5, 12]
		pickbutton pickAnimPelvisObj "é€‰æ‹©åŠ¨ç”»è´¨å¿ƒ" pos:[5, 32] width:150 tooltip:"é€‰æ‹©æœ‰åŠ¨ç”»ä¿¡æ¯çš„è´¨å¿ƒã€‚å¯¹äºBipedï¼Œè¯·é€‰æ‹©Bip001ã€‚"
		label labelOriginalRoot "åŸæ ¹èŠ‚ç‚¹: " align:#left pos:[5, 62]
		pickbutton pickOriginalRoot "é€‰æ‹©åŸæ ¹èŠ‚ç‚¹" width:150 pos:[5, 82] tooltip:"é€‰æ‹©åŸå§‹æ ¹èŠ‚ç‚¹å¯¹è±¡ã€‚"
		label labelRootObj "ä¸´æ—¶æ ¹èŠ‚ç‚¹: " align:#left pos:[5, 112]
		pickbutton pickRootObj "é€‰æ‹©ä¸´æ—¶æ ¹èŠ‚ç‚¹" width:150 pos:[5, 132] tooltip:"é€‰æ‹©è¦ç”¨ä½œä¸´æ—¶æ ¹èŠ‚ç‚¹çš„å¯¹è±¡ã€‚"
		
		button btnLinkController ">> é“¾æ¥æ§åˆ¶å™¨ <<" width:140 height:40 pos:[10, 165] tooltip:"å°†æ§åˆ¶å™¨åº”ç”¨åˆ°æ ¹èŠ‚ç‚¹å¹¶ä¸è´¨å¿ƒè¿æ¥ã€‚" enabled:false
		
		groupbox gpbPos "ä½ç½®æ§åˆ¶" pos:[5, 217] width:150 height:280
		
		spinner spnManualX "æ‰‹åŠ¨X:   " type:#float range:[-99999.0, 99999.0, 0.0] align:#left width:100 pos:[10, 237]
		spinner spnManualY "æ‰‹åŠ¨Y:   " type:#float range:[-99999.0, 99999.0, 0.0] align:#left width:100 pos:[10, 262]
		spinner spnManualZ "æ‰‹åŠ¨Z:   " type:#float range:[-99999.0, 99999.0, 0.0] align:#left width:100 pos:[10, 287]
		label labelTrackX "TrackX: " align:#left width:50 pos:[10, 317]
		slider sliderTrackX "" type:#float range:[0.0, 1.0, 0.0] width:100 align:#left pos:[55, 307]
		spinner spnTrackX_Offset "TrackX åç§»:  " type:#float range:[-99999.0, 99999.0, 0.0] align:#left width:100 pos:[10, 342]
		label labelTrackY "TrackY: " align:#left width:50 pos:[10, 367]
		slider sliderTrackY "" type:#float range:[0.0, 1.0, 0.0] width:100 align:#left pos:[55, 357]
		spinner spnTrackY_Offset "TrackY åç§»:  " type:#float range:[-99999.0, 99999.0, 0.0] align:#left width:100 pos:[10, 392]
		label labelTrackZ "TrackZ: " align:#left width:50 pos:[10, 417]
		slider sliderTrackZ "" type:#float range:[0.0, 1.0, 0.0] width:100 align:#left pos:[55, 407]
		spinner spnTrackZ_Offset "TrackZ åç§»:  " type:#float range:[-99999.0, 99999.0, 0.0] align:#left width:100 pos:[10, 442]
		button btnGetPelvisPosZ "è·å–è´¨å¿ƒZä½ç½®" align:#center width:140 pos:[10, 467] tooltip:"è‡ªåŠ¨è·å–è´¨å¿ƒè·ç¦»åœ°é¢çš„é«˜åº¦å€¼å¹¶åº”ç”¨åˆ°TrackZåç§»ä¸­ã€‚"
		
		groupbox gpbRot "æ—‹è½¬æ§åˆ¶" pos:[5, 512] width:150 height:100

		spinner spnManualYaw "æ‰‹åŠ¨ yaw:  " type:#float range:[-99999.0, 99999.0, 0.0] align:#left width:100 pos:[10, 532]
		label labelTrackYaw "Track yaw:  " align:#left width:60 pos:[10, 557]
		slider sliderTrackYaw "" type:#float range:[0.0, 1.0, 0.0] width:90 align:#left pos:[70, 547]
		spinner spnTrackYaw_Offset "Track yaw åç§»:   " type:#float range:[-99999.0, 99999.0, 90.0] align:#left width:118 pos:[10, 582] tooltip:"é»˜è®¤å€¼ = 90"
		
		-- æ·»åŠ å¿«æ·åŠŸèƒ½åŒºåŸŸ
		groupbox gpbQuickTools "å¿«æ·å·¥å…·" pos:[5, 622] width:150 height:80
		
		button btnStraightenCurves "æ‰“ç›´å…³é”®å¸§æ›²æŸ„" width:95 height:25 pos:[10, 642] tooltip:"å°†ä¸´æ—¶æ ¹èŠ‚ç‚¹çš„ä½ç§»å’Œæ—‹è½¬æ›²çº¿æ‰“ç›´"
		button btnRestoreCurves "è¿˜åŸ" width:40 height:25 pos:[110, 642] tooltip:"è¿˜åŸä¸´æ—¶æ ¹èŠ‚ç‚¹çš„ä½ç§»å’Œæ—‹è½¬æ›²çº¿"
		button btnSwitchTrajectory "Rootè½¨è¿¹" width:70 height:20 pos:[10, 672] tooltip:"æ˜¾ç¤ºéšè—é€‰ä¸­ç‰©ä½“çš„è¿åŠ¨è½¨è¿¹"
		button btnCurvePanel "æ›²çº¿é¢æ¿" width:65 height:20 pos:[85, 672] tooltip:"æ‰“å¼€æ›²çº¿é¢æ¿,ä¿®æ”¹å’Œåˆ å¸§"

		-- æ·»åŠ çƒ˜ç„™åŠŸèƒ½åŒºåŸŸ
		groupbox gpbBakeTools "çƒ˜ç„™å·¥å…·" pos:[5, 710] width:150 height:85
		
		button btnBakeToTempKey "çƒ˜ç„™åˆ°ä¸´æ—¶æ ¹(å…³é”®å¸§)" width:140 height:25 pos:[10, 730] tooltip:"å°†åŠ¨ç”»çƒ˜ç„™åˆ°ä¸´æ—¶æ ¹èŠ‚ç‚¹(ä»…å…³é”®å¸§)"
		button btnBakeToTempFull "çƒ˜ç„™åˆ°ä¸´æ—¶æ ¹  (æ»¡å¸§)" width:140 height:25 pos:[10, 760] tooltip:"å°†åŠ¨ç”»çƒ˜ç„™åˆ°ä¸´æ—¶æ ¹èŠ‚ç‚¹  (æ‰€æœ‰å¸§)"

		fn Initialize = (
			local pelvisObj = maxOps.getNodeByHandle PelvisObjHandle
			if (pelvisObj != undefined) then (
				labelPelvisObj.text = "è´¨å¿ƒ: ã€ " + pelvisObj.name + " ã€‘"
			) else (
				labelPelvisObj.text = "è´¨å¿ƒ: ã€ æœªæŒ‡å®š ã€‘"
			)
			local rootObj = maxOps.getNodeByHandle RootObjHandle
			if (rootObj != undefined) then (
				labelRootObj.text = "ä¸´æ—¶æ ¹èŠ‚ç‚¹: ã€ " + rootObj.name + " ã€‘"
			) else (
				labelRootObj.text = "ä¸´æ—¶æ ¹èŠ‚ç‚¹: ã€ æœªæŒ‡å®š ã€‘"
			)
			local originalRoot = maxOps.getNodeByHandle OriginalRootHandle
			if (originalRoot != undefined) then (
				labelOriginalRoot.text = "åŸæ ¹èŠ‚ç‚¹: ã€ " + originalRoot.name + " ã€‘"
			) else (
				labelOriginalRoot.text = "åŸæ ¹èŠ‚ç‚¹: ã€ æœªæŒ‡å®š ã€‘"
			)
			
			-- æ£€æŸ¥æ˜¯å¦å¯ä»¥å¯ç”¨é“¾æ¥æŒ‰é’®
			btnLinkController.enabled = (pelvisObj != undefined and rootObj != undefined)
			
			-- ä¸ºå‚æ•°è®¾ç½®æ§åˆ¶å™¨ï¼ˆå¦‚æœè¿˜æ²¡æœ‰çš„è¯ï¼‰
			if (ManualX.controller == undefined) do (ManualX.controller = bezier_float ())
			if (ManualY.controller == undefined) do (ManualY.controller = bezier_float ())
			if (ManualZ.controller == undefined) do (ManualZ.controller = bezier_float ())
			if (TrackX.controller == undefined) do (TrackX.controller = bezier_float ())
			if (TrackX_Offset.controller == undefined) do (TrackX_Offset.controller = bezier_float ())
			if (TrackY.controller == undefined) do (TrackY.controller = bezier_float ())
			if (TrackY_Offset.controller == undefined) do (TrackY_Offset.controller = bezier_float ())
			if (TrackZ.controller == undefined) do (TrackZ.controller = bezier_float ())
			if (TrackZ_Offset.controller == undefined) do (TrackZ_Offset.controller = bezier_float ())
			if (ManualYaw.controller == undefined) do (ManualYaw.controller = bezier_float ())
			if (TrackYaw.controller == undefined) do (TrackYaw.controller = bezier_float ())
			if (TrackYaw_Offset.controller == undefined) do (TrackYaw_Offset.controller = bezier_float ())
		)

		on pickAnimPelvisObj picked obj do (
			if obj == undefined do return()
			PelvisObjHandle = obj.inode.handle
			labelPelvisObj.text = "è´¨å¿ƒ: ã€ " + obj.name + " ã€‘"
			btnLinkController.enabled = (maxOps.getNodeByHandle RootObjHandle != undefined)
			-- ä¿å­˜åˆ°è‡ªå®šä¹‰å±æ€§
			local controllerObj = rolRootMotionTools.FindRootMotionCtrl()
			if controllerObj != undefined do setUserProp controllerObj "BsRMPelvisObj" obj.name
		)

		on pickRootObj picked obj do (
			if obj == undefined do return()
			RootObjHandle = obj.inode.handle
			labelRootObj.text = "ä¸´æ—¶æ ¹èŠ‚ç‚¹: ã€ " + obj.name + " ã€‘"
			btnLinkController.enabled = (maxOps.getNodeByHandle PelvisObjHandle != undefined)
			-- ä¿å­˜åˆ°è‡ªå®šä¹‰å±æ€§
			local controllerObj = rolRootMotionTools.FindRootMotionCtrl()
			if controllerObj != undefined do setUserProp controllerObj "BsRMRootObj" obj.name
		)
		
		on pickOriginalRoot picked obj do (
			if obj == undefined do return()
			OriginalRootHandle = obj.inode.handle
			labelOriginalRoot.text = "åŸæ ¹èŠ‚ç‚¹: ã€ " + obj.name + " ã€‘"
			-- ä¿å­˜åˆ°è‡ªå®šä¹‰å±æ€§
			local controllerObj = rolRootMotionTools.FindRootMotionCtrl()
			if controllerObj != undefined do setUserProp controllerObj "BsRMOriginalRoot" obj.name
		)
		
		on btnLinkController pressed do (
			-- æ£€æŸ¥å¯¹è±¡æ˜¯å¦å·²é€‰æ‹©
			local pelvisObj = maxOps.getNodeByHandle PelvisObjHandle
			if pelvisObj == undefined do return()
			local rootObj = maxOps.getNodeByHandle RootObjHandle
			if rootObj == undefined do return()

			-- è®¾ç½®ä½ç½®æ§åˆ¶å™¨
			rootObj.pos.controller = Position_XYZ ()
			rootObj.pos.controller.X_Position.controller = Float_Expression ()
			rootObj.pos.controller.Y_Position.controller = Float_Expression ()
			rootObj.pos.controller.Z_Position.controller = Float_Expression ()
			rootObj.pos.controller.X_Position.controller.AddScalarTarget "ManualX" ManualX.controller
			rootObj.pos.controller.Y_Position.controller.AddScalarTarget "ManualY" ManualY.controller
			rootObj.pos.controller.Z_Position.controller.AddScalarTarget "ManualZ" ManualZ.controller
			rootObj.pos.controller.X_Position.controller.AddVectorNode "PelvisPos" pelvisObj
			rootObj.pos.controller.Y_Position.controller.AddVectorNode "PelvisPos" pelvisObj
			rootObj.pos.controller.Z_Position.controller.AddVectorNode "PelvisPos" pelvisObj
			rootObj.pos.controller.X_Position.controller.AddScalarTarget "TrackX" TrackX.controller
			rootObj.pos.controller.X_Position.controller.AddScalarTarget "TrackX_Offset" TrackX_Offset.controller
			rootObj.pos.controller.Y_Position.controller.AddScalarTarget "TrackY" TrackY.controller
			rootObj.pos.controller.Y_Position.controller.AddScalarTarget "TrackY_Offset" TrackY_Offset.controller
			rootObj.pos.controller.Z_Position.controller.AddScalarTarget "TrackZ" TrackZ.controller
			rootObj.pos.controller.Z_Position.controller.AddScalarTarget "TrackZ_Offset" TrackZ_Offset.controller
			rootObj.pos.controller.X_Position.controller.SetExpression "(TrackX_Offset + PelvisPos.x)*TrackX + ManualX*(1-TrackX)"
			rootObj.pos.controller.Y_Position.controller.SetExpression "(TrackY_Offset + PelvisPos.y)*TrackY + ManualY*(1-TrackY)"
			rootObj.pos.controller.Z_Position.controller.SetExpression "(TrackZ_Offset + PelvisPos.z)*TrackZ + ManualZ*(1-TrackZ)"
			
			-- è®¾ç½®æ—‹è½¬æ§åˆ¶å™¨
			rootObj.rotation.controller = Euler_XYZ ()
			rootObj.rotation.controller.X_Rotation.controller = Float_Expression ()
			rootObj.rotation.controller.X_Rotation.controller.SetExpression "0"
			rootObj.rotation.controller.Y_Rotation.controller = Float_Expression ()
			rootObj.rotation.controller.Y_Rotation.controller.SetExpression "0"
			rootObj.rotation.controller.Z_Rotation.controller = float_script ()
			rootObj.rotation.controller.Z_Rotation.controller.AddTarget "ManualYaw" ManualYaw.controller
			rootObj.rotation.controller.Z_Rotation.controller.AddTarget "TrackYaw" TrackYaw.controller
			rootObj.rotation.controller.Z_Rotation.controller.AddTarget "TrackYaw_Offset" TrackYaw_Offset.controller
			rootObj.rotation.controller.Z_Rotation.controller.AddNode "PelvisObj" pelvisObj
			rootObj.rotation.controller.Z_Rotation.controller.SetExpression ("local pelvisYaw = degToRad (PelvisObj.transform.rotation as EulerAngles).z\n" + 
				"local track = (pelvisYaw + degToRad (TrackYaw_Offset)) * TrackYaw\n" + 
				"local manual = degToRad(ManualYaw) * (1-TrackYaw)\n" + 
				"return (track + manual)")
		)

		on btnGetPelvisPosZ pressed do (
			local pelvisObj = maxOps.getNodeByHandle PelvisObjHandle
			if pelvisObj == undefined do return()
			TrackZ_Offset = -pelvisObj.transform.pos.z
		)

		on BsRMRollout open do (
			Initialize()
		)

		-- é˜²æ­¢æ’­æ”¾æ—¶äº§ç”Ÿæ„å¤–å…³é”®å¸§çš„å‡½æ•°
		fn OnButtonDown = (
			animStateBackup = animButtonState
			if isAnimPlaying() do (
				animButtonState = false
			)
		)

		fn OnButtonUp = (
			animButtonState = animStateBackup
		)

		on spnManualX buttondown do (OnButtonDown())
		on spnManualX buttonup do (OnButtonUp())
		on spnManualY buttondown do (OnButtonDown())
		on spnManualY buttonup do (OnButtonUp())
		on spnManualZ buttondown do (OnButtonDown())
		on spnManualZ buttonup do (OnButtonUp())
		on sliderTrackX buttondown do (OnButtonDown())
		on sliderTrackX buttonup do (OnButtonUp())
		on spnTrackX_Offset buttondown do (OnButtonDown())
		on spnTrackX_Offset buttonup do (OnButtonUp())
		on sliderTrackY buttondown do (OnButtonDown())
		on sliderTrackY buttonup do (OnButtonUp())
		on spnTrackY_Offset buttondown do (OnButtonDown())
		on spnTrackY_Offset buttonup do (OnButtonUp())
		on sliderTrackZ buttondown do (OnButtonDown())
		on sliderTrackZ buttonup do (OnButtonUp())
		on spnTrackZ_Offset buttondown do (OnButtonDown())
		on spnTrackZ_Offset buttonup do (OnButtonUp())
		on spnManualYaw buttondown do (OnButtonDown())
		on spnManualYaw buttonup do (OnButtonUp())
		on sliderTrackYaw buttondown do (OnButtonDown())
		on sliderTrackYaw buttonup do (OnButtonUp())
		on spnTrackYaw_Offset buttondown do (OnButtonDown())
		on spnTrackYaw_Offset buttonup do (OnButtonUp())

		-- æ·»åŠ æ–°æŒ‰é’®çš„äº‹ä»¶å¤„ç†
		on btnStraightenCurves pressed do (
			local rootObj = maxOps.getNodeByHandle RootObjHandle
			if rootObj != undefined do (
				-- æ‰“ç›´ä½ç§»æ›²çº¿
				if rootObj.pos.controller != undefined do (
					
				)
				-- æ‰“ç›´æ—‹è½¬æ›²çº¿
				if rootObj.rotation.controller != undefined do (
					
				)
			)
		)

		on btnRestoreCurves pressed do (
			local rootObj = maxOps.getNodeByHandle RootObjHandle
			if rootObj != undefined do (
				-- è¿˜åŸä½ç§»æ›²çº¿
				if rootObj.pos.controller != undefined do (
					
				)
				-- è¿˜åŸæ—‹è½¬æ›²çº¿
				if rootObj.rotation.controller != undefined do (
					
				)
			)
		)

		on btnSwitchTrajectory pressed do (
			local rootObj = maxOps.getNodeByHandle RootObjHandle
			if rootObj != undefined do (
				rootObj.showTrajectory = not rootObj.showTrajectory
			)
		)

		-- å ä½æŒ‰é’®äº‹ä»¶
		on btnBakeToTempKey pressed do ()
		on btnBakeToTempFull pressed do ()
	)

	-- ä¿®æ”¹å™¨çš„ä¸»è¦åŠŸèƒ½
	fn modify obj = (
		-- è¿™é‡Œå¯ä»¥æ·»åŠ ä¿®æ”¹å™¨çš„å®é™…åŠŸèƒ½
		-- ç›®å‰æˆ‘ä»¬ä½¿ç”¨è¡¨è¾¾å¼æ§åˆ¶å™¨æ¥å¤„ç†ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥ä¸ºç©º
	)

	-- æ·»åŠ on createäº‹ä»¶å¤„ç†ç¨‹åº
	on create do (
		-- åˆå§‹åŒ–å‚æ•°
		PelvisObjHandle = 0
		RootObjHandle = 0
		OriginalRootHandle = 0
		
		-- ä»è‡ªå®šä¹‰å±æ€§ä¸­è¯»å–èŠ‚ç‚¹å¼•ç”¨
		local controllerObj = rolRootMotionTools.FindRootMotionCtrl()
		if controllerObj != undefined do (
			local pelvisName = getUserProp controllerObj "BsRMPelvisObj"
			local rootName = getUserProp controllerObj "BsRMRootObj"
			local originalRootName = getUserProp controllerObj "BsRMOriginalRoot"
			
			if pelvisName != undefined do (
				local pelvisObj = getNodeByName pelvisName
				if pelvisObj != undefined do PelvisObjHandle = pelvisObj.inode.handle
			)
			if rootName != undefined do (
				local rootObj = getNodeByName rootName
				if rootObj != undefined do RootObjHandle = rootObj.inode.handle
			)
			if originalRootName != undefined do (
				local originalRoot = getNodeByName originalRootName
				if originalRoot != undefined do OriginalRootHandle = originalRoot.inode.handle
			)
		)
	)
)

-- åˆ›å»ºUI
global rolRootMotionTools
try (destroydialog rolRootMotionTools) catch()

rollout rolRootMotionTools ("BsRootTools_v1.0") width:240
(
	button uiCreateController "åˆ›å»ºæ ¹è¿åŠ¨æ§åˆ¶å™¨" width:100 height:30 tooltip:"åœ¨åœºæ™¯ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„æ ¹è¿åŠ¨æ§åˆ¶å™¨å¯¹è±¡" across:2
	button uiOpenController "é€‰ä¸­ç°æœ‰æ§åˆ¶å™¨" width:100 height:30 tooltip:"æŸ¥æ‰¾å¹¶æ‰“å¼€åœºæ™¯ä¸­å·²æœ‰çš„æ ¹è¿åŠ¨æ§åˆ¶å™¨"
	button btnApplyNewRoot "åº”ç”¨æ–° Root åŠ¨ç”»å¹¶æ¸…ç†æ§åˆ¶å™¨" width:210 height:35 tooltip:"åº”ç”¨æ–°çš„æ ¹èŠ‚ç‚¹åŠ¨ç”»å¹¶æ¸…ç†æ§åˆ¶å™¨"
	group "ç®¡ç†å·¥å…·" (
		button uiAddRMAttribute "å•ç‹¬æ·»åŠ æ ¹è¿åŠ¨ä¿®æ”¹å™¨" width:200 tooltip:"ç»™é€‰ä¸­çš„å¯¹è±¡æ·»åŠ æ ¹è¿åŠ¨æ§åˆ¶å™¨ä¿®æ”¹å™¨"
		button uiRemoveRMController "ç§»é™¤æ ¹è¿åŠ¨æ§åˆ¶å™¨ï¼ˆåŒ…æ‹¬ç‰©ä½“ï¼‰" width:200 tooltip:"ä»…ç§»é™¤é€‰ä¸­å¯¹è±¡çš„æ ¹è¿åŠ¨æ§åˆ¶å™¨ä¿®æ”¹å™¨ï¼Œä¿ç•™å…¶ä»–ä¿®æ”¹å™¨"
	)
	hyperLink hlHomepage "ğŸ  åŸä½œè€…å‘å¸ƒé¡µ" width:90 height:20 align:#center across:2 \
	address:"https://cafe.naver.com/pinksox/9011" color:(color 0 100 200) hovercolor:(color 0 150 255)
	hyperLink hlTutorial "ğŸ“º ä¿®æ”¹ï¼šBullet.S" width:90 height:20 align:#center \
	address:"https://space.bilibili.com/2031113/lists/560782?type=season" color:(color 0 100 200) hovercolor:(color 0 150 255)

	-- æŸ¥æ‰¾åœºæ™¯ä¸­çš„æ ¹è¿åŠ¨æ§åˆ¶å™¨
	function FindRootMotionCtrl = (
		for obj in objects do (
			for i = 1 to obj.modifiers.count do (
				if classof obj.modifiers[i] == BsRootMotionModifier do (
					return obj
				)
			)
		)
		return undefined
	)

	-- åˆ›å»ºæ§åˆ¶å™¨å¯¹è±¡
	function CreateControllerObject = (
		-- ä¿å­˜å½“å‰é€‰ä¸­çš„å¯¹è±¡ä¿¡æ¯
		local selectedObj = selection[1]
		local selectedParent = if selectedObj != undefined then selectedObj.parent else undefined
		
		-- åˆ›å»ºä¸€ä¸ªæ–‡æœ¬å¯¹è±¡ä½œä¸ºæ§åˆ¶å™¨
		local mainController = Text()
		mainController.text = "ROOT\nMOTION"
		mainController.size = 8
		mainController.wirecolor = color 255 255 0  -- é»„è‰²
		mainController.renderable = false
		
		-- è®¾ç½®æ§åˆ¶å™¨å±æ€§
		mainController.name = uniqueName "RootMotionCtrl"
		
		-- å°†æ§åˆ¶å™¨æ”¾ç½®åœ¨è†ç›–ä¾§è¾¹ä½ç½®
		mainController.pos = [-60, 50, -50]  -- Xè½´æ­£æ–¹å‘60å•ä½ï¼ˆä¾§è¾¹ï¼‰ï¼ŒZè½´50å•ä½ï¼ˆè†ç›–é«˜åº¦ï¼‰
		
		-- æ–‡å­—ç«‹èµ·æ¥æ˜¾ç¤ºï¼ˆæ—‹è½¬90åº¦é¢å‘æ‘„åƒæœºï¼‰
		mainController.rotation = (eulerAngles -90 0 0)  -- ç»•Zè½´æ—‹è½¬90åº¦è®©æ–‡å­—ç«‹èµ·æ¥
		
		-- åˆ›å»ºæ ¹èŠ‚ç‚¹(ä½¿ç”¨Pointå¯¹è±¡)
		local rootNode = Point()
		rootNode.name = uniqueName "Root"
		rootNode.wirecolor = color 255 255 0  -- é»„è‰²
		rootNode.size = 50
		rootNode.cross = true
		rootNode.box = true
		rootNode.centermarker = true
		rootNode.axistripod = true
		rootNode.centermarker = true
		rootNode.renderable = false
		
		-- è®¾ç½®æ ¹èŠ‚ç‚¹çš„å˜æ¢
		rootNode.transform = matrix3 [1,0,0] [0,1,0] [0,0,1] [0,0,0]
		rootNode.rotation = eulerAngles 0 0 0
		
		-- é€‰ä¸­æ–°åˆ›å»ºçš„æ§åˆ¶å™¨
		select mainController
		
		-- æ·»åŠ ä¿®æ”¹å™¨
		addModifier mainController (BsRootMotionModifier())
		
		-- è®¾ç½®ä¿®æ”¹å™¨çš„æ ¹èŠ‚ç‚¹å‚æ•°
		mainController.modifiers[#Bs_RootMotion_Ctrl].RootObjHandle = rootNode.inode.handle
		
		-- è®¾ç½®è´¨å¿ƒå’ŒåŸæ ¹èŠ‚ç‚¹
		if selectedObj != undefined then (
			mainController.modifiers[#Bs_RootMotion_Ctrl].PelvisObjHandle = selectedObj.inode.handle
			if selectedParent != undefined then (
				mainController.modifiers[#Bs_RootMotion_Ctrl].OriginalRootHandle = selectedParent.inode.handle
			)
		)
		
		-- ä¿å­˜åˆ°è‡ªå®šä¹‰å±æ€§
		if selectedObj != undefined do setUserProp mainController "BsRMPelvisObj" selectedObj.name
		setUserProp mainController "BsRMRootObj" rootNode.name
		if selectedParent != undefined do setUserProp mainController "BsRMOriginalRoot" selectedParent.name
		
		-- è‡ªåŠ¨æ‰“å¼€ä¿®æ”¹é¢æ¿æ˜¾ç¤ºä¿®æ”¹å™¨
		setCommandPanelTaskMode #modify
		
		-- å¼ºåˆ¶æ›´æ–°UI
		mainController.modifiers[#Bs_RootMotion_Ctrl].BsRMRollout.labelPelvisObj.text = "è´¨å¿ƒ: ã€ " + (if selectedObj != undefined then selectedObj.name else "æœªæŒ‡å®š") + " ã€‘"
		mainController.modifiers[#Bs_RootMotion_Ctrl].BsRMRollout.labelRootObj.text = "ä¸´æ—¶æ ¹èŠ‚ç‚¹: ã€ " + rootNode.name + " ã€‘"
		mainController.modifiers[#Bs_RootMotion_Ctrl].BsRMRollout.labelOriginalRoot.text = "åŸæ ¹èŠ‚ç‚¹: ã€ " + (if selectedParent != undefined then selectedParent.name else "æœªæŒ‡å®š") + " ã€‘"
		
		-- æ›´æ–°é“¾æ¥æŒ‰é’®çŠ¶æ€
		mainController.modifiers[#Bs_RootMotion_Ctrl].BsRMRollout.btnLinkController.enabled = (selectedObj != undefined)
		
		return mainController
	)
	
	on uiCreateController pressed do (
		-- æ£€æŸ¥æ˜¯å¦å·²æœ‰æ§åˆ¶å™¨
		local existingController = FindRootMotionCtrl()
		if existingController != undefined then (
			local result = yesNoCancelBox ("åœºæ™¯ä¸­å·²å­˜åœ¨æ ¹è¿åŠ¨æ§åˆ¶å™¨: " + existingController.name + "\n\næ˜¯å¦è¦åˆ›å»ºæ–°çš„æ§åˆ¶å™¨ï¼Ÿ\n\næ˜¯=åˆ›å»ºæ–°çš„  å¦=æ‰“å¼€ç°æœ‰çš„  å–æ¶ˆ=ä»€ä¹ˆéƒ½ä¸åš")
			if result == #yes then (
				local confirmResult = yesNoCancelBox "è¯·å…ˆé€‰æ‹©è´¨å¿ƒå¯¹è±¡ï¼Œç„¶åç‚¹å‡»'æ˜¯'ç»§ç»­åˆ›å»ºæ§åˆ¶å™¨ã€‚\n\næ˜¯=ç»§ç»­åˆ›å»º  å¦=å–æ¶ˆåˆ›å»º"
				if confirmResult == #yes then (
					if selection.count > 0 then (
						local newController = CreateControllerObject()
						completeredraw()
						messageBox "æ–°çš„æ ¹è¿åŠ¨æ§åˆ¶å™¨å·²åˆ›å»ºï¼\n\nè¯·åœ¨å³ä¾§ä¿®æ”¹å™¨é¢æ¿ä¸­æ‰¾åˆ° 'Bs_RootMotion_Ctrl' ä¿®æ”¹å™¨ã€‚                            " title:"åˆ›å»ºå®Œæˆ"
					) else (
						messageBox "è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¯¹è±¡ä½œä¸ºè´¨å¿ƒï¼" title:"é”™è¯¯"
					)
				)
			) else if result == #no then (
				select existingController
				setCommandPanelTaskMode #modify
			)
		) else (
			local confirmResult = yesNoCancelBox "è¯·å…ˆé€‰æ‹©è´¨å¿ƒå¯¹è±¡ï¼Œç„¶åç‚¹å‡»'æ˜¯'ç»§ç»­åˆ›å»ºæ§åˆ¶å™¨ã€‚\n\næ˜¯=ç»§ç»­åˆ›å»º  å¦=å–æ¶ˆåˆ›å»º"
			if confirmResult == #yes then (
				if selection.count > 0 then (
					local newController = CreateControllerObject()
					completeredraw()
					messageBox "æ ¹è¿åŠ¨æ§åˆ¶å™¨å·²åˆ›å»ºæˆåŠŸï¼\n\n\nè¯·åœ¨å³ä¾§ä¿®æ”¹å™¨é¢æ¿ä¸­æ‰¾åˆ° 'Bs_RootMotion_Ctrl' ä¿®æ”¹å™¨ï¼Œ\n\nè®¾ç½®è´¨å¿ƒå’Œæ ¹èŠ‚ç‚¹å¯¹è±¡ã€‚                                                                         " title:"åˆ›å»ºå®Œæˆ"
				) else (
					messageBox "è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¯¹è±¡ä½œä¸ºè´¨å¿ƒï¼" title:"é”™è¯¯"
				)
			)
		)
	)

	on uiOpenController pressed do (
		local controllerObj = FindRootMotionCtrl()
		if controllerObj != undefined then (
			select controllerObj
			setCommandPanelTaskMode #modify
		) else (
			messageBox "åœºæ™¯ä¸­æ²¡æœ‰æ‰¾åˆ°æ ¹è¿åŠ¨æ§åˆ¶å™¨ã€‚\nè¯·å…ˆç‚¹å‡»'åˆ›å»ºæ ¹è¿åŠ¨æ§åˆ¶å™¨'ã€‚" title:"æœªæ‰¾åˆ°"
		)
	)

	on uiAddRMAttribute pressed do (
		if selection.count == 0 do (
			messageBox "è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¦æ·»åŠ æ ¹è¿åŠ¨æ§åˆ¶å™¨ä¿®æ”¹å™¨çš„å¯¹è±¡"
			return()
		)
		
		local obj = selection[1]
		local hasModifier = false
		for i = 1 to obj.modifiers.count do (
			if classof obj.modifiers[i] == BsRootMotionModifier do (
				hasModifier = true
				exit
			)
		)
		
		if hasModifier then (
			messageBox ("å¯¹è±¡ " + obj.name + " å·²ç»æœ‰æ ¹è¿åŠ¨æ§åˆ¶å™¨ä¿®æ”¹å™¨äº†ï¼")
		) else (
			-- æ·»åŠ ä¿®æ”¹å™¨
			addModifier obj (BsRootMotionModifier())
			setCommandPanelTaskMode #modify
			messageBox ("æˆåŠŸç»™å¯¹è±¡ " + obj.name + " æ·»åŠ æ ¹è¿åŠ¨æ§åˆ¶å™¨ä¿®æ”¹å™¨ï¼") title:"æ·»åŠ å®Œæˆ"
		)
	)

	on uiRemoveRMController pressed do (
		local controllerObj = FindRootMotionCtrl()
		if controllerObj != undefined then (
			-- è·å–æ ¹èŠ‚ç‚¹
			local rootObj = maxOps.getNodeByHandle controllerObj.modifiers[#Bs_RootMotion_Ctrl].RootObjHandle
			if rootObj != undefined do delete rootObj
			delete controllerObj
		) else (
			messageBox "åœºæ™¯ä¸­æ²¡æœ‰æ‰¾åˆ°æ ¹è¿åŠ¨æ§åˆ¶å™¨ã€‚\nè¯·å…ˆç‚¹å‡»'åˆ›å»ºæ ¹è¿åŠ¨æ§åˆ¶å™¨'ã€‚" title:"æœªæ‰¾åˆ°"
		)
	)
)

createDialog rolRootMotionTools style:#(#style_titlebar, #style_toolwindow, #style_sysmenu) lockWidth:true