-- å…¨å±€å˜é‡
global imageArray = #()
global currentFrame = 0
global timeShift = 0
global isLoaded = false
global isPlaying = false
global loopEnabled = false
global lastFrame = 0
global statusMessage = ""
global alwaysOnTop = false
global dotNetTimer = dotNetObject "System.Windows.Forms.Timer"

-- æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§çª—å£
try(sequence_viewer.close())catch()

-- é¢œè‰²å®šä¹‰
Ccolor = dotnetclass "system.drawing.color"
BackGrey = (dotNetClass "system.drawing.color").fromArgb 29 29 29
TopbarGrey = (dotNetClass "system.drawing.color").fromArgb 73 73 73
GreenColor = (dotNetClass "system.drawing.color").fromArgb 152 252 3
YellowColor = (dotNetClass "system.drawing.color").fromArgb 252 190 3
RedColor = (dotNetClass "system.drawing.color").fromArgb 252 82 3

-- åˆ›å»ºä¸»çª—å£
sequence_viewer = dotNetObject "MaxCustomControls.MaxForm"
sequence_viewer.AllowTransparency = true
sequence_viewer.opacity = 1
sequence_viewer.width = 600
sequence_viewer.height = 600
sequence_viewer.FormBorderStyle = (dotNetClass "System.Windows.Forms.FormBorderStyle").none

-- åˆ›å»ºæ ‡é¢˜æ 
lbl_Title = dotNetObject "label"
lbl_Title.text = "åºåˆ—å›¾ç‰‡æŸ¥çœ‹å™¨"
lbl_Title.Width = sequence_viewer.width
lbl_Title.Height = 23
lbl_Title.left = 5
lbl_Title.top = 11
lbl_Title.forecolor = Ccolor.green
sequence_viewer.controls.add lbl_Title

-- åˆ›å»ºç½®é¡¶æŒ‰é’®
btn_TopMost = dotnetObject "system.windows.forms.button"
btn_TopMost.width = 35
btn_TopMost.height = 34
btn_TopMost.top = 0
btn_TopMost.left = (sequence_viewer.width-70)
btn_TopMost.flatStyle = (dotNetClass "System.Windows.Forms.FlatStyle").flat
btn_TopMost.backcolor = Ccolor.lightgray
btn_TopMost.forecolor = Ccolor.dimgray
btn_TopMost.font = (dotNetObject "System.Drawing.Font" "Verdana" 10 ((dotNetClass "System.Drawing.FontStyle").bold))
btn_TopMost.text = "ğŸ“Œ"
btn_TopMost.flatappearance.bordersize = 0
sequence_viewer.controls.add btn_TopMost

-- åˆ›å»ºå…³é—­æŒ‰é’®
btn_Close = dotnetObject "system.windows.forms.button"
btn_Close.width = 35
btn_Close.height = 34
btn_Close.top = 0
btn_Close.left = (sequence_viewer.width-35)
btn_Close.flatStyle = (dotNetClass "System.Windows.Forms.FlatStyle").flat
btn_Close.backcolor = Ccolor.lightgray
btn_Close.forecolor = Ccolor.dimgray
btn_Close.font = (dotNetObject "System.Drawing.Font" "Verdana" 10 ((dotNetClass "System.Drawing.FontStyle").bold))
btn_Close.text = "x"
btn_Close.flatappearance.bordersize = 0
sequence_viewer.controls.add btn_Close

-- åˆ›å»ºé€æ˜åº¦æ»‘å—
sldOpacity = dotNetObject "System.Windows.Forms.TrackBar"
sldOpacity.width = 300
sldOpacity.height = 45
sldOpacity.top = 40
sldOpacity.left = 10
sldOpacity.minimum = 10
sldOpacity.maximum = 100
sldOpacity.value = 100
sldOpacity.tickFrequency = 10
sequence_viewer.controls.add sldOpacity

-- åˆ›å»ºå›¾ç‰‡é¢„è§ˆåŒºåŸŸ
picBox = dotNetObject "System.Windows.Forms.PictureBox"
picBox.width = 300
picBox.height = 300
picBox.top = 90
picBox.left = 10
picBox.sizeMode = picBox.sizeMode.Zoom
picBox.backColor = Ccolor.White
sequence_viewer.controls.add picBox

-- åˆ›å»ºçŠ¶æ€æ ‡ç­¾
lblStatus = dotNetObject "System.Windows.Forms.Label"
lblStatus.text = "çŠ¶æ€: æœªåŠ è½½å›¾ç‰‡"
lblStatus.width = 300
lblStatus.height = 20
lblStatus.top = 400
lblStatus.left = 10
sequence_viewer.controls.add lblStatus

-- åˆ›å»ºå¸§è®¡æ•°æ ‡ç­¾
lblMaxFrame = dotNetObject "System.Windows.Forms.Label"
lblMaxFrame.text = "å½“å‰å¸§: 0"
lblMaxFrame.width = 150
lblMaxFrame.height = 20
lblMaxFrame.top = 420
lblMaxFrame.left = 10
sequence_viewer.controls.add lblMaxFrame

-- åˆ›å»ºå¼•ç”¨å¸§æ ‡ç­¾
lblRefFrame = dotNetObject "System.Windows.Forms.Label"
lblRefFrame.text = "å¼•ç”¨å¸§: 0"
lblRefFrame.width = 150
lblRefFrame.height = 20
lblRefFrame.top = 420
lblRefFrame.left = 160
sequence_viewer.controls.add lblRefFrame

-- åˆ›å»ºæ—¶é—´åç§»æ§ä»¶
lblTimeShift = dotNetObject "System.Windows.Forms.Label"
lblTimeShift.text = "æ—¶é—´åç§»:"
lblTimeShift.width = 80
lblTimeShift.height = 20
lblTimeShift.top = 450
lblTimeShift.left = 10
sequence_viewer.controls.add lblTimeShift

numTimeShift = dotNetObject "System.Windows.Forms.NumericUpDown"
numTimeShift.width = 60
numTimeShift.height = 20
numTimeShift.top = 450
numTimeShift.left = 90
numTimeShift.minimum = -1000
numTimeShift.maximum = 1000
numTimeShift.value = 0
sequence_viewer.controls.add numTimeShift

-- åˆ›å»ºåŠ è½½æŒ‰é’®
btnLoad = dotNetObject "System.Windows.Forms.Button"
btnLoad.text = "åŠ è½½åºåˆ—å›¾ç‰‡"
btnLoad.width = 150
btnLoad.height = 30
btnLoad.top = 480
btnLoad.left = 10
sequence_viewer.controls.add btnLoad

-- åˆ›å»ºæ§åˆ¶æŒ‰é’®é¢æ¿
pnlControls = dotNetObject "System.Windows.Forms.Panel"
pnlControls.width = 300
pnlControls.height = 40
pnlControls.top = 510
pnlControls.left = 10
sequence_viewer.controls.add pnlControls

-- å¼€å§‹å¸§æŒ‰é’®
btnStartFrame = dotNetObject "System.Windows.Forms.Button"
btnStartFrame.text = "â®"
btnStartFrame.width = 40
btnStartFrame.height = 30
btnStartFrame.top = 5
btnStartFrame.left = 10
btnStartFrame.enabled = false
pnlControls.controls.add btnStartFrame

-- ä¸Šä¸€å¸§æŒ‰é’®
btnPrevFrame = dotNetObject "System.Windows.Forms.Button"
btnPrevFrame.text = "â—€"
btnPrevFrame.width = 40
btnPrevFrame.height = 30
btnPrevFrame.top = 5
btnPrevFrame.left = 60
btnPrevFrame.enabled = false
pnlControls.controls.add btnPrevFrame

-- æ’­æ”¾æŒ‰é’®
btnPlay = dotNetObject "System.Windows.Forms.Button"
btnPlay.text = "â–¶"
btnPlay.width = 40
btnPlay.height = 30
btnPlay.top = 5
btnPlay.left = 110
btnPlay.enabled = false
pnlControls.controls.add btnPlay

-- ä¸‹ä¸€å¸§æŒ‰é’®
btnNextFrame = dotNetObject "System.Windows.Forms.Button"
btnNextFrame.text = "â–¶"
btnNextFrame.width = 40
btnNextFrame.height = 30
btnNextFrame.top = 5
btnNextFrame.left = 160
btnNextFrame.enabled = false
pnlControls.controls.add btnNextFrame

-- ç»“æŸå¸§æŒ‰é’®
btnEndFrame = dotNetObject "System.Windows.Forms.Button"
btnEndFrame.text = "â­"
btnEndFrame.width = 40
btnEndFrame.height = 30
btnEndFrame.top = 5
btnEndFrame.left = 210
btnEndFrame.enabled = false
pnlControls.controls.add btnEndFrame

-- åˆ›å»ºå¾ªç¯æŒ‰é’®
chkLoop = dotNetObject "System.Windows.Forms.CheckBox"
chkLoop.text = "å¾ªç¯æ’­æ”¾"
chkLoop.width = 100
chkLoop.height = 20
chkLoop.top = 450
chkLoop.left = 160
chkLoop.enabled = false
sequence_viewer.controls.add chkLoop

-- åˆå§‹åŒ–å‡½æ•°
fn initializeImages = (
    imageArray = #()
    currentFrame = 0
    isLoaded = false
    lastFrame = 0
    
    -- ç¦ç”¨æ§åˆ¶æŒ‰é’®
    btnPlay.enabled = false
    btnStartFrame.enabled = false
    btnPrevFrame.enabled = false
    btnNextFrame.enabled = false
    btnEndFrame.enabled = false
    chkLoop.enabled = false
    chkLoop.checked = false
    loopEnabled = false
    
    lblStatus.text = "çŠ¶æ€: æœªåŠ è½½å›¾ç‰‡"
    lblMaxFrame.text = "å½“å‰å¸§: 0"
    lblRefFrame.text = "å¼•ç”¨å¸§: 0"
)

-- è®¾ç½®çŠ¶æ€ä¿¡æ¯
fn setStatus message color = (
    lblStatus.text = message
    lblStatus.forecolor = color
    statusMessage = message
)

-- åŠ è½½åºåˆ—å›¾ç‰‡
fn loadSequenceImages basePath = (
    -- ç¡®ä¿è·¯å¾„ä»¥åæ–œæ ç»“å°¾
    if basePath[basePath.count] != "\\" do basePath += "\\"
    
    -- è·å–æ‰€æœ‰æ”¯æŒçš„å›¾ç‰‡æ ¼å¼
    local files = #()
    local jpgFiles = getFiles (basePath + "*.jpg")
    local jpegFiles = getFiles (basePath + "*.jpeg")
    local pngFiles = getFiles (basePath + "*.png")
    local bmpFiles = getFiles (basePath + "*.bmp")
    
    -- åˆå¹¶æ‰€æœ‰æ–‡ä»¶
    join files jpgFiles
    join files jpegFiles
    join files pngFiles
    join files bmpFiles
    
    if files.count == 0 do (
        messageBox "æœªæ‰¾åˆ°åºåˆ—å›¾ç‰‡ï¼\nè¯·ç¡®ä¿æ–‡ä»¶å¤¹ä¸­åŒ…å«æ”¯æŒçš„å›¾ç‰‡æ ¼å¼(.jpg, .jpeg, .png, .bmp)ã€‚" title:"é”™è¯¯"
        return false
    )
    
    -- æŒ‰æ–‡ä»¶åæ’åº
    sort files
    
    imageArray = #()
    for f in files do (
        append imageArray f
    )
    
    -- æµ‹è¯•åŠ è½½ç¬¬ä¸€å¼ å›¾ç‰‡
    try(
        local testBmp = (dotNetObject "System.Drawing.Bitmap" imageArray[1])
        picBox.image = testBmp
        lblStatus.text = "çŠ¶æ€: å·²åŠ è½½ " + imageArray.count as string + " å¼ å›¾ç‰‡"
        setStatus ("å·²åŠ è½½ " + imageArray.count as string + " å¼ å›¾ç‰‡") GreenColor
        
        -- å¯ç”¨æ§åˆ¶æŒ‰é’®
        btnPlay.enabled = true
        btnStartFrame.enabled = true
        btnPrevFrame.enabled = true
        btnNextFrame.enabled = true
        btnEndFrame.enabled = true
        chkLoop.enabled = true
        
        isLoaded = true
        lastFrame = imageArray.count
        
        true
    )catch(
        messageBox "åŠ è½½å›¾ç‰‡å¤±è´¥ï¼è¯·æ£€æŸ¥å›¾ç‰‡æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚" title:"é”™è¯¯"
        setStatus "åŠ è½½å›¾ç‰‡å¤±è´¥" RedColor
        false
    )
)

-- æ›´æ–°å½“å‰å¸§çš„å›¾ç‰‡
fn updateCurrentImage = (
    if imageArray.count > 0 and isLoaded do (
        -- è·å–å½“å‰å¸§å·å¹¶ç¡®ä¿æ˜¯æ•´æ•°
        currentFrame = (sliderTime.frame as integer)
        
        -- è®¡ç®—å¼•ç”¨å¸§ï¼ˆè€ƒè™‘æ—¶é—´åç§»ï¼‰
        local refFrame = currentFrame - timeShift
        
        -- æ›´æ–°å¸§ä¿¡æ¯æ˜¾ç¤º
        lblMaxFrame.text = "å½“å‰å¸§: " + currentFrame as string
        lblRefFrame.text = "å¼•ç”¨å¸§: " + refFrame as string
        
        -- æ£€æŸ¥æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…
        if refFrame >= 0 and refFrame < imageArray.count then (
            try(
                -- æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
                if doesFileExist imageArray[refFrame + 1] then (
                    -- ä½¿ç”¨FileStreamåŠ è½½å›¾ç‰‡
                    local fs = (dotNetObject "System.IO.FileStream" imageArray[refFrame + 1] (dotNetClass "System.IO.FileMode").Open (dotNetClass "System.IO.FileAccess").Read)
                    local bmp = (dotNetObject "System.Drawing.Bitmap" fs)
                    fs.close()
                    
                    -- å¦‚æœå½“å‰æœ‰å›¾ç‰‡ï¼Œå…ˆé‡Šæ”¾å®ƒ
                    if picBox.image != undefined do (
                        picBox.image.dispose()
                    )
                    
                    picBox.image = bmp
                )
            )catch()
        ) else (
            -- å¤„ç†è¶…å‡ºèŒƒå›´çš„æƒ…å†µ
            if loopEnabled then (
                -- å¾ªç¯æ’­æ”¾ï¼šå›åˆ°å¼€å§‹
                if isPlaying then (
                    toggleStopAnimation()
                    sliderTime = timeShift
                    togglePlayAnimation()
                ) else (
                    sliderTime = timeShift
                )
            ) else (
                -- ä¸å¾ªç¯ï¼šæ˜¾ç¤ºè¶…å‡ºèŒƒå›´æ¶ˆæ¯
                if refFrame < 0 then (
                    sliderTime = timeShift
                ) else if refFrame >= imageArray.count then (
                    sliderTime = timeShift + imageArray.count - 1
                )
                setStatus "å¸§è¶…å‡ºèŒƒå›´" YellowColor
            )
        )
    )
)

-- æ’­æ”¾åŠ¨ç”»
fn togglePlayAnimation = (
    if isLoaded then (
        isPlaying = true
        btnPlay.text = "â¸"
        numTimeShift.enabled = false
        playAnimation()
    )
)

-- åœæ­¢åŠ¨ç”»
fn toggleStopAnimation = (
    isPlaying = false
    btnPlay.text = "â–¶"
    numTimeShift.enabled = true
    stopAnimation()
)

-- ä¸‹ä¸€å¸§
fn nextFrame = (
    if isLoaded then (
        toggleStopAnimation()
        sliderTime += 1
    )
)

-- ä¸Šä¸€å¸§
fn previousFrame = (
    if isLoaded then (
        toggleStopAnimation()
        sliderTime -= 1
    )
)

-- å¼€å§‹å¸§
fn startFrame = (
    if isLoaded then (
        toggleStopAnimation()
        sliderTime = timeShift
    )
)

-- ç»“æŸå¸§
fn endFrame = (
    if isLoaded then (
        toggleStopAnimation()
        sliderTime = timeShift + (imageArray.count - 1)
    )
)

-- æ›´æ–°æ—¶é—´åç§»
fn updateTimeShift = (
    timeShift = numTimeShift.value as integer
    updateCurrentImage()
)

-- åˆ‡æ¢å¾ªç¯æ’­æ”¾
fn toggleLoop sender args = (
    loopEnabled = chkLoop.checked
)

-- äº‹ä»¶å¤„ç†
fn onOpacityChanged sender e = (
    sequence_viewer.opacity = sldOpacity.value / 100.0
)
dotnet.addEventHandler sldOpacity "ValueChanged" onOpacityChanged

fn onLoadClick sender e = (
    local path = getSavePath caption:"é€‰æ‹©åºåˆ—å›¾ç‰‡æ‰€åœ¨æ–‡ä»¶å¤¹"
    if path != undefined do (
        loadSequenceImages path
    )
)
dotnet.addEventHandler btnLoad "Click" onLoadClick

fn onCloseClick sender e = (
    sequence_viewer.dispose()
)
dotnet.addEventHandler btn_Close "Click" onCloseClick

fn onTimeShiftChanged sender e = (
    updateTimeShift()
)
dotnet.addEventHandler numTimeShift "ValueChanged" onTimeShiftChanged

fn onPlayClick sender e = (
    if isPlaying then (
        toggleStopAnimation()
    ) else (
        togglePlayAnimation()
    )
)
dotnet.addEventHandler btnPlay "Click" onPlayClick

fn onNextFrameClick sender e = (
    nextFrame()
)
dotnet.addEventHandler btnNextFrame "Click" onNextFrameClick

fn onPrevFrameClick sender e = (
    previousFrame()
)
dotnet.addEventHandler btnPrevFrame "Click" onPrevFrameClick

fn onStartFrameClick sender e = (
    startFrame()
)
dotnet.addEventHandler btnStartFrame "Click" onStartFrameClick

fn onEndFrameClick sender e = (
    endFrame()
)
dotnet.addEventHandler btnEndFrame "Click" onEndFrameClick

-- å¾ªç¯æ’­æ”¾äº‹ä»¶
dotnet.addEventHandler chkLoop "CheckedChanged" toggleLoop

-- çª—å£æ‹–åŠ¨
global mouseOffset = [0,0]
global dragging = 0

fn onTitleMouseDown sender e = (
    mouseOffset[1] = mouse.screenPos.x - sequence_viewer.left
    mouseOffset[2] = mouse.screenPos.y - sequence_viewer.top
    global dragging = 1
)
dotnet.addEventHandler lbl_Title "MouseDown" onTitleMouseDown

fn onTitleMouseMove sender e = (
    if dragging == 1 do (
        sequence_viewer.left = mouse.screenpos.x - mouseOffset[1]
        sequence_viewer.top = mouse.screenpos.y - mouseOffset[2]
    )
)
dotnet.addEventHandler lbl_Title "MouseMove" onTitleMouseMove

fn onTitleMouseUp sender e = (
    global dragging = 0
)
dotnet.addEventHandler lbl_Title "MouseUp" onTitleMouseUp

-- åˆ‡æ¢çª—å£ç½®é¡¶çŠ¶æ€
fn toggleTopMost = (
    alwaysOnTop = not alwaysOnTop
    
    -- è®¾ç½®çª—å£ç½®é¡¶çŠ¶æ€
    if alwaysOnTop then (
        sequence_viewer.TopMost = true
        btn_TopMost.backcolor = GreenColor
        setStatus "çª—å£å·²ç½®é¡¶" GreenColor
    ) else (
        sequence_viewer.TopMost = false
        btn_TopMost.backcolor = Ccolor.lightgray
        setStatus "çª—å£å·²å–æ¶ˆç½®é¡¶" YellowColor
    )
)

-- ç½®é¡¶æŒ‰é’®äº‹ä»¶
fn onTopMostClick sender e = (
    toggleTopMost()
)
dotnet.addEventHandler btn_TopMost "Click" onTopMostClick

-- åˆå§‹åŒ–
initializeImages()
registerTimeCallback updateCurrentImage

-- è®¾ç½®çª—å£ä½ç½®
fn getScreenResolution = (
    screen = (dotNetClass "System.Windows.Forms.Screen").PrimaryScreen.Bounds
    return #(screen.Width, screen.Height)
)
res = getScreenResolution()
ResWidth = (res[1]/2)-(sequence_viewer.width/2)
ResHeight = (res[2]/2)-(sequence_viewer.height/2)
sequence_viewer.top = ResHeight
sequence_viewer.left = ResWidth

-- æ˜¾ç¤ºçª—å£
dotNet.setLifeTimeControl sequence_viewer #dotNet
sequence_viewer.showModeless()