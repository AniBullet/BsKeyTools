/*
* @Description: å¿«é€Ÿæ‰“å¼€maxæ–‡ä»¶ï¼Œå¹¶ä¿å­˜å¸¸ç”¨ç›®å½•
* @Author: Bullet.S
* @Date: 2019-11-23 01:41:13
 * @LastEditors: Bullet.S
 * @LastEditTime: 2021-05-09 22:32:29
* @Email: animator.bullet@foxmail.com
*/


try(destroydialog rolBsOpenTools)catch()
try(destroydialog rolAddItem)catch()

struct itemsFolder (name,dir)
Global iniPosOpenTools
Global iniWidthOpenTools = 340
Global iniDesktop        = (itemsFolder name:"Desktop" dir:"")
Global iniSelectedID     = 1
Global iniLikedFolder    = #()
Global iniFilterPrefix   = #()

try(FileIn ((getDir #scripts) + "\\BulletScripts\\fnSaveLoadConfig.ms"))
catch(messagebox "è„šæœ¬å®‰è£…å¯èƒ½ä¸å®Œå…¨,å»ºè®®é‡æ–°å®‰è£…...        " beep:false)
try(FileIn ((getDir #scripts) + "\\BulletScripts\\fnGetColorTheme.ms"))
catch(messagebox "è„šæœ¬å®‰è£…å¯èƒ½ä¸å®Œå…¨,å»ºè®®é‡æ–°å®‰è£…...        " beep:false)
stLoadConfigAll.fnLoadConfigBsOpenTools ()

struct itemsFolder (name,dir)
global dateTime = (dotNetClass "System.DateTime").Now
global arrDayWeek = #("æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­")
Global BulletConfig = execute ("@\"" + (getDir #maxData) + "\\BulletConfig.ini\"")  --é…ç½®æ–‡ä»¶è·¯å¾„

-- Global iniRefPicDir			= (itemsFolder name:"RefPicDir" dir:"")
Global posMouMove         = [0,0]
Global switchMouState     = false

Global arrFolders         = #()
Global arrFoldersName     = #()
Global arrFiles           = #()
Global arrFilesName       = #()
Global dirLiked           = ""
Global dirOpened          = ""
Global arrDirItems        = #()
Global arrPreItems        = #()
Global arrRecentFiles     = #()
Global arrRecentFilesName = #()
Global arrFileType        = #(".max",".fbx",".bip",".ms*")
Global rolBsOpenTools
Global fnRefreshList
Global tempLastFolder

rollout rolAddItem "æ·»åŠ " width:340 height:80
(
	groupbox gbxAddDir "æ·»åŠ å¸¸ç”¨è·¯å¾„  ---------- Tipsï¼šå³å‡»æ¡†å†…æ¡ç›®åˆ é™¤ " width:330 height:70 pos:[5,5]
	
	edittext edtAddDir "å‘½å" pos:[10,25] fieldWidth:160 height:20 labelOnTop:false text:""
	button btnOpenDir "é€‰æ‹©ç›®å½•"  pos:[200,25] width:70 height:20 tooltip:"é€‰æ‹©æ·»åŠ ç›®å½•ï¼Œé»˜è®¤æ‰“å¼€å½“å‰æ–‡ä»¶ç›®å½•"
	edittext edtDirStr "" pos:[5,50] fieldWidth:262 height:20 readOnly:true
	
	groupbox gbxAddPre "æ·»åŠ è¿‡æ»¤å‰ç¼€  ---------- Tipsï¼šå³å‡»æ¡†å†…æ¡ç›®åˆ é™¤ "  width:330 height:70 pos:[5,5]
	edittext edtPrefix ""  text:"" fieldWidth:262 height:35 pos:[5,35]

	button btnAddItems "æ·»åŠ " width:55 height:45 pos:[275,25]

	on btnOpenDir pressed do 
	(
		local dir = getSavePath caption:"è¯·é€‰æ‹©ç›®å½•:" initialDir:(maxFilePath)
		if (dir != undefined) then
		(
			edtDirStr.text = dir
		)
	)

	on edtAddDir changed txt do 
	(
		tempText = substituteString txt "\n" ""
		edtAddDir.text = tempText
		-- print edtAddDir.text
	)

	on edtPrefix changed txt do 
	(
		tempText = substituteString txt "\n" ""
		edtPrefix.text = tempText
		-- print edtPrefix.text
	)

	on btnAddItems pressed do 
	(
		if ((edtDirStr.text != "") and (edtAddDir.text != "") and (edtDirStr.visible == true)) then
		(
			local fnExist = 0
			for i = 1 to iniLikedFolder.count do 
			(
				if matchPattern iniLikedFolder[i].dir pattern:edtDirStr.text then 
				(
					fnExist = 1
				)
			)
			if fnExist == 0 then
			(
				append iniLikedFolder (itemsFolder edtAddDir.text edtDirStr.text)
				arrDirItems = #()
				for i = iniLikedFolder.count to 1 by -1 do
				(
					append arrDirItems iniLikedFolder[i].name
				)
				rolBsOpenTools.ddlLikedFolder.items = arrDirItems
				rolBsOpenTools.ddlLikedFolder.selection = 1
				rolBsOpenTools.ddlLikedFolder.tooltip = iniLikedFolder[iniLikedFolder.count].dir
				-- fnRefreshList rolBsOpenTools.edtBrowseFolder.text type:arrFileType[rolBsOpenTools.rdoFileType.state]
			)
			else (messagebox "----------------------------------------\r\nå¯èƒ½å¸¸ç”¨ç›®å½•ä¸­å·²å­˜åœ¨æ­¤ç›®å½•~")
		)
		if ((edtPrefix.text != "") and (edtPrefix.visible == true)) then
		(
			if (findItem iniFilterPrefix edtPrefix.text) != 0 then 
			(
				messagebox "-------------------------------------\r\nå¯èƒ½è¿‡æ»¤è¯ç¼€ä¸­å·²å­˜åœ¨~"
			)
			else
			(
				append iniFilterPrefix edtPrefix.text
				arrPreItems = #()
				for i = iniFilterPrefix.count to 1 by -1 do
				(
					append arrPreItems iniFilterPrefix[i]
				)
				rolBsOpenTools.ltbFilterPrefix.items = arrPreItems
				rolBsOpenTools.ltbFilterPrefix.selection = 1
				-- fnRefreshList rolBsOpenTools.edtBrowseFolder.text type:arrFileType[rolBsOpenTools.rdoFileType.state]
			)
		)
	)
)

rollout rolBsOpenTools "" width:340 height:365
(
	groupbox grpMain "æ—¶å…‰æœº_v0.4---------ä¸­é”®å…³é—­,å³å‡»ä¸Šå±‚ç›®å½•" \
	width:330 height:360 pos:[5,0]
	editText edtBrowseFolder "" text:"" labelOnTop:true align:#right \
	height:20 fieldWidth:210 pos:[70,22] readOnly:true 
	button btnOpenAddress "..." align:#right tooltip:"é€‰æ‹©æ‰“å¼€ç›®å½•" \
	height:22 width:30 pos:[37,20] 
	button btnPrevFolder "â†‘" tooltip:"è¿”å›ä¸Šå±‚ç›®å½•ï¼Œä¹Ÿå¯å³å‡»é¢æ¿ç©ºç™½å¤„" \
	height:25 width:25 pos:[280,20] border:false
	button btnOpenCurrentDir "æ‰“å¼€" tooltip:"æ‰“å¼€å½“å‰æ–‡ä»¶å¤¹" \
	height:25 width:25 pos:[305,20] border:false
	-- button btnRemoveFolder "â”" align:#left \
	-- height:20 width:25 pos:[10,20] tooltip:"åˆ é™¤é€‰ä¸­çš„æ”¶è—ç›®å½•"
	-- button btnAddFolder "âœš" align:#left border:false \
	-- height:20 width:20 pos:[35,20] tooltip:"æ–°å¢å¸¸ç”¨ç›®å½•"
	button btnRefreshFolder "R" align:#left \
	height:22 width:25 pos:[10,20] tooltip:"å·¦ï¼šåˆ·æ–°å½“å‰æ–‡ä»¶ç›®å½•\r\nå³ï¼šé‡ç½®åœºæ™¯"
	button btnLikedFolder "â†“æ·»åŠ å¸¸ç”¨â†“" border:false \
	height:23 width:70 pos:[10,43] tooltip:"æ–°å¢å¸¸ç”¨ç›®å½•ï¼Œå³å‡»é€‰ä¸­æ¡ç›®åˆ é™¤"
	dropdownlist ddlLikedFolder "" align:#left selection:1 \
	height:15 width:70 pos:[10,70]
	listBox ltbFilesList "" align:#right selection:0 \
	height:18 width:245 pos:[85,70]
	button btnFilterPrefix "âœšè¿‡æ»¤è¯ç¼€âœš" border:false \
	height:23 width:70 pos:[10,95] tooltip:"å·¦ï¼šæ·»åŠ è¿‡æ»¤\r\nå³ï¼šå–æ¶ˆè¿‡æ»¤\r\né€‰ä¸­è¿‡æ»¤åˆ—è¡¨\r\nå³å‡»åˆ é™¤æ¡ç›®"
	listBox ltbFilterPrefix "" align:#left selection:0 \
	height:8 width:70 pos:[10,120]
	radioButtons rdoFileType "" columns:5 offsets:#([14,0],[14,0],[14,0],[14,0]) \
	pos:[82,48] labels:#(".max",".fbx",".bip",".ms") 

	-- button btnRefPicDir "å›¾ç‰‡å‚è€ƒ" border:false \
	-- height:25 width:70 pos:[10,182] tooltip:"å·¦ï¼šæ‰“å¼€å‚è€ƒï¼Œå³ï¼šåˆ›å»ºPlane"
	button btnRecentFileDir "æœ€è¿‘æ‰“å¼€" border:false \
	height:25 width:70 pos:[10,230] tooltip:"æœ€è¿‘æ‰“å¼€æ–‡ä»¶"
	button btnDesktopDir "æ¡Œé¢è‡ªå®š" border:false \
	height:25 width:70 pos:[10,255] tooltip:"è‡ªå®šæ–‡ä»¶å¤¹ï¼Œé»˜è®¤æ¡Œé¢ï¼Œå³é”®å¯è®¾"
	button btnScriptsDir "è„šæœ¬ç›®å½•" border:false \
	height:25 width:70 pos:[10,280] tooltip:"è„šæœ¬æ–‡ä»¶å¤¹\r\nå·¦ï¼šæ ¹ç›®å½•\r\nå³ï¼šè‡ªå¯ç›®å½•"
	button btnAutobackDir "è‡ªåŠ¨ä¿å­˜" border:false \
	height:25 width:70 pos:[10,305] tooltip:"è‡ªåŠ¨ä¿å­˜ç›®å½•"
	-- button btnPreviewDir "<è½®å›æ¢¦å¢ƒ>" border:false \
	-- height:25 width:70 pos:[10,310] tooltip:"å·¦ï¼šé¢„è§ˆè§†é¢‘é»˜è®¤æ–‡ä»¶å¤¹\r\nå³ï¼šå¿«é€Ÿæ‹å±æ¸²æŸ“é¢„è§ˆåŠ¨ç”»"
	groupBox grpDate "" width:330 height:30 pos:[5,330]
	label lblCountTips "" height:15 width:80 pos:[15,340]
	label lblDateTime "" height:15 width:130 pos:[120,340] 
	HyperLink lnkLink "miHoYo_Bullet.S" color:myfgColor hovercolor:myClickColor visitedcolor:myClickColor \
	pos:[245,340] address:"https://space.bilibili.com/2031113"
	checkbutton ckbLockWidth "ğŸ”’" pos:[86,312] width:20 height:20 border:false \
	toolTip:"æ˜¯å¦è§£é”å®½åº¦è°ƒèŠ‚\r\nå³ï¼šé‡ç½®å®½åº¦" checked:false
	slider sldSetWidth "" pos:[113,312] range:[340,540,iniWidthOpenTools] ticks:0 \
	width:222 type:#integer toolTip:"è°ƒèŠ‚é¢æ¿å®½åº¦,ä»¥æ˜¾ç¤ºæ›´å¤šå­—" enabled:false
	-- label labLogo "-------------------------  TECH OTAKUS SAVE THE WORLD -" pos:[12,365]
	------------------------------------------------- â†‘ UI -------------------------------------
	
	-- global charClass = dotNetClass "System.Char" --dotnet charclass used for isDigit comparisment
	-- dotNetClass:System.Char

	fn getFilesequenceFile f &base &digits = 
	(
		f = getFilenameFile f
		base = trimRight f "0123456789"
		digits = subString f (base.count + 1) -1
	)

	fn fnPseudoNaturalSort a b =  --æ–‡ä»¶åæ’åºæ–°æ–¹æ³•--https://forums.cgsociety.org/t/sorting-filenames/1219205/4
	(
		a = a as string
		b = b as string
		getFilesequenceFile a &aBase &aDigits
		-- hackhackhack.  This pads a number with zeros to 6 digits without using a loop.
		-- things will fail if there's more digits.. 6 'seems' safe.
		aDigits = subString ((1000000 + (aDigits as integer)) as string) 2 -1
		getFilesequenceFile b &bBase &bDigits
		bDigits = subString ((1000000 + (bDigits as integer)) as string) 2 -1
		a = aBase + aDigits
		b = bBase + bDigits
	
		case of (
		(a == b): 0
		(a < b): -1
		(a > b): 1
		)
	)
-------------------------------------â†‘ æ–‡ä»¶æ’åºæ–¹æ³• --------------------------------------------------
	Fn fnLoadRecentFileList = -------è·å–æœ€è¿‘æ‰“å¼€æ–‡ä»¶åˆ—è¡¨
	(
		local recentfiles = (getdir #maxData) + "RecentDocuments.xml"
		if doesfileexist recentfiles then
		(
			arrRecentFiles     = #()
			arrRecentFilesName = #()
			xDoc = dotnetobject "system.xml.xmldocument"	
			xDoc.Load recentfiles
			Rootelement = xDoc.documentelement

			arrRecentFiles = for i = 0 to rootelement.childnodes.item[4].childnodes.itemof[0].childnodes.count-1 collect 
			(
				rootelement.childnodes.item[4].childnodes.itemof[0].childnodes.itemof[i].childnodes.itemof[3].innertext	
			)
			Return arrRecentFiles
			LRXML = Undefined
			XDoc = Undefined
			XDoc = nothing	
		)
		if arrRecentFiles[1] != undefined then
		(
			for c in arrRecentFiles do  --è·å–æ–‡ä»¶å¤¹åå­—,åé¢åˆ‡æ¢è„šæœ¬ç±»åˆ«å’Œåˆ—è¡¨ä¼šç”¨åˆ°
			(
				append arrRecentFilesName ("ğŸ“„ " + (getFilenameFile (substring c 1 (c.count-1))))
			)
		)
	)

	fn fnGetLastFolder strFolder =
	(
		if ((strFolder != "") and (doesDirectoryExist strFolder)) then
		(
			local arrFilterStr = filterstring strFolder @"\"
			local strLastFolder = ""
			for i = 1 to (arrFilterStr.count - 1) do 
			(
				strLastFolder = strLastFolder  + arrFilterStr[i] + @"\\"
			)
		)
		return strLastFolder
	)
	
	fn fnRefreshList strFilesDir type:".max" =
	(
		arrFolders = #()
		arrFiles = #()
		arrFoldersName = #()
		arrFilesName = #()
		if strFilesDir != undefined then 
		(
			if ((strFilesDir != "") and (doesDirectoryExist strFilesDir)) then
			(
				local tempDir = GetDirectories (strFilesDir + "/*")
				for i in tempDir do 
				(
					append arrFolders (substring i 1 (i.count-1))
				)
				qsort arrFolders fnPseudoNaturalSort
				(arrFilesBeforeFilter = getFiles (strFilesDir + "\\*" + type))
				qsort arrFilesBeforeFilter fnPseudoNaturalSort
				if (rolBsOpenTools.ltbFilterPrefix.selected != undefined) then
				(
					for i in arrFilesBeforeFilter do 
					(
						if (matchpattern (getfilenamefile i) \
						pattern:("*" + rolBsOpenTools.ltbFilterPrefix.selected + "*")) then 
						(append arrFiles i)
					)
				)
				else arrFiles = arrFilesBeforeFilter
				
				if arrFolders[1] != undefined then
				(
					for c in arrFolders do  --è·å–æ–‡ä»¶å¤¹åå­—,åé¢åˆ‡æ¢è„šæœ¬ç±»åˆ«å’Œåˆ—è¡¨ä¼šç”¨åˆ°
					(
						append arrFoldersName ("ğŸ“‚ " + (getFilenameFile c))
					)
				)
				if arrFiles[1] != undefined then
				(
					for c in arrFiles do  --è·å–æ–‡ä»¶åå­—,åé¢åˆ‡æ¢è„šæœ¬ç±»åˆ«å’Œåˆ—è¡¨ä¼šç”¨åˆ°
					(
						(append arrFilesName ("ğŸ“„ " + (getFilenameFile c) + type))
					)
				)
				rolBsOpenTools.ltbFilesList.items = arrFoldersName + arrFilesName
				rolBsOpenTools.edtBrowseFolder.text = strFilesDir
				for i = 1 to iniLikedFolder.count do 
				(
					if matchPattern iniLikedFolder[i].dir pattern:strFilesDir then 
					(
						rolBsOpenTools.ddlLikedFolder.selection = iniLikedFolder.count + 1 - i
						rolBsOpenTools.ddlLikedFolder.tooltip = iniLikedFolder[i].dir
					)
				)
			)
			else 
			(
				if ((iniSelectedID != 0) and (iniLikedFolder.count > 0)) then
				(
					rolBsOpenTools.ddlLikedFolder.selection = iniSelectedID
					fnRefreshList iniLikedFolder[iniLikedFolder.count + 1 - iniSelectedID].dir
					rolBsOpenTools.ddlLikedFolder.tooltip = iniLikedFolder[iniLikedFolder.count + 1 - iniSelectedID].dir
				)
			)
		)
		else messagebox "-------------------------------------\r\næ–‡ä»¶å¤¹å¯èƒ½å·²ä¸å­˜åœ¨\r\nè¯·å°è¯•åˆ·æ–°\r\n"
		lblCountTips.text = "æ–‡ä»¶ï¼š" + arrFiles.count as string
	)
	
	fn fnRefreshAddress =
	(
		if (maxFilePath != "") then 
		(
			local tempMaxFilePath = (substring maxFilePath 1 (maxFilePath.count-1))
			fnRefreshList tempMaxFilePath type:arrFileType[rdoFileType.state]
		)
		else 
		(
			if rolBsOpenTools.ddlLikedFolder.selection != 0 then 
			(
				local tempSelectionID = rolBsOpenTools.ddlLikedFolder.selection
				edtBrowseFolder.text = iniLikedFolder[iniLikedFolder.count + 1 - tempSelectionID].dir
			)
			else 
			(
				edtBrowseFolder.text = " ( æ‰“å¼€ç›®å½• )"
			)
		)
	)

	fn fnRefLikedFolderItems =
	(
		arrDirItems = #()
		if iniLikedFolder.count != 0 then
		(
			for i = iniLikedFolder.count to 1 by -1 do
			(
				append arrDirItems iniLikedFolder[i].name
			)
		)
		else 
		(
			ddlLikedFolder.tooltip = "è¯·æ·»åŠ å¸¸ç”¨ç›®å½•"
		)
		rolBsOpenTools.ddlLikedFolder.items = arrDirItems
	)

	fn fnRefreshFilterItems =
	(
		local arrPreItems = #()
		for i = iniFilterPrefix.count to 1 by -1 do
		(
			append arrPreItems iniFilterPrefix[i]
		)
		rolBsOpenTools.ltbFilterPrefix.items = arrPreItems
	)

	fn fnLoadBip fBip =
	(
		-- biped.loadBipFile <biped_ctrl> <file_name> \
		-- [#matchFileStruct] [#zeroHgt] [#noRedraw] \
		-- [#loadMaxObjects][#promptForDuplicates] [#retargetHeight] \
		-- [#retargetLimbSizes] [#scaleIKObjectSize] [#loadSubAnimControllers] \
		-- [#loadSelectedMaxObjects nodename_array] \
		-- [#loadSelectedSubAnimControllers bipednodename_array int_array]

		local numSelbiped = #()   -------åˆ¤æ–­é€‰æ‹©äº†å‡ ä¸ªbipedéª¨æ¶
		if selection.count != 0 then
		(
			for i in (selection as array) where ((classof i == Biped_Object) and (i.ishidden == false)) do  
			(
				appendIfUnique numSelbiped i.controller.rootNode  --æ·»åŠ åˆ°éª¨æ¶æ•°ç»„
			)
			for b in numSelbiped do 
			(
				biped.loadBipFile b.controller fBip #noRedraw
			)
		)
	)

	fn fnRefreshDate =
	(
		local arrTime = (getUniversalTime())
		local dayWeekID = (mod arrTime[3] 7) as integer
		lblDateTime.text = dateTime.Year as string + "/" + dateTime.Month as string + "/" \
		+ dateTime.Day as string + "  æ˜ŸæœŸ" + arrDayWeek[dayWeekID + 1] as string
	)

	----------------------------------------------------------------------------------------------------
	
	on rolBsOpenTools open do 
	(
		sldSetWidth.value        = iniWidthOpenTools
		rolBsOpenTools.width     = iniWidthOpenTools
		btnRefreshFolder.images  = #("UVWUnwrapModes_16i.bmp","UVWUnwrapModes_16i.bmp",28,3,3,3,3,true,false)
		ckbLockWidth.images      = #("LockButtonExt_i.bmp","LockButtonExt_i.bmp",2,1,1,2,2,true,false)
		btnOpenCurrentDir.images = #("UVWUnwrapModes_16i.bmp","UVWUnwrapModes_16i.bmp",28,5,5,5,5,true,false)
		btnPrevFolder.images     = #("MergeAnim_24i.bmp","MergeAnim_24i.bmp",4,1,1,1,1,false,true)

		fnRefreshAddress ()
		fnRefreshList maxFilePath type: arrFileType[rdoFileType.state]
		lblCountTips.text = "æ–‡ä»¶ï¼š" + arrFiles.count as string
		stLoadConfigAll.fnLoadConfigBsOpenTools ()  ---------------è„šæœ¬ä½ç½®ç­‰èµ‹å€¼
		stSetConfigAll.fnSetConfigBsOpenTools ()  ----------------ä¿å­˜ä½ç½®ä¿¡æ¯åˆ°iniæ–‡ä»¶
		fnRefLikedFolderItems ()
		ltbFilterPrefix.selection = 0
		fnRefreshFilterItems ()
		ddlLikedFolder.selection = iniSelectedID
		fnRefreshDate ()
	)

	on rolBsOpenTools close do -- å…³é—­è®°å¿†æµ®åŠ¨çª—å£ä½ç½®
	(
		iniPosOpenTools   = (GetDialogPos rolBsOpenTools)
		iniSelectedID     = rolBsOpenTools.ddlLikedFolder.selection
		iniWidthOpenTools = rolBsOpenTools.width
		stSetConfigAll.fnSetConfigBsOpenTools ()
	)

	on rolBsOpenTools mbuttondown pos do 
	(
		try (destroydialog rolBsOpenTools) catch ()
		try(destroydialog rolAddItem)catch()
	)

	on rolBsOpenTools lbuttondown posMou do
	(
		posMouMove = posMou
		switchMouState = on
	)

	on rolBsOpenTools lbuttonup posMou do
	(
		switchMouState = off
	)

	on rolBsOpenTools rbuttondown pos do 
	(
		tempLastFolder = fnGetLastFolder edtBrowseFolder.text
		fnRefreshList tempLastFolder type:arrFileType[rdoFileType.state]
	)

	on rolBsOpenTools mouseMove pos do
	(
		if switchMouState == on then
		(
			SetDialogPos rolBsOpenTools (mouse.screenpos - posMouMove)			
		)
	)

	on rolBsOpenTools resized pos do
	(
		grpMain.width          = rolBsOpenTools.width - 10
		grpDate.width          = rolBsOpenTools.width - 10
		edtBrowseFolder.width  = rolBsOpenTools.width - 130
		ltbFilesList.width     = rolBsOpenTools.width - 95
		btnOpenCurrentDir.pos  = [rolBsOpenTools.width - 35,20]
		btnPrevFolder.pos      = [rolBsOpenTools.width - 60,20]

	)
	------------------------------------------------------------------------------

	on ckbLockWidth changed state do 
	(
		if state == on then sldSetWidth.enabled = true 
		else sldSetWidth.enabled = false
	)

	on ckbLockWidth rightclick do
	(
		rolBsOpenTools.width = 340
		sldSetWidth.value    = 340
	)

	on sldSetWidth changed ticks do
	(
		rolBsOpenTools.width = ticks
	)

	on btnRefreshFolder pressed do 
	(
		fnRefreshAddress ()
		fnRefreshList edtBrowseFolder.text type:arrFileType[rdoFileType.state]
	)

	on btnPrevFolder pressed do 
	(
		tempLastFolder = fnGetLastFolder edtBrowseFolder.text
		fnRefreshList tempLastFolder type:arrFileType[rdoFileType.state]
	)

	on btnRefreshFolder rightclick do 
	(
		CheckForSave ()
		resetMaxFile #noPrompt
		max tool maximize
	)

	on btnOpenCurrentDir pressed do 
	(
		if (doesDirectoryExist edtBrowseFolder.text) then
		(
			shellLaunch edtBrowseFolder.text ""
		)
	)

	on edtBrowseFolder changed txt do
	(
		fnRefreshList txt type:arrFileType[rdoFileType.state]
	)

	on rdoFileType changed state do
	(
		fnRefreshList rolBsOpenTools.edtBrowseFolder.text type:arrFileType[state]
	)

	on btnOpenAddress pressed do 
	(
		dirOpened = getSavePath caption:"è¯·é€‰æ‹©Maxæ–‡ä»¶è·¯å¾„:" initialDir:(maxFilePath)
		if (dirOpened != undefined) then
		(
			edtBrowseFolder.text = dirOpened
			fnRefreshList dirOpened type:arrFileType[rdoFileType.state]
		)
	)
	
	on btnLikedFolder pressed do 
	(
		try(destroydialog rolAddItem)catch()
		createdialog rolAddItem fgcolor:myfgColor pos:mouse.screenpos
		rolAddItem.gbxAddDir.visible  = true
		rolAddItem.edtAddDir.visible  = true
		rolAddItem.btnOpenDir.visible = true
		rolAddItem.edtDirStr.visible  = true
		rolAddItem.gbxAddPre.visible  = false
		rolAddItem.edtPrefix.visible  = false
	)

	on btnFilterPrefix pressed do 
	(
		try(destroydialog rolAddItem)catch()
		createdialog rolAddItem fgcolor:myfgColor pos:mouse.screenpos
		rolAddItem.gbxAddPre.visible  = true
		rolAddItem.edtPrefix.visible  = true
		rolAddItem.gbxAddDir.visible  = false
		rolAddItem.edtAddDir.visible  = false
		rolAddItem.btnOpenDir.visible = false
		rolAddItem.edtDirStr.visible  = false
	)

	on btnFilterPrefix rightclick do 
	(
		ltbFilterPrefix.selection = 0
		fnRefreshList edtBrowseFolder.text type:arrFileType[rdoFileType.state]
	)

	on ddlLikedFolder selected id do
	(
		if iniLikedFolder[id] != undefined then
		(
			ddlLikedFolder.tooltip = iniLikedFolder[iniLikedFolder.count + 1 - id].dir
			fnRefreshList ddlLikedFolder.tooltip type:arrFileType[rdoFileType.state]
		)
		else ddlLikedFolder.tooltip = "è¯·æ·»åŠ å¸¸ç”¨ç›®å½•"
		iniSelectedID = id
	)

	on ddlLikedFolder rightclick do
	(
		idDel = iniLikedFolder.count + 1 - ddlLikedFolder.selection
		deleteItem iniLikedFolder idDel
		fnRefLikedFolderItems ()
	)

	on ltbFilterPrefix selected id do
	(
		fnRefreshList edtBrowseFolder.text type:arrFileType[rdoFileType.state]
	)
	
	on ltbFilterPrefix rightclick id do
	(
		idDel = iniFilterPrefix.count + 1 - id
		deleteItem iniFilterPrefix idDel
		fnRefreshFilterItems ()
	)

	on ltbFilesList rightclick id do
	(
		tempLastFolder = fnGetLastFolder edtBrowseFolder.text
		fnRefreshList tempLastFolder type:arrFileType[rdoFileType.state]
	)

	on ltbFilesList doubleClicked id do
	(
		if (doesDirectoryExist edtBrowseFolder.text) then
		(
			if edtBrowseFolder.text == (getdir #preview) then ramplayer arrFiles[id] ""
			else 
			(
				case of
				(
					((id <= arrFolders.count) and (id > 0)):
					(
						edtBrowseFolder.text = arrFolders[id]
						-- fnRefreshList edtBrowseFolder.text type:arrFileType[rdoFileType.state]
					)
					(id > arrFolders.count):
					(
						local idFile = id - arrFolders.count
						case of 
						(
							(rdoFileType.state == 1):
							(
								CheckForSave ()
								loadMaxFile (arrFiles[idFile] as string) useFileUnits:true
							)
							(rdoFileType.state == 2):(importFile arrFiles[idFile] #noPrompt using:FBXIMP)
							(rdoFileType.state == 3):(fnLoadBip arrFiles[idFile])
							(rdoFileType.state == 4):(fileIn arrFiles[idFile])
							(rdoFileType.state == 5):(fnOpenPic arrFiles[idFile])
						)
					)
				)
				fnRefreshList edtBrowseFolder.text type:arrFileType[rdoFileType.state]
			)
		)
		else 
		(
			if edtBrowseFolder.text == "( æœ€è¿‘æ‰“å¼€ Max æ–‡ä»¶åˆ—è¡¨ )" then
			(
				if doesFileExist arrRecentFiles[id] then 
				(
					loadMaxFile (arrRecentFiles[id]) useFileUnits:true
					local tempDir = getfilenamepath arrRecentFiles[id]
					fnRefreshList tempDir type:arrFileType[rdoFileType.state]
				)
			)
		)
	)

	on btnDesktopDir pressed do 
	(
		if iniDesktop.dir == "" then 
		(
			iniDesktop.dir = (@"C:\Users\" + (filterString  (getdir #userscripts) @"\")[3] + @"\Desktop\")
		)
		fnRefreshList iniDesktop.dir type:arrFileType[rdoFileType.state]
	)

	on btnDesktopDir rightclick do 
	(
		dirOpened = getSavePath caption:"è¯·è®¾ç½®æ¡Œé¢è·¯å¾„:" initialDir:(maxFilePath)
		if (dirOpened != undefined) then
		(
			iniDesktop.dir = dirOpened
			fnRefreshList iniDesktop.dir type:arrFileType[rdoFileType.state]
		)
	)

	on btnAutobackDir pressed do 
	(
		rdoFileType.state  = 1
		fnRefreshList (getdir #autoback) type:".max"
	)

	on btnScriptsDir pressed do
	(
		rdoFileType.state  = 4
		fnRefreshList (getdir #scripts) type:".ms*"
	)

	on btnScriptsDir rightclick do
	(
		rdoFileType.state  = 4
		fnRefreshList (getdir #startupScripts) type:".ms*"
	)

	on btnRecentFileDir pressed do 
	(
		fnLoadRecentFileList ()
		for i in arrRecentFiles do 
		(
			if doesFileExist i then
			(
				append arrRecentFilesName ("ğŸ“„ " + (getFilenameFile i) + ".max")
			)
			else append arrRecentFilesName ("ğŸ“„ (ç–‘ä¸¢å¤±) " + (getFilenameFile i) + ".max")
		)
		rdoFileType.state  = 1
		ltbFilesList.items = arrRecentFilesName
		edtBrowseFolder.text = "( æœ€è¿‘æ‰“å¼€ Max æ–‡ä»¶åˆ—è¡¨ )"
		lblCountTips.text = "æ–‡ä»¶ï¼š" + arrRecentFiles.count as string
	)
)
if (iniPosOpenTools != 0) then (Createdialog rolBsOpenTools fgcolor:myFgColor pos:iniPosOpenTools style:#() lockHeight:true)
else (Createdialog rolBsOpenTools fgcolor:myFgColor style:#() lockHeight:true)
------------------------toolbar----------------------------------------------------
macroScript BsOpenTools
category:"_[BulletTools]"
buttonText:"æ—¶å…‰æœº"
toolTip:"æ—¶å…‰æœº"
-- Icon:#("Systems",2)
(
	on execute do
	(
		fileIn ((getDir #Scripts)+ @"\\BulletScripts\\BsOpenTools.ms")
	)
)
-------------------------------------------------------------------------------------